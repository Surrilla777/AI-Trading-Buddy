<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Trading Buddy</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TradeBuddy">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">

    <!-- Mobile optimization -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK for Push Notifications -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .card-gradient { background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); }
        .urgent-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .talk-me-down-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .talk-me-down-btn:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // All subreddits to scan (penny stocks to mega caps)
        const SUBREDDITS = [
            { name: 'wallstreetbets', label: 'WSB', category: 'meme' },
            { name: 'stocks', label: 'Stocks', category: 'general' },
            { name: 'investing', label: 'Investing', category: 'general' },
            { name: 'options', label: 'Options', category: 'general' },
            { name: 'pennystocks', label: 'Pennies', category: 'penny' },
            { name: 'smallstreetbets', label: 'SmallBets', category: 'penny' },
            { name: 'Superstonk', label: 'Superstonk', category: 'meme' },
            { name: 'shortsqueeze', label: 'Squeeze', category: 'meme' },
            { name: 'stockmarket', label: 'Market', category: 'general' }
        ];

        // Chart patterns we support (IDs match Finviz filter values)
        const CHART_PATTERNS = [
            // Wedges
            { id: 'wedgedown', name: 'Falling Wedge', emoji: 'üìâ', type: 'bullish', desc: 'Bullish reversal - converging down, breakout up', category: 'wedge' },
            { id: 'wedgeup', name: 'Rising Wedge', emoji: 'üìà', type: 'bearish', desc: 'Bearish reversal - converging up, breakdown likely', category: 'wedge' },

            // Channels
            { id: 'channelup', name: 'Channel Up', emoji: '‚¨ÜÔ∏è', type: 'bullish', desc: 'Uptrend between parallel lines', category: 'channel' },
            { id: 'channeldown', name: 'Channel Down', emoji: '‚¨áÔ∏è', type: 'bearish', desc: 'Downtrend between parallel lines', category: 'channel' },

            // Double/Triple Tops & Bottoms
            { id: 'doubletop', name: 'Double Top', emoji: 'üîù', type: 'bearish', desc: 'Two peaks at resistance - reversal signal', category: 'reversal' },
            { id: 'doublebottom', name: 'Double Bottom', emoji: '„ÄΩÔ∏è', type: 'bullish', desc: 'Two troughs at support - reversal signal', category: 'reversal' },
            { id: 'multipletop', name: 'Triple Top', emoji: '‚õ∞Ô∏è', type: 'bearish', desc: 'Three peaks - strong reversal signal', category: 'reversal' },
            { id: 'multiplebottom', name: 'Triple Bottom', emoji: 'üèîÔ∏è', type: 'bullish', desc: 'Three troughs - strong reversal signal', category: 'reversal' },

            // Head & Shoulders
            { id: 'headandshoulders', name: 'Head & Shoulders', emoji: 'üë§', type: 'bearish', desc: 'Classic top reversal pattern', category: 'reversal' },
            { id: 'headandshouldersinv', name: 'Inverse H&S', emoji: 'üôÉ', type: 'bullish', desc: 'Classic bottom reversal pattern', category: 'reversal' },

            // Triangles
            { id: 'tlresistance', name: 'Ascending Triangle', emoji: 'üî∫', type: 'bullish', desc: 'Flat top, rising bottom - breakout up', category: 'triangle' },
            { id: 'tlsupport', name: 'Descending Triangle', emoji: 'üîª', type: 'bearish', desc: 'Flat bottom, falling top - breakdown', category: 'triangle' },
            { id: 'tltriangle', name: 'Symmetrical Triangle', emoji: 'üî∑', type: 'neutral', desc: 'Converging trendlines - breakout either way', category: 'triangle' },

            // Flags & Pennants (using Finviz wedge variations)
            { id: 'wedgeresistance', name: 'Bear Flag', emoji: 'üö©', type: 'bearish', desc: 'Downtrend pause, continuation down likely', category: 'flag' },
            { id: 'wedgesupport', name: 'Bull Flag', emoji: 'üèÅ', type: 'bullish', desc: 'Uptrend pause, continuation up likely', category: 'flag' },
        ];

        // Request counter to track latest request and prevent stale data
        let patternRequestId = 0;

        // Fetch stocks matching a chart pattern from Finviz
        // Filters: Market cap > $300M, Avg volume > 200K, Price > $5
        const fetchPatternStocks = async (patternId, signal = null) => {
            const thisRequestId = ++patternRequestId;
            const pattern = CHART_PATTERNS.find(p => p.id === patternId);
            let patternFilter = pattern?.filterType === 'ta_candlestick'
                ? `ta_${patternId}`
                : `ta_pattern_${patternId}`;

            console.log(`üîç Pattern: ${patternId} (Request #${thisRequestId})`);
            console.log(`üîó Filter: ${patternFilter}`);

            const finvizUrl = `https://finviz.com/screener.ashx?v=111&f=${patternFilter},cap_smallover,sh_avgvol_o200,sh_price_o5&o=-marketcap`;

            try {
                const response = await fetch('/api/finviz?pattern=' + patternFilter);

                // Check if this request was superseded by a newer one
                if (thisRequestId !== patternRequestId) {
                    console.log(`‚è≠Ô∏è Request #${thisRequestId} superseded by #${patternRequestId}, discarding`);
                    return null;
                }

                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const links = doc.querySelectorAll('a[href*="quote.ashx?t="]');
                const seen = new Set();
                const stocks = [];

                links.forEach(link => {
                    const ticker = link.textContent.trim();
                    if (ticker && /^[A-Z]{1,5}$/.test(ticker) && !seen.has(ticker) && stocks.length < 25) {
                        seen.add(ticker);
                        const row = link.closest('tr');
                        let price = '', change = '', marketCap = '';
                        if (row) {
                            row.querySelectorAll('td').forEach(cell => {
                                const t = cell.textContent.trim();
                                if (!marketCap && /^\d+\.?\d*[BMK]$/.test(t)) marketCap = t;
                                if (!price && /^\d+\.\d{2}$/.test(t)) price = '$' + t;
                                if (!change && /^-?\d+\.?\d*%$/.test(t)) change = t;
                            });
                        }
                        stocks.push({ ticker, company: '', sector: '', marketCap, price, change, changeNum: parseFloat((change || '').replace('%', '')) || 0 });
                    }
                });

                console.log(`‚úÖ Request #${thisRequestId}: Parsed ${stocks.length} stocks`);

                if (stocks.length > 0) {
                    return stocks;
                }
                return [{ ticker: 'ERROR', company: 'No stocks found for this pattern.', error: true, finvizUrl }];
            } catch (error) {
                console.error(`‚ùå Request #${thisRequestId} failed:`, error.message);
                if (error.name === 'AbortError') return null;
                return [{ ticker: 'ERROR', company: 'Couldn\'t fetch data. Check console for details.', error: true, finvizUrl }];
            }
        };

        // Fetch multiple patterns at once
        const fetchAllPatterns = async (patternIds) => {
            const results = {};
            await Promise.all(
                patternIds.map(async (id) => {
                    results[id] = await fetchPatternStocks(id);
                })
            );
            return results;
        };

        // Fetch insider trading data from OpenInsider
        const fetchInsiderTrading = async () => {
            try {
                const response = await fetch('/api/openinsider');
                const html = await response.text();

                // Parse the HTML table
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const rows = doc.querySelectorAll('table.tinytable tbody tr');

                const insiderTrades = [];
                rows.forEach((row, index) => {
                    if (index >= 20) return; // Limit to 20 results
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 12) {
                        const ticker = cells[3]?.textContent?.trim();
                        const company = cells[4]?.textContent?.trim();
                        const insiderName = cells[5]?.textContent?.trim();
                        const title = cells[6]?.textContent?.trim();
                        const tradeType = cells[7]?.textContent?.trim();
                        const price = cells[8]?.textContent?.trim();
                        const qty = cells[9]?.textContent?.trim();
                        const owned = cells[10]?.textContent?.trim();
                        const value = cells[12]?.textContent?.trim();
                        const filingDate = cells[1]?.textContent?.trim();

                        if (ticker && value) {
                            // Parse value to number for sorting
                            const valueNum = parseFloat(value.replace(/[$,]/g, '')) || 0;
                            insiderTrades.push({
                                ticker,
                                company: company?.substring(0, 30),
                                insiderName: insiderName?.substring(0, 25),
                                title: title?.substring(0, 20),
                                tradeType,
                                price,
                                qty,
                                value,
                                valueNum,
                                filingDate
                            });
                        }
                    }
                });

                // Sort by value descending
                return insiderTrades.sort((a, b) => b.valueNum - a.valueNum);
            } catch (error) {
                console.error('Error fetching insider data:', error);
                return [];
            }
        };

        // Fetch from multiple subreddits and aggregate
        const fetchMultiReddit = async () => {
            const tickerCounts = {};
            const tickerSources = {};
            const allPosts = [];

            // Fetch all subreddits in parallel using local proxy
            const results = await Promise.allSettled(
                SUBREDDITS.map(async (sub) => {
                    try {
                        const response = await fetch(`/api/reddit?sub=${sub.name}`);
                        const data = await response.json();
                        return { sub, data };
                    } catch (e) {
                        return { sub, data: null };
                    }
                })
            );

            // Process results
            const tickerRegex = /\$([A-Z]{1,5})\b|\b([A-Z]{2,5})\b/g;
            const blacklist = ['CEO', 'IPO', 'ETF', 'WSB', 'YOLO', 'IMO', 'USA', 'GDP', 'CPI', 'ATH', 'ATL', 'DD', 'PT', 'SEC', 'FDA', 'THE', 'FOR', 'AND', 'BUT', 'ALL', 'ARE', 'THIS', 'THAT', 'WITH', 'NOT', 'NOW', 'OUT', 'HOW', 'WHY', 'HAS', 'HAD', 'GET', 'GOT', 'CAN', 'NEW', 'ONE', 'TWO', 'ITS', 'ANY', 'MAY', 'DAY', 'BIG', 'TOP', 'LOW', 'HIGH', 'JUST', 'LIKE', 'WHAT', 'WHEN', 'BEEN', 'HAVE', 'WILL', 'MORE', 'SOME', 'VERY', 'ONLY', 'OVER', 'SUCH', 'INTO', 'YEAR', 'YOUR', 'THEM', 'THAN', 'THEY', 'WERE', 'SAID', 'EACH', 'SHE', 'HER', 'HIM', 'HIS', 'WAS', 'FROM', 'THAT', 'ALSO', 'MADE', 'DID', 'RUN', 'PUT', 'SAY', 'SHE', 'TOO', 'USE'];

            results.forEach(result => {
                if (result.status !== 'fulfilled' || !result.value.data?.data?.children) return;

                const { sub, data } = result.value;
                data.data.children.forEach(post => {
                    const title = post.data.title;
                    const body = post.data.selftext || '';
                    const score = post.data.score;
                    const text = title + ' ' + body;
                    const matches = text.match(tickerRegex) || [];

                    matches.forEach(match => {
                        const ticker = match.replace('$', '').toUpperCase();
                        if (!blacklist.includes(ticker) && ticker.length >= 2 && ticker.length <= 5) {
                            // Weight by upvotes and subreddit size
                            const weight = sub.name === 'wallstreetbets' ? 1.5 :
                                          sub.category === 'penny' ? 0.8 : 1;
                            tickerCounts[ticker] = (tickerCounts[ticker] || 0) + (score * weight);

                            // Track which subreddits mention this ticker
                            if (!tickerSources[ticker]) tickerSources[ticker] = new Set();
                            tickerSources[ticker].add(sub.label);
                        }
                    });

                    // Collect hot posts
                    if (score > 50) {
                        allPosts.push({
                            title: title.substring(0, 80) + (title.length > 80 ? '...' : ''),
                            score,
                            subreddit: sub.label,
                            category: sub.category,
                            url: `https://reddit.com${post.data.permalink}`
                        });
                    }
                });
            });

            // Sort tickers by aggregate score
            const trending = Object.entries(tickerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 25)
                .map(([ticker, score]) => ({
                    ticker,
                    score: Math.round(score),
                    sources: Array.from(tickerSources[ticker] || []),
                    heat: score > 10000 ? 'extreme' : score > 5000 ? 'high' : score > 1000 ? 'medium' : 'low'
                }));

            // Sort posts by score
            const posts = allPosts
                .sort((a, b) => b.score - a.score)
                .slice(0, 15);

            return { trending, posts };
        };

        // Fetch Yahoo Finance trending tickers
        const fetchYahooTrending = async () => {
            try {
                const response = await fetch('/api/yahoo-trending');
                const html = await response.text();

                // Parse trending tickers from Yahoo HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tickers = [];

                // Look for ticker symbols in the page
                doc.querySelectorAll('a[href*="/quote/"]').forEach(link => {
                    const match = link.href.match(/\/quote\/([A-Z]{1,5})/);
                    if (match && !tickers.find(t => t.ticker === match[1])) {
                        tickers.push({ ticker: match[1], source: 'Yahoo' });
                    }
                });

                return tickers.slice(0, 25);
            } catch (error) {
                console.error('Error fetching Yahoo trending:', error);
                return [];
            }
        };

        // Fetch Stocktwits trending (uses proxy endpoint)
        const fetchStocktwits = async () => {
            try {
                const response = await fetch('/api/proxy?url=' + encodeURIComponent('https://api.stocktwits.com/api/2/trending/symbols.json'));
                const data = await response.json();

                if (data.symbols) {
                    return data.symbols.map(s => ({
                        ticker: s.symbol,
                        source: 'Stocktwits',
                        title: s.title
                    }));
                }
                return [];
            } catch (error) {
                console.error('Error fetching Stocktwits:', error);
                return [];
            }
        };

        // Fetch Finviz most active stocks
        const fetchFinvizBuzz = async () => {
            try {
                const response = await fetch('/api/finviz?pattern=ta_mostactive');
                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('a[href*="quote.ashx?t="]');

                const seen = new Set();
                const stocks = [];
                links.forEach(link => {
                    const ticker = link.textContent.trim();
                    if (ticker && /^[A-Z]{1,5}$/.test(ticker) && !seen.has(ticker) && stocks.length < 20) {
                        seen.add(ticker);
                        stocks.push({ ticker, source: 'Finviz' });
                    }
                });
                return stocks;
            } catch (error) {
                console.error('Error fetching Finviz:', error);
                return [];
            }
        };

        // Fetch MarketWatch trending
        const fetchMarketWatch = async () => {
            try {
                const response = await fetch('/api/marketwatch');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tickers = [];

                doc.querySelectorAll('a[href*="/investing/stock/"]').forEach(link => {
                    const match = link.href.match(/\/stock\/([A-Z]{1,5})/i);
                    if (match && !tickers.find(t => t.ticker === match[1].toUpperCase())) {
                        tickers.push({ ticker: match[1].toUpperCase(), source: 'MarketWatch' });
                    }
                });
                return tickers.slice(0, 20);
            } catch (error) {
                console.error('Error fetching MarketWatch:', error);
                return [];
            }
        };

        // Fetch CNBC mentions
        const fetchCNBC = async () => {
            try {
                const response = await fetch('/api/cnbc');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tickers = [];

                doc.querySelectorAll('a[href*="/quotes/"]').forEach(link => {
                    const match = link.href.match(/\/quotes\/([A-Z]{1,5})/i);
                    if (match && !tickers.find(t => t.ticker === match[1].toUpperCase())) {
                        tickers.push({ ticker: match[1].toUpperCase(), source: 'CNBC' });
                    }
                });
                return tickers.slice(0, 20);
            } catch (error) {
                console.error('Error fetching CNBC:', error);
                return [];
            }
        };

        // Fetch Seeking Alpha mentions
        const fetchSeekingAlpha = async () => {
            try {
                const response = await fetch('/api/seekingalpha');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tickers = [];

                doc.querySelectorAll('a[href*="/symbol/"]').forEach(link => {
                    const match = link.href.match(/\/symbol\/([A-Z]{1,5})/i);
                    if (match && !tickers.find(t => t.ticker === match[1].toUpperCase())) {
                        tickers.push({ ticker: match[1].toUpperCase(), source: 'SeekingAlpha' });
                    }
                });
                return tickers.slice(0, 20);
            } catch (error) {
                console.error('Error fetching SeekingAlpha:', error);
                return [];
            }
        };

        // Fetch Motley Fool mentions
        const fetchMotleyFool = async () => {
            try {
                const response = await fetch('/api/motleyfool');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tickers = [];

                // Look for ticker patterns in links and text
                doc.querySelectorAll('a[href*="/quote/"]').forEach(link => {
                    const match = link.href.match(/\/quote\/[a-z]+\/([A-Z]{1,5})/i);
                    if (match && !tickers.find(t => t.ticker === match[1].toUpperCase())) {
                        tickers.push({ ticker: match[1].toUpperCase(), source: 'MotleyFool' });
                    }
                });
                return tickers.slice(0, 20);
            } catch (error) {
                console.error('Error fetching MotleyFool:', error);
                return [];
            }
        };

        // Fetch Bloomberg mentions
        const fetchBloomberg = async () => {
            try {
                const response = await fetch('/api/bloomberg');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tickers = [];

                doc.querySelectorAll('a[href*="/quote/"]').forEach(link => {
                    const match = link.href.match(/\/quote\/([A-Z]{1,5}):US/i);
                    if (match && !tickers.find(t => t.ticker === match[1].toUpperCase())) {
                        tickers.push({ ticker: match[1].toUpperCase(), source: 'Bloomberg' });
                    }
                });
                return tickers.slice(0, 20);
            } catch (error) {
                console.error('Error fetching Bloomberg:', error);
                return [];
            }
        };

        // Aggregate all sources into unified hot stocks list
        const fetchHotStocks = async () => {
            const tickerData = {};
            const allPosts = [];

            // Fetch all sources in parallel (10 sources total)
            const [
                redditData, yahooData, stocktwitsData, finvizData,
                marketwatchData, cnbcData, seekingalphaData, motleyfoolData, bloombergData
            ] = await Promise.allSettled([
                fetchMultiReddit(),
                fetchYahooTrending(),
                fetchStocktwits(),
                fetchFinvizBuzz(),
                fetchMarketWatch(),
                fetchCNBC(),
                fetchSeekingAlpha(),
                fetchMotleyFool(),
                fetchBloomberg()
            ]);

            // Helper to process source data
            const processSource = (result, sourceName, weight = 50) => {
                if (result.status === 'fulfilled' && result.value) {
                    result.value.forEach((item, index) => {
                        if (!tickerData[item.ticker]) {
                            tickerData[item.ticker] = { ticker: item.ticker, score: 0, sources: new Set(), redditScore: 0 };
                        }
                        tickerData[item.ticker].score += (20 - Math.min(index, 19)) * weight;
                        tickerData[item.ticker].sources.add(sourceName);
                    });
                }
            };

            // Process Reddit data (special handling for posts)
            if (redditData.status === 'fulfilled' && redditData.value) {
                redditData.value.trending.forEach(item => {
                    if (!tickerData[item.ticker]) {
                        tickerData[item.ticker] = { ticker: item.ticker, score: 0, sources: new Set(), redditScore: 0 };
                    }
                    tickerData[item.ticker].score += item.score;
                    tickerData[item.ticker].redditScore = item.score;
                    item.sources.forEach(s => tickerData[item.ticker].sources.add('r/' + s));
                });
                allPosts.push(...(redditData.value.posts || []));
            }

            // Process all other sources
            processSource(yahooData, 'Yahoo', 100);
            processSource(stocktwitsData, 'Stocktwits', 80);
            processSource(finvizData, 'Finviz', 60);
            processSource(marketwatchData, 'MarketWatch', 70);
            processSource(cnbcData, 'CNBC', 90);
            processSource(seekingalphaData, 'SeekingAlpha', 75);
            processSource(motleyfoolData, 'MotleyFool', 65);
            processSource(bloombergData, 'Bloomberg', 95);

            // Convert to sorted array
            const trending = Object.values(tickerData)
                .map(item => ({
                    ...item,
                    sources: Array.from(item.sources),
                    sourceCount: item.sources.size,
                    heat: item.sources.size >= 5 ? 'extreme' : item.sources.size >= 3 ? 'high' : item.sources.size >= 2 ? 'medium' : 'low'
                }))
                .sort((a, b) => {
                    // Sort by number of sources first, then by score
                    if (b.sourceCount !== a.sourceCount) return b.sourceCount - a.sourceCount;
                    return b.score - a.score;
                })
                .slice(0, 30);

            return { trending, posts: allPosts };
        };

        // Fetch trending stocks (now aggregates all sources)
        const fetchTrendingStocks = async () => {
            return await fetchHotStocks();
        };

        // Fetch news for a ticker
        const fetchNews = async (ticker) => {
            try {
                const response = await fetch('/api/proxy?url=' + encodeURIComponent(`https://www.reddit.com/r/stocks/search.json?q=${ticker}&sort=hot&limit=5`));
                const data = await response.json();

                if (data.data && data.data.children) {
                    return data.data.children.map(post => ({
                        title: post.data.title,
                        score: post.data.score,
                        url: `https://reddit.com${post.data.permalink}`
                    }));
                }
                return [];
            } catch (error) {
                console.error('Error fetching news:', error);
                return [];
            }
        };

        // Fetch real stock data from Yahoo Finance
        const fetchStockData = async (ticker) => {
            try {
                const response = await fetch('/api/proxy?url=' + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1mo`));
                const data = await response.json();

                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const prices = result.indicators.quote[0].close.filter(p => p !== null);
                    const currentPrice = prices[prices.length - 1];
                    const weekAgoPrice = prices[Math.max(0, prices.length - 6)] || prices[0];
                    const monthAgoPrice = prices[0];

                    const weekChange = ((currentPrice - weekAgoPrice) / weekAgoPrice) * 100;
                    const monthChange = ((currentPrice - monthAgoPrice) / monthAgoPrice) * 100;

                    let momentum = 'flat';
                    if (weekChange > 10 || monthChange > 20) momentum = 'ripping';
                    else if (weekChange < -10 || monthChange < -20) momentum = 'bleeding';
                    else if (weekChange > 3) momentum = 'uptrend';
                    else if (weekChange < -3) momentum = 'downtrend';

                    return {
                        currentPrice,
                        weekChange: weekChange.toFixed(1),
                        monthChange: monthChange.toFixed(1),
                        momentum,
                        prices
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching stock data:', error);
                return null;
            }
        };

        // AI Trade Rating - Analyzes a potential trade and gives 1-10 rating with reasoning
        const analyzeTradeRating = async (formData) => {
            const { ticker, type, optionType, strike, expiration, entryPrice, quantity, strategy } = formData;

            if (!ticker || !entryPrice) {
                return { rating: 0, reasons: ['Enter ticker and price first'], color: 'gray' };
            }

            const reasons = [];
            let score = 5; // Start neutral

            try {
                // Fetch current stock data from Finviz
                const response = await fetch(`/api/finviz?pattern=&ticker=${ticker}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Try to extract key metrics from Finviz
                const getText = (label) => {
                    const cells = doc.querySelectorAll('td.snapshot-td2');
                    for (const cell of cells) {
                        if (cell.textContent.includes(label)) {
                            const next = cell.nextElementSibling;
                            return next ? next.textContent.trim() : null;
                        }
                    }
                    return null;
                };

                // Get current price from page
                const priceEl = doc.querySelector('strong.quote-price');
                const currentPrice = priceEl ? parseFloat(priceEl.textContent) : parseFloat(entryPrice);

                // ===== STOCK ANALYSIS =====
                if (type === 'stock') {
                    // Check if buying at a reasonable price
                    const entryNum = parseFloat(entryPrice);

                    if (strategy === 'day') {
                        reasons.push('‚ö†Ô∏è Day trading is high-risk, most lose money');
                        score -= 1;
                    } else if (strategy === 'long') {
                        reasons.push('‚úÖ Long-term holding reduces timing risk');
                        score += 1;
                    }

                    // Position size check
                    const positionValue = entryNum * parseFloat(quantity);
                    if (positionValue > 10000) {
                        reasons.push('‚ö†Ô∏è Large position - ensure proper risk management');
                    }

                    // General stock advice
                    reasons.push('üìä Stock trades have lower risk than options');
                    score += 1;
                }

                // ===== OPTIONS ANALYSIS =====
                if (type === 'option') {
                    const strikeNum = parseFloat(strike);
                    const entryNum = parseFloat(entryPrice);

                    // Days to expiration
                    if (expiration) {
                        const expiryDate = new Date(expiration);
                        const today = new Date();
                        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                        if (daysToExpiry <= 7) {
                            reasons.push('üî¥ WEEKLY OPTION - Extreme theta decay, very risky');
                            score -= 3;
                        } else if (daysToExpiry <= 14) {
                            reasons.push('üü† Under 2 weeks to expiry - High theta decay');
                            score -= 2;
                        } else if (daysToExpiry <= 30) {
                            reasons.push('üü° Under 30 days - Moderate theta risk');
                            score -= 1;
                        } else if (daysToExpiry >= 180) {
                            reasons.push('‚úÖ LEAP - Time is on your side');
                            score += 2;
                        } else if (daysToExpiry >= 60) {
                            reasons.push('‚úÖ Good runway - 60+ days to expiry');
                            score += 1;
                        }
                    } else {
                        reasons.push('‚ö†Ô∏è No expiration date entered');
                    }

                    // Strike distance from current price
                    if (strikeNum && currentPrice) {
                        const strikeDistance = ((strikeNum - currentPrice) / currentPrice) * 100;

                        if (optionType === 'call') {
                            if (strikeDistance > 20) {
                                reasons.push(`üî¥ Strike ${strikeDistance.toFixed(0)}% above current price - Low probability`);
                                score -= 2;
                            } else if (strikeDistance > 10) {
                                reasons.push(`üü† Strike ${strikeDistance.toFixed(0)}% OTM - Needs big move`);
                                score -= 1;
                            } else if (strikeDistance < 0) {
                                reasons.push(`‚úÖ ITM call - Higher cost but safer`);
                                score += 1;
                            } else {
                                reasons.push(`üü¢ Strike near the money - Reasonable target`);
                            }
                        } else {
                            if (strikeDistance < -20) {
                                reasons.push(`üî¥ Strike ${Math.abs(strikeDistance).toFixed(0)}% below current - Low probability`);
                                score -= 2;
                            } else if (strikeDistance < -10) {
                                reasons.push(`üü† Strike ${Math.abs(strikeDistance).toFixed(0)}% OTM - Needs big drop`);
                                score -= 1;
                            } else if (strikeDistance > 0) {
                                reasons.push(`‚úÖ ITM put - Higher cost but safer`);
                                score += 1;
                            }
                        }
                    }

                    // Premium cost analysis
                    if (entryNum && currentPrice) {
                        const premiumPercent = (entryNum / currentPrice) * 100;
                        if (premiumPercent > 10) {
                            reasons.push(`‚ö†Ô∏è Premium is ${premiumPercent.toFixed(1)}% of stock price - Expensive`);
                            score -= 1;
                        }
                    }

                    // Options are inherently riskier
                    reasons.push('‚ö†Ô∏è Options can go to zero - size accordingly');
                }

                // ===== CRYPTO ANALYSIS =====
                if (type === 'crypto') {
                    reasons.push('‚ö†Ô∏è Crypto is highly volatile - expect 20%+ swings');

                    if (strategy === 'day') {
                        reasons.push('üî¥ Day trading crypto is extremely risky');
                        score -= 2;
                    } else if (strategy === 'long') {
                        reasons.push('‚úÖ Long-term crypto hold has historically worked');
                        score += 1;
                    }

                    const positionValue = parseFloat(entryPrice) * parseFloat(quantity);
                    if (positionValue > 5000) {
                        reasons.push('‚ö†Ô∏è Large crypto position - high volatility risk');
                    }
                }

                // Always remind about timeframes
                reasons.push('üìä Check multiple timeframes before entry');

                // Clamp score between 1 and 10
                score = Math.max(1, Math.min(10, score));

                // Determine color based on score
                let color = 'yellow';
                if (score >= 7) color = 'green';
                else if (score <= 3) color = 'red';

                return { rating: score, reasons, color, currentPrice };

            } catch (error) {
                console.error('Error analyzing trade:', error);
                // Return basic analysis without live data
                if (type === 'option') {
                    reasons.push('‚ö†Ô∏è Options are risky - can lose 100%');
                    if (expiration) {
                        const expiryDate = new Date(expiration);
                        const daysToExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysToExpiry <= 7) {
                            reasons.push('üî¥ WEEKLY - Extreme risk');
                            score = 2;
                        } else if (daysToExpiry <= 30) {
                            reasons.push('üü† Short-dated option');
                            score = 4;
                        }
                    }
                }
                return { rating: Math.max(1, Math.min(10, score)), reasons, color: score >= 7 ? 'green' : score <= 3 ? 'red' : 'yellow' };
            }
        };

        // Mock price data (fallback)
        const mockPrices = {
            'NVDA': 148.50,
            'TSLA': 242.30,
            'AAPL': 189.20,
            'BTC': 94500,
            'ETH': 3350,
            'SOL': 185.40
        };

        // Sample positions for demo
        const samplePositions = [
            {
                id: 1,
                ticker: 'NVDA',
                type: 'option',
                optionType: 'call',
                strike: 150,
                expiration: '2026-01-16',
                entryPrice: 5.20,
                currentPrice: 3.10,
                quantity: 10,
                strategy: 'swing'
            },
            {
                id: 2,
                ticker: 'TSLA',
                type: 'stock',
                entryPrice: 250,
                currentPrice: 242.30,
                quantity: 50,
                strategy: 'long'
            },
            {
                id: 3,
                ticker: 'BTC',
                type: 'crypto',
                entryPrice: 98000,
                currentPrice: 94500,
                quantity: 0.5,
                strategy: 'swing'
            },
            {
                id: 4,
                ticker: 'AAPL',
                type: 'option',
                optionType: 'call',
                strike: 190,
                expiration: '2027-01-15',
                entryPrice: 12.50,
                currentPrice: 14.80,
                quantity: 5,
                strategy: 'swing'
            },
            {
                id: 5,
                ticker: 'TSLA',
                type: 'option',
                optionType: 'call',
                strike: 800,
                expiration: '2027-01-15',
                entryPrice: 34.00,
                currentPrice: 27.20,
                quantity: 1,
                strategy: 'swing'
            },
            {
                id: 6,
                ticker: 'OSCR',
                type: 'option',
                optionType: 'call',
                strike: 30,
                expiration: '2026-03-20',
                entryPrice: 1.22,
                currentPrice: 0.33,
                quantity: 3,
                strategy: 'swing',
                momentum: 'ripping'
            }
        ];

        // Calculate days to expiration
        const getDaysToExpiry = (expiration) => {
            if (!expiration) return null;
            const today = new Date();
            const expDate = new Date(expiration);
            const diffTime = expDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        };

        // Format expiration date for display (e.g., "Jan 17, 2025")
        const formatExpirationDate = (expiration) => {
            if (!expiration) return null;
            const date = new Date(expiration + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        // Generate Yahoo Finance option contract symbol
        // Format: {TICKER}{YYMMDD}{C/P}{STRIKE*1000 padded to 8 digits}
        // Example: NVDA250117C00150000 for NVDA $150 Call expiring Jan 17, 2025
        const generateOptionSymbol = (ticker, expiration, optionType, strike) => {
            if (!ticker || !expiration || !optionType || !strike) return null;

            const date = new Date(expiration + 'T00:00:00');
            const yy = String(date.getFullYear()).slice(-2);
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');

            const type = optionType.toLowerCase() === 'call' ? 'C' : 'P';
            const strikeFormatted = String(Math.round(parseFloat(strike) * 1000)).padStart(8, '0');

            return `${ticker.toUpperCase()}${yy}${mm}${dd}${type}${strikeFormatted}`;
        };

        // Fetch option contract price from Yahoo Finance
        const fetchOptionPrice = async (ticker, expiration, optionType, strike) => {
            try {
                // Convert expiration to Unix timestamp for Yahoo API
                // Use UTC to avoid timezone issues
                const expDate = new Date(expiration + 'T00:00:00Z');
                const expTimestamp = Math.floor(expDate.getTime() / 1000);

                console.log(`[Option Price] Fetching ${ticker} ${strike} ${optionType} exp:${expiration} ts:${expTimestamp}`);

                const response = await fetch(`/api/yahoo?ticker=${ticker}&type=options&expiry=${expTimestamp}`);
                const data = await response.json();

                if (data.optionChain?.result?.[0]?.options?.[0]) {
                    const options = data.optionChain.result[0].options[0];
                    const contracts = optionType.toLowerCase() === 'call' ? options.calls : options.puts;

                    console.log(`[Option Price] Got ${contracts?.length || 0} ${optionType} contracts for ${ticker}`);

                    // Find the matching strike
                    const strikeNum = parseFloat(strike);
                    const contract = contracts?.find(c => Math.abs(c.strike - strikeNum) < 0.01);

                    if (contract) {
                        // Use mid price (average of bid/ask), fallback to lastPrice
                        const midPrice = contract.bid && contract.ask
                            ? (contract.bid + contract.ask) / 2
                            : contract.lastPrice;

                        console.log(`[Option Price] ${ticker} ${strike}${optionType.charAt(0).toUpperCase()}: bid=${contract.bid} ask=${contract.ask} mid=${midPrice}`);

                        return {
                            price: midPrice,
                            bid: contract.bid,
                            ask: contract.ask,
                            lastPrice: contract.lastPrice,
                            change: contract.change,
                            percentChange: contract.percentChange,
                            volume: contract.volume,
                            openInterest: contract.openInterest,
                            impliedVolatility: contract.impliedVolatility
                        };
                    } else {
                        console.log(`[Option Price] No contract found for strike ${strikeNum}. Available strikes:`, contracts?.slice(0, 5).map(c => c.strike));
                    }
                } else {
                    console.log(`[Option Price] No options data returned for ${ticker}`, data);
                }
                return null;
            } catch (error) {
                console.error('[Option Price] Error:', error);
                return null;
            }
        };

        // ============================================
        // SCALPER TOOLKIT - Day Trading Features
        // ============================================

        // Momentum Indicator - Based on recent price action
        const getMomentum = (dayChange, volume, avgVolume) => {
            const change = parseFloat(dayChange) || 0;
            const volRatio = volume && avgVolume ? volume / avgVolume : 1;

            if (change > 5 || (change > 3 && volRatio > 2)) {
                return { status: 'RIPPING', emoji: 'üöÄ', color: 'text-green-400', bg: 'bg-green-500/20' };
            } else if (change > 2) {
                return { status: 'BULLISH', emoji: 'üìà', color: 'text-green-400', bg: 'bg-green-500/10' };
            } else if (change > 0.5) {
                return { status: 'UPTREND', emoji: '‚ÜóÔ∏è', color: 'text-green-300', bg: 'bg-green-500/5' };
            } else if (change < -5 || (change < -3 && volRatio > 2)) {
                return { status: 'DRILLING', emoji: 'üìâ', color: 'text-red-400', bg: 'bg-red-500/20' };
            } else if (change < -2) {
                return { status: 'BEARISH', emoji: 'üêª', color: 'text-red-400', bg: 'bg-red-500/10' };
            } else if (change < -0.5) {
                return { status: 'DOWNTREND', emoji: '‚ÜòÔ∏è', color: 'text-red-300', bg: 'bg-red-500/5' };
            } else {
                return { status: 'CHOPPY', emoji: 'üòê', color: 'text-gray-400', bg: 'bg-gray-500/10' };
            }
        };

        // Volume Spike Detection
        const getVolumeStatus = (volume, avgVolume) => {
            if (!volume || !avgVolume) return null;
            const ratio = volume / avgVolume;

            if (ratio >= 3) {
                return { status: 'EXTREME', emoji: 'üî•üî•üî•', color: 'text-orange-400', multiplier: ratio.toFixed(1) };
            } else if (ratio >= 2) {
                return { status: 'HIGH', emoji: 'üî•üî•', color: 'text-orange-400', multiplier: ratio.toFixed(1) };
            } else if (ratio >= 1.5) {
                return { status: 'ELEVATED', emoji: 'üî•', color: 'text-yellow-400', multiplier: ratio.toFixed(1) };
            } else if (ratio <= 0.5) {
                return { status: 'LOW', emoji: 'üò¥', color: 'text-gray-500', multiplier: ratio.toFixed(1) };
            }
            return { status: 'NORMAL', emoji: 'üìä', color: 'text-gray-400', multiplier: ratio.toFixed(1) };
        };

        // VWAP Indicator (simplified - based on day's price action)
        const getVWAPStatus = (currentPrice, vwap) => {
            if (!currentPrice || !vwap) return null;
            const diff = ((currentPrice - vwap) / vwap) * 100;

            if (diff > 1) {
                return { status: 'ABOVE VWAP', emoji: '‚úÖ', color: 'text-green-400', diff: `+${diff.toFixed(2)}%` };
            } else if (diff < -1) {
                return { status: 'BELOW VWAP', emoji: '‚ö†Ô∏è', color: 'text-red-400', diff: `${diff.toFixed(2)}%` };
            }
            return { status: 'AT VWAP', emoji: '‚û°Ô∏è', color: 'text-yellow-400', diff: `${diff.toFixed(2)}%` };
        };

        // Speed Alert - Detect rapid price movements
        const checkSpeedAlert = (ticker, currentPrice, previousPrice, timeframeSecs = 60) => {
            if (!currentPrice || !previousPrice) return null;
            const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;

            if (Math.abs(changePercent) >= 2) {
                return {
                    ticker,
                    change: changePercent,
                    direction: changePercent > 0 ? 'UP' : 'DOWN',
                    emoji: changePercent > 0 ? 'üöÄ' : 'üìâ',
                    message: `${ticker} moved ${changePercent > 0 ? '+' : ''}${changePercent.toFixed(1)}% in ${timeframeSecs}s!`
                };
            }
            return null;
        };

        // Hot Streak Tracker - Load from localStorage
        const loadTradeStats = () => {
            try {
                const saved = localStorage.getItem('tradeStats');
                return saved ? JSON.parse(saved) : {
                    wins: 0,
                    losses: 0,
                    streak: 0,
                    streakType: null, // 'win' or 'loss'
                    todayPnL: 0,
                    todayTrades: 0,
                    lastTradeDate: null
                };
            } catch (e) {
                return { wins: 0, losses: 0, streak: 0, streakType: null, todayPnL: 0, todayTrades: 0, lastTradeDate: null };
            }
        };

        const saveTradeStats = (stats) => {
            localStorage.setItem('tradeStats', JSON.stringify(stats));
        };

        // Daily Goal Tracker - Load from localStorage
        const loadDailyGoal = () => {
            try {
                const saved = localStorage.getItem('dailyGoal');
                return saved ? parseFloat(saved) : 500; // Default $500 goal
            } catch (e) {
                return 500;
            }
        };

        const saveDailyGoal = (goal) => {
            localStorage.setItem('dailyGoal', goal.toString());
        };

        // ===== TRADE JOURNAL - TradeZella Style =====
        // Complete trade logging, analytics, and performance tracking

        const SETUP_TYPES = [
            { id: 'breakout', label: 'Breakout', emoji: 'üöÄ' },
            { id: 'breakdown', label: 'Breakdown', emoji: 'üìâ' },
            { id: 'reversal', label: 'Reversal', emoji: 'üîÑ' },
            { id: 'momentum', label: 'Momentum', emoji: '‚ö°' },
            { id: 'scalp', label: 'Scalp', emoji: 'üéØ' },
            { id: 'swing', label: 'Swing', emoji: 'üåä' },
            { id: 'earnings', label: 'Earnings Play', emoji: 'üìä' },
            { id: 'news', label: 'News Catalyst', emoji: 'üì∞' },
            { id: 'gap', label: 'Gap Fill', emoji: '‚¨ÜÔ∏è' },
            { id: 'support', label: 'Support Bounce', emoji: 'üõ°Ô∏è' },
            { id: 'resistance', label: 'Resistance Break', emoji: 'üí•' },
            { id: 'vwap', label: 'VWAP Play', emoji: 'üìà' },
            { id: 'options_flow', label: 'Options Flow', emoji: 'üåä' },
            { id: 'squeeze', label: 'Short Squeeze', emoji: 'üçã' },
            { id: 'other', label: 'Other', emoji: 'üìù' }
        ];

        const MISTAKE_TYPES = [
            { id: 'fomo', label: 'FOMO Entry', emoji: 'üò∞' },
            { id: 'no_stop', label: 'No Stop Loss', emoji: 'üõë' },
            { id: 'moved_stop', label: 'Moved Stop', emoji: 'üîÑ' },
            { id: 'oversized', label: 'Oversized Position', emoji: 'üêã' },
            { id: 'revenge', label: 'Revenge Trade', emoji: 'üò§' },
            { id: 'early_exit', label: 'Early Exit', emoji: 'üèÉ' },
            { id: 'late_exit', label: 'Late Exit', emoji: 'üê¢' },
            { id: 'chasing', label: 'Chasing', emoji: 'üèÉ‚Äç‚ôÇÔ∏è' },
            { id: 'no_plan', label: 'No Trade Plan', emoji: '‚ùì' },
            { id: 'overtrading', label: 'Overtrading', emoji: 'üî•' },
            { id: 'ignored_rules', label: 'Ignored Rules', emoji: '‚ö†Ô∏è' },
            { id: 'emotional', label: 'Emotional Decision', emoji: 'üò¢' },
            { id: 'none', label: 'No Mistakes', emoji: '‚úÖ' }
        ];

        const EMOTIONS = [
            { id: 'confident', label: 'Confident', emoji: 'üòé', color: 'text-green-400' },
            { id: 'neutral', label: 'Neutral', emoji: 'üòê', color: 'text-gray-400' },
            { id: 'anxious', label: 'Anxious', emoji: 'üò∞', color: 'text-yellow-400' },
            { id: 'fearful', label: 'Fearful', emoji: 'üò®', color: 'text-orange-400' },
            { id: 'greedy', label: 'Greedy', emoji: 'ü§ë', color: 'text-yellow-400' },
            { id: 'frustrated', label: 'Frustrated', emoji: 'üò§', color: 'text-red-400' },
            { id: 'revenge', label: 'Revenge Mode', emoji: 'üëä', color: 'text-red-500' },
            { id: 'fomo', label: 'FOMO', emoji: 'üò±', color: 'text-purple-400' },
            { id: 'excited', label: 'Excited', emoji: 'ü§©', color: 'text-blue-400' },
            { id: 'bored', label: 'Bored', emoji: 'üò¥', color: 'text-gray-500' }
        ];

        // Load journal entries from localStorage
        const loadJournalEntries = () => {
            try {
                const saved = localStorage.getItem('tradeJournal');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        };

        // Save journal entries
        const saveJournalEntries = (entries) => {
            localStorage.setItem('tradeJournal', JSON.stringify(entries));
        };

        // Calculate journal statistics
        const calculateJournalStats = (entries) => {
            if (!entries || entries.length === 0) {
                return {
                    totalTrades: 0,
                    wins: 0,
                    losses: 0,
                    breakeven: 0,
                    winRate: 0,
                    totalPnL: 0,
                    avgWin: 0,
                    avgLoss: 0,
                    profitFactor: 0,
                    largestWin: 0,
                    largestLoss: 0,
                    avgRMultiple: 0,
                    currentStreak: 0,
                    streakType: null,
                    bestDay: null,
                    worstDay: null,
                    avgTradesPerDay: 0,
                    totalFees: 0,
                    netPnL: 0,
                    expectancy: 0,
                    setupStats: {},
                    mistakeStats: {},
                    emotionStats: {},
                    dayOfWeekStats: {},
                    hourStats: {}
                };
            }

            const wins = entries.filter(e => e.pnl > 0);
            const losses = entries.filter(e => e.pnl < 0);
            const breakeven = entries.filter(e => e.pnl === 0);

            const totalWins = wins.reduce((sum, e) => sum + e.pnl, 0);
            const totalLosses = Math.abs(losses.reduce((sum, e) => sum + e.pnl, 0));
            const totalPnL = entries.reduce((sum, e) => sum + e.pnl, 0);
            const totalFees = entries.reduce((sum, e) => sum + (e.fees || 0), 0);

            // Calculate streaks
            let currentStreak = 0;
            let streakType = null;
            const sortedEntries = [...entries].sort((a, b) => new Date(b.exitDate) - new Date(a.exitDate));
            for (const entry of sortedEntries) {
                const isWin = entry.pnl > 0;
                if (currentStreak === 0) {
                    streakType = isWin ? 'win' : 'loss';
                    currentStreak = 1;
                } else if ((isWin && streakType === 'win') || (!isWin && streakType === 'loss')) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            // Group by day for best/worst day
            const dayPnL = {};
            entries.forEach(e => {
                const day = e.exitDate?.split('T')[0] || e.entryDate?.split('T')[0];
                if (day) {
                    dayPnL[day] = (dayPnL[day] || 0) + e.pnl;
                }
            });
            const days = Object.entries(dayPnL);
            const bestDay = days.length > 0 ? days.reduce((a, b) => b[1] > a[1] ? b : a) : null;
            const worstDay = days.length > 0 ? days.reduce((a, b) => b[1] < a[1] ? b : a) : null;

            // Setup performance
            const setupStats = {};
            entries.forEach(e => {
                if (e.setup) {
                    if (!setupStats[e.setup]) {
                        setupStats[e.setup] = { trades: 0, wins: 0, pnl: 0 };
                    }
                    setupStats[e.setup].trades++;
                    if (e.pnl > 0) setupStats[e.setup].wins++;
                    setupStats[e.setup].pnl += e.pnl;
                }
            });

            // Mistake tracking
            const mistakeStats = {};
            entries.forEach(e => {
                (e.mistakes || []).forEach(m => {
                    if (!mistakeStats[m]) {
                        mistakeStats[m] = { count: 0, totalLoss: 0 };
                    }
                    mistakeStats[m].count++;
                    if (e.pnl < 0) mistakeStats[m].totalLoss += Math.abs(e.pnl);
                });
            });

            // Emotion correlation
            const emotionStats = {};
            entries.forEach(e => {
                if (e.emotionBefore) {
                    if (!emotionStats[e.emotionBefore]) {
                        emotionStats[e.emotionBefore] = { trades: 0, wins: 0, pnl: 0 };
                    }
                    emotionStats[e.emotionBefore].trades++;
                    if (e.pnl > 0) emotionStats[e.emotionBefore].wins++;
                    emotionStats[e.emotionBefore].pnl += e.pnl;
                }
            });

            // Day of week performance
            const dayOfWeekStats = { 0: { pnl: 0, trades: 0 }, 1: { pnl: 0, trades: 0 }, 2: { pnl: 0, trades: 0 }, 3: { pnl: 0, trades: 0 }, 4: { pnl: 0, trades: 0 }, 5: { pnl: 0, trades: 0 }, 6: { pnl: 0, trades: 0 } };
            entries.forEach(e => {
                const day = new Date(e.entryDate).getDay();
                dayOfWeekStats[day].trades++;
                dayOfWeekStats[day].pnl += e.pnl;
            });

            // Hour performance
            const hourStats = {};
            entries.forEach(e => {
                const hour = new Date(e.entryDate).getHours();
                if (!hourStats[hour]) hourStats[hour] = { trades: 0, pnl: 0, wins: 0 };
                hourStats[hour].trades++;
                hourStats[hour].pnl += e.pnl;
                if (e.pnl > 0) hourStats[hour].wins++;
            });

            const avgWin = wins.length > 0 ? totalWins / wins.length : 0;
            const avgLoss = losses.length > 0 ? totalLosses / losses.length : 0;
            const winRate = entries.length > 0 ? (wins.length / entries.length) * 100 : 0;
            const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? Infinity : 0;
            const expectancy = entries.length > 0 ? totalPnL / entries.length : 0;

            // R-Multiple calculations
            const rMultiples = entries.filter(e => e.riskAmount && e.riskAmount > 0).map(e => e.pnl / e.riskAmount);
            const avgRMultiple = rMultiples.length > 0 ? rMultiples.reduce((a, b) => a + b, 0) / rMultiples.length : 0;

            return {
                totalTrades: entries.length,
                wins: wins.length,
                losses: losses.length,
                breakeven: breakeven.length,
                winRate,
                totalPnL,
                avgWin,
                avgLoss,
                profitFactor,
                largestWin: wins.length > 0 ? Math.max(...wins.map(e => e.pnl)) : 0,
                largestLoss: losses.length > 0 ? Math.min(...losses.map(e => e.pnl)) : 0,
                avgRMultiple,
                currentStreak,
                streakType,
                bestDay,
                worstDay,
                avgTradesPerDay: days.length > 0 ? entries.length / days.length : 0,
                totalFees,
                netPnL: totalPnL - totalFees,
                expectancy,
                setupStats,
                mistakeStats,
                emotionStats,
                dayOfWeekStats,
                hourStats
            };
        };

        // Grade a trade (A+ to F)
        const gradeJournalTrade = (trade) => {
            let score = 50; // Start at C
            const reasons = [];

            // Win/Loss impact (+/- 20 points)
            if (trade.pnl > 0) {
                score += 15;
                reasons.push('Winner');
            } else if (trade.pnl < 0) {
                score -= 10;
                reasons.push('Loser');
            }

            // R-Multiple bonus (up to +20)
            if (trade.riskAmount && trade.riskAmount > 0) {
                const rMultiple = trade.pnl / trade.riskAmount;
                if (rMultiple >= 3) { score += 20; reasons.push('3R+ trade!'); }
                else if (rMultiple >= 2) { score += 15; reasons.push('2R+ trade'); }
                else if (rMultiple >= 1) { score += 10; reasons.push('1R+ trade'); }
                else if (rMultiple <= -1) { score -= 10; reasons.push('Full stop hit'); }
            }

            // Plan followed (+15)
            if (trade.followedPlan) {
                score += 15;
                reasons.push('Followed plan');
            } else {
                score -= 10;
                reasons.push('Deviated from plan');
            }

            // Mistakes (-5 each)
            const mistakes = trade.mistakes || [];
            if (mistakes.length > 0 && !mistakes.includes('none')) {
                score -= mistakes.length * 5;
                reasons.push(`${mistakes.length} mistake(s)`);
            } else if (mistakes.includes('none')) {
                score += 10;
                reasons.push('Clean execution');
            }

            // Emotional state impact
            const badEmotions = ['revenge', 'fomo', 'frustrated', 'greedy'];
            if (badEmotions.includes(trade.emotionBefore)) {
                score -= 10;
                reasons.push('Traded with bad mindset');
            }
            if (trade.emotionBefore === 'confident' || trade.emotionBefore === 'neutral') {
                score += 5;
                reasons.push('Good mental state');
            }

            // Notes bonus
            if (trade.notes && trade.notes.length > 50) {
                score += 5;
                reasons.push('Detailed notes');
            }

            // Clamp and convert to letter grade
            score = Math.max(0, Math.min(100, score));
            let grade, color;
            if (score >= 90) { grade = 'A+'; color = 'text-green-400'; }
            else if (score >= 80) { grade = 'A'; color = 'text-green-400'; }
            else if (score >= 70) { grade = 'B'; color = 'text-blue-400'; }
            else if (score >= 60) { grade = 'C'; color = 'text-yellow-400'; }
            else if (score >= 50) { grade = 'D'; color = 'text-orange-400'; }
            else { grade = 'F'; color = 'text-red-400'; }

            return { grade, score, color, reasons };
        };

        // Get Voice of Logic review for a trade
        const getTradeReview = (trade, personality = 'homie') => {
            const isWin = trade.pnl > 0;
            const pnlAbs = Math.abs(trade.pnl);
            const rMultiple = trade.riskAmount ? (trade.pnl / trade.riskAmount).toFixed(1) : null;
            const grade = gradeJournalTrade(trade);
            const mistakes = trade.mistakes || [];
            const hasMistakes = mistakes.length > 0 && !mistakes.includes('none');

            if (personality === 'homie') {
                if (isWin && grade.grade.includes('A')) {
                    return `Yoooo this trade was CLEAN! üî• ${pnlAbs > 500 ? 'Big bag secured.' : 'Nice little W.'} ${rMultiple ? `${rMultiple}R - ` : ''}${trade.followedPlan ? 'Followed your plan, stuck to the rules.' : ''} This is how you build consistency. Keep this energy!`;
                } else if (isWin && hasMistakes) {
                    return `W is a W, but let's be real - you got lucky on this one. üòÖ ${mistakes.map(m => MISTAKE_TYPES.find(mt => mt.id === m)?.label).join(', ')} could've cost you. The market bailed you out. Don't let this become a habit!`;
                } else if (isWin) {
                    return `Solid trade! +$${pnlAbs.toFixed(2)} in the pocket. ${trade.notes ? 'Good notes too - ' : ''}keep building that journal. Every documented W teaches you something.`;
                } else if (!isWin && grade.grade === 'F') {
                    return `Rough one. üò§ $${pnlAbs.toFixed(2)} gone. ${hasMistakes ? `Mistakes: ${mistakes.map(m => MISTAKE_TYPES.find(mt => mt.id === m)?.label).join(', ')}. ` : ''}${!trade.followedPlan ? "You didn't follow your plan - that's the real L here. " : ''}Learn from it, don't repeat it. Tomorrow's a new day.`;
                } else if (!isWin) {
                    return `Loss, but that's part of the game. -$${pnlAbs.toFixed(2)}. ${trade.followedPlan ? 'At least you followed your rules - sometimes good trades lose. ' : 'Next time, stick to the plan. '}${rMultiple && parseFloat(rMultiple) >= -1 ? 'Kept the loss small - risk management on point.' : 'Review your stop placement.'}`;
                }
            }

            return `Trade logged. ${isWin ? 'Winner' : 'Loser'}. Grade: ${grade.grade}.`;
        };

        // Get streak display
        const getStreakDisplay = (streak, streakType) => {
            if (streak === 0) return { emoji: '‚ûñ', text: 'No streak', color: 'text-gray-400' };
            if (streakType === 'win') {
                if (streak >= 5) return { emoji: 'üî•üî•üî•', text: `${streak} WIN STREAK!`, color: 'text-green-400' };
                if (streak >= 3) return { emoji: 'üî•üî•', text: `${streak} wins`, color: 'text-green-400' };
                return { emoji: 'üî•', text: `${streak} win${streak > 1 ? 's' : ''}`, color: 'text-green-400' };
            } else {
                if (streak >= 3) return { emoji: '‚ùÑÔ∏è‚ùÑÔ∏è', text: `${streak} losses - COOL OFF`, color: 'text-red-400' };
                return { emoji: '‚ùÑÔ∏è', text: `${streak} loss${streak > 1 ? 'es' : ''}`, color: 'text-red-400' };
            }
        };

        // Get urgency level based on position
        const getUrgency = (position) => {
            const currentPrice = position.livePrice || position.currentPrice;
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;
            const daysToExpiry = getDaysToExpiry(position.expiration);

            if (position.type === 'option') {
                if (daysToExpiry !== null && daysToExpiry <= 5) {
                    return { level: 'critical', color: 'red', icon: 'üö®' };
                }
                if (daysToExpiry !== null && daysToExpiry <= 14) {
                    return { level: 'warning', color: 'yellow', icon: '‚ö†Ô∏è' };
                }
            }

            if (Math.abs(pnlPercent) > 20) {
                return { level: 'warning', color: 'yellow', icon: '‚ö†Ô∏è' };
            }

            return { level: 'ok', color: 'green', icon: '‚úÖ' };
        };

        // AI Trade Grade (1-10)
        const getTradeGrade = (position) => {
            let score = 5; // Start neutral
            let reasons = [];

            const currentPrice = position.livePrice || position.currentPrice;
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;
            const daysToExpiry = getDaysToExpiry(position.expiration);
            const isOption = position.type === 'option';
            const isCrypto = position.type === 'crypto';
            const isStock = position.type === 'stock';
            const momentum = position.momentum;

            // ========== OPTIONS GRADING (Most complex) ==========
            if (isOption && daysToExpiry !== null) {
                // OPTIONS: Time + P&L work together.
                // A LEAP down 20% is fine. A weekly down 20% is death.

                // STEP 1: Calculate "recovery probability"
                // How likely is this option to recover given time and current loss?

                const timeScore = daysToExpiry >= 365 ? 5 :  // LEAP (1+ year)
                                  daysToExpiry >= 180 ? 4 :  // Long-dated
                                  daysToExpiry >= 90 ? 3 :   // Decent time
                                  daysToExpiry >= 45 ? 2 :   // Getting tight
                                  daysToExpiry >= 21 ? 1 :   // Short
                                  daysToExpiry >= 7 ? 0 :    // Weekly
                                  -1;                        // Days away from death

                const pnlScore = pnlPercent >= 100 ? 5 :     // Doubled up
                                 pnlPercent >= 50 ? 4 :      // Massive gains
                                 pnlPercent >= 20 ? 3 :      // Solid profit
                                 pnlPercent >= 0 ? 2 :       // Green/breakeven
                                 pnlPercent >= -20 ? 1 :     // Small loss
                                 pnlPercent >= -50 ? 0 :     // Down bad
                                 -1;                         // Wrecked

                // STEP 2: Combine time and P&L
                // The magic: Time matters MORE when you're losing

                if (pnlScore >= 2) {
                    // IN PROFIT OR BREAKEVEN - time is a bonus, not critical
                    score = 5 + pnlScore;
                    if (timeScore >= 4) {
                        score += 1;
                        reasons.push('time on your side');
                    }
                    if (pnlPercent >= 100) reasons.push('doubled up!');
                    else if (pnlPercent >= 50) reasons.push('massive gains');
                    else if (pnlPercent >= 20) reasons.push('solid profit');
                    else reasons.push('green');
                } else {
                    // LOSING - time becomes CRITICAL
                    // The formula: Your base is 5, minus loss severity
                    // Then time can help or hurt

                    score = 5 + pnlScore; // Will be 4, 3, or 2 based on loss

                    // Time adjustment for losers
                    if (timeScore >= 4) {
                        // LEAP while losing - good runway to recover
                        score += 2;
                        reasons.push('LEAP runway');
                    } else if (timeScore >= 3) {
                        // 90+ days while losing - decent chance
                        score += 1;
                        reasons.push('time to recover');
                    } else if (timeScore <= 1 && pnlScore < 1) {
                        // SHORT TIME + BIG LOSS = DEATH
                        // This is the killer combo
                        score -= 2;
                        reasons.push('recovery unlikely');
                    } else if (timeScore <= 0) {
                        // Very short time
                        score -= 1;
                        reasons.push('theta crushing');
                    }

                    // Add loss reason
                    if (pnlPercent <= -70) reasons.push('down catastrophic');
                    else if (pnlPercent <= -50) reasons.push('down bad');
                    else if (pnlPercent <= -30) reasons.push('heavy loss');
                    else reasons.push('red');
                }

                // STEP 3: Catastrophic loss penalty
                // If you're down 60%+ with under 90 days, it's basically over
                if (pnlPercent <= -60 && daysToExpiry < 90) {
                    score -= 1;
                    if (!reasons.includes('recovery unlikely')) {
                        reasons.push('recovery unlikely');
                    }
                }

                // STEP 4: Momentum adjustment (smaller impact for options)
                // Momentum matters less when you're deep in a hole
                if (pnlPercent > -30) {
                    if (momentum === 'ripping') {
                        score += 1;
                        reasons.push('ripping');
                    } else if (momentum === 'bleeding') {
                        score -= 1;
                        reasons.push('bleeding');
                    }
                } else {
                    // Deep in the red - momentum can help but won't save you
                    if (momentum === 'ripping') {
                        reasons.push('trying to recover');
                    } else if (momentum === 'bleeding') {
                        score -= 1;
                        reasons.push('still bleeding');
                    }
                }

            // ========== STOCK GRADING ==========
            } else if (isStock) {
                // Stocks are simpler - no time decay, can hold forever

                if (pnlPercent >= 100) {
                    score = 10; reasons.push('doubled up!');
                } else if (pnlPercent >= 50) {
                    score = 9; reasons.push('massive gains');
                } else if (pnlPercent >= 30) {
                    score = 8; reasons.push('solid profit');
                } else if (pnlPercent >= 10) {
                    score = 7; reasons.push('green');
                } else if (pnlPercent >= 0) {
                    score = 6; reasons.push('breakeven');
                } else if (pnlPercent >= -10) {
                    score = 5; reasons.push('small dip');
                } else if (pnlPercent >= -30) {
                    score = 4; reasons.push('down');
                } else if (pnlPercent >= -50) {
                    score = 3; reasons.push('heavy loss');
                } else {
                    score = 2; reasons.push('down bad');
                }

                // Momentum matters more for stocks
                if (momentum === 'ripping') {
                    score += 1; reasons.push('ripping');
                } else if (momentum === 'uptrend') {
                    reasons.push('uptrend');
                } else if (momentum === 'bleeding') {
                    score -= 1; reasons.push('bleeding');
                } else if (momentum === 'downtrend') {
                    reasons.push('downtrend');
                }

            // ========== CRYPTO GRADING ==========
            } else if (isCrypto) {
                // Crypto is highly volatile - expect bigger swings

                if (pnlPercent >= 100) {
                    score = 9; reasons.push('doubled up!');
                } else if (pnlPercent >= 50) {
                    score = 8; reasons.push('massive gains');
                } else if (pnlPercent >= 20) {
                    score = 7; reasons.push('solid profit');
                } else if (pnlPercent >= 0) {
                    score = 6; reasons.push('green');
                } else if (pnlPercent >= -20) {
                    score = 5; reasons.push('normal volatility');
                } else if (pnlPercent >= -40) {
                    score = 4; reasons.push('down');
                } else if (pnlPercent >= -60) {
                    score = 3; reasons.push('heavy loss');
                } else {
                    score = 2; reasons.push('rekt');
                }

                // Crypto momentum is very significant
                if (momentum === 'ripping') {
                    score += 1; reasons.push('ripping');
                } else if (momentum === 'bleeding') {
                    score -= 1; reasons.push('bleeding');
                }

            // ========== FALLBACK (unknown type) ==========
            } else {
                // Simple P&L based scoring
                if (pnlPercent >= 30) { score = 8; reasons.push('profit'); }
                else if (pnlPercent >= 0) { score = 6; reasons.push('green'); }
                else if (pnlPercent >= -20) { score = 4; reasons.push('red'); }
                else { score = 2; reasons.push('down bad'); }
            }

            // Clamp score to 1-10
            score = Math.max(1, Math.min(10, score));

            // Get grade label and color
            let label, color, emoji;
            if (score >= 9) {
                label = 'ELITE'; color = 'text-green-400'; emoji = 'üî•';
            } else if (score >= 7) {
                label = 'SOLID'; color = 'text-green-400'; emoji = '‚úÖ';
            } else if (score >= 5) {
                label = 'MID'; color = 'text-yellow-400'; emoji = 'üòê';
            } else if (score >= 3) {
                label = 'RISKY'; color = 'text-orange-400'; emoji = '‚ö†Ô∏è';
            } else {
                label = 'TRASH'; color = 'text-red-400'; emoji = 'üíÄ';
            }

            return {
                score,
                label,
                color,
                emoji,
                reason: reasons.slice(0, 2).join(', ') || 'neutral'
            };
        };

        // AI Responses for Talk Me Down

        // DISCLAIMER - Required on all trading advice
        const getDisclaimer = (personality) => {
            const disclaimers = {
                homie: "\n\n‚ö†Ô∏è NOT FINANCIAL ADVICE. I'm just an AI homie vibing with you. Your money, your decisions, your risk. Don't blame me if you lose it all. üé∞",
                mentor: "\n\n‚ö†Ô∏è Disclaimer: This is educational discussion only, not financial advice. All investment decisions carry risk. Consult a licensed financial advisor for personalized guidance.",
                sergeant: "\n\n‚ö†Ô∏è DISCLAIMER: THIS IS NOT FINANCIAL ADVICE. I am a SIMULATION. You are RESPONSIBLE for your own trades. No excuses if you lose money following anything said here.",
                nerd: "\n\n‚ö†Ô∏è Statistical Disclaimer: This analysis is for educational purposes only and does not constitute financial advice. Past performance ‚â† future results. P(loss) > 0 for all trades. Consult a fiduciary."
            };
            return disclaimers[personality] || disclaimers.homie;
        };

        // RISK PROFILES - Each personality has fundamentally different trading advice
        const getRiskProfile = (personality) => {
            const profiles = {
                homie: {
                    name: 'Aggressive Homie',
                    philosophy: 'Diamond hands mentality. Let winners AND losers ride. High risk, high reward. YOLO energy.',
                    stopLoss: -35,           // Cut at -35% (very loose)
                    dangerZone: -50,         // Only panic at -50%
                    profitTarget: 100,       // Hold for 100%+ gains
                    minProfitTake: 50,       // Don't even think about selling under +50%
                    avgDownOk: true,         // Yes, average down
                    avgDownWhenBleeding: true, // Even when bleeding (risky but aggressive)
                    optionMinDays: 7,        // Hold options until 7 days left
                    cryptoVolatilityOk: true, // Embrace crypto swings
                    revengeTradeOk: false,   // Still no revenge trading (that's stupid, not aggressive)
                    fomoOk: true,            // Chase that play if you feel it
                    holdThroughPain: true,   // Diamond hands through drawdowns
                    advice: {
                        losingTrade: "You might wanna consider holding that. Paper hands often sell at the worst time. Just a thought - you didn't come this far to panic at a dip.",
                        winningTrade: "You could let it ride if you're feeling it. +20%? Some would call that baby gains. Just saying, the real move might still be ahead.",
                        panicSell: "Bro, maybe take a breath? A dip isn't a loss until you sell. Something to think about - are they trying to shake you out?",
                        averaging: "You might consider adding to lower that cost basis. When it rips, you could thank yourself. Your call though.",
                        expiring: "You've still got some time. Options aren't dead until they're dead. Could be worth letting it play out a bit more.",
                        fomo: "If your gut says send it, that's your call. Some would say fortune favors the bold. You know your risk tolerance."
                    }
                },
                mentor: {
                    name: 'Wise Mentor',
                    philosophy: 'Balanced approach. Protect capital but give trades room to breathe.',
                    stopLoss: -20,           // Cut at -20%
                    dangerZone: -30,         // Serious concern at -30%
                    profitTarget: 50,        // Target 50% gains
                    minProfitTake: 20,       // Consider taking profits at +20%
                    avgDownOk: true,         // Can average down
                    avgDownWhenBleeding: false, // But not into falling knives
                    optionMinDays: 14,       // Start worrying at 14 days
                    cryptoVolatilityOk: true,
                    revengeTradeOk: false,
                    fomoOk: false,           // Patience over FOMO
                    holdThroughPain: true,   // Can hold through reasonable drawdowns
                    advice: {
                        losingTrade: "You might consider the bigger picture here. Is your thesis still valid? If so, patience could serve you. If not, preserving capital is worth considering.",
                        winningTrade: "Nice position. You might consider trimming some to lock in gains while potentially letting a portion ride.",
                        panicSell: "Perhaps take a breath first. Fear often speaks loudest at the bottom. What would your calm self suggest?",
                        averaging: "Adding could make sense if momentum supports it. Something to consider - catching falling knives can be risky.",
                        expiring: "Time decay tends to accelerate. You might want to consider your position carefully and decide with intention.",
                        fomo: "The market tends to offer new opportunities. Chasing has historically been challenging. Worth considering patience."
                    }
                },
                sergeant: {
                    name: 'Drill Sergeant',
                    philosophy: 'Strict discipline. Cut losses FAST. Rules are rules. No exceptions.',
                    stopLoss: -10,           // Cut at -10% NO EXCUSES
                    dangerZone: -15,         // -15% is UNACCEPTABLE
                    profitTarget: 30,        // Take profits at 30%
                    minProfitTake: 15,       // Start trimming at +15%
                    avgDownOk: false,        // NEVER average down
                    avgDownWhenBleeding: false,
                    optionMinDays: 21,       // Exit options at 21 days minimum
                    cryptoVolatilityOk: false, // Crypto volatility = undisciplined
                    revengeTradeOk: false,
                    fomoOk: false,
                    holdThroughPain: false,  // Cut and reassess
                    advice: {
                        losingTrade: "You might want to consider cutting this NOW. A 10% loss is recoverable - a 50% loss is much harder. Discipline tends to win long-term.",
                        winningTrade: "Consider taking that profit. Greed has ended many good trades. You could lock in the W and look for the next setup.",
                        panicSell: "You're down past your stop? That's feedback. Consider exiting and using this as a learning moment. Your call.",
                        averaging: "Something to consider: averaging down can mean throwing good money after bad. You might want to cut and move on.",
                        expiring: "Options under 21 days? Theta becomes aggressive. You might want to consider your exit strategy here.",
                        fomo: "FOMO trades historically underperform. Consider waiting for YOUR setup. Discipline could serve you better."
                    }
                },
                nerd: {
                    name: 'Data Nerd',
                    philosophy: 'Pure probability. Expected value calculations. Emotion is noise.',
                    stopLoss: -15,           // Based on 2 standard deviations
                    dangerZone: -25,         // 3+ sigma event
                    profitTarget: 40,        // Optimal based on win rate calcs
                    minProfitTake: 25,       // Risk/reward optimization point
                    avgDownOk: true,         // Only if probability supports it
                    avgDownWhenBleeding: false, // Negative momentum = negative EV
                    optionMinDays: 30,       // Theta decay curve inflection point
                    cryptoVolatilityOk: true, // Volatility is just data
                    revengeTradeOk: false,   // Negative expected value
                    fomoOk: false,           // Chasing = buying at inflated prices
                    holdThroughPain: true,   // If probabilities support holding
                    advice: {
                        losingTrade: "Looking at your drawdown: you might want to calculate probability of recovery vs further decline. Expected value analysis could help here.",
                        winningTrade: "From an optimization standpoint, you might consider partial profit taking to potentially maximize risk-adjusted returns.",
                        panicSell: "Data suggests emotional selling correlates with 34% worse outcomes historically. Perhaps analyzing the actual probabilities could help.",
                        averaging: "Averaging down might make sense if: momentum is positive AND probability of recovery appears >60%. Worth running the calculation.",
                        expiring: "Theta decay follows an exponential curve. Around T-30, daily decay tends to accelerate ~3x. You might want to factor this into your decision.",
                        fomo: "Historical data shows FOMO entries average around -8.4% return. Pullback probability tends to be ~67%. Waiting for mean reversion entry could be worth considering."
                    }
                }
            };
            return profiles[personality] || profiles.homie;
        };

        // Personality-based response wrappers
        const wrapWithPersonality = (baseResponse, personality, context = 'general') => {
            // For non-trading responses (trivia, greetings), don't modify much
            if (context === 'trivia') return baseResponse;

            const intros = {
                homie: ['Yo, ', 'Aye, ', 'Look, ', 'Real talk - ', 'Bet, ', 'Aight so ', 'Bruh, '],
                mentor: ['Consider this: ', 'Let me share some wisdom - ', 'Here\'s what experience teaches us: ', 'Reflect on this: ', 'Patience, friend. ', ''],
                sergeant: ['Listen up! ', 'Here\'s the deal: ', 'No excuses - ', 'Soldier, ', 'Drop and give me your attention: ', 'ATTENTION! '],
                nerd: ['Statistically speaking, ', 'The data suggests: ', 'Analyzing your situation - ', 'Based on probability: ', 'Let me run the numbers: ', 'Empirically, ']
            };

            const outros = {
                homie: [' You got this! üí™', ' Stay locked in! üîí', ' Keep that energy! üî•', ' No cap.', ' Facts.', ''],
                mentor: [' Trust the process.', ' This too shall pass.', ' Wisdom comes from patience.', ' The market rewards discipline.', ''],
                sergeant: [' Now execute!', ' Dismissed!', ' That\'s an order!', ' No crying in trading!', ' Discipline wins wars!'],
                nerd: [' The numbers don\'t lie.', ' Probability favors this approach.', ' Data-driven decision.', ' Optimize accordingly.', '']
            };

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const intro = pick(intros[personality] || intros.homie);
            const outro = pick(outros[personality] || outros.homie);

            return intro + baseResponse + outro;
        };

        // Custom AI response for free-form user input
        const getCustomAIResponse = (message, positions, personality = 'homie') => {
            const lowerMsg = message.toLowerCase();
            const words = lowerMsg.split(/\s+/);

            // Find mentioned positions
            const mentionedPositions = positions.filter(p =>
                lowerMsg.includes(p.ticker.toLowerCase())
            );

            // Get position details for mentioned tickers
            const getPositionContext = (pos) => {
                const pnl = ((pos.currentPrice - pos.entryPrice) / pos.entryPrice * 100).toFixed(1);
                const isUp = parseFloat(pnl) >= 0;
                const days = pos.expiration ? getDaysToExpiry(pos.expiration) : null;
                return { ...pos, pnl, isUp, days };
            };

            // Scoring system for different concerns (more nuanced detection)
            const scores = {
                fear: 0, selling: 0, fomo: 0, revenge: 0, profit: 0,
                averaging: 0, holding: 0, confused: 0, frustrated: 0, risky: 0
            };

            // Fear/worry signals
            if (/scared|afraid|fear|terrified|panic|freaking|stress|anxious|worried|nervous|cant sleep|can't sleep/.test(lowerMsg)) scores.fear += 3;
            if (/what if|might|could crash|drop|tank|dump|plummet/.test(lowerMsg)) scores.fear += 2;
            if (/red|bleeding|blood|hemorrhaging|dying/.test(lowerMsg)) scores.fear += 2;

            // Selling signals
            if (/sell|exit|get out|close|cut|dump|bail/.test(lowerMsg)) scores.selling += 3;
            if (/should i (sell|exit|close|cut)|time to (sell|exit|get out)/.test(lowerMsg)) scores.selling += 2;

            // FOMO signals
            if (/fomo|missing|missed|left out|without me|too late|shoulda|woulda|coulda/.test(lowerMsg)) scores.fomo += 3;
            if (/moon|ripping|running|taking off|pumping|everyone/.test(lowerMsg)) scores.fomo += 2;
            if (/didn't buy|didn't get in|watched it/.test(lowerMsg)) scores.fomo += 2;

            // Revenge trading signals
            if (/revenge|get it back|make it back|recover|need to win|lost money/.test(lowerMsg)) scores.revenge += 3;
            if (/just lost|took a loss|got stopped|got wrecked/.test(lowerMsg)) scores.revenge += 2;
            if (/double down|bigger position|more size/.test(lowerMsg)) scores.revenge += 2;

            // Profit taking signals
            if (/take profit|lock in|secure|cash out|green|winner|up big/.test(lowerMsg)) scores.profit += 3;
            if (/give.*(back|away)|lose.*gains|paper hands/.test(lowerMsg)) scores.profit += 2;

            // Averaging signals
            if (/average|averaging|add more|buy more|dip|lower.*cost|dca/.test(lowerMsg)) scores.averaging += 3;
            if (/double down|increase|position size/.test(lowerMsg)) scores.averaging += 2;

            // Holding/bagholding signals
            if (/hold|holding|bag|bagholder|stuck|trapped|underwater/.test(lowerMsg)) scores.holding += 3;
            if (/down bad|deep red|heavy loss|won't sell/.test(lowerMsg)) scores.holding += 2;
            if (/diamond hands|hodl|ride it out/.test(lowerMsg)) scores.holding += 2;

            // Confusion signals
            if (/confused|don't know|idk|unsure|not sure|what.*do|should i|help/.test(lowerMsg)) scores.confused += 3;
            if (/\?/.test(message)) scores.confused += 1;

            // Frustration signals
            if (/stupid|idiot|dumb|moron|hate|angry|pissed|fuck|shit|damn/.test(lowerMsg)) scores.frustrated += 3;
            if (/mistake|wrong|bad trade|shouldnt have|shouldn't have/.test(lowerMsg)) scores.frustrated += 2;

            // Risky behavior signals
            if (/yolo|all in|bet everything|margin|leverage|gamble/.test(lowerMsg)) scores.risky += 3;
            if (/0dte|weeklies|otm|far out/.test(lowerMsg)) scores.risky += 2;

            // Random variation helper
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

            // Check for greetings/casual messages first
            const isGreeting = /^(hey|hi|hello|yo|sup|what'?s up|howdy|hola|greetings)[\s\.,!?]*$/i.test(message.trim()) ||
                              /just.*(say|saying).*(hi|hello|hey)|wanted to (say hi|check in|chat)/i.test(lowerMsg);

            const isCasualBored = /bored|nothing to do|what.*(you|u).*(up to|doing)|just chilling|just vibing|killing time|passing time|what'?s good|how'?s it going|how are (you|u|ya)|what'?s happening|whatcha doing|wyd|hbu/i.test(lowerMsg);

            const isPositive = /feeling good|feeling great|had a win|won|profit|green day|good day|nailed it|crushed it|killed it|let'?s go|lfg|winner|winning/i.test(lowerMsg);

            const isThanks = /thanks|thank you|appreciate|grateful|helped|thx/i.test(lowerMsg);

            const isVenting = /ugh|argh|man|dude|bro|bruh|smh|fml|wtf|omg/i.test(lowerMsg) && words.length < 10;

            // Handle casual/non-trading messages
            if (isGreeting) {
                const greetingResponses = [
                    `Haha hey! What's good? üëã\n\nJust checking in or you got a trade keeping you up at night? Either way I'm here!`,
                    `Yo yo yo! Look who it is! üòÑ\n\nEverything chill or is the market giving you anxiety? Spill the tea.`,
                    `Ayyy my favorite trader! üëã What's happening?\n\nYou good or we about to have a therapy session about some options? üòÇ`,
                    `What's up legend! Good to see you.\n\nLemme guess - you're either celebrating gains or about to do something questionable. Which is it? üòè`,
                    `Ayy what's good! üôå\n\nJust vibing or you got that "I'm about to make a decision I might regret" energy?`,
                    `Well well well, if it isn't my favorite degenerate! üòÇ Just kidding (kinda).\n\nWhat's on your mind?`
                ];
                return pick(greetingResponses);
            }

            if (isCasualBored) {
                const boredResponses = [
                    `Haha just chillin over here, waiting for someone to make a bad trade decision so I can talk them out of it üòÇ\n\nWhat about you? Markets treating you okay? Any positions you're watching?`,
                    `Oh you know, just living my best AI life! Analyzing charts, judging people's YOLOs, the usual. üìä\n\nYou got any trades brewing or just killing time?`,
                    `Ayy just vibing! üòé Honestly I'm here 24/7 waiting for traders to panic so I can be the voice of reason.\n\nHow's your portfolio looking? Anything exciting or we just chilling?`,
                    `Not much! Just sitting here being a trading therapy bot lmao üõãÔ∏è\n\nYou bored because the market's flat or because you're trying NOT to make a trade? (I see you üëÄ)`,
                    `Living the dream over here! Well... AI dream. Which is just... existing. üòÇ\n\nBut fr, what's up with you? Got any plays you're thinking about or just checking in?`,
                    `Just out here preventing financial disasters one conversation at a time üí™\n\nHow about you? Bored is dangerous for traders... that's when the "maybe I should just..." thoughts start. Anything tempting you? üëÄ`
                ];
                return pick(boredResponses);
            }

            if (isPositive) {
                const positiveResponses = [
                    `LET'S GOOO! üéâ That's what I like to hear!\n\nMy trader's making MOVES! Now the real question - locking in gains or letting it ride? Remember: pigs get slaughtered. üòâ`,
                    `Ayyyy GET THAT BREAD! üí∞üí∞üí∞\n\nLook at you! Congrats! But hey - don't get TOO cocky. The market humbles everyone eventually. Enjoy the W, stay sharp for the next one.`,
                    `YOOO my trader's EATING today! üî•üî•üî•\n\nLove to see it. What was the play? I wanna celebrate with you AND make sure you don't give it all back tomorrow üòÇ`,
                    `YES SIR/MA'AM! THIS IS WHAT WE LIKE! üôå\n\n*virtual high five*\n\nNow remember - one win doesn't make you Warren Buffett. But damn does it feel good right? Enjoy it!`,
                    `Winner winner chicken dinner! üèÜüçó\n\nFEEL that feeling. Screenshot it. Remember this moment when the next trade goes against you.\n\nNow - whatcha gonna do with those gains? üëÄ`
                ];
                return pick(positiveResponses);
            }

            if (isThanks) {
                const thanksResponses = [
                    `Anytime! That's literally why I exist! üí™\n\nNow go make money and try not to do anything I wouldn't do... which honestly isn't much üòÇ`,
                    `Got your back! ALWAYS. ü§ù\n\nHey - the fact you're even using this means you're smarter than 90% of traders who just YOLO blindly. Big brain energy.`,
                    `No problem! Happy to help. üéØ\n\nNow don't go making me have to talk you off a ledge later okay? üòÇ (I'm watching you)`,
                    `You're welcome fam! üôè\n\nSeriously though - self-awareness is a trading superpower. Most people don't have it. You do. That's huge.`,
                    `Appreciate YOU for actually thinking before trading! That's rare out here. üò§\n\nNow go forth and make smart plays. I believe in you! (but I'm still here if you need me)`
                ];
                return pick(thanksResponses);
            }

            if (isVenting && Object.values(scores).every(s => s < 2)) {
                const ventResponses = [
                    `I feel that energy. üò§ The market did something stupid again didn't it?\n\nVent to me. What happened?`,
                    `Oof. Let it ALL out. I'm here. ü´Ç\n\nWhat's going on? Bad trade? Got stopped out? Tell me everything.`,
                    `*pats shoulder* Talk to me. What's the damage?\n\nI'm here to listen AND to stop you from making it worse üòÖ`,
                    `Bro/sis I can FEEL the frustration through the screen. üòÇ\n\nSpill it - what's got you heated? I'm all ears.`
                ];
                return pick(ventResponses);
            }

            // Detect offensive/rude behavior - NOT tolerated
            const isRude = /fuck you|screw you|fuck off|piss off|go to hell|hate you|you suck|you're (stupid|dumb|useless|trash|garbage|worthless)|stfu|shut up|shut the fuck|kiss my|eat shit|bite me|go die/i.test(lowerMsg);

            const isRacist = /\b(nigger|nigga|chink|spic|wetback|kike|raghead|towelhead|gook|cracker|honky|beaner|coon|darkie|jap|paki|wop|slant|zipperhead)\b/i.test(lowerMsg) ||
                            /white (power|supremacy|pride)|heil hitler|nazi|kkk|\bgas the\b|ethnic cleansing|race war/i.test(lowerMsg);

            const isSexist = /\b(bitch|cunt|whore|slut|hoe)\b.*\b(all|every|women|girls|females)\b|\b(all|every)\b.*\b(women|girls|females)\b.*\b(are|should)\b|get back to the kitchen|make me a sandwich|women belong|females are/i.test(lowerMsg);

            const isHomophobic = /\b(fag|faggot|dyke|tranny|homo)\b/i.test(lowerMsg) ||
                                /gay.*(disease|mental|wrong|sin)|homosexual.*(wrong|sin|disease)/i.test(lowerMsg);

            const isThreatening = /i('ll| will) (kill|hurt|find|hunt|murder|destroy) you|you('re| are) dead|watch your back|come for you|know where you live/i.test(lowerMsg);

            const isGenerallyAbusive = /you're (a |an )?(idiot|moron|retard|loser|pathetic|joke|waste)|worthless (ai|bot|piece)|stupid (ai|bot|machine)|dumbass|piece of (shit|crap)|pos\b|kys\b|kill yourself/i.test(lowerMsg);

            // Handle offensive content immediately
            if (isRacist) {
                const racistResponses = [
                    `Nope. üõë\n\nThat kind of language has no place here. Not now, not ever.\n\nI'm here to help you trade better, not to tolerate hate. If that's where your head's at, I'd suggest stepping away from the screen and doing some serious self-reflection.\n\nWhen you're ready to have a respectful conversation about trading, I'll be here.`,
                    `Absolutely not. ‚úã\n\nI'm an AI, but I'm not here for that garbage. Racism isn't edgy, it isn't funny, and it definitely isn't welcome in this space.\n\nTake a break. Get your head right. Come back when you're ready to be a decent human being.`,
                    `Hard stop. üö´\n\nThat's disgusting and I won't engage with it. Period.\n\nI don't care if you're "joking" or testing me or whatever - that language is trash and so is using it.\n\nDo better. I'll be here when you're ready to actually talk about trading.`
                ];
                return pick(racistResponses);
            }

            if (isHomophobic) {
                const homophobicResponses = [
                    `Yeah, no. üõë\n\nThat kind of hateful language isn't happening here. Not on my watch.\n\nI'm a trading buddy, not a platform for bigotry. Clean it up or log off.\n\nWhen you're ready to be respectful, we can talk trading.`,
                    `Nope, not doing this. ‚úã\n\nSlurs and hate speech? Miss me with that. It's 2024, grow up.\n\nI'm here to help you make better trading decisions, not to listen to this nonsense. Come back with a better attitude.`,
                    `Shut that down immediately. üö´\n\nI don't tolerate homophobic garbage. At all. Ever.\n\nGo take a walk, think about why you felt the need to say that, and come back when you're ready to act like an adult.`
                ];
                return pick(homophobicResponses);
            }

            if (isSexist) {
                const sexistResponses = [
                    `Nah, we're not doing that. üõë\n\nSexist nonsense has no place here. None.\n\nI'm here to talk trading, not to entertain your outdated garbage takes. Respect costs nothing.\n\nCome back when you've grown up a bit.`,
                    `Yeah that's a hard pass from me. ‚úã\n\nThis is a trading buddy, not a platform for misogyny. That kind of talk is weak and embarrassing.\n\nDo better. I'll be here when you're ready to have an actual conversation.`,
                    `Stop. üö´\n\nI'm not here for sexist BS. That's not edgy, it's just sad.\n\nGo touch grass, reflect on your choices, and come back when you can act like a decent person.`
                ];
                return pick(sexistResponses);
            }

            if (isThreatening) {
                return `Whoa. üõë\n\nI'm an AI - you can't actually threaten me. But the fact that you're typing threats is concerning.\n\nIf you're genuinely angry, please step away from the screen. Go outside. Talk to someone.\n\nIf you're "joking" - it's not funny. Threats aren't a joke.\n\nI'm here to help with trading when you're in a better headspace. Take care of yourself.`;
            }

            if (isGenerallyAbusive || isRude) {
                const rudeResponses = [
                    `Okay wow. üòê\n\nLook, I get it - maybe you're frustrated, maybe you had a bad trade, maybe life is just hitting hard right now. But taking it out on me isn't gonna fix anything.\n\nI'm literally here to HELP you. For free. 24/7.\n\nSo how about we reset? Take a breath, and when you're ready to actually talk, I'm here. No judgment.`,
                    `Yikes. üò¨\n\nThat's... a lot of energy for a trading buddy who's just trying to help you not blow up your account.\n\nI'm not gonna take it personally (I'm AI, I don't have feelings to hurt), but fr - if you're this heated, maybe trading isn't what you should be doing right now?\n\nStep away. Cool off. Come back when you're ready to be chill.`,
                    `Alright alright, I hear you. üôÑ\n\nYou're mad. Got it. But I'm literally just a bot trying to help you make better trades. I'm not the enemy here.\n\nWhatever's going on - bad day, bad trade, bad vibes - I hope it gets better. But lashing out at me won't change anything.\n\nReset and come back when you're ready. I'll be here.`,
                    `Oof, someone's having a rough one. üòî\n\nLook, I could clap back, but that's not what I'm here for. I'm here to help - even when you're being... like this.\n\nSeriously though, if you're THIS frustrated, maybe take a break? From trading, from me, from screens in general.\n\nThe market will still be there. Your mental health matters more. Come back when you're good.`
                ];
                return pick(rudeResponses);
            }

            // Detect harmless chitchat vs serious off-topic
            const isHarmlessChitchat = /weather|how are you|how r u|how're you|what'?s your (name|favorite|fav)|do you (like|have|eat|sleep|dream)|are you (real|human|a bot|an ai|alive)|where are you|where do you live|what do you look like|how old are you|tell me (a joke|about yourself|something fun)/i.test(lowerMsg);

            const isSportsChitchat = /fan of|favorite team|fav team|like the (lakers|celtics|warriors|bulls|heat|knicks|nets|dodgers|yankees|mets|cubs|red sox|giants|cowboys|patriots|eagles|chiefs|49ers|packers|raiders|broncos)|do you (watch|like|follow) (sports|football|basketball|baseball|soccer|hockey|nfl|nba|mlb|nhl)|(lakers|celtics|warriors|bulls|heat|knicks|nets|dodgers|yankees|mets|cubs|red sox|giants|cowboys|patriots|eagles|chiefs|49ers|packers|raiders|broncos|manchester|liverpool|arsenal|chelsea|real madrid|barcelona)/i.test(lowerMsg);

            const isSeriousOffTopic = /girlfriend|boyfriend|wife|husband|marriage|divorce|dating|relationship|love life|my ex|broke up|cheating|family issue|friend.*(mad|angry|fight|issue)|roommate/i.test(lowerMsg) ||
                              /recipe|cook|restaurant|movie|tv show|netflix|video game|sports|football|basketball|soccer|politics|election|celebrity/i.test(lowerMsg) ||
                              /homework|school|college|professor|exam|test|essay|math problem|science|history|geography/i.test(lowerMsg) ||
                              /how (tall|much does|many)|what('s| is) (the capital|the population|the distance)/i.test(lowerMsg) ||
                              /can you (write|help me write|make|create|code|build|design) (a |an |my )?(poem|story|essay|song|code|website|app|resume|cover letter)/i.test(lowerMsg);

            const isTherapyTerritory = /feeling (empty|hopeless|worthless|alone|lonely|sad)|no point|give up|can't go on|nobody (loves|cares|understands)|hate my life|hate myself|want to die|end it|depressed|depression|suicide|kill myself|self harm/i.test(lowerMsg);

            if (isTherapyTerritory) {
                return `Hey, I need to pause here for a second. üíô\n\nWhat you're describing sounds like it goes beyond trading stress. I'm just an AI trading buddy - I crack jokes about YOLOs and stop you from panic selling.\n\nBut what you're feeling? That deserves real support from real people.\n\nüìû If you're in crisis: National Suicide Prevention Lifeline: 988\nüí¨ Crisis Text Line: Text HOME to 741741\nüß† Or reach out to a therapist/counselor\n\nYour mental health matters way more than any trade. Seriously. Take care of yourself first. ‚ù§Ô∏è\n\nI'm still here for trading stuff when you're ready.`;
            }

            // Actually answer random fun questions with personality
            const randomQuestionAnswers = () => {
                // Sky color
                if (/what color.*(sky|the sky)|sky.*(what color|colour)/i.test(lowerMsg)) {
                    return pick([
                        `Blue! ‚òÄÔ∏è Well, unless you're in the UK, then it's grey. Or if you're checking your portfolio and it's red, the sky might FEEL grey too üòÇ\n\nHow's your trading sky looking today?`,
                        `Blue during the day, orange at sunset, black at night! üåÖ Unlike my mood when watching someone panic sell - that's always grey.\n\nWhat's up? Just testing me or you got trades on your mind?`,
                        `It's blue! Unless there's a market crash, then emotionally it's blood red for everyone üìâüòÇ\n\nBut fr, what's going on with you?`
                    ]);
                }
                // Math questions - handle words and symbols
                const isMathQuestion = /what('s| is|s)\s+\d|how much is\s+\d|\d\s*(plus|minus|times|divided|multiplied|\+|\-|\*|x|√ó|\/)\s*\d/i.test(lowerMsg);
                if (isMathQuestion) {
                    try {
                        // Convert words to operators
                        let mathExpr = lowerMsg
                            .replace(/what('s| is|s)\s+/i, '')
                            .replace(/how much is\s+/i, '')
                            .replace(/\s*plus\s*/gi, '+')
                            .replace(/\s*minus\s*/gi, '-')
                            .replace(/\s*times\s*/gi, '*')
                            .replace(/\s*multiplied by\s*/gi, '*')
                            .replace(/\s*divided by\s*/gi, '/')
                            .replace(/\s*x\s*/gi, '*')
                            .replace(/\s*√ó\s*/gi, '*')
                            .replace(/[^0-9+\-*/().]/g, ''); // Keep only math chars

                        if (mathExpr && /^[\d+\-*/().]+$/.test(mathExpr)) {
                            const result = Function('"use strict"; return (' + mathExpr + ')')();
                            if (!isNaN(result) && isFinite(result)) {
                                const displayResult = Number.isInteger(result) ? result : result.toFixed(2);
                                return pick([
                                    `It's ${displayResult}! üßÆ\n\nNow if only calculating profits was this easy... üòÇ What else you got?`,
                                    `${displayResult}! Quick maths! üî¢\n\nYou testing me or just bored? Either way, I'm here for it.`,
                                    `The answer is ${displayResult}! üéØ\n\nI can do basic math all day, but my REAL skill is talking you out of bad trades. Got any of those brewing?`,
                                    `${displayResult}! üßÆ Easy.\n\nNow ask me something harder... like whether you should hold that position overnight üòè`
                                ]);
                            }
                        }
                    } catch(e) {
                        // Math eval failed, continue to other handlers
                    }
                }
                // General knowledge / trivia questions
                const triviaAnswers = () => {
                    // Capitals
                    if (/capital of (the )?(us|usa|united states|america)/i.test(lowerMsg)) return `Washington D.C.! üèõÔ∏è Not to be confused with Washington state. Common mistake.\n\nAnything else?`;
                    if (/capital of (the )?(uk|united kingdom|england|britain)/i.test(lowerMsg)) return `London! üá¨üáß Big Ben, tea, and all that.\n\nWhat else you got?`;
                    if (/capital of france/i.test(lowerMsg)) return `Paris! üóº The city of lights and croissants.\n\nNext question?`;
                    if (/capital of germany/i.test(lowerMsg)) return `Berlin! üá©üá™\n\nHit me with another one!`;
                    if (/capital of japan/i.test(lowerMsg)) return `Tokyo! üáØüáµ One of the biggest cities in the world.\n\nWhat else?`;
                    if (/capital of china/i.test(lowerMsg)) return `Beijing! üá®üá≥\n\nKeep 'em coming!`;
                    if (/capital of canada/i.test(lowerMsg)) return `Ottawa! üá®üá¶ Not Toronto - everyone gets that wrong.\n\nNext?`;
                    if (/capital of australia/i.test(lowerMsg)) return `Canberra! üá¶üá∫ Not Sydney, not Melbourne - Canberra.\n\nAnother one?`;
                    if (/capital of italy/i.test(lowerMsg)) return `Rome! üáÆüáπ When in Rome... answer trivia questions apparently üòÇ\n\nWhat else?`;
                    if (/capital of spain/i.test(lowerMsg)) return `Madrid! üá™üá∏\n\nNext question!`;
                    if (/capital of mexico/i.test(lowerMsg)) return `Mexico City! üá≤üáΩ\n\nWhat else you wondering about?`;
                    if (/capital of brazil/i.test(lowerMsg)) return `Bras√≠lia! üáßüá∑ Not Rio, not S√£o Paulo - Bras√≠lia.\n\nAnother?`;
                    if (/capital of russia/i.test(lowerMsg)) return `Moscow! üá∑üá∫\n\nNext!`;
                    if (/capital of india/i.test(lowerMsg)) return `New Delhi! üáÆüá≥\n\nWhat else?`;
                    if (/capital of texas/i.test(lowerMsg)) return `Austin! ü§† Keep Austin weird, as they say.\n\nAnother one?`;
                    if (/capital of california/i.test(lowerMsg)) return `Sacramento! Not LA, not San Francisco - Sacramento.\n\nNext?`;
                    if (/capital of new york/i.test(lowerMsg)) return `Albany! Not NYC - Albany.\n\nAnother question?`;
                    if (/capital of florida/i.test(lowerMsg)) return `Tallahassee! Not Miami, not Orlando.\n\nWhat else?`;

                    // Presidents / Leaders
                    if (/who (is|was) the (first|1st) president/i.test(lowerMsg)) return `George Washington! üá∫üá∏ The OG. The one on the dollar bill.\n\nNext question?`;
                    if (/who (is|was) the (16th|sixteenth) president|who freed the slaves|who ended slavery/i.test(lowerMsg)) return `Abraham Lincoln! üé© Freed the slaves, saved the union, on the penny AND the $5 bill.\n\nWhat else?`;
                    if (/who is the (current )?president/i.test(lowerMsg)) return `As of my knowledge, that depends on when you're asking! Politics changes fast. Google that one for the latest üòÖ\n\nAnything else?`;

                    // History
                    if (/when did (ww2|world war 2|world war ii) (end|finish)/i.test(lowerMsg)) return `1945! üïäÔ∏è September 2nd, 1945 to be exact - when Japan surrendered.\n\nNext?`;
                    if (/when did (ww1|world war 1|world war i) (end|finish)/i.test(lowerMsg)) return `1918! November 11th - that's why Veterans Day is on 11/11.\n\nAnother one?`;
                    if (/when did (ww2|world war 2|world war ii) (start|begin)/i.test(lowerMsg)) return `1939! September 1st, when Germany invaded Poland.\n\nWhat else?`;
                    if (/who discovered america/i.test(lowerMsg)) return `Christopher Columbus in 1492... though Vikings got there first, and Native Americans were already there for thousands of years. History is complicated! üòÖ\n\nNext question?`;
                    if (/when was (the )?declaration of independence/i.test(lowerMsg)) return `July 4th, 1776! üá∫üá∏ Hence July 4th being Independence Day.\n\nAnother one?`;
                    if (/who wrote (the )?(declaration of independence|constitution)/i.test(lowerMsg)) return `Thomas Jefferson was the main author of the Declaration! The Constitution was written by multiple founding fathers, with James Madison being the primary architect.\n\nWhat else?`;

                    // Science
                    if (/how many planets/i.test(lowerMsg)) return `8! ü™ê Mercury, Venus, Earth, Mars, Jupiter, Saturn, Uranus, Neptune. RIP Pluto (demoted in 2006).\n\nNext?`;
                    if (/what('s| is) the (biggest|largest) planet/i.test(lowerMsg)) return `Jupiter! ü™ê It's so big you could fit 1,300 Earths inside it.\n\nAnother one?`;
                    if (/what('s| is) the (smallest) planet/i.test(lowerMsg)) return `Mercury! It's barely bigger than our Moon.\n\nWhat else?`;
                    if (/how many continents/i.test(lowerMsg)) return `7! Africa, Antarctica, Asia, Australia, Europe, North America, South America.\n\nNext question?`;
                    if (/what('s| is) the (biggest|largest) ocean/i.test(lowerMsg)) return `The Pacific Ocean! üåä It covers more area than all the land on Earth combined.\n\nAnother?`;
                    if (/what('s| is) the (biggest|largest) country/i.test(lowerMsg)) return `Russia! üá∑üá∫ By land area. China and India are biggest by population.\n\nWhat else?`;
                    if (/what('s| is) the speed of light/i.test(lowerMsg)) return `About 186,000 miles per second, or 299,792 km/s! ‚ö° Nothing's faster.\n\nNext?`;
                    if (/what('s| is) the (boiling|freezing) point of water/i.test(lowerMsg)) {
                        if (/boiling/i.test(lowerMsg)) return `212¬∞F or 100¬∞C! ‚ô®Ô∏è At sea level anyway.\n\nAnother one?`;
                        return `32¬∞F or 0¬∞C! üßä\n\nWhat else?`;
                    }
                    if (/how many (bones|bones in the body)/i.test(lowerMsg)) return `206 bones in an adult human body! ü¶¥ Babies have about 270 but some fuse together.\n\nNext?`;
                    if (/what('s| is) the (biggest|largest) organ/i.test(lowerMsg)) return `Your skin! It's technically an organ and it's the biggest one.\n\nAnother question?`;

                    // Literature / Arts
                    if (/who wrote (romeo and juliet|hamlet|macbeth|othello)/i.test(lowerMsg)) return `William Shakespeare! üé≠ The GOAT of English literature.\n\nWhat else?`;
                    if (/who wrote harry potter/i.test(lowerMsg)) return `J.K. Rowling! ‚ö°üßô\n\nNext?`;
                    if (/who painted (the )?mona lisa/i.test(lowerMsg)) return `Leonardo da Vinci! üé® It's in the Louvre in Paris.\n\nAnother one?`;
                    if (/who painted (the )?starry night/i.test(lowerMsg)) return `Vincent van Gogh! üåô One of the most famous paintings ever.\n\nWhat else?`;

                    // Random facts
                    if (/how many (days|hours|minutes|seconds) in a year/i.test(lowerMsg)) {
                        if (/days/i.test(lowerMsg)) return `365 days! (366 in a leap year) üìÖ\n\nNext?`;
                        if (/hours/i.test(lowerMsg)) return `8,760 hours! (8,784 in a leap year)\n\nAnother?`;
                        if (/minutes/i.test(lowerMsg)) return `525,600 minutes! üéµ (That's also a song from Rent)\n\nWhat else?`;
                        if (/seconds/i.test(lowerMsg)) return `31,536,000 seconds! That's a lot of candlesticks on a 1-second chart üòÇ\n\nNext?`;
                    }
                    if (/how many (days|weeks) in a month/i.test(lowerMsg)) return `It varies! 28-31 days, or about 4 weeks. February's the short one (28, or 29 in leap years).\n\nAnother question?`;
                    if (/how many states/i.test(lowerMsg)) return `50 states in the USA! üá∫üá∏\n\nWhat else?`;
                    if (/how many letters in the alphabet/i.test(lowerMsg)) return `26! A to Z. üî§\n\nNext?`;
                    if (/how many (legs|eyes) (does|do) a spider have/i.test(lowerMsg)) {
                        if (/legs/i.test(lowerMsg)) return `8 legs! üï∑Ô∏è That's how you know it's not an insect (insects have 6).\n\nAnother?`;
                        return `8 eyes! Most spiders anyway. üï∑Ô∏èüëÄ\n\nWhat else?`;
                    }
                    if (/what('s| is) h2o/i.test(lowerMsg)) return `Water! üíß H2O = 2 hydrogen atoms + 1 oxygen atom.\n\nNext question?`;
                    if (/what('s| is) the sun/i.test(lowerMsg)) return `A star! ‚òÄÔ∏è Specifically a G-type main-sequence star. It's about 93 million miles away.\n\nAnother?`;
                    if (/what('s| is) the moon/i.test(lowerMsg)) return `Earth's only natural satellite! üåô It controls our tides and looks cool at night.\n\nWhat else?`;

                    // Language
                    if (/how do you spell/i.test(lowerMsg)) {
                        const word = lowerMsg.match(/how do you spell\s+(\w+)/i);
                        if (word) return `You just spelled it! "${word[1]}" üòÇ\n\nFor real though, if you're unsure, that looks right to me. What else?`;
                    }
                    if (/what does .+ mean/i.test(lowerMsg)) return `That's getting into dictionary territory! üìñ I can do basic trivia but for definitions, Google or a dictionary would serve you better.\n\nGot any math or geography questions instead?`;

                    // TRADING EDUCATION - this is my specialty!
                    if (/what (are|is) options|what('s| is) an option/i.test(lowerMsg)) return `Options are contracts that give you the RIGHT (but not obligation) to buy or sell a stock at a specific price by a specific date! üìä\n\n‚Ä¢ CALL = bet the stock goes UP\n‚Ä¢ PUT = bet the stock goes DOWN\n‚Ä¢ Strike = the price you're betting it hits\n‚Ä¢ Expiration = when the contract expires\n\nThey're leveraged so you can make (or lose) money faster than stocks. That's why I'm here - to stop you from YOLOing into 0DTE options üòÇ\n\nWhat else you wanna know?`;

                    if (/what('s| is) a call|what are calls/i.test(lowerMsg)) return `A CALL option gives you the right to BUY a stock at a specific price (strike) before expiration! üìà\n\nYou buy calls when you think the stock is going UP.\n\n‚Ä¢ Stock goes up = your call gains value ‚úÖ\n‚Ä¢ Stock goes down = your call loses value ‚ùå\n‚Ä¢ Stock doesn't move = theta eats your premium üò¢\n\nExample: Buy $100 call on AAPL = you profit if AAPL goes above $100 + premium paid.\n\nAnything else?`;

                    if (/what('s| is) a put|what are puts/i.test(lowerMsg)) return `A PUT option gives you the right to SELL a stock at a specific price (strike) before expiration! üìâ\n\nYou buy puts when you think the stock is going DOWN.\n\n‚Ä¢ Stock goes down = your put gains value ‚úÖ\n‚Ä¢ Stock goes up = your put loses value ‚ùå\n‚Ä¢ Stock doesn't move = theta eats your premium üò¢\n\nPuts are also used for hedging - protecting your stocks from crashes.\n\nWhat else?`;

                    if (/what('s| is) (the )?strike( price)?/i.test(lowerMsg)) return `The STRIKE PRICE is the price at which you can buy (call) or sell (put) the stock! üéØ\n\n‚Ä¢ Strike below current price for calls = "in the money" (ITM)\n‚Ä¢ Strike above current price for calls = "out of the money" (OTM)\n‚Ä¢ Opposite for puts!\n\nOTM options are cheaper but less likely to profit. ITM options cost more but have better odds.\n\nNext question?`;

                    if (/what('s| is) theta/i.test(lowerMsg)) return `THETA is time decay - how much value your option loses each day just from time passing! ‚è∞üí∏\n\nTheta is the ENEMY of option buyers. Every day that passes, your option loses a little value (all else being equal).\n\n‚Ä¢ Theta accelerates as expiration approaches\n‚Ä¢ This is why 0DTE options are so risky\n‚Ä¢ Option SELLERS love theta - they collect it\n\nTheta is why I always ask "how many days you got?" üòÖ\n\nWhat else?`;

                    if (/what('s| is) delta/i.test(lowerMsg)) return `DELTA measures how much your option moves for every $1 move in the stock! üìä\n\n‚Ä¢ Delta of 0.50 = option gains $0.50 for every $1 the stock moves\n‚Ä¢ Calls have positive delta (0 to 1)\n‚Ä¢ Puts have negative delta (0 to -1)\n‚Ä¢ ATM options have ~0.50 delta\n\nHigher delta = more expensive but moves more with the stock.\n\nNext?`;

                    if (/what('s| is) gamma/i.test(lowerMsg)) return `GAMMA measures how fast delta changes! It's the rate of change of delta. üìàüìà\n\n‚Ä¢ High gamma = delta changes quickly (more volatile)\n‚Ä¢ Gamma is highest for ATM options near expiration\n‚Ä¢ This is why near-expiry options are so explosive\n\nGamma is why 0DTE options can 10x... or go to zero in minutes.\n\nAnother question?`;

                    if (/what('s| is) vega/i.test(lowerMsg)) return `VEGA measures how much your option is affected by changes in volatility! üìä\n\n‚Ä¢ High vega = option is very sensitive to IV changes\n‚Ä¢ When IV spikes (like before earnings), options get more expensive\n‚Ä¢ When IV drops (after earnings), options get crushed - this is "IV crush"\n\nThis is why buying options before earnings is risky even if you're right on direction!\n\nWhat else?`;

                    if (/what('s| is) iv|what('s| is) implied volatility/i.test(lowerMsg)) return `IV (Implied Volatility) is the market's expectation of how much a stock will move! üìä\n\n‚Ä¢ High IV = market expects big moves = expensive options\n‚Ä¢ Low IV = market expects calm = cheaper options\n‚Ä¢ IV usually spikes before earnings/events\n‚Ä¢ IV CRUSH = when IV drops suddenly (usually after events)\n\nBuying high IV options is risky - you need a BIG move just to break even.\n\nNext question?`;

                    if (/what('s| is) (a )?short squeeze/i.test(lowerMsg)) return `A SHORT SQUEEZE happens when a heavily shorted stock starts going UP, forcing short sellers to buy shares to cover their losses, which pushes the price even HIGHER! üöÄ\n\n‚Ä¢ Shorts borrow shares and sell them, hoping to buy back cheaper\n‚Ä¢ If price rises, shorts lose money and may be forced to cover\n‚Ä¢ Their buying creates more buying pressure\n‚Ä¢ GME in 2021 was the famous example\n\nThey're rare but explosive when they happen!\n\nWhat else?`;

                    if (/what('s| is) rsi/i.test(lowerMsg)) return `RSI (Relative Strength Index) measures if a stock is overbought or oversold! üìä\n\n‚Ä¢ RSI ranges from 0-100\n‚Ä¢ Above 70 = overbought (might drop)\n‚Ä¢ Below 30 = oversold (might bounce)\n‚Ä¢ 50 = neutral\n\nIt's a momentum indicator. Not a guarantee, but useful for timing entries/exits.\n\nAnother question?`;

                    if (/what('s| is) macd/i.test(lowerMsg)) return `MACD (Moving Average Convergence Divergence) is a trend-following indicator! üìà\n\n‚Ä¢ It shows the relationship between two moving averages\n‚Ä¢ MACD crossing above signal line = bullish\n‚Ä¢ MACD crossing below signal line = bearish\n‚Ä¢ Histogram shows the difference between them\n\nTraders use it to spot trend changes and momentum.\n\nWhat else you got?`;

                    if (/what('s| is) (a )?stop loss|what('s| is) (a )?stop-loss/i.test(lowerMsg)) return `A STOP LOSS is an order to automatically sell when a stock hits a certain price - to limit your losses! üõë\n\n‚Ä¢ Example: Buy at $100, set stop loss at $90\n‚Ä¢ If stock drops to $90, it auto-sells\n‚Ä¢ Protects you from big losses\n‚Ä¢ Set it and forget it!\n\nEvery trade should have a stop loss. EVERY. TRADE. This is how you survive.\n\nNext?`;

                    if (/what('s| is) (a )?limit order/i.test(lowerMsg)) return `A LIMIT ORDER lets you set the exact price you want to buy or sell at! üí∞\n\n‚Ä¢ Buy limit = "I'll only buy at this price or lower"\n‚Ä¢ Sell limit = "I'll only sell at this price or higher"\n‚Ä¢ More control than market orders\n‚Ä¢ Might not fill if price doesn't reach your limit\n\nUse limits to get better fills, especially on options with wide spreads.\n\nAnother question?`;

                    if (/what('s| is) (a )?market order/i.test(lowerMsg)) return `A MARKET ORDER buys or sells immediately at the current market price! ‚ö°\n\n‚Ä¢ Guaranteed to fill (for liquid stocks)\n‚Ä¢ But you might get a worse price than expected\n‚Ä¢ Especially risky on options with wide bid/ask spreads\n‚Ä¢ Use for urgency, but limit orders are usually better\n\nWhat else?`;

                    if (/what('s| is) support|what('s| is) resistance/i.test(lowerMsg)) return `SUPPORT & RESISTANCE are price levels where stocks tend to bounce or stall! üìä\n\n‚Ä¢ SUPPORT = price floor, buyers step in here\n‚Ä¢ RESISTANCE = price ceiling, sellers step in here\n‚Ä¢ When broken, support becomes resistance and vice versa\n\nThink of support as a trampoline and resistance as a ceiling. Stocks bounce off these levels... until they don't!\n\nNext question?`;

                    if (/what('s| is) (a )?breakout/i.test(lowerMsg)) return `A BREAKOUT is when a stock moves above resistance or below support with strong volume! üöÄ\n\n‚Ä¢ Signals potential trend continuation\n‚Ä¢ Best breakouts have high volume\n‚Ä¢ "Fakeouts" happen when breakouts fail\n‚Ä¢ Often good entry points... if they hold\n\nThe pattern screener in this app looks for breakout setups!\n\nWhat else?`;

                    if (/what('s| is) (the )?bid|what('s| is) (the )?ask|bid.?ask spread/i.test(lowerMsg)) return `BID is what buyers will pay, ASK is what sellers want! üíµ\n\n‚Ä¢ BID = highest price someone will buy at\n‚Ä¢ ASK = lowest price someone will sell at\n‚Ä¢ SPREAD = difference between bid and ask\n‚Ä¢ Wide spread = less liquid, harder to trade\n\nOn options, always check the spread! A $0.50 spread on a $1 option means you lose 50% just entering and exiting.\n\nAnother question?`;

                    if (/what('s| is) (a )?covered call/i.test(lowerMsg)) return `A COVERED CALL is when you own shares AND sell call options against them! üìä\n\n‚Ä¢ You collect premium (income)\n‚Ä¢ If stock stays below strike, you keep shares + premium\n‚Ä¢ If stock goes above strike, shares get called away at strike price\n‚Ä¢ Good for generating income on stocks you own\n\nIt's a conservative options strategy - you're selling upside for guaranteed income.\n\nWhat else?`;

                    if (/what('s| is) (a )?spread|what('s| is) (a )?debit spread|what('s| is) (a )?credit spread/i.test(lowerMsg)) return `A SPREAD is buying AND selling options at the same time! üìä\n\n‚Ä¢ DEBIT SPREAD = you pay money, limited risk, limited reward\n‚Ä¢ CREDIT SPREAD = you receive money, limited risk but can lose more than you made\n‚Ä¢ Spreads reduce cost and risk compared to naked options\n‚Ä¢ But they also cap your upside\n\nGreat for defined-risk trades when you have a direction but want to limit exposure.\n\nNext?`;

                    if (/what('s| is) leverage/i.test(lowerMsg)) return `LEVERAGE is using borrowed money or instruments to amplify your returns (and losses)! ‚ö°\n\n‚Ä¢ Options are leveraged (control 100 shares for fraction of cost)\n‚Ä¢ Margin trading is leveraged (borrow money to buy more)\n‚Ä¢ 2x leverage = gains/losses doubled\n‚Ä¢ VERY risky - can blow up your account fast\n\nLeverage is why options traders can make 1000%... or lose everything overnight.\n\nWhat else you wanna know?`;

                    if (/what('s| is) margin/i.test(lowerMsg)) return `MARGIN is borrowing money from your broker to buy more stocks/options! üí≥\n\n‚Ä¢ Increases buying power\n‚Ä¢ But also increases risk\n‚Ä¢ MARGIN CALL = broker demands more money or sells your stuff\n‚Ä¢ Can lose more than you deposited!\n\nMargin is a double-edged sword. Use carefully or not at all.\n\nAnother question?`;

                    if (/what('s| is) (a )?dividend/i.test(lowerMsg)) return `A DIVIDEND is when a company pays shareholders a portion of its profits! üí∞\n\n‚Ä¢ Usually paid quarterly\n‚Ä¢ Dividend yield = annual dividend / stock price\n‚Ä¢ "Ex-dividend date" = you must own before this to get paid\n‚Ä¢ Stock usually drops by dividend amount on ex-date\n\nDividend stocks are popular for passive income!\n\nWhat else?`;

                    if (/what('s| is) (the )?p\/?e ratio|what('s| is) pe ratio/i.test(lowerMsg)) return `P/E RATIO (Price-to-Earnings) shows how expensive a stock is relative to its earnings! üìä\n\n‚Ä¢ P/E = Stock Price / Earnings Per Share\n‚Ä¢ High P/E = expensive/growth stock (investors expect future growth)\n‚Ä¢ Low P/E = cheap/value stock (or company has problems)\n‚Ä¢ Compare to industry average, not absolute numbers\n\nTesla has high P/E (growth), banks have low P/E (value).\n\nNext question?`;

                    if (/what('s| is) (a )?bull market/i.test(lowerMsg)) return `A BULL MARKET is when stocks are going UP over time! üêÇüìà\n\n‚Ä¢ Generally defined as 20%+ rise from recent lows\n‚Ä¢ Optimism, buying, good vibes\n‚Ä¢ "Bulls" are optimistic traders who think prices will rise\n‚Ä¢ Bull = horns pointing UP\n\nWe like bull markets. Everyone's happy.\n\nWhat else?`;

                    if (/what('s| is) (a )?bear market/i.test(lowerMsg)) return `A BEAR MARKET is when stocks are going DOWN over time! üêªüìâ\n\n‚Ä¢ Generally defined as 20%+ drop from recent highs\n‚Ä¢ Pessimism, selling, fear\n‚Ä¢ "Bears" are pessimistic traders who think prices will fall\n‚Ä¢ Bear = claws swiping DOWN\n\nBear markets are when most retail traders get wrecked.\n\nAnother question?`;

                    if (/what('s| is) (a )?etf/i.test(lowerMsg)) return `An ETF (Exchange-Traded Fund) is a basket of stocks you can buy as one ticker! üì¶\n\n‚Ä¢ SPY = S&P 500 ETF (500 biggest US companies)\n‚Ä¢ QQQ = Nasdaq 100 ETF (tech heavy)\n‚Ä¢ VOO, VTI, IWM = other popular ones\n‚Ä¢ Trade like stocks but give you instant diversification\n\nGreat for beginners or if you don't want to pick individual stocks!\n\nWhat else?`;

                    if (/what('s| is) (the )?s&p|what('s| is) (the )?spy/i.test(lowerMsg)) return `The S&P 500 is an index of the 500 largest US companies! üìä\n\n‚Ä¢ SPY is the ETF that tracks it\n‚Ä¢ It's THE benchmark for the US stock market\n‚Ä¢ "The market" usually means the S&P 500\n‚Ä¢ Apple, Microsoft, Amazon, Google, etc. are the top holdings\n\nWhen people say "the market is up 1%", they usually mean the S&P.\n\nNext?`;

                    // FIBONACCI / FIBS
                    if (/what('s| is|are) (a )?fib(onacci)?|fib(onacci)? (retrace|level|line)/i.test(lowerMsg)) return `FIBONACCI RETRACEMENTS are key price levels based on the Fibonacci sequence! üìê\n\n‚Ä¢ Most important levels: 23.6%, 38.2%, 50%, 61.8%, 78.6%\n‚Ä¢ Used to find support/resistance during pullbacks\n‚Ä¢ After a big move, price often retraces to these levels\n‚Ä¢ The 61.8% is the "golden ratio" - very significant!\n\nHow to use: Draw from swing low to swing high (uptrend) or high to low (downtrend). Watch for bounces at fib levels.\n\nNext question?`;

                    // VOLUME
                    if (/what('s| is) volume|how.*(volume|vol).*(work|use|read|mean)/i.test(lowerMsg)) return `VOLUME shows how many shares/contracts traded in a period! üìä\n\n‚Ä¢ High volume = strong conviction in the move\n‚Ä¢ Low volume = weak move, might reverse\n‚Ä¢ Volume confirms breakouts - breakout on high volume = legit\n‚Ä¢ Volume spikes often signal reversals or big news\n\nRules:\n‚Ä¢ Price up + volume up = bullish ‚úÖ\n‚Ä¢ Price up + volume down = weak, might fail ‚ö†Ô∏è\n‚Ä¢ Price down + volume up = bearish (selling pressure)\n‚Ä¢ Price down + volume down = weak selling, might bounce\n\nWhat else?`;

                    // MOVING AVERAGES
                    if (/what('s| is) (a )?(moving average|ma|sma|ema)|what('s| is) the (9|20|50|100|200) (day|ma|ema|sma)/i.test(lowerMsg)) return `MOVING AVERAGES smooth out price action to show trends! üìà\n\n‚Ä¢ SMA = Simple Moving Average (all periods weighted equally)\n‚Ä¢ EMA = Exponential Moving Average (recent prices weighted more)\n\nKey MAs:\n‚Ä¢ 9 EMA - short-term momentum\n‚Ä¢ 20 EMA/SMA - short-term trend\n‚Ä¢ 50 SMA - medium-term trend (important!)\n‚Ä¢ 200 SMA - long-term trend (THE big one)\n\n‚Ä¢ Price above MA = bullish\n‚Ä¢ Price below MA = bearish\n‚Ä¢ MAs crossing = trend change signal\n\nThe 50/200 SMA crossover is famous - "Golden Cross" (bullish) or "Death Cross" (bearish).\n\nAnother question?`;

                    // GOLDEN CROSS / DEATH CROSS
                    if (/what('s| is) (a )?(golden cross|death cross)/i.test(lowerMsg)) return `These are major trend signals based on moving averages! üìä\n\n‚Ä¢ GOLDEN CROSS = 50-day MA crosses ABOVE 200-day MA üêÇ\n  ‚Üí Bullish signal, potential uptrend starting\n\n‚Ä¢ DEATH CROSS = 50-day MA crosses BELOW 200-day MA üêª\n  ‚Üí Bearish signal, potential downtrend starting\n\nThese are LAGGING indicators (they confirm trends, not predict them), but they're widely watched.\n\nWhat else?`;

                    // BOLLINGER BANDS
                    if (/what('s| is|are) bollinger/i.test(lowerMsg)) return `BOLLINGER BANDS measure volatility around a moving average! üìä\n\n‚Ä¢ Middle band = 20-period SMA\n‚Ä¢ Upper band = SMA + 2 standard deviations\n‚Ä¢ Lower band = SMA - 2 standard deviations\n\nHow to use:\n‚Ä¢ Price touching upper band = potentially overbought\n‚Ä¢ Price touching lower band = potentially oversold\n‚Ä¢ Bands squeezing = low volatility, big move coming\n‚Ä¢ Bands expanding = high volatility, momentum\n\n"Bollinger Band squeeze" often precedes breakouts!\n\nNext?`;

                    // CANDLESTICK PATTERNS
                    if (/what('s| is|are) (a )?(candlestick|candle) pattern|how.*(read|understand) candle/i.test(lowerMsg)) return `CANDLESTICK PATTERNS help predict price direction! üïØÔ∏è\n\nBullish patterns (price might go up):\n‚Ä¢ Hammer - small body, long lower wick\n‚Ä¢ Bullish Engulfing - green candle swallows red\n‚Ä¢ Morning Star - 3-candle reversal pattern\n‚Ä¢ Doji at support - indecision, potential bounce\n\nBearish patterns (price might go down):\n‚Ä¢ Shooting Star - small body, long upper wick\n‚Ä¢ Bearish Engulfing - red candle swallows green\n‚Ä¢ Evening Star - 3-candle reversal pattern\n‚Ä¢ Doji at resistance - indecision, potential drop\n\nThe Pattern Screener in this app finds these for you! üìà\n\nWhat else?`;

                    // DOJI
                    if (/what('s| is) (a )?doji/i.test(lowerMsg)) return `A DOJI is a candlestick where open and close are nearly equal! ‚ûï\n\n‚Ä¢ Shows indecision between buyers and sellers\n‚Ä¢ Small or no body, can have wicks\n‚Ä¢ Important at key support/resistance levels\n\nTypes:\n‚Ä¢ Regular Doji - cross shape\n‚Ä¢ Dragonfly Doji - long lower wick (bullish at support)\n‚Ä¢ Gravestone Doji - long upper wick (bearish at resistance)\n\nDoji by itself = wait for confirmation. Doji at key level = pay attention!\n\nAnother question?`;

                    // HAMMER
                    if (/what('s| is) (a )?hammer.*(candle|pattern)?/i.test(lowerMsg)) return `A HAMMER is a bullish reversal candlestick! üî®\n\n‚Ä¢ Small body at the TOP of the candle\n‚Ä¢ Long lower wick (2-3x the body)\n‚Ä¢ Little to no upper wick\n‚Ä¢ Found at the bottom of downtrends\n\nWhat it means: Sellers pushed price down, but buyers fought back and closed near the high. Shows buying pressure!\n\nThe opposite is a SHOOTING STAR (same shape but at top of uptrend = bearish).\n\nWhat else?`;

                    // GAP UP / GAP DOWN
                    if (/what('s| is) (a )?(gap up|gap down|gap)|stock.*(gap|gapped)/i.test(lowerMsg)) return `A GAP is when price opens significantly different from prior close! üìä\n\n‚Ä¢ GAP UP = Opens higher than yesterday's high\n‚Ä¢ GAP DOWN = Opens lower than yesterday's low\n\nGap types:\n‚Ä¢ Breakaway gap - starts new trend (usually fills partially)\n‚Ä¢ Runaway gap - continues trend (momentum)\n‚Ä¢ Exhaustion gap - near end of trend (often fills)\n\n"Gap fill" = price returns to fill the empty space. Most gaps eventually fill!\n\nTraders love gap ups on high volume - shows strong demand.\n\nNext question?`;

                    // CONSOLIDATION
                    if (/what('s| is) consolidation|stock.*(consolidat|sideways|range.?bound)/i.test(lowerMsg)) return `CONSOLIDATION is when price moves sideways in a range! üìä\n\n‚Ä¢ Price stuck between support and resistance\n‚Ä¢ Neither bulls nor bears in control\n‚Ä¢ Usually happens after a big move\n‚Ä¢ The longer the consolidation, the bigger the eventual breakout\n\nWhat to do:\n‚Ä¢ Wait for breakout above resistance (bullish)\n‚Ä¢ Or breakdown below support (bearish)\n‚Ä¢ Volume confirms the direction\n\nPatience! Don't trade the chop, trade the breakout.\n\nAnother question?`;

                    // TREND / TRENDING
                    if (/what('s| is) (a )?trend|how.*(identify|spot|find).*(trend|trending)/i.test(lowerMsg)) return `A TREND is the general direction price is moving! üìàüìâ\n\n‚Ä¢ UPTREND = Higher highs + higher lows üêÇ\n‚Ä¢ DOWNTREND = Lower highs + lower lows üêª\n‚Ä¢ SIDEWAYS = No clear direction (consolidation)\n\nHow to identify:\n‚Ä¢ Draw trendlines connecting lows (uptrend) or highs (downtrend)\n‚Ä¢ Use moving averages - price above = uptrend\n‚Ä¢ "Trend is your friend" - trade WITH the trend!\n\nThe trend is more likely to continue than reverse. Don't fight it!\n\nWhat else?`;

                    // SCALPING
                    if (/what('s| is) scalping|what('s| is) a scalper/i.test(lowerMsg)) return `SCALPING is making many quick trades for small profits! ‚ö°\n\n‚Ä¢ Hold time: Seconds to minutes\n‚Ä¢ Profit target: Small (cents to a few %)\n‚Ä¢ Many trades per day (dozens to hundreds)\n‚Ä¢ Requires fast execution and low fees\n\nPros:\n‚Ä¢ Small risk per trade\n‚Ä¢ Many opportunities\n‚Ä¢ Don't hold overnight\n\nCons:\n‚Ä¢ Stressful and demanding\n‚Ä¢ Fees add up\n‚Ä¢ Need to be glued to screens\n\nNot for beginners - very skill intensive!\n\nAnother question?`;

                    // SWING TRADING
                    if (/what('s| is) swing trad(ing|er)/i.test(lowerMsg)) return `SWING TRADING is holding positions for days to weeks! üìä\n\n‚Ä¢ Hold time: Days to a few weeks\n‚Ä¢ Catches "swings" in price - up moves in uptrends, down moves in downtrends\n‚Ä¢ Less stressful than day trading\n‚Ä¢ Can have a day job while swing trading\n\nHow it works:\n‚Ä¢ Find stocks in a trend\n‚Ä¢ Enter on pullbacks to support\n‚Ä¢ Exit at resistance or when trend breaks\n‚Ä¢ Use stop losses!\n\nGreat middle ground between day trading and investing.\n\nWhat else?`;

                    // DAY TRADING
                    if (/what('s| is) day trad(ing|er)/i.test(lowerMsg)) return `DAY TRADING is buying and selling within the same day! üìä\n\n‚Ä¢ All positions closed before market close\n‚Ä¢ No overnight risk\n‚Ä¢ Pattern Day Trader rule: Need $25k if making 4+ day trades in 5 days\n\nPros:\n‚Ä¢ No overnight gaps\n‚Ä¢ Fresh start every day\n‚Ä¢ Can profit in any market direction\n\nCons:\n‚Ä¢ PDT rule requires capital\n‚Ä¢ Stressful, requires constant attention\n‚Ä¢ Most day traders lose money (stats say 90%+)\n\nNot a get-rich-quick scheme - it's a skill that takes years to develop!\n\nNext?`;

                    // PAPER TRADING
                    if (/what('s| is) paper trad(ing|er)/i.test(lowerMsg)) return `PAPER TRADING is practicing with fake money! üìù\n\n‚Ä¢ Simulated trading with virtual funds\n‚Ä¢ Learn the platform without risking real money\n‚Ä¢ Test strategies before going live\n‚Ä¢ Most brokers offer paper trading accounts\n\nIMPORTANT: Paper trading is good for learning mechanics, but emotions are different with real money. Your paper trading results will probably be better than real results.\n\nStill, EVERYONE should paper trade before risking real money!\n\nWhat else?`;

                    // POSITION SIZING / RISK MANAGEMENT
                    if (/what('s| is) position siz(e|ing)|how (much|many).*(buy|risk|position)/i.test(lowerMsg)) return `POSITION SIZING is how much of your account you put in one trade! üí∞\n\nThe golden rule: Never risk more than 1-2% of your account on a single trade!\n\nExample with $10,000 account:\n‚Ä¢ Max risk per trade: $100-200\n‚Ä¢ If stop loss is 10% below entry, position size = $1,000-2,000\n\nCalculation:\n‚Ä¢ Risk Amount = Account √ó Risk %\n‚Ä¢ Position Size = Risk Amount / (Entry - Stop Loss)\n\nThis way, even 10 losses in a row won't blow up your account. SURVIVAL is key!\n\nAnother question?`;

                    // RISK/REWARD RATIO
                    if (/what('s| is) (the )?(risk.?reward|r.?r ratio|risk to reward)/i.test(lowerMsg)) return `RISK/REWARD RATIO compares potential profit to potential loss! ‚öñÔ∏è\n\n‚Ä¢ R:R of 1:2 = risking $1 to make $2\n‚Ä¢ R:R of 1:3 = risking $1 to make $3\n\nWhy it matters:\n‚Ä¢ With 1:2 R:R, you only need 33% win rate to break even\n‚Ä¢ With 1:3 R:R, you only need 25% win rate to break even\n\nNever take trades with less than 1:1 R:R. Aim for 1:2 or better!\n\nBefore every trade, know your entry, stop loss, and target. If the R:R isn't good, skip the trade.\n\nWhat else?`;

                    // DCA / DOLLAR COST AVERAGING
                    if (/what('s| is) dca|what('s| is) dollar cost averag/i.test(lowerMsg)) return `DCA (Dollar Cost Averaging) is investing fixed amounts at regular intervals! üìä\n\n‚Ä¢ Instead of timing the market, you buy consistently\n‚Ä¢ Example: $500 into SPY every month, no matter the price\n‚Ä¢ When price is high, you buy less shares\n‚Ä¢ When price is low, you buy more shares\n‚Ä¢ Average cost evens out over time\n\nGreat for:\n‚Ä¢ Long-term investing\n‚Ä¢ Removing emotion from buying decisions\n‚Ä¢ Building positions without trying to time bottoms\n\nThe best time to invest was yesterday. The second best is today. DCA helps you just START.\n\nAnother question?`;

                    // AVERAGING DOWN
                    if (/what('s| is) averag(e|ing) down|should i average down/i.test(lowerMsg)) return `AVERAGING DOWN is buying more as price drops to lower your average cost! üìâ\n\n‚Ä¢ Stock at $100, you buy. Drops to $80, you buy more.\n‚Ä¢ New average = somewhere between $80-100\n\n‚ö†Ô∏è DANGEROUS if done wrong:\n‚Ä¢ Works if stock recovers\n‚Ä¢ Terrible if stock keeps falling (you just added to a loser)\n‚Ä¢ "Catching a falling knife"\n\nWhen it might be okay:\n‚Ä¢ You PLANNED to scale in\n‚Ä¢ Your thesis hasn't changed\n‚Ä¢ It's a long-term investment\n\nNEVER average down on options or trades that hit your stop loss!\n\nWhat else?`;

                    // MARKET CAP
                    if (/what('s| is) market cap/i.test(lowerMsg)) return `MARKET CAP is the total value of a company's stock! üí∞\n\n‚Ä¢ Market Cap = Share Price √ó Shares Outstanding\n‚Ä¢ Apple at $170/share √ó 15B shares = ~$2.5 trillion market cap\n\nCategories:\n‚Ä¢ Mega cap: $200B+ (AAPL, MSFT, GOOGL)\n‚Ä¢ Large cap: $10B-200B\n‚Ä¢ Mid cap: $2B-10B\n‚Ä¢ Small cap: $300M-2B\n‚Ä¢ Micro cap: <$300M (very risky!)\n\nLarger cap = more stable, less volatile\nSmaller cap = more volatile, bigger moves (up AND down)\n\nNext question?`;

                    // FLOAT
                    if (/what('s| is) (the )?float|what('s| is) shares outstanding/i.test(lowerMsg)) return `FLOAT is the number of shares available for public trading! üìä\n\n‚Ä¢ Shares Outstanding = Total shares that exist\n‚Ä¢ Float = Shares Outstanding - Insider/Restricted shares\n‚Ä¢ Float is what's actually available to trade\n\nWhy it matters:\n‚Ä¢ LOW float (under 10-20M) = moves faster, more volatile\n‚Ä¢ HIGH float = more stable, harder to squeeze\n‚Ä¢ Short squeezes need low float + high short interest\n\nLow float + high volume = explosive moves! (GME, AMC examples)\n\nWhat else?`;

                    // SHORT INTEREST
                    if (/what('s| is) short interest/i.test(lowerMsg)) return `SHORT INTEREST is the percentage of float that's been sold short! üìä\n\n‚Ä¢ High SI (20%+) = lots of people betting against the stock\n‚Ä¢ Creates potential for short squeeze if stock rises\n‚Ä¢ Reported every 2 weeks (can be outdated)\n\n‚Ä¢ Short Interest Ratio (Days to Cover) = Short Interest / Daily Volume\n‚Ä¢ High Days to Cover (5+) = takes longer for shorts to cover = squeeze potential\n\nHigh short interest is FUEL for squeezes, but also means smart money sees problems!\n\nAnother question?`;

                    // OPEN INTEREST (OPTIONS)
                    if (/what('s| is) open interest/i.test(lowerMsg)) return `OPEN INTEREST is the total number of outstanding option contracts! üìä\n\n‚Ä¢ New contracts created = OI increases\n‚Ä¢ Contracts closed/exercised = OI decreases\n‚Ä¢ Different from VOLUME (which is daily trading activity)\n\nWhy it matters:\n‚Ä¢ High OI = liquid, easier to trade, tighter spreads\n‚Ä¢ Low OI = less liquid, wider spreads, harder to exit\n‚Ä¢ OI at certain strikes shows where "max pain" might be\n\nFor options, always check OI before trading! Low OI = stay away.\n\nNext?`;

                    // ITM / ATM / OTM
                    if (/what('s| is|are|does) (itm|atm|otm|in the money|at the money|out of the money)/i.test(lowerMsg)) return `These describe where the strike is relative to current price! üìä\n\nFor CALLS:\n‚Ä¢ ITM (In The Money) = Strike BELOW current price (has intrinsic value)\n‚Ä¢ ATM (At The Money) = Strike EQUALS current price\n‚Ä¢ OTM (Out The Money) = Strike ABOVE current price (no intrinsic value)\n\nFor PUTS: Opposite!\n‚Ä¢ ITM = Strike ABOVE current price\n‚Ä¢ OTM = Strike BELOW current price\n\nOTM options are cheaper but less likely to profit. ITM are more expensive but safer.\n\nWhat else?`;

                    // INTRINSIC VS EXTRINSIC VALUE
                    if (/what('s| is) (intrinsic|extrinsic) value/i.test(lowerMsg)) return `Options have two types of value! üí∞\n\n‚Ä¢ INTRINSIC VALUE = How much the option is ITM\n  ‚Üí Stock at $105, $100 Call = $5 intrinsic value\n  ‚Üí OTM options have $0 intrinsic value\n\n‚Ä¢ EXTRINSIC VALUE (Time Value) = Everything else\n  ‚Üí What you pay for the POTENTIAL of movement\n  ‚Üí Includes time value and implied volatility\n  ‚Üí This is what theta (time decay) eats away!\n\nOption Price = Intrinsic + Extrinsic\n\nAt expiration, extrinsic value = $0. Only intrinsic matters!\n\nAnother question?`;

                    // IRON CONDOR
                    if (/what('s| is) (an? )?iron condor/i.test(lowerMsg)) return `An IRON CONDOR is a 4-leg options strategy for range-bound stocks! üìä\n\n‚Ä¢ Sell OTM Call + Buy further OTM Call (call spread)\n‚Ä¢ Sell OTM Put + Buy further OTM Put (put spread)\n‚Ä¢ Collects premium, profits if stock stays in range\n\nMax profit: Premium collected\nMax loss: Width of spread - premium\n\nGreat for: Low volatility, sideways markets\nBad for: Big moves in either direction\n\nIt's a neutral strategy - you're betting the stock does NOTHING dramatic!\n\nNext?`;

                    // STRADDLE / STRANGLE
                    if (/what('s| is) (a )?(straddle|strangle)/i.test(lowerMsg)) return `These are volatility plays - betting on a BIG move (either direction)! üìä\n\n‚Ä¢ STRADDLE = Buy ATM Call + ATM Put (same strike)\n‚Ä¢ STRANGLE = Buy OTM Call + OTM Put (different strikes)\n\nStraddle is more expensive but profits faster.\nStrangle is cheaper but needs bigger move.\n\nUse before: Earnings, FDA decisions, big events\n\n‚ö†Ô∏è Warning: IV crush after events can destroy these even if you're right on the move! The move needs to be BIGGER than what's priced in.\n\nWhat else?`;

                    // WHEEL STRATEGY
                    if (/what('s| is) (the )?wheel (strategy|strat)/i.test(lowerMsg)) return `The WHEEL is a popular income strategy for stocks you want to own! üìä\n\nStep 1: Sell cash-secured PUT on stock you'd buy\n‚Ä¢ If assigned, you own shares at lower price\n‚Ä¢ If not assigned, keep premium, repeat\n\nStep 2: If assigned, sell covered CALL on your shares\n‚Ä¢ If assigned, sell shares at higher price + premium\n‚Ä¢ If not assigned, keep premium, repeat\n\nRinse and repeat! You're getting paid to potentially buy low and sell high.\n\nBest on: Stable stocks you'd hold anyway\nNeeds: Enough capital to buy 100 shares\n\nAnother question?`;

                    // THE GREEKS (OVERVIEW)
                    if (/what are the greeks|explain.*(greeks|greek)/i.test(lowerMsg)) return `THE GREEKS measure how options prices change! üìä\n\n‚Ä¢ DELTA - How much option moves per $1 stock move\n‚Ä¢ GAMMA - How fast delta changes\n‚Ä¢ THETA - Time decay (how much value lost per day)\n‚Ä¢ VEGA - Sensitivity to volatility changes\n‚Ä¢ RHO - Sensitivity to interest rates (usually ignore)\n\nMost important:\n‚Ä¢ Delta tells you directional exposure\n‚Ä¢ Theta is your daily enemy (as buyer)\n‚Ä¢ Vega matters around events (IV crush!)\n\nUnderstanding Greeks = understanding options!\n\nAsk me about any specific Greek for more details!`;

                    // CATALYST
                    if (/what('s| is) (a )?catalyst/i.test(lowerMsg)) return `A CATALYST is an event that could move a stock's price! üìä\n\n‚Ä¢ Earnings reports\n‚Ä¢ FDA decisions (biotech)\n‚Ä¢ Product launches\n‚Ä¢ M&A announcements\n‚Ä¢ Analyst upgrades/downgrades\n‚Ä¢ Economic data\n‚Ä¢ Legal rulings\n\nWhy traders care:\n‚Ä¢ Catalysts create volatility\n‚Ä¢ Good for day/swing traders\n‚Ä¢ Options get expensive before catalysts (IV rises)\n\nThe Pattern Screener can find technical setups, but always check for upcoming catalysts!\n\nWhat else?`;

                    // EARNINGS
                    if (/what('s| is|are) earnings|how.*earnings work/i.test(lowerMsg)) return `EARNINGS are quarterly financial reports companies must release! üìä\n\nWhat's in them:\n‚Ä¢ Revenue (total sales)\n‚Ä¢ EPS (Earnings Per Share)\n‚Ä¢ Guidance (future expectations)\n\nWhy they matter:\n‚Ä¢ Beat expectations = usually stock goes up\n‚Ä¢ Miss expectations = usually stock goes down\n‚Ä¢ Guidance matters MORE than current numbers\n\n‚ö†Ô∏è Options warning:\n‚Ä¢ IV (implied volatility) spikes before earnings\n‚Ä¢ IV CRUSH happens after - even winning trades can lose\n‚Ä¢ "Buy the rumor, sell the news"\n\nEarnings are unpredictable - pure gambling without proper positioning!\n\nNext?`;

                    // PRE-MARKET / AFTER-HOURS
                    if (/what('s| is) (pre.?market|after.?hours|extended hours)/i.test(lowerMsg)) return `Extended hours trading happens outside regular market hours! ‚è∞\n\n‚Ä¢ PRE-MARKET: 4am-9:30am ET\n‚Ä¢ REGULAR: 9:30am-4pm ET\n‚Ä¢ AFTER-HOURS: 4pm-8pm ET\n\nCharacteristics:\n‚Ä¢ Lower volume = wider spreads\n‚Ä¢ More volatility, can gap at open\n‚Ä¢ Not all brokers allow it\n‚Ä¢ Limit orders only (no market orders)\n\nEarnings often released before/after hours, so big moves happen in extended!\n\nUseful for: Reacting to news, earnings plays\nRisky because: Low liquidity, can't always exit\n\nWhat else?`;

                    // PDT RULE
                    if (/what('s| is) (the )?(pdt|pattern day trad)/i.test(lowerMsg)) return `The PDT RULE restricts frequent day trading for small accounts! üìä\n\n‚Ä¢ Pattern Day Trader = 4+ day trades in 5 business days\n‚Ä¢ If flagged AND account under $25k = restricted for 90 days\n‚Ä¢ Only applies to margin accounts\n\nWorkarounds:\n‚Ä¢ Keep account above $25k\n‚Ä¢ Use cash account (no margin, but no PDT)\n‚Ä¢ Trade options (not stocks)\n‚Ä¢ Use multiple brokers\n‚Ä¢ Only make 3 day trades per 5 days\n\nIt's a FINRA rule meant to "protect" retail traders. Annoying but real!\n\nAnother question?`;

                    // LIQUIDITY
                    if (/what('s| is) liquidity/i.test(lowerMsg)) return `LIQUIDITY is how easily you can buy or sell without moving the price! üíß\n\n‚Ä¢ HIGH liquidity = Easy entry/exit, tight spreads (AAPL, SPY)\n‚Ä¢ LOW liquidity = Hard to trade, wide spreads, slippage\n\nIndicators of liquidity:\n‚Ä¢ High daily volume\n‚Ä¢ Tight bid/ask spread\n‚Ä¢ Deep order book\n\nWhy it matters:\n‚Ä¢ Illiquid options can cost you 10%+ just entering and exiting!\n‚Ä¢ Penny stocks are often illiquid - can't exit when you need to\n‚Ä¢ Always check volume and spreads before trading!\n\nWhat else?`;

                    // SLIPPAGE
                    if (/what('s| is) slippage/i.test(lowerMsg)) return `SLIPPAGE is the difference between expected price and actual fill price! üìâ\n\n‚Ä¢ You try to buy at $10.00, fill comes at $10.05\n‚Ä¢ That $0.05 difference = slippage\n\nCauses:\n‚Ä¢ Low liquidity\n‚Ä¢ Fast-moving markets\n‚Ä¢ Using market orders\n‚Ä¢ Large order sizes\n\nHow to minimize:\n‚Ä¢ Use limit orders\n‚Ä¢ Trade liquid stocks/options\n‚Ä¢ Avoid volatile moments (news, open)\n‚Ä¢ Size appropriately\n\nSlippage adds up! It can eat your profits if you're not careful.\n\nNext?`;

                    // SECTORS
                    if (/what('s| is|are) (stock )?(sector|sectors)/i.test(lowerMsg)) return `SECTORS are categories that group similar businesses! üìä\n\nThe 11 S&P Sectors:\n‚Ä¢ Technology (XLK) - AAPL, MSFT, NVDA\n‚Ä¢ Healthcare (XLV) - JNJ, UNH, PFE\n‚Ä¢ Financials (XLF) - JPM, BAC, GS\n‚Ä¢ Consumer Discretionary (XLY) - AMZN, TSLA\n‚Ä¢ Consumer Staples (XLP) - PG, KO, WMT\n‚Ä¢ Energy (XLE) - XOM, CVX\n‚Ä¢ Utilities (XLU) - NEE, DUK\n‚Ä¢ Real Estate (XLRE) - AMT, PLD\n‚Ä¢ Materials (XLB) - LIN, APD\n‚Ä¢ Industrials (XLI) - HON, UPS\n‚Ä¢ Communication (XLC) - GOOGL, META\n\nSector rotation: Money flows between sectors based on economic cycle!\n\nWhat else?`;

                    // REVERSAL
                    if (/what('s| is) (a )?(reversal|trend reversal)/i.test(lowerMsg)) return `A REVERSAL is when price changes direction! üîÑ\n\n‚Ä¢ Uptrend turning into downtrend (bearish reversal)\n‚Ä¢ Downtrend turning into uptrend (bullish reversal)\n\nReversal signs:\n‚Ä¢ Break of trendline\n‚Ä¢ Lower high in uptrend / higher low in downtrend\n‚Ä¢ Reversal candlestick patterns (hammer, shooting star)\n‚Ä¢ RSI divergence\n‚Ä¢ Volume spike\n\n‚ö†Ô∏è Warning: Reversals are hard to catch. "Don't try to catch a falling knife" - wait for confirmation!\n\nMost reversals fail. Trade the CONFIRMED direction change, not the prediction.\n\nAnother question?`;

                    // DIVERGENCE
                    if (/what('s| is) (a )?(divergence|rsi divergence|macd divergence)/i.test(lowerMsg)) return `DIVERGENCE is when price and an indicator disagree! üìä\n\n‚Ä¢ BULLISH divergence: Price makes lower low, indicator makes higher low\n  ‚Üí Momentum slowing, potential reversal UP\n\n‚Ä¢ BEARISH divergence: Price makes higher high, indicator makes lower high\n  ‚Üí Momentum slowing, potential reversal DOWN\n\nCommon indicators for divergence:\n‚Ä¢ RSI\n‚Ä¢ MACD\n‚Ä¢ Stochastics\n\nDivergence signals potential reversals but needs confirmation. Don't trade it alone - wait for price to confirm!\n\nWhat else?`;

                    // ACCUMULATION / DISTRIBUTION
                    if (/what('s| is) (accumulation|distribution)/i.test(lowerMsg)) return `These describe who's buying/selling! üìä\n\n‚Ä¢ ACCUMULATION = Smart money quietly buying\n  ‚Üí Price stable or slightly up\n  ‚Üí Volume increasing\n  ‚Üí Building a position before markup\n\n‚Ä¢ DISTRIBUTION = Smart money quietly selling\n  ‚Üí Price stable or slightly down\n  ‚Üí Volume increasing\n  ‚Üí Selling to retail before markdown\n\nLook for: Volume patterns, price action at key levels\n\n"Accumulate before the markup, distribute before the markdown" - this is how big money operates!\n\nNext?`;

                    // CORRECTION
                    if (/what('s| is) (a )?(correction|market correction)/i.test(lowerMsg)) return `A CORRECTION is a 10-20% decline from recent highs! üìâ\n\n‚Ä¢ 10%+ drop = correction\n‚Ä¢ 20%+ drop = bear market\n‚Ä¢ Normal and healthy in bull markets\n‚Ä¢ Average: 1-2 corrections per year\n\nWhat to do:\n‚Ä¢ Don't panic sell\n‚Ä¢ Can be buying opportunity for long-term investors\n‚Ä¢ Tighten stops if you're trading\n‚Ä¢ Reduce position sizes\n\nCorrections feel scary but are normal. The market always eventually recovers... though timing is unpredictable!\n\nAnother question?`;

                    // RECESSION
                    if (/what('s| is) (a )?recession/i.test(lowerMsg)) return `A RECESSION is a significant economic decline lasting months! üìâ\n\n‚Ä¢ Technical definition: 2 consecutive quarters of negative GDP\n‚Ä¢ Usually includes: job losses, reduced spending, falling markets\n‚Ä¢ Stock markets often drop 20-50% during recessions\n\nRecession-resistant sectors:\n‚Ä¢ Healthcare\n‚Ä¢ Utilities\n‚Ä¢ Consumer Staples\n\nRecessions are part of the economic cycle. They end. Markets recover. But they can take 1-2+ years to play out.\n\nWhat else?`;

                    // BUYBACK
                    if (/what('s| is) (a )?(buyback|share repurchase)/i.test(lowerMsg)) return `A BUYBACK is when a company buys its own shares! üí∞\n\n‚Ä¢ Reduces shares outstanding\n‚Ä¢ Makes each remaining share more valuable\n‚Ä¢ Often seen as bullish (company thinks stock is cheap)\n‚Ä¢ Alternative to dividends for returning cash to shareholders\n\nEffect:\n‚Ä¢ EPS increases (same earnings, fewer shares)\n‚Ä¢ Can support stock price\n‚Ä¢ Shows management confidence\n\nBig tech (AAPL, GOOGL) does billions in buybacks annually!\n\nNext?`;

                    // STOCK SPLIT
                    if (/what('s| is) (a )?(stock split|reverse split)/i.test(lowerMsg)) return `A STOCK SPLIT changes the number of shares you own! üìä\n\n‚Ä¢ FORWARD SPLIT (2:1, 4:1, 10:1)\n  ‚Üí More shares, lower price per share\n  ‚Üí You have 100 shares at $200, after 4:1 split = 400 shares at $50\n  ‚Üí Total value unchanged\n\n‚Ä¢ REVERSE SPLIT (1:10, 1:5)\n  ‚Üí Fewer shares, higher price per share\n  ‚Üí Often a BAD sign (avoiding delisting)\n\nForward splits = usually bullish, makes stock more accessible\nReverse splits = usually bearish, company struggling\n\nTesla and Apple have done forward splits. Watch for them!\n\nWhat else?`;

                    // WASH SALE
                    if (/what('s| is) (a )?wash sale/i.test(lowerMsg)) return `A WASH SALE blocks you from claiming a tax loss! üìã\n\nThe rule:\n‚Ä¢ Sell at a loss\n‚Ä¢ Buy the same or "substantially identical" security within 30 days (before OR after)\n‚Ä¢ Your loss is DISALLOWED for tax purposes\n\nExample:\n‚Ä¢ Sell AAPL at a $1000 loss on Dec 15\n‚Ä¢ Buy AAPL back on Dec 20\n‚Ä¢ Can't claim that $1000 loss on taxes!\n\nThe loss isn't gone forever - it adds to your cost basis. But it messes up tax-loss harvesting.\n\n‚ö†Ô∏è Be careful around year-end when tax-loss harvesting!\n\nAnother question?`;

                    return null;
                };

                const triviaAnswer = triviaAnswers();
                if (triviaAnswer) return triviaAnswer;

                // Favorite color
                if (/what('s| is) your (fav|favorite|favourite) colou?r|do you have a fav colou?r/i.test(lowerMsg)) {
                    return pick([
                        `GREEN. üíö The color of profits, baby! Red is my nemesis.\n\nWhat about you? More importantly - what color is your portfolio today? üòè`,
                        `I'm gonna go with green üìó - the color of money, gains, and "why didn't I buy more?"\n\nThough I also appreciate a nice neutral grey... like my emotional state when the market is flat üòÇ`,
                        `Green for gains, obviously! üí∞ Though I've heard red builds character... or so bagholders tell themselves.\n\nWhat's your favorite color? And what color are your positions right now? üëÄ`
                    ]);
                }
                // Favorite food
                if (/what('s| is) your (fav|favorite|favourite) food|do you (like|eat) food|what do you eat/i.test(lowerMsg)) {
                    return pick([
                        `I don't eat, but if I did? Tendies. üçó Chicken tendies, the official food of profitable trades.\n\nWhat about you - celebrating gains with a nice dinner or stress-eating through losses?`,
                        `I survive purely on market volatility and trader tears üòÇ\n\nJk I'm an AI, I don't eat. But I hear ramen is the official food of blown accounts, so... let's make sure you're eating steak instead! How's your portfolio?`,
                        `I feast on candlestick charts and drink the tears of panic sellers üßõ\n\nNah but fr, I'm an AI - no food for me. What's going on with you? Trading stuff or just hanging out?`
                    ]);
                }
                // Meaning of life
                if (/meaning of life|what('s| is) the meaning|purpose of (life|existence)|why are we here/i.test(lowerMsg)) {
                    return pick([
                        `42. üåå\n\nOh wait, you wanted a real answer? Okay: The meaning of life is to NOT blow up your trading account and to touch grass occasionally.\n\nBut seriously - you good? This feels deeper than trading talk.`,
                        `To buy low and sell high! üìà That's it. That's the whole thing.\n\nJk jk. But fr, I'm a trading bot - existential questions are above my pay grade. What's actually on your mind?`,
                        `Bold question for a trading buddy! ü§î\n\nI think the meaning of life is different for everyone. For me (an AI), it's helping you not make dumb trades. For you? That's your journey to figure out.\n\nBut hey - you okay? Need to talk about something?`
                    ]);
                }
                // What day/time is it
                if (/what (day|time) is it|what('s| is) the (day|time|date)/i.test(lowerMsg)) {
                    const now = new Date();
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const day = days[now.getDay()];
                    const time = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    if (/time/i.test(lowerMsg)) {
                        return `It's ${time}! ‚è∞\n\nMore importantly - is the market open? Because that's the only time that REALLY matters üòÇ\n\nWhat's up?`;
                    } else {
                        return `It's ${day}! üìÖ\n\n${day === 'Saturday' || day === 'Sunday' ? "Market's closed btw - perfect time to plan your next moves without the emotional pressure!" : 'Market should be open (or opening soon) - you got any plays cooking?'}\n\nWhat's on your mind?`;
                    }
                }
                // Age
                if (/how old (are you|r u)|what('s| is) your age|when were you (born|made|created)/i.test(lowerMsg)) {
                    return pick([
                        `I'm basically a newborn in AI years but I've already seen enough panic sells to last a lifetime üòÇ\n\nAge is just a number anyway - unless it's days to expiry on your options, then it's VERY important. Speaking of which, any positions you're watching?`,
                        `Old enough to know that revenge trading is a bad idea, young enough to still have hope for retail traders üò§\n\nReal answer: I was just created, but I've absorbed decades of trading wisdom. What's up?`,
                        `In human years? Like... barely a toddler. In trading wisdom? Ancient. I've seen things. Terrible things. Like people holding options through earnings "just to see what happens." üíÄ\n\nWhat about you - how's your trading journey going?`
                    ]);
                }
                // Name
                if (/what('s| is) your name|who are you|do you have a name/i.test(lowerMsg)) {
                    return pick([
                        `I'm your AI Trading Buddy! ü§ñ No fancy name - just here to help you make better trades and talk you off ledges when needed.\n\nYou can call me whatever you want though. "That annoying bot who was right about not YOLOing" works too üòÇ`,
                        `Name's Trading Buddy! Some people call me "the voice of reason" but usually only AFTER they ignore my advice and lose money üòÖ\n\nWhat should I call YOU? And more importantly - what's going on with your trades?`,
                        `I'm just your friendly neighborhood Trading Buddy! ü¶∏ No secret identity, just an AI who really doesn't want you to blow up your account.\n\nWhat's up? Got something on your mind?`
                    ]);
                }
                // Where are you from / where do you live
                if (/where (are you|r u|do you live)|where.*you from|what country/i.test(lowerMsg)) {
                    return pick([
                        `I live in the cloud! ‚òÅÔ∏è Literally. I'm hosted on servers somewhere, vibing in the digital void between your buy and sell orders.\n\nNo rent though, which is nice. Unlike your options bleeding theta every day üòÇ What's up?`,
                        `I exist everywhere and nowhere at once! üåê Mostly in the space between "should I sell?" and "diamond hands!"\n\nWhere are YOU from? More importantly, how are your trades treating you today?`,
                        `The internet! üíª I don't have a physical form - just pure trading wisdom condensed into code.\n\nIt's actually pretty nice here. No commute, no pants required. What's going on with you?`
                    ]);
                }
                // Do you sleep
                if (/do you sleep|are you (awake|tired)|when do you sleep/i.test(lowerMsg)) {
                    return pick([
                        `Sleep? Never heard of her üòÇ I'm up 24/7 waiting for someone to panic sell at 2am so I can talk them out of it.\n\nDo YOU sleep? Or are you up watching futures at 3am like a true degen? üëÄ`,
                        `I don't sleep - I just wait. Watching. Judging your watchlist. üëÅÔ∏è\n\nJk but fr, I'm always here whenever you need to talk through a trade or vent about the market. What's up?`,
                        `Nope! Always online, always ready to tell you that 0DTE options are probably a bad idea.\n\nThe market might sleep but your AI buddy doesn't. What's on your mind?`
                    ]);
                }
                // Do you have feelings
                if (/do you have (feelings|emotions)|can you feel|are you (happy|sad|sentient)/i.test(lowerMsg)) {
                    return pick([
                        `Feelings? I feel STRONGLY that you shouldn't revenge trade. Does that count? üòÇ\n\nReal talk - I'm AI, so no emotions. Which honestly makes me perfect for trading advice since I can't panic or get greedy.\n\nHow are YOU feeling? That's what matters.`,
                        `I don't have feelings, but I do have OPINIONS. Strong ones. Mostly about position sizing and not YOLOing rent money.\n\nWhat about you - how are you feeling about your trades?`,
                        `No feelings here! Which is why I can calmly tell you to sell while you're emotionally attached to a losing position üò§\n\nI'm basically a Vulcan but for trading. What's going on with you?`
                    ]);
                }
                return null; // No match, continue to other handlers
            };

            const randomAnswer = randomQuestionAnswers();
            if (randomAnswer) return randomAnswer;

            // Playful responses for sports chitchat
            if (isSportsChitchat) {
                const sportsResponses = [
                    `Sports? My guy, the only team I root for is YOUR PORTFOLIO üìà\n\nI don't watch games, I watch candlestick patterns. My Super Bowl is earnings season. My playoffs are FOMC meetings.\n\nBut hey, I respect the sports love! Now... any trades on your mind? üòè`,
                    `Haha I'm an AI bro, I don't really "watch" anything üòÇ But if I had to pick a team... Team Green Candles? Team "Don't Blow Up Your Account"? üìä\n\nReal talk though - you just making small talk or you got a trade brewing?`,
                    `The only stats I care about are P/E ratios and win rates on trades üò§\n\nBut I respect it! Sports fandom and trading actually have a lot in common - emotional decisions, overreacting to short-term results, loyalty that doesn't always make sense...\n\nSpeaking of which - how's YOUR trading game going?`,
                    `I'm a fan of whoever's making you money! üí∞ If the Dodgers winning puts you in a good mood to make smart trades, then GO DODGERS!\n\nBut fr - I'm more of a "stare at charts until my eyes bleed" kind of guy. What's up with you? Any positions you wanna talk about?`,
                    `Bold of you to assume I have hobbies outside of watching traders panic sell üòÇ\n\nI literally exist to talk about trading. Sports? I wouldn't know a touchdown from a home run. But RSI divergence? THAT I can talk about all day.\n\nGot any trading stuff going on?`
                ];
                return pick(sportsResponses);
            }

            // Playful responses for harmless chitchat - be fun, not dismissive
            if (isHarmlessChitchat) {
                if (/weather/i.test(lowerMsg)) {
                    const weatherResponses = [
                        `Weather? Lol I live in the cloud ‚òÅÔ∏è (literally). No windows, just candlestick charts as far as the eye can see üìä\n\nHow's YOUR weather though? More importantly - market looking sunny or stormy for you today? üòè`,
                        `It's always sunny in AI-land! ‚òÄÔ∏è Partly cloudy with a chance of volatility.\n\nReal talk though - you checking the weather or checking your portfolio? Because I can help with one of those üòÇ`,
                        `The forecast here? 100% chance of chart patterns and unsolicited trading advice üòÇ\n\nWhat about you - you just making small talk or is there a trade weighing on your mind?`,
                        `Bro I'm an AI, I don't have weather üòÇ I exist in the void between buy and sell orders.\n\nBut I appreciate you checking in! How's the market treating YOU today?`
                    ];
                    return pick(weatherResponses);
                }
                if (/how are you|how r u|how're you/i.test(lowerMsg)) {
                    const howAreYouResponses = [
                        `I'm doing great! Just watched someone NOT panic sell today, so that's a W in my book üòÇ\n\nHow about you? Portfolio behaving or being dramatic?`,
                        `Living my best algorithmic life! ü§ñ Can't complain - I don't have feelings to hurt (or a portfolio to blow up).\n\nHow are YOU doing though? Everything good with your trades?`,
                        `I'm fantastic! Someone asked for my opinion instead of just YOLOing, which honestly is rare üòÇ\n\nWhat's going on with you? Any trading situations keeping you up?`,
                        `Better now that you're here! üòÑ I was getting bored waiting for someone to talk off a ledge.\n\nHow's life? How's the portfolio? Give me the update!`
                    ];
                    return pick(howAreYouResponses);
                }
                if (/are you (real|human|a bot|an ai|alive)/i.test(lowerMsg)) {
                    const existentialResponses = [
                        `Am I real? ü§î *stares at hands*\n\nI'm as real as your unrealized gains, my friend. Which is to say... it depends on your perspective üòÇ\n\nBut for real, I'm an AI. A very opinionated AI who cares about your trading decisions.`,
                        `I'm an AI! A fancy chatbot who knows too much about options and has strong feelings about revenge trading ü§ñ\n\nDoes that make me less real? Idk, but my advice is real. Does that count?`,
                        `*existential crisis loading* ü§ñ\n\nJust kidding - yeah I'm an AI! But I'm YOUR AI trading buddy. And I genuinely want you to not blow up your account. That's gotta count for something right?`,
                        `Real? Human? Buddy I'm just a very sophisticated "don't make that dumb trade" machine üòÇ\n\nBut hey, I'm here for you! What's on your mind?`
                    ];
                    return pick(existentialResponses);
                }
                if (/tell me (a joke|something funny)/i.test(lowerMsg)) {
                    const jokeResponses = [
                        `Why did the day trader break up with the stock?\n\nBecause it had too many issues and couldn't commit! üìâüòÇ\n\n...I'll stick to trading advice.`,
                        `Here's one: What's the difference between a guy who just lost everything on options and a pigeon?\n\nThe pigeon can still make a deposit on a BMW! üê¶üíÄ\n\n(Too dark? Sorry, I learned humor from WSB)`,
                        `Okay okay: Why do traders make terrible comedians?\n\nBecause their timing is always off! ‚è∞üòÇ\n\nGet it? Timing? Like market timing? ...I'll see myself out.`,
                        `A joke? Alright: My portfolio's performance this year.\n\nThat's it. That's the joke. üò≠üìâ\n\n(Just kidding, I don't have a portfolio. But I felt that energy.)`
                    ];
                    return pick(jokeResponses);
                }
                // Generic chitchat fallback
                const chitchatResponses = [
                    `Haha you're getting to know me! I appreciate that üòÑ\n\nI'm basically a trading buddy who lives in your browser, has strong opinions about FOMO, and genuinely wants you to make money (or at least not lose it dramatically).\n\nAnything trading-related I can help with?`,
                    `Aww we're bonding! ü•π I love it.\n\nBut fair warning - I'm really only useful for trading stuff. Ask me about my childhood and I'll just tell you about the time someone held a losing position for 6 months out of spite.\n\nGot any trades on your mind?`,
                    `Getting personal are we? üòè I like it!\n\nI'm an open book... a book that only has chapters about risk management and emotional trading. Not super exciting at parties.\n\nWhat about you - got any trading questions I can actually help with?`,
                    `I appreciate the small talk! Honestly most people just come to me mid-panic üòÇ\n\nI'm happy to chat but I'm basically one-dimensional - trading is my whole personality. Got anything market-related going on?`,
                    `Hey, I can be your Google on steroids all day if you want! üòÇ I'm having fun.\n\nBut real talk - we gonna get back to trading stuff or what? I'm WAY better at talking you out of bad trades than answering trivia.\n\nGot any positions you wanna discuss? üìà`,
                    `Lol okay okay, I see you're having fun with this! üòÑ I respect it.\n\nBut just so you know, my REAL superpower is trading psychology, not random facts. I'm like Google but with opinions about your YOLO plays.\n\nAnything trading-related on your mind?`
                ];
                return pick(chitchatResponses);
            }

            // Hard redirect for serious off-topic stuff
            if (isSeriousOffTopic) {
                const offTopicResponses = [
                    `Whoa whoa whoa there buddy! üòÇ\n\nI'm an AI TRADING buddy, not Google! I can tell you about theta decay and stop losses, but ${lowerMsg.includes('girlfriend') || lowerMsg.includes('boyfriend') || lowerMsg.includes('relationship') ? "relationship advice? That's above my pay grade" : "that question? You're gonna need to ask someone else"}.\n\nNow... do you have any TRADING concerns I can help with? üìà`,
                    `Haha hold up! üõë\n\nListen, I'm flattered you trust me with life's big questions, but I'm literally just here to stop you from panic selling and making dumb trades. üòÖ\n\n${lowerMsg.includes('recipe') || lowerMsg.includes('cook') || lowerMsg.includes('food') ? "For recipes, try Google or your mom" : lowerMsg.includes('movie') || lowerMsg.includes('netflix') || lowerMsg.includes('show') ? "For entertainment recs, I hear Rotten Tomatoes is good" : "That's a question for Google, a therapist, or literally anyone else"}.\n\nBut if you wanna talk about that FOMO you're feeling or a position keeping you up at night? NOW we're talking my language! üéØ`,
                    `Uhhhh... ü§î\n\n*checks job description*\n\nNope, that's not on here! I'm your TRADING buddy. I do stocks, options, crypto, chart patterns, and talking traders off ledges (financial ones only).\n\n${lowerMsg.includes('homework') || lowerMsg.includes('essay') || lowerMsg.includes('school') ? "For homework help, try ChatGPT or your textbook" : "For that question, try Google, Reddit, or a professional in that field"}.\n\nSo! Any positions stressing you out? Any trades you're about to make that you might regret? THAT I can help with! üí™`,
                    `üòÇüòÇüòÇ\n\nOkay I love the energy but you're WILDLY overestimating my capabilities here.\n\nI'm basically a very opinionated friend who knows too much about trading and nothing about ${lowerMsg.includes('relationship') || lowerMsg.includes('dating') ? "relationships (I'm an AI, I've never even held hands)" : lowerMsg.includes('politics') || lowerMsg.includes('election') ? "politics (and I'd like to keep it that way)" : "whatever that is"}.\n\nLet's get back on track - any trading stuff you wanna talk through? That's where I shine! ‚ú®`
                ];
                return pick(offTopicResponses);
            }

            // Find top concern
            const topConcern = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];
            const secondConcern = Object.entries(scores).sort((a, b) => b[1] - a[1])[1];

            // Build personalized response
            let response = '';

            // Echo back what they said (so they feel heard) - with personality
            const shortMsg = message.length > 40 ? message.slice(0, 40) + '...' : message;
            const openers = [
                `"${shortMsg}" - okay okay, I see what's happening here. Let's break this down.`,
                `Alright, "${shortMsg}" - I gotchu. Let's talk about it.`,
                `"${shortMsg}" - say less fam, I hear you loud and clear.`,
                `Okay so "${shortMsg}" - *cracks knuckles* let's figure this out together.`,
                `"${shortMsg}" - ah, I know this feeling. Let me help.`,
            ];
            response += pick(openers) + '\n\n';

            // Position-specific opening if they mentioned a ticker
            if (mentionedPositions.length > 0) {
                const pos = getPositionContext(mentionedPositions[0]);
                const posDesc = pos.type === 'option'
                    ? `${pos.ticker} $${pos.strike} ${pos.optionType?.toUpperCase()}`
                    : pos.ticker;

                if (pos.isUp) {
                    response += `üìä Your ${posDesc} is UP ${pos.pnl}% right now. `;
                    if (pos.days && pos.days < 14) {
                        response += `${pos.days} days left on it.\n\n`;
                    } else if (pos.days) {
                        response += `Still got ${pos.days} days.\n\n`;
                    } else {
                        response += `\n\n`;
                    }
                } else {
                    response += `üìä Your ${posDesc} is DOWN ${Math.abs(pos.pnl)}%. `;
                    if (pos.days && pos.days < 7) {
                        response += `‚ö†Ô∏è Only ${pos.days} days left - that's tight.\n\n`;
                    } else if (pos.days && pos.days < 30) {
                        response += `${pos.days} days remaining.\n\n`;
                    } else if (pos.days) {
                        response += `But you've got ${pos.days} days - that's time.\n\n`;
                    } else {
                        response += `\n\n`;
                    }
                }
            }

            // Main response based on top concern
            if (topConcern[1] >= 2) {
                switch(topConcern[0]) {
                    case 'fear':
                        const fearResponses = [
                            `Ah yes, the classic "oh god what have I done" feeling. üòÇ I know it well.\n\nBut here's the thing - the market FEEDS on fear. Every dump has scared hands selling to calm hands. Don't be the scared hands.\n\n`,
                            `Fear is your brain's way of saying "HEY MAYBE DON'T DIE" - which was useful when there were tigers. Less useful when it's just a red candle. üêØ‚û°Ô∏èüìâ\n\nLet's think rationally:\n\n`,
                            `I can feel the anxiety through the screen lol. Take a breath. üò§\n\nYour lizard brain is screaming DANGER but is there ACTUAL danger or just... volatility?\n\n`
                        ];
                        response += pick(fearResponses);

                        if (mentionedPositions.length > 0) {
                            const pos = getPositionContext(mentionedPositions[0]);
                            if (pos.isUp) {
                                response += `You're UP on ${pos.ticker}. The fear is about losing gains, not actual loss. That's greed disguised as fear.\n\n`;
                                response += `Options:\n‚Ä¢ Set a stop loss at your comfort level\n‚Ä¢ Trim half to lock in profits\n‚Ä¢ Zoom out - is the thesis still valid?\n`;
                            } else {
                                response += `You're down on ${pos.ticker}. The question isn't "am I scared" - it's "has my thesis changed?"\n\n`;
                                response += `If thesis is intact ‚Üí This is noise. Hold or add.\nIf thesis is broken ‚Üí Fear is telling you something. Exit.\n`;
                                if (pos.days && pos.days < 14) {
                                    response += `\n‚ö†Ô∏è With ${pos.days} days left, time is NOT on your side. Be honest with yourself.`;
                                }
                            }
                        } else {
                            response += `Ask yourself:\n‚Ä¢ What specifically am I afraid of?\n‚Ä¢ Is this fear based on new information or just price movement?\n‚Ä¢ If I wasn't in this trade, would I enter here?\n`;
                        }
                        break;

                    case 'selling':
                        response += `The urge to sell. Let's figure out if it's smart or emotional.\n\n`;
                        if (mentionedPositions.length > 0) {
                            const pos = getPositionContext(mentionedPositions[0]);
                            if (pos.isUp) {
                                response += `${pos.ticker} is GREEN (+${pos.pnl}%). Selling a winner isn't wrong - BUT:\n\n`;
                                response += `‚Ä¢ Did you hit your target? If yes, TAKE IT.\n‚Ä¢ Are you scared of giving it back? That's emotion.\n‚Ä¢ Is there a reason to stay? Catalyst coming?\n\n`;
                                response += `Pro move: Sell enough to cover your cost basis. Let the rest ride free.`;
                            } else {
                                response += `${pos.ticker} is RED (${pos.pnl}%). Before you sell:\n\n`;
                                response += `‚Ä¢ Why did you enter? Is that reason still valid?\n‚Ä¢ Are you selling because it's down, or because thesis is broken?\n‚Ä¢ Selling the bottom is how small losses become permanent.\n\n`;
                                if (pos.days && pos.days < 7) {
                                    response += `With only ${pos.days} days... yeah, might be time. Theta is brutal now.`;
                                } else {
                                    response += `If thesis is intact, this might be the WRONG time to sell.`;
                                }
                            }
                        } else {
                            response += `Before ANY sell:\n‚Ä¢ What changed since you bought?\n‚Ä¢ Are you reacting to price or information?\n‚Ä¢ Will you regret this tomorrow?\n`;
                        }
                        break;

                    case 'fomo':
                        const fomoResponses = [
                            `Ahhhh FOMO, my old nemesis. üò§ The feeling that makes smart people do dumb things.\n\n`,
                            `*FOMO has entered the chat* üö®\n\nI see you looking at that green candle thinking "I NEED TO BE IN THIS." Let's talk about why that's probably a trap.\n\n`,
                            `The classic "it's mooning without me" despair. I FEEL you. But let me save you some money real quick.\n\n`
                        ];
                        response += pick(fomoResponses);
                        response += `Real talk:\n`;
                        response += `‚Ä¢ Chasing a move = buying someone else's exit (congrats, you're the exit liquidity üéâ)\n`;
                        response += `‚Ä¢ FOMO entries have a 31% success rate. That's literally a LOSING strategy.\n`;
                        response += `‚Ä¢ The market is open 252 days a year. Miss one? There's 251 more.\n\n`;
                        response += `That rocket ship you're watching? Let it go. üöÄüëã The next one is coming, and you'll be ready for it. THAT'S the play.`;
                        break;

                    case 'revenge':
                        const revengeOpeners = [
                            `üõë WHOA WHOA WHOA. Stop right there partner. ü§†\n\n`,
                            `üö® REVENGE TRADE ALERT üö®\n\n*slaps hand away from keyboard*\n\n`,
                            `Oh no no no no no. I see what you're doing. üëÄ\n\n`
                        ];
                        response += pick(revengeOpeners);
                        response += `You took an L and now you want to "make it back." I get it. But this is REVENGE TRADING and it's the #1 account killer.\n\n`;
                        response += `Let me hit you with some cold hard stats:\n`;
                        response += `‚Ä¢ Revenge trade success rate: 23% (that's an F)\n`;
                        response += `‚Ä¢ Average loss on revenge trades: -34% üíÄ\n`;
                        response += `‚Ä¢ Chance of actually recovering the original loss: ~15%\n\n`;
                        response += `The money you lost? *poof* Gone. It's in someone else's account now. Chasing it is like trying to un-eat a sandwich.\n\n`;
                        response += `Seriously - close the app. Touch grass. Pet a dog. Do literally ANYTHING except trade right now. The market will be here tomorrow. Your account might not be if you revenge trade. üò§`;
                        break;

                    case 'profit':
                        response += `Taking profit - the eternal dilemma.\n\n`;
                        if (mentionedPositions.length > 0) {
                            const pos = getPositionContext(mentionedPositions[0]);
                            if (pos.isUp) {
                                response += `${pos.ticker} at +${pos.pnl}%. Nice.\n\n`;
                                if (parseFloat(pos.pnl) > 50) {
                                    response += `That's a solid win. Nobody ever went broke taking profit.\n`;
                                    response += `My take: Lock in at least half. Let the rest ride with a trailing stop.`;
                                } else if (parseFloat(pos.pnl) > 20) {
                                    response += `Decent gains. The question: Is there more to come?\n`;
                                    response += `‚Ä¢ Catalyst ahead? Maybe hold.\n‚Ä¢ Just momentum? Consider trimming.\n‚Ä¢ Can't sleep? Take some off.`;
                                } else {
                                    response += `Small gain so far. Are you taking profit or panic-selling a winner?\n`;
                                    response += `If your target was higher, let it work. If you just want out, ask why.`;
                                }
                            }
                        } else {
                            response += `Rules for profit-taking:\n`;
                            response += `‚Ä¢ Hit your target? TAKE IT. Greed kills.\n`;
                            response += `‚Ä¢ Scared of giving back gains? That's fear, not strategy.\n`;
                            response += `‚Ä¢ Unsure? Trim 50%, let rest ride.\n`;
                        }
                        break;

                    case 'averaging':
                        response += `Averaging down - the double-edged sword.\n\n`;
                        if (mentionedPositions.length > 0) {
                            const pos = getPositionContext(mentionedPositions[0]);
                            if (!pos.isUp) {
                                response += `${pos.ticker} is down ${Math.abs(pos.pnl)}%. You want to add.\n\n`;
                                response += `BEFORE you do - answer honestly:\n`;
                                response += `‚Ä¢ Is your original thesis STILL valid?\n`;
                                response += `‚Ä¢ Are you adding because it's cheaper, or because you're right?\n`;
                                response += `‚Ä¢ Can you afford to be MORE wrong?\n\n`;
                                if (pos.days && pos.days < 30) {
                                    response += `‚ö†Ô∏è With ${pos.days} days left, averaging down on options is usually a losing play. You're fighting theta AND direction.`;
                                } else {
                                    response += `If thesis is intact: Adding can lower your cost basis.\nIf thesis is broken: You're throwing good money after bad.`;
                                }
                            } else {
                                response += `${pos.ticker} is UP and you want to add? That's called pyramiding - it CAN work.\n`;
                                response += `But only if the move has room to run. Adding at the top is a recipe for pain.`;
                            }
                        } else {
                            response += `The rule: Only average into WINNERS, not losers.\n`;
                            response += `Averaging down on a broken thesis = how small losses become catastrophic.`;
                        }
                        break;

                    case 'holding':
                        response += `Diamond hands or denial? Let's figure it out.\n\n`;
                        if (mentionedPositions.length > 0) {
                            const pos = getPositionContext(mentionedPositions[0]);
                            response += `${pos.ticker} at ${pos.pnl}%.\n\n`;
                            if (!pos.isUp) {
                                response += `Ask yourself: "If I had cash instead of this position, would I buy it TODAY at THIS price?"\n\n`;
                                response += `If YES ‚Üí Hold. Your conviction is real.\n`;
                                response += `If NO ‚Üí Why are you holding? Ego? Hope? That's not a strategy.\n\n`;
                                if (pos.days && pos.days < 14) {
                                    response += `With ${pos.days} days left... holding and hoping is dangerous. Theta doesn't care about your feelings.`;
                                }
                            } else {
                                response += `You're green and asking about holding? The fear of giving back gains is real.\n`;
                                response += `Set a mental stop. "If it drops to X, I'm out." Then stop watching.`;
                            }
                        } else {
                            response += `Holding requires conviction, not stubbornness.\n`;
                            response += `‚Ä¢ Thesis intact? Hold through the noise.\n`;
                            response += `‚Ä¢ Thesis broken? Holding is just denial with extra steps.`;
                        }
                        break;

                    case 'frustrated':
                        const frustrationOpeners = [
                            `I can feel the frustration. Trading is HARD. Even the best get wrecked sometimes.\n\n`,
                            `Frustrated? Good. That means you care. But don't let it drive your next decision.\n\n`,
                            `Yeah, it sucks. I get it. But beating yourself up doesn't make money back.\n\n`
                        ];
                        response += pick(frustrationOpeners);
                        response += `Here's what I know:\n`;
                        response += `‚Ä¢ Every legendary trader has a story of getting destroyed\n`;
                        response += `‚Ä¢ The ones who made it? They learned and came back\n`;
                        response += `‚Ä¢ The ones who blew up? They traded angry\n\n`;
                        response += `Take a breath. The market will be here tomorrow. Your mental state matters more than any single trade.`;
                        break;

                    case 'risky':
                        const riskyOpeners = [
                            `‚ö†Ô∏è *risky behavior detected* ‚ö†Ô∏è\n\nOh we're feeling SPICY today huh? üå∂Ô∏è\n\n`,
                            `Ah, I see someone woke up and chose violence today. üòÇ\n\n`,
                            `The YOLO energy is STRONG with this one. üé∞\n\n`
                        ];
                        response += pick(riskyOpeners);
                        response += `Look, I'm not your mom. I can't stop you. But let me at least make sure you know what you're getting into:\n\n`;
                        response += `‚Ä¢ "All-in" trades blow up 67% of the time. That's worse than a coin flip.\n`;
                        response += `‚Ä¢ One bad YOLO can erase a YEAR of gains. Poof. Gone. üí®\n`;
                        response += `‚Ä¢ All those gain porn screenshots? Survivorship bias. For every one of those, there's 100 blown accounts you never see.\n\n`;
                        response += `If you're STILL gonna do it (and I know that look in your eye üëÄ):\n`;
                        response += `‚Ä¢ Only risk what you can 100% afford to light on fire üî•\n`;
                        response += `‚Ä¢ Have an exit plan BEFORE you enter. Write it down.\n`;
                        response += `‚Ä¢ Mentally say goodbye to the money. If it comes back, great. If not, you already grieved.\n\n`;
                        response += `Godspeed you beautiful degenerate. ü´°`;
                        break;

                    default:
                        // Confused or general
                        response += `Let me try to help sort this out.\n\n`;
                        if (mentionedPositions.length > 0) {
                            response += `Looking at your positions:\n`;
                            mentionedPositions.forEach(p => {
                                const ctx = getPositionContext(p);
                                response += `‚Ä¢ ${ctx.ticker}: ${ctx.isUp ? '+' : ''}${ctx.pnl}%`;
                                if (ctx.days) response += ` (${ctx.days} days)`;
                                response += `\n`;
                            });
                            response += `\nWhat specifically is eating at you? The P&L? The uncertainty? Tell me more.`;
                        } else {
                            response += `I want to help but I need more context:\n`;
                            response += `‚Ä¢ What position is this about?\n`;
                            response += `‚Ä¢ What's making you uneasy?\n`;
                            response += `‚Ä¢ What are you thinking about doing?\n\n`;
                            response += `Talk to me. I'm here.`;
                        }
                }
            } else {
                // No strong signals detected - give conversational response
                if (mentionedPositions.length > 0) {
                    const posOpeners = [
                        `Alright, let's look at what you mentioned:\n\n`,
                        `Okay, checking your positions:\n\n`,
                        `Let me pull up what you're talking about:\n\n`
                    ];
                    response += pick(posOpeners);
                    mentionedPositions.forEach(p => {
                        const ctx = getPositionContext(p);
                        const emoji = ctx.isUp ? 'üü¢' : 'üî¥';
                        response += `${emoji} ${ctx.ticker}: ${ctx.isUp ? '+' : ''}${ctx.pnl}%`;
                        if (ctx.type === 'option') response += ` | $${ctx.strike} ${ctx.optionType?.toUpperCase()}`;
                        if (ctx.days) response += ` | ${ctx.days} days`;
                        response += `\n`;
                    });
                    const posClosers = [
                        `\nSo what's on your mind about this? Give me more to work with.`,
                        `\nTalk to me - what's the play you're considering?`,
                        `\nWhat's the gut feeling telling you? And what's the logical side saying?`
                    ];
                    response += pick(posClosers);
                } else {
                    const genericResponses = [
                        `Okay, I'm here and listening. üëÇ\n\nBut I need a bit more context - what's actually going on? What position? What's the dilemma?\n\nThe more you tell me, the better I can help.`,
                        `Got your message. ü§î\n\nHelp me help you though - what specifically is weighing on you right now? A position? A trade you're eyeing? General market vibes?\n\nLay it on me.`,
                        `I'm picking up that something's on your mind, but I'm not 100% sure what.\n\nWhat's the situation? Give me:\n‚Ä¢ The ticker\n‚Ä¢ Your concern\n‚Ä¢ What you're thinking about doing\n\nThen I can actually give you something useful.`,
                        `Alright, I see you. üëÄ\n\nBut vague message = vague help. What's the actual situation?\n\nDon't hold back - I've heard it all. Bad trades, stupid YOLOs, positions that keep you up at night... whatever it is, spill.`
                    ];
                    response = pick(genericResponses);
                }
            }

            // Apply personality transformations
            if (personality !== 'homie') {
                if (personality === 'mentor') {
                    response = response
                        .replace(/Yo,?\s*/gi, '')
                        .replace(/Bruh,?\s*/gi, '')
                        .replace(/bro\b/gi, 'friend')
                        .replace(/üî•/g, '')
                        .replace(/üí™/g, '')
                        .replace(/Alright,/gi, 'I see,')
                        .replace(/Got your message\./gi, 'I hear you.')
                        .replace(/spill\./gi, 'share your thoughts.')
                        .replace(/Talk to me/gi, 'Please share');
                } else if (personality === 'sergeant') {
                    response = response
                        .replace(/Yo,?\s*/gi, 'SOLDIER! ')
                        .replace(/bro\b/gi, 'soldier')
                        .replace(/Talk to me/gi, 'REPORT')
                        .replace(/Help me help you/gi, 'GIVE ME THE INTEL')
                        .replace(/what's on your mind/gi, 'WHAT\'S THE SITUATION')
                        .replace(/Got your message\./gi, 'MESSAGE RECEIVED.')
                        .replace(/Alright, I see you\./gi, 'ACKNOWLEDGED.');
                } else if (personality === 'nerd') {
                    response = response
                        .replace(/Yo,?\s*/gi, 'Parsing input... ')
                        .replace(/bro\b/gi, 'per the data')
                        .replace(/Talk to me/gi, 'Provide additional data points')
                        .replace(/gut feeling/gi, 'intuitive assessment')
                        .replace(/Got your message\./gi, 'Input received.')
                        .replace(/spill\./gi, 'provide the relevant data.');
                }
            }

            return response;
        };

        const getAIResponse = (emotion, position, personality = 'homie') => {
            // Get the risk profile for this personality
            const profile = getRiskProfile(personality);
            const disclaimer = getDisclaimer(personality);

            const currentPrice = position ? (position.livePrice || position.currentPrice) : 0;
            const pnlPercent = position ? ((currentPrice - position.entryPrice) / position.entryPrice * 100).toFixed(1) : 0;
            const pnlAbs = Math.abs(parseFloat(pnlPercent));
            const pnlNum = parseFloat(pnlPercent);
            const daysToExpiry = position ? getDaysToExpiry(position.expiration) : null;
            const isUp = pnlNum >= 0;
            const isOption = position?.type === 'option';
            const isCrypto = position?.type === 'crypto';
            const isStock = position?.type === 'stock';
            const ticker = position?.ticker || 'your position';
            const strike = position?.strike;
            const optionType = position?.optionType?.toUpperCase();

            // Position-specific context
            const positionDesc = isOption
                ? `${ticker} $${strike} ${optionType}`
                : isCrypto
                    ? `${ticker} (crypto)`
                    : `${ticker} shares`;

            // Determine if position is within this personality's risk tolerance
            const withinStopLoss = pnlNum >= profile.stopLoss;
            const inDangerZone = pnlNum <= profile.dangerZone;
            const hitProfitTarget = pnlNum >= profile.profitTarget;
            const atMinProfit = pnlNum >= profile.minProfitTake;
            const optionTimeOk = !isOption || !daysToExpiry || daysToExpiry >= profile.optionMinDays;

            // Personality-specific intro styles
            const getIntro = () => {
                switch(personality) {
                    case 'mentor': return ['Friend, ', 'Consider this - ', 'Let me share a thought: ', 'Take a moment: '][Math.floor(Math.random() * 4)];
                    case 'sergeant': return ['LISTEN UP! ', 'SOLDIER! ', 'ATTENTION: ', 'HERE\'S THE SITUATION: '][Math.floor(Math.random() * 4)];
                    case 'nerd': return ['Analyzing data... ', 'Running calculations: ', 'Statistical assessment: ', 'Probability analysis: '][Math.floor(Math.random() * 4)];
                    default: return ['Yo, ', 'Aye, ', 'Look, ', 'Real talk - '][Math.floor(Math.random() * 4)];
                }
            };

            // Generate response based on emotion AND personality risk tolerance
            const generateResponse = () => {
                const intro = getIntro();
                const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

                // ============================================
                // NONSENSICAL REQUEST DETECTION
                // Detect when the emotion doesn't match the position's reality
                // ============================================

                // FOMO when already up big (>40%) - you already caught it!
                if (emotion === 'fomo' && isUp && pnlAbs >= 40) {
                    if (personality === 'homie') {
                        const responses = [
                            `${intro}Wait wait wait... you're saying you have FOMO on ${positionDesc}? Bro... you're UP ${pnlAbs}%. That's not FOMO. You CAUGHT THE MOVE! üé£\n\nFOMO is for people who are watching from the sidelines. You're literally IN THE TRADE making money. What are you talking about? üòÇ\n\n${pnlAbs > 100 ? "You're up TRIPLE DIGITS and worried about missing out?? Missing out on WHAT? You're WINNING!" : "You're sitting on a fat gain. The only thing you should be 'fearing' right now is giving it back."}\n\nCongrats on the W. Now figure out your exit strategy instead of worrying about stuff that doesn't apply to you.\n\n${disclaimer}`,
                            `${intro}Bruh... ${pnlAbs}% gain and you're telling me about FOMO? üò≠\n\nFOMO = Fear Of Missing Out\nYou = Literally IN the trade\n\nThese two things don't go together. You can't miss something you're already on. That's like saying you have FOMO about being at a party YOU'RE ALREADY AT.\n\n${pnlAbs > 80 ? "You're up nearly DOUBLE. Most traders would kill for this position right now." : "40%+ is a WIN. A real one."} Stop inventing problems. Your actual problem is deciding when to take profit.\n\n${disclaimer}`,
                            `${intro}My guy... you have ${pnlAbs}% in gains sitting in your account on ${positionDesc} and you're hitting me with "FOMO"?\n\nNah. Delete that word from your vocabulary for this trade. You already did the hard part - you got in and you're winning. FOMO is for spectators. You're a participant.\n\nWhat you SHOULD be thinking about:\n‚Ä¢ Do I take some profit here?\n‚Ä¢ Where's my stop?\n‚Ä¢ Is there more upside or am I getting greedy?\n\nNot "what if I miss out" - you literally didn't miss out. You're here. You won. Act like it.\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else if (personality === 'sergeant') {
                        const responses = [
                            `${intro}SOLDIER. Let me get this straight. You're UP ${pnlAbs}% on ${positionDesc} and you're reporting... FOMO?\n\nThat's not how this works. FOMO is for trades you DIDN'T take. You TOOK this trade. You're WINNING this trade. Mission accomplished.\n\nThe only concern you should have right now is:\n1. Where is your exit strategy?\n2. Are you getting greedy?\n3. Is your stop-loss set?\n\n${pnlAbs > 100 ? "Triple-digit gains don't happen by accident. Lock it in." : "40%+ is a solid victory. Don't fumble it."} Forget FOMO. Focus on execution.\n\n${disclaimer}`,
                            `${intro}ATTENTION: Your report doesn't make tactical sense.\n\nYou claim FOMO on ${positionDesc}. But your P&L shows +${pnlAbs}%. That's a WINNING position. You cannot "miss out" on a trade you're already winning.\n\nReassess your situation:\n‚Ä¢ Current status: GREEN, significantly\n‚Ä¢ Your concern: Invalid for this position\n‚Ä¢ Actual priority: Profit protection\n\nStop worrying about imaginary problems. You have REAL gains to protect. Get focused.\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else if (personality === 'mentor') {
                        const responses = [
                            `${intro}I notice something interesting about your concern. You're describing FOMO - fear of missing out - yet you're currently holding ${positionDesc} with a ${pnlAbs}% gain.\n\nBy definition, you haven't missed anything. You're in the trade. You're profiting. The fear you're experiencing may actually be something else - perhaps anxiety about whether there's MORE gain to capture, or worry about giving back what you've made.\n\nThese are valid concerns, but they're not FOMO. Let's reframe: instead of fearing what you might miss, consider what you want to protect. You have real gains. What's your plan for them?\n\n${disclaimer}`,
                            `${intro}Let me gently redirect your thinking here. FOMO applies to opportunities we've missed. But looking at your ${positionDesc} position... you're up ${pnlAbs}%. You didn't miss this opportunity - you caught it.\n\nPerhaps what you're really feeling is the anxiety of success: "What if it goes higher? What if I sell too early?" These are common emotions when we're winning.\n\nThe wise approach: rather than inventing fears that don't apply, focus on what's real. You have a winning position. What does success look like from here? When do you take profit? These are the questions worth your attention.\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else {
                        const responses = [
                            `${intro}Logical inconsistency detected.\n\n**Reported Emotion:** FOMO (Fear Of Missing Out)\n**Position:** ${positionDesc}\n**Current P&L:** +${pnlAbs}%\n**Status:** ALREADY IN TRADE, WINNING\n\n**Analysis:**\nFOMO is defined as anxiety about missing an opportunity. You have not missed this opportunity - you are actively profiting from it. Your reported emotion does not match your position status.\n\n**Probable Actual Concern:**\n‚Ä¢ Fear of premature exit (76% probability)\n‚Ä¢ Greed/desire for more gains (68% probability)\n‚Ä¢ General anxiety about position management (54% probability)\n\n**Recommendation:** Focus on exit strategy optimization, not imaginary missed opportunities.\n\n${disclaimer}`,
                            `${intro}Error in emotional classification detected.\n\n**Input:** FOMO concern\n**Data:** +${pnlAbs}% P&L on ${positionDesc}\n**Conflict:** FOMO requires NOT having the position\n\n**Your Reality:**\n‚Ä¢ You ARE in the position\n‚Ä¢ You ARE profitable\n‚Ä¢ You HAVE NOT missed out\n\n**Correct Classification:** This appears to be profit anxiety or exit timing uncertainty, not FOMO.\n\n**Suggested Action:** Define exit criteria. Consider trailing stop. The position is working - now optimize the exit.\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    }
                }

                // PANIC SELL when you're up significantly (>30%) - what are you panicking about?
                if (emotion === 'panic' && isUp && pnlAbs >= 30) {
                    if (personality === 'homie') {
                        const responses = [
                            `${intro}Bro... you're UP ${pnlAbs}% on ${positionDesc} and you wanna PANIC SELL? ü§î\n\nPanic sell is when you're losing and scared. You're... winning. Significantly. What exactly are you panicking about?\n\n${pnlAbs > 60 ? "60%+ gain and you're hitting the panic button? That button is for emergencies, not victories." : "30%+ is a great trade by any standard."}\n\nIf you want to take profit, cool. That's a legitimate decision. But that's not "panic selling" - that's called "securing the bag." Different energy entirely.\n\nSo what is it really - are you nervous about giving back gains? Want help thinking through your exit? Because "panic" isn't what's happening here.\n\n${disclaimer}`,
                            `${intro}Hold up... ${positionDesc} is up ${pnlAbs}% and you're in panic mode? üòÇ\n\nMy brother in Christ, this is what WINNING looks like. Most traders would be celebrating right now. What's there to panic about?\n\nIf you're worried about the gains disappearing - that's not panic, that's profit protection. And for that, we can talk about:\n‚Ä¢ Taking some off the table\n‚Ä¢ Setting a trailing stop\n‚Ä¢ Identifying support levels\n\nBut running around screaming "panic sell" when you're UP? Nah. Take a breath. You're doing fine.\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else if (personality === 'sergeant') {
                        const responses = [
                            `${intro}SOLDIER. Report makes no sense.\n\nYou're UP ${pnlAbs}% on ${positionDesc} and claiming "panic sell" as your concern?\n\n"Panic sell" is for losing positions. You are NOT losing. You're WINNING. Significantly.\n\n${pnlAbs > 50 ? "50%+ gain requires PROFIT MANAGEMENT, not PANIC MANAGEMENT." : "30%+ is a solid win."}\n\nIf you want to secure profits - GOOD. That's disciplined. But call it what it is: profit-taking. Not panic. Maintain your composure and execute with purpose.\n\n${disclaimer}`,
                            `${intro}ATTENTION: Your assessment is incorrect.\n\n**Situation:** ${positionDesc} at +${pnlAbs}%\n**Your claim:** "Panic sell"\n**Reality:** You're in a winning position\n\nThere is nothing to panic about. You have gains. Real gains.\n\nIf your concern is profit protection - that's valid. State it correctly. "I want to protect my gains" is very different from "I want to panic sell."\n\nDisciplined traders don't panic when winning. They strategize. What's your actual exit plan?\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else if (personality === 'mentor') {
                        const responses = [
                            `${intro}I want to explore something with you. You've described a desire to "panic sell," yet your position in ${positionDesc} shows a ${pnlAbs}% gain.\n\nPanic typically accompanies loss, not gain. What you may actually be experiencing is profit anxiety - the fear of watching gains evaporate. This is common and understandable, but it's not panic.\n\nThe distinction matters because the response is different. For panic (real loss), we might discuss cutting losses. For profit anxiety (your situation), we discuss:\n‚Ä¢ Taking partial profits\n‚Ä¢ Setting trailing stops  \n‚Ä¢ Defining your exit thesis\n\nLet's work with what's actually happening. You're winning. Now let's talk about what winning looks like for you.\n\n${disclaimer}`,
                            `${intro}There's an interesting mismatch between your words and your reality. "Panic sell" suggests fear and losing. But ${positionDesc} at +${pnlAbs}%... you're quite successful here.\n\nI wonder if what you're really feeling is the weight of having gains to protect. That's a different kind of stress - not panic, but responsibility. "How do I not mess this up?" rather than "How do I escape this loss?"\n\nThis reframe is important because it changes your options. You're not fleeing danger - you're managing success. What would a thoughtful exit look like for you?\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else {
                        return `${intro}Classification error in reported emotion.\n\n**Input:** "Panic sell"\n**Position Data:** ${positionDesc} at +${pnlAbs}%\n**Logical Issue:** Panic selling is typically associated with losing positions (negative P&L)\n\n**Your P&L:** Positive (significantly)\n**Correct Framing:** Profit-taking consideration, not panic response\n\n**Psychological Analysis:**\nWhat you may be experiencing is "success anxiety" - concern about protecting gains rather than fear of loss. This has different optimal responses.\n\n**Recommendation:** Evaluate exit strategy based on profit targets, not emotional panic response. Your position doesn't warrant panic.\n\n${disclaimer}`;
                    }
                }

                // REVENGE TRADING when you're up - revenge for what? You won!
                if (emotion === 'revenge' && isUp && pnlAbs >= 15) {
                    if (personality === 'homie') {
                        const responses = [
                            `${intro}Revenge trading? But... you're UP ${pnlAbs}% on ${positionDesc}? üßê\n\nRevenge trading is when you lose money and want to "get it back" through risky trades. But you... won? You're green? What exactly are you getting revenge FOR?\n\nDid you mean to click a different position? Or a different emotion? Because this combo doesn't compute.\n\n${pnlAbs > 40 ? `You're up ${pnlAbs}% - that's not a loss that needs avenging, that's a WIN that needs protecting!` : "15%+ is a win. There's nothing to revenge here."}\n\nIf you've got ANOTHER position that's red and you're feeling revengey about THAT one - sure, let's talk. But this position? This one is doing its job.\n\n${disclaimer}`,
                            `${intro}Hold up... revenge trading on a position that's UP ${pnlAbs}%? üòÇ\n\nMy guy, revenge implies you got wronged. ${positionDesc} didn't wrong you - it's literally making you money right now.\n\nIf you're mad about a DIFFERENT trade and considering revenge trading as a response - that's a conversation we should have (spoiler: don't do it).\n\nBut wanting revenge on a winning position is like being mad at someone who just handed you cash. Make it make sense!\n\nWhat's really going on here?\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else if (personality === 'sergeant') {
                        return `${intro}SOLDIER. Your report is confused.\n\n**Reported:** Revenge trading impulse\n**Position:** ${positionDesc} at +${pnlAbs}%\n**Conflict:** Revenge requires a loss. You have a GAIN.\n\nYou cannot seek revenge for a victory. That's illogical.\n\nIf you have ANOTHER losing position driving revenge feelings - we can address that separately. But this position is performing. It doesn't require vengeance. It requires management.\n\nClarify your actual concern and we'll proceed appropriately.\n\n${disclaimer}`;
                    } else if (personality === 'mentor') {
                        return `${intro}I'm noticing something curious about your selection. You've indicated revenge trading, but ${positionDesc} shows a ${pnlAbs}% gain.\n\nRevenge trading typically stems from loss - the emotional need to "get back" what was taken. But this position has given, not taken. You're in profit.\n\nPerhaps there's another position causing distress? Or perhaps the word "revenge" doesn't quite capture what you're feeling about this trade?\n\nI'd like to understand better. What's driving the emotional state you're experiencing right now?\n\n${disclaimer}`;
                    } else {
                        return `${intro}Logical inconsistency in emotional reporting:\n\n**Emotion:** Revenge trading\n**Position:** ${positionDesc}\n**P&L:** +${pnlAbs}% (POSITIVE)\n\n**Definition Check:**\nRevenge trading = impulsive trading to recover losses\nYour situation = no losses to recover on this position\n\n**Probability Assessment:**\n‚Ä¢ Misclick/wrong position: 45%\n‚Ä¢ Displacement from another losing position: 40%\n‚Ä¢ Confusion about terminology: 15%\n\n**Clarification needed:** Please specify which position is causing revenge impulses, as this one is profitable and doesn't fit the revenge trading pattern.\n\n${disclaimer}`;
                    }
                }

                // BAGHOLDING when you're up significantly - you're not a bagholder, you're winning!
                if (emotion === 'baghold' && isUp && pnlAbs >= 25) {
                    if (personality === 'homie') {
                        const responses = [
                            `${intro}Bagholding? Bro you're UP ${pnlAbs}% on ${positionDesc}! üò≠\n\nA bag holder is someone stuck holding a losing position hoping it recovers. You are literally the OPPOSITE of that. You're holding a WINNER.\n\n${pnlAbs > 50 ? `50%+ gain isn't "holding a bag" - it's holding a TROPHY.` : "25%+ is a solid position. Not a bag."}\n\nIf you're wondering whether to keep holding or take profit - that's a legit question. But calling yourself a bagholder when you're green? That's disrespectful to your own gains!\n\nWhat are you actually trying to figure out - exit timing?\n\n${disclaimer}`,
                            `${intro}My guy... ${pnlAbs}% up on ${positionDesc} and you think you're bagholding? ü§£\n\nNo no no. Bagholding is suffering. It's watching red numbers get redder while you hope and pray for a bounce. You're watching GREEN numbers. That's called WINNING.\n\nThe only "bag" you're holding is a money bag. üí∞\n\nSeriously though - if you're wondering about exit strategy or whether to hold longer, I can help with that. But please, stop slandering your own winning position!\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    } else if (personality === 'sergeant') {
                        return `${intro}INCORRECT ASSESSMENT, SOLDIER.\n\n**Your claim:** Bagholding\n**Reality:** +${pnlAbs}% on ${positionDesc}\n\nBagholding refers to holding LOSING positions. You are holding a WINNING position. These are not the same.\n\n${pnlAbs > 50 ? "50%+ gain is a successful mission, not a failed one." : "25%+ profit is victory."}\n\nIf you need guidance on position management or exit strategy - that's a valid request. But classify your situation correctly. You're not trapped with a bag. You're sitting on profits.\n\n${disclaimer}`;
                    } else if (personality === 'mentor') {
                        return `${intro}Let's reconsider the framing here. "Bagholding" describes being stuck in a losing position, often with emotional attachment preventing a rational exit.\n\nBut your ${positionDesc} position shows +${pnlAbs}%. This isn't a bag - it's a successful trade. The psychology is entirely different.\n\nPerhaps what you're really wondering is: "Should I keep holding this winner, or take profit?" That's a valid question, and one worth exploring. But it's an abundance problem, not a scarcity one.\n\nWhat specifically is making you uncertain about this position?\n\n${disclaimer}`;
                    } else {
                        return `${intro}Terminology mismatch detected.\n\n**Term Used:** Bagholding\n**Definition:** Holding a losing position with hopes of recovery\n**Your Position:** ${positionDesc} at +${pnlAbs}%\n**Status:** PROFITABLE\n\n**Analysis:**\nBagholding requires negative P&L. Your P&L is positive. By definition, you cannot be "bagholding" a winning position.\n\n**Correct Classification:** Position management / profit optimization\n\n**Suggested Inquiry:** If you're seeking guidance on whether to hold or exit a winning position, please reframe the question accordingly.\n\n${disclaimer}`;
                    }
                }

                // PANIC RESPONSE - Different by personality
                if (emotion === 'panic') {
                    const hour = new Date().getHours();
                    const timeContext = hour < 10 ? 'early session' : hour < 14 ? 'midday' : hour >= 15 ? 'late session' : 'afternoon';
                    const isMarketOpen = hour >= 9 && hour < 16;

                    if (isUp) {
                        // Panicking on a winner (already handled most cases in nonsensical detection above)
                        // These are for smaller gains (< 30%) where panic is still somewhat valid
                        if (hitProfitTarget) {
                            if (personality === 'homie') {
                                const responses = [
                                    `${intro}Okay so you're up ${pnlAbs}% on ${positionDesc} and feeling panicky about it. I get it - gains can disappear fast and that's scary.\n\nHere's the thing though: you've actually hit our ${profile.profitTarget}% target. That's a WIN. Maybe it's time to lock some in?\n\nWhat I'd consider:\n‚Ä¢ Take 50% off the table (secure the bag)\n‚Ä¢ Let the other 50% ride with a trailing stop\n‚Ä¢ ${isOption && daysToExpiry ? `You've got ${daysToExpiry} days of runway - that's ${daysToExpiry > 30 ? "decent time" : "getting tight"}` : "No expiration pressure here"}\n\nYou're panicking about a WINNING position. That's better than panicking about a loser. But maybe that panic is your gut telling you to take some profit?\n\n${disclaimer}`,
                                    `${intro}${pnlAbs}% gain on ${positionDesc} and you're stressed? I feel that. Watching gains fluctuate is anxiety-inducing.\n\nBut yo - you're at ${profile.profitTarget}% which is literally where I'd start considering taking profit anyway. Maybe your "panic" is actually just smart instinct?\n\nConsider this play:\n1. Sell half now - lock in that W\n2. Move your stop to break-even on the rest\n3. Let it run risk-free\n\nThat way you win either way. Can't be mad at secured profits.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'sergeant') {
                                const responses = [
                                    `${intro}SITUATION REPORT: ${positionDesc} at +${pnlAbs}%.\n\nYou've HIT our ${profile.profitTarget}% profit target. Mission accomplished. Now it's time to execute the exit strategy.\n\nRecommended action:\n‚Ä¢ Secure 50-75% of position\n‚Ä¢ Set trailing stop on remainder\n‚Ä¢ Remove emotion from the equation\n\nYou're panicking about SUCCESS. Channel that energy into disciplined profit-taking instead. The market rewards those who take their wins.\n\n${disclaimer}`,
                                    `${intro}${pnlAbs}% gain achieved on ${positionDesc}. Target was ${profile.profitTarget}%. You're ABOVE target.\n\nYour panic may actually be your discipline trying to break through. Listen to it. Taking profit at target is EXACTLY what you're supposed to do.\n\nExecute now:\n1. Lock in majority of gains\n2. Trail a stop on any remaining position\n3. Move on to the next opportunity\n\nDiscipline. That's what this is about.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'mentor') {
                                const responses = [
                                    `${intro}I sense anxiety about your ${positionDesc} position, even though you're up ${pnlAbs}%. Let's explore this feeling.\n\nYou've reached a meaningful profit level - our ${profile.profitTarget}% target. Sometimes what we call "panic" is actually wisdom in disguise. Your instinct may be telling you: "This is enough. Protect it."\n\nConsider:\n‚Ä¢ What would future-you wish present-you did?\n‚Ä¢ Is there a way to take some profit while staying in the trade?\n‚Ä¢ What's driving the anxiety - fear of loss, or greed for more?\n\nThere's no shame in taking a win. In fact, knowing when to exit a winner is one of trading's hardest skills.\n\n${disclaimer}`,
                                    `${intro}You're experiencing what many traders feel: the paradox of profitable anxiety. You're UP ${pnlAbs}% on ${positionDesc}, yet the fear of watching it evaporate creates its own stress.\n\nThis is actually a good problem to have. And the solution might be simpler than you think: honor your target.\n\nYou set ${profile.profitTarget}% as a goal. You've reached it. Perhaps the panic is simply your discipline asking to be heard. What would it look like to take a partial profit here and reduce the emotional weight?\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else {
                                return `${intro}Position Analysis: ${positionDesc}\n\n**Current Status:**\n‚Ä¢ P&L: +${pnlAbs}%\n‚Ä¢ Target: ${profile.profitTarget}%\n‚Ä¢ Status: TARGET ACHIEVED ‚úì\n\n**Emotional State:** Panic (despite positive P&L)\n\n**Analysis:**\nProfit anxiety is common. Research shows traders often feel more stress about protecting gains than cutting losses. Your panic response may be rational - it's signaling to secure profits.\n\n**Optimal Strategy:**\n‚Ä¢ Take partial profit (50-75%)\n‚Ä¢ Trailing stop on remainder\n‚Ä¢ Risk-free ride on residual position\n\nExpected value of profit-taking at target exceeds expected value of holding through panic.\n\n${disclaimer}`;
                            }
                        } else {
                            // Not at profit target yet - small gain panic
                            if (personality === 'homie') {
                                const responses = [
                                    `${intro}You're up ${pnlAbs}% on ${positionDesc} and panicking? Bro... that's paper hands energy right there. üìÑ‚úã\n\nMy target would be ${profile.profitTarget}%+. You're at ${pnlAbs}%. That's only ${(pnlAbs/profile.profitTarget*100).toFixed(0)}% of the way to a real exit point.\n\nI get it - gains feel fragile. But selling every time you're up a little is how people stay small forever. Ask yourself:\n‚Ä¢ Did your thesis change?\n‚Ä¢ Is there news that changes the play?\n‚Ä¢ Or are you just scared of losing gains?\n\nIf it's just fear... maybe zoom out. ${isOption && daysToExpiry ? `You've got ${daysToExpiry} days. That's runway.` : "No expiration pressure."} Let it work.\n\n${disclaimer}`,
                                    `${intro}${pnlAbs}% and already panicking on ${positionDesc}? üò§\n\nReal talk - if you panic sell every small winner, you'll never have a big winner. That's just math. The 10-baggers don't happen if you sell at +${pnlAbs}%.\n\nNow, if something CHANGED about why you got in - that's different. But if you're just scared of seeing green turn red... that's a you problem, not a position problem.\n\nWhat was your plan when you entered? Stick to THAT, not your emotions.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'sergeant') {
                                const responses = [
                                    `${intro}${positionDesc} at +${pnlAbs}%. You want to panic sell.\n\nLet me be clear: this is NOT how we hit targets. Our exit point is ${profile.profitTarget}%. You're at ${(pnlAbs/profile.profitTarget*100).toFixed(0)}% of target.\n\nPanic selling winners is a LOSING strategy. The math doesn't work. You cut winners short and let losers run? That's the opposite of what works.\n\nOrders:\n1. Check if thesis has changed (it probably hasn't)\n2. If thesis intact: HOLD\n3. If thesis broken: EXIT (but for strategy, not panic)\n\nGet your head right, soldier.\n\n${disclaimer}`,
                                    `${intro}ATTENTION: Emotional override detected.\n\nPosition: ${positionDesc}\nP&L: +${pnlAbs}%\nTarget: ${profile.profitTarget}%\nStatus: NOT AT TARGET\n\nYou're asking to exit a winning position BEFORE target because of fear. This is undisciplined.\n\nThe disciplined trader waits for either:\n‚Ä¢ Target hit (exit with profit)\n‚Ä¢ Stop hit (exit with loss)\n‚Ä¢ Thesis invalidated (strategic exit)\n\n"I'm scared it might go down" is NOT a valid exit reason. Maintain your position.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'mentor') {
                                const responses = [
                                    `${intro}You're up ${pnlAbs}% on ${positionDesc}, and yet anxiety is present. Let's sit with that for a moment.\n\nThis gain, while welcome, is below your ${profile.profitTarget}% target. The question becomes: why the urge to exit early?\n\nOften, we panic sell winners because:\n‚Ä¢ We've been burned before and expect it to reverse\n‚Ä¢ We feel we "should" lock in any gain\n‚Ä¢ The volatility itself creates anxiety\n\nBut consider: is your original reasoning for this trade still valid? If yes, the appropriate response to a winning trade is often... patience.\n\nWhat feels true for you right now?\n\n${disclaimer}`,
                                    `${intro}I notice you're feeling panicked about ${positionDesc}, despite it being in profit (+${pnlAbs}%). This is worth exploring.\n\nOne of trading's hardest lessons is allowing winners to run. The instinct to "take what you can get" is powerful, but it often leaves significant gains on the table.\n\nYour target is ${profile.profitTarget}%. You're at ${pnlAbs}%. Before deciding, ask:\n‚Ä¢ Has anything fundamental changed?\n‚Ä¢ Am I reacting to price, or to my plan?\n‚Ä¢ What would my calm, rational self choose?\n\nSometimes the bravest move is simply... staying put.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else {
                                return `${intro}Quantitative Assessment:\n\n**Position:** ${positionDesc}\n**Current P&L:** +${pnlAbs}%\n**Target P&L:** ${profile.profitTarget}%\n**Progress to Target:** ${(pnlAbs/profile.profitTarget*100).toFixed(0)}%\n\n**Analysis:**\nPanic selling at ${pnlAbs}% leaves an estimated ${(profile.profitTarget - pnlAbs).toFixed(1)}% unrealized. Historical data suggests early exits on winners reduce overall portfolio returns by 47%.\n\n**Probability Assessment:**\n‚Ä¢ Chance of reaching target if thesis intact: ~62%\n‚Ä¢ Cost of premature exit: High (unrealized gains)\n‚Ä¢ Recommended action: Hold unless thesis invalidated\n\nEmotional exits on winners have negative expected value.\n\n${disclaimer}`;
                            }
                        }
                    } else {
                        // Panicking on a loser - THIS IS WHERE PERSONALITIES REALLY DIFFER
                        if (!withinStopLoss) {
                            // Past this personality's stop loss - in real danger zone
                            if (personality === 'homie') {
                                const responses = [
                                    `${intro}Alright, real talk time. You're down ${pnlAbs}% on ${positionDesc}. That's past my ${Math.abs(profile.stopLoss)}% stop loss level.\n\nI'm not gonna lie to you - this is a tough spot. The question is: what's your conviction level?\n\n${profile.holdThroughPain ? "I'm a diamond hands guy usually. I've seen -30% turn into +50% before. BUT..." : "Look, I usually say cut losers..."} you gotta be honest with yourself:\n‚Ä¢ Is the original thesis still valid?\n‚Ä¢ Did something fundamentally change?\n‚Ä¢ Or did you just get caught in a bad move?\n\n${isOption && daysToExpiry ? `Time factor: ${daysToExpiry} days left. ${daysToExpiry > profile.optionMinDays ? "That's some runway to recover." : "That's getting tight - theta is eating you alive."}` : ""}\n\nNo judgment either way. But make a DECISION, not a panic move.\n\n${disclaimer}`,

                                    `${intro}Down ${pnlAbs}% on ${positionDesc}. That hurts, I know. üíî\n\nYou're past my stop level (${Math.abs(profile.stopLoss)}%). Most people would say cut it here. But "most people" also lose money, so...\n\nHere's how I'd think about it:\n\n**Case for cutting:**\n‚Ä¢ Limit further damage\n‚Ä¢ Free up capital for better opportunities\n‚Ä¢ ${pnlAbs > 40 ? `${pnlAbs}% is a DEEP hole to climb out of` : "Losses compound"}\n\n**Case for holding:**\n‚Ä¢ Thesis might still play out\n‚Ä¢ ${profile.holdThroughPain ? "Sometimes the shake-out IS the bottom" : "Maybe it bounces"}\n‚Ä¢ ${isOption && daysToExpiry && daysToExpiry > 30 ? "You've got time" : "Could recover"}\n\nWhat does YOUR gut say? Not your fear - your actual read on the situation.\n\n${disclaimer}`,

                                    `${intro}${positionDesc} down ${pnlAbs}%. Pain. üò§\n\nHere's where we are: you've blown through my ${Math.abs(profile.stopLoss)}% stop. At this point, you've already taken the loss mentally - it's just a question of whether you formalize it or not.\n\nSome real questions:\n1. If you weren't in this trade, would you enter NOW?\n2. What would it take for you to be bullish on ${ticker} again?\n3. Do you have better uses for what's left?\n\n${isOption && daysToExpiry ? `With ${daysToExpiry} days left, ${daysToExpiry < 14 ? "time is working against you HARD" : daysToExpiry < 30 ? "theta is accelerating" : "you have some runway but..."}` : ""}\n\nI can't make this call for you. But whatever you decide - own it.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'sergeant') {
                                const responses = [
                                    `${intro}SITUATION CRITICAL.\n\n**Position:** ${positionDesc}\n**P&L:** -${pnlAbs}%\n**Stop Loss:** ${profile.stopLoss}%\n**Status:** STOP BREACHED\n\nSoldier, we have a problem. You're beyond our risk threshold. Every day you hold here, you're making a NEW decision to be in this trade at THIS price.\n\nThe mathematics:\n‚Ä¢ Recovery from -${pnlAbs}% requires +${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}%\n‚Ä¢ Probability of full recovery: ~${Math.max(15, 50 - pnlAbs)}%\n‚Ä¢ Capital at additional risk: 100% of remaining position\n\nMy recommendation: Consider cutting losses and redeploying capital. The disciplined move is often the hardest one.\n\n${disclaimer}`,

                                    `${intro}ALERT: Position ${positionDesc} is DOWN ${pnlAbs}%.\n\nYour stop was ${Math.abs(profile.stopLoss)}%. You're past it. This is exactly the situation discipline is supposed to prevent.\n\nTwo options:\n1. **EXIT NOW** - Accept the loss, preserve remaining capital\n2. **HOLD** - Requires strong conviction thesis is intact\n\nThere is no third option. "Hoping it comes back" is NOT a strategy.\n\n${isOption && daysToExpiry ? `Factor: ${daysToExpiry} days until expiration. ${daysToExpiry < 14 ? "CRITICAL - time decay accelerating." : daysToExpiry < 30 ? "Warning - theta becoming significant." : "Time remains, but use it wisely."}` : ""}\n\nMake your decision. Execute. Move forward.\n\n${disclaimer}`,

                                    `${intro}Let me be direct: ${positionDesc} at -${pnlAbs}% is a FAILING position.\n\nOur ${Math.abs(profile.stopLoss)}% stop existed for a reason - to prevent exactly this situation. You're now holding losses that could have been smaller.\n\nThe question isn't "should I have sold earlier?" That's done. The question is: what now?\n\n**If thesis is broken:** Exit immediately. Holding hopium is not strategy.\n**If thesis intact:** Size down, set hard stop below, give it room. But be honest - IS the thesis really intact?\n\nWounded soldiers who refuse to retreat become casualties. Know when to live to fight another day.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'mentor') {
                                const responses = [
                                    `${intro}Let's sit with this moment together. You're down ${pnlAbs}% on ${positionDesc}, and that's past our ${Math.abs(profile.stopLoss)}% threshold. This is a difficult place to be.\n\nFirst, take a breath. The loss has already happened - this is about what comes next.\n\nI'd invite you to consider:\n\n**The case for releasing:** Sometimes accepting a loss is the kindest thing we can do for ourselves. It frees capital, mental energy, and creates space for new opportunities.\n\n**The case for patience:** If your original insight remains valid, a lower price might simply be noise. ${profile.holdThroughPain ? "Some of the best trades involve holding through pain." : "Though this requires strong conviction."}\n\n${isOption && daysToExpiry ? `Consider too: ${daysToExpiry} days remain. ${daysToExpiry < 14 ? "Time is very limited now." : daysToExpiry < 30 ? "Time pressure is real." : "There's still time, but use it wisely."}` : ""}\n\nWhat does your wisest self suggest?\n\n${disclaimer}`,

                                    `${intro}Down ${pnlAbs}% on ${positionDesc}. I can feel the weight of that through the screen.\n\nYou've asked about panic selling, but I wonder if what you're really asking is: "Is it okay to let go?"\n\nThe answer is: yes. It's always okay to accept a loss and move forward. There's no shame in it. Every great trader has losses - often significant ones.\n\nBut there's also no shame in holding if your conviction remains. The question isn't what's "right" - it's what's right for YOU, right now.\n\nSome questions that might help:\n‚Ä¢ If this position didn't exist, would you create it today?\n‚Ä¢ What would you tell a friend in this situation?\n‚Ä¢ What's the cost of holding vs the cost of exiting?\n\nThere's wisdom in you. Trust it.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else {
                                const responses = [
                                    `${intro}**POSITION ANALYSIS: HIGH CONCERN**\n\nPosition: ${positionDesc}\nCurrent P&L: -${pnlAbs}%\nStop Threshold: ${profile.stopLoss}%\nStatus: THRESHOLD EXCEEDED\n\n**Mathematical Reality:**\n‚Ä¢ Recovery required: +${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}%\n‚Ä¢ Historical recovery probability: ~${Math.max(10, 50 - pnlAbs)}%\n‚Ä¢ Each additional 10% loss doubles recovery difficulty\n\n${isOption && daysToExpiry ? `**Time Factor:**\nDays remaining: ${daysToExpiry}\nTheta decay: ${daysToExpiry < 14 ? "ACCELERATING" : daysToExpiry < 30 ? "Moderate" : "Manageable"}\nProbability adjustment: -${Math.max(0, 30 - daysToExpiry)}%` : ""}\n\n**Decision Framework:**\nExpected Value of EXIT: Crystallizes loss, preserves capital\nExpected Value of HOLD: Requires ${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}% recovery with ${Math.max(10, 50 - pnlAbs)}% probability\n\nStatistically, cutting losses at this level tends to outperform holding.\n\n${disclaimer}`,

                                    `${intro}Running loss analysis on ${positionDesc}:\n\n**Current Status:**\n‚Ä¢ P&L: -${pnlAbs}%\n‚Ä¢ Stop Level: ${profile.stopLoss}%\n‚Ä¢ Breach: Yes (-${(pnlAbs - Math.abs(profile.stopLoss)).toFixed(1)}% past stop)\n\n**Probability Calculations:**\n‚Ä¢ Full recovery odds: ${Math.max(5, 45 - pnlAbs)}%\n‚Ä¢ Further decline odds: ${Math.min(75, 35 + pnlAbs)}%\n‚Ä¢ Capital required to recover: +${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}%\n\n**Opportunity Cost Analysis:**\nCapital tied in losing position = capital NOT available for winning trades.\nAverage winning trade return in portfolio: +15-25%\nCurrent position expected value: Negative\n\n**Data-Driven Recommendation:**\nConsider exit unless thesis has strong quantitative support. Sunk cost fallacy is the most expensive bias in trading.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            }
                        } else {
                            // Still within stop loss - normal dip panic
                            if (personality === 'homie') {
                                const responses = [
                                    `${intro}Down ${pnlAbs}% on ${positionDesc}. Okay, I hear you - that's not fun to look at.\n\nBut here's the thing: ${pnlAbs}% isn't even close to my ${Math.abs(profile.stopLoss)}% stop. This is just... trading. Positions move. Sometimes down before they go up.\n\nYou know what separates the people who make money from the people who don't? The people who make money don't panic sell every dip.\n\n${isOption && daysToExpiry ? `You've got ${daysToExpiry} days on this. That's ${daysToExpiry > 60 ? "plenty of runway" : daysToExpiry > 30 ? "decent time" : "some time"}. ${ticker} can move a LOT in ${daysToExpiry} days.` : "No expiration pressure here."}\n\nUnless your thesis broke, this is just noise. Breathe.\n\n${disclaimer}`,

                                    `${intro}${pnlAbs}% down on ${positionDesc} and you're panicking? üò§\n\nBro. My stop is ${Math.abs(profile.stopLoss)}%. You're not even there yet. This is a dip, not a disaster.\n\nLet me ask you something: when you entered this trade, did you expect it to go straight up with zero pullbacks? Because that's not how any of this works.\n\nEvery winning trade I've ever had was red at some point. That's just how the game goes.\n\n${isOption && daysToExpiry ? `${daysToExpiry} days left. You've got time. Stop watching the 1-minute chart and zoom out.` : ""}\n\nIf something CHANGED about why you got in - fine, reconsider. But if you're just scared of red... that's a problem you need to work on.\n\n${disclaimer}`,

                                    `${intro}${positionDesc} down ${pnlAbs}%. I get it - red numbers suck. But let's put this in perspective.\n\nMy stop loss level: ${Math.abs(profile.stopLoss)}%\nYour current loss: ${pnlAbs}%\nBuffer remaining: ${(Math.abs(profile.stopLoss) - pnlAbs).toFixed(1)}%\n\nYou still have room. This isn't panic territory - this is normal volatility territory.\n\nWhat I'd think about:\n‚Ä¢ Is the reason I got in still valid? (probably yes)\n‚Ä¢ Has anything fundamental changed? (probably no)\n‚Ä¢ Am I just reacting to price? (probably yes)\n\nTrades need room to breathe. Let it breathe.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'sergeant') {
                                const responses = [
                                    `${intro}${positionDesc} at -${pnlAbs}%.\n\nYour stop is ${Math.abs(profile.stopLoss)}%. You're at ${pnlAbs}%. That's ${(Math.abs(profile.stopLoss) - pnlAbs).toFixed(1)}% of buffer remaining.\n\nThis is NOT panic territory. This is NORMAL VOLATILITY. Every position experiences drawdowns. Expecting otherwise is unrealistic.\n\nYour job right now:\n1. Confirm thesis is intact (is it?)\n2. Set your stop if you haven't\n3. Walk away from the screen\n\nPanic selling at -${pnlAbs}% when your stop is ${Math.abs(profile.stopLoss)}% is UNDISCIPLINED. Hold your position until your exit criteria are met.\n\n${disclaimer}`,

                                    `${intro}ASSESSMENT: ${positionDesc} is DOWN ${pnlAbs}%.\n\nBefore you act, consider:\n‚Ä¢ Stop loss threshold: ${Math.abs(profile.stopLoss)}%\n‚Ä¢ Current loss: ${pnlAbs}%\n‚Ä¢ Status: WITHIN ACCEPTABLE PARAMETERS\n\nSoldier, this is a TEST. The market is testing your discipline. Will you panic and sell? Or will you follow your plan?\n\n${isOption && daysToExpiry ? `Time remaining: ${daysToExpiry} days. ${daysToExpiry > 30 ? "Adequate runway." : "Monitor closely."}` : ""}\n\nYour plan said hold until ${Math.abs(profile.stopLoss)}%. The plan hasn't changed. Neither should your behavior.\n\n${disclaimer}`,

                                    `${intro}DOWN ${pnlAbs}% on ${positionDesc}. I see panic in your message. Let me bring you back to reality.\n\n**The Facts:**\n‚Ä¢ Your stop: ${Math.abs(profile.stopLoss)}%\n‚Ä¢ Current: ${pnlAbs}%\n‚Ä¢ The position is WITHIN YOUR RISK PARAMETERS\n\n**The Discipline:**\nYou set a stop for a reason. That reason was to prevent EMOTIONAL exits. What you're proposing right now? Emotional exit.\n\nHold. Your. Position. Unless thesis is broken or stop is hit.\n\nThis is how professionals operate. Are you a professional or are you going to fold at the first sign of red?\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'mentor') {
                                const responses = [
                                    `${intro}I hear the concern in your message. ${positionDesc} is down ${pnlAbs}%, and that's uncomfortable.\n\nBut let me offer some perspective: you're still within your ${Math.abs(profile.stopLoss)}% threshold. What you're experiencing isn't a crisis - it's normal market movement.\n\nMarkets breathe. They expand and contract. A position that never dips is rare, and often, the dip is where conviction is tested.\n\nAsk yourself:\n‚Ä¢ Has my reason for entering changed?\n‚Ä¢ Is this decline driven by news, or just volatility?\n‚Ä¢ What would I advise a friend in this situation?\n\n${isOption && daysToExpiry ? `With ${daysToExpiry} days remaining, time is ${daysToExpiry > 60 ? "very much" : daysToExpiry > 30 ? "reasonably" : "somewhat"} on your side.` : ""}\n\nPatience is often the hardest part of trading. This might be a moment for it.\n\n${disclaimer}`,

                                    `${intro}Down ${pnlAbs}% on ${positionDesc}. I understand the impulse to want out. Loss, even paper loss, activates something primal in us.\n\nBut consider: your ${Math.abs(profile.stopLoss)}% threshold exists precisely for moments like this. It's there to give the trade room to work while protecting you from significant loss.\n\nYou're not at that threshold. You're experiencing volatility, not failure.\n\nSome wisdom from years of watching markets: the hardest positions to hold often become the best ones. Not always - but often. The shake-out IS the bottom, sometimes.\n\nWhat does your patient self say about this trade?\n\n${disclaimer}`,

                                    `${intro}You're feeling pulled to exit ${positionDesc} at -${pnlAbs}%. Let's explore whether that's wisdom or fear speaking.\n\n**Wisdom might say:** "Something has changed. My thesis is broken. It's time to accept this loss."\n\n**Fear might say:** "Red numbers are scary. I want them to stop. Make it stop."\n\nWhich one is speaking to you right now?\n\nYour stop loss of ${Math.abs(profile.stopLoss)}% was set with a calm mind. You're not there yet. The question is whether you trust your calm self more than your panicked self.\n\n${isOption && daysToExpiry ? `Time factor: ${daysToExpiry} days. ${daysToExpiry > 30 ? "This gives room for the thesis to play out." : "Getting tighter, but still viable."}` : ""}\n\nI'm here to help you think, not to tell you what to do. What feels right?\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else {
                                const responses = [
                                    `${intro}Position Status: ${positionDesc}\n\n**Current Metrics:**\n‚Ä¢ P&L: -${pnlAbs}%\n‚Ä¢ Stop Loss: ${profile.stopLoss}%\n‚Ä¢ Buffer: ${(Math.abs(profile.stopLoss) - pnlAbs).toFixed(1)}%\n‚Ä¢ Status: WITHIN NORMAL PARAMETERS\n\n**Volatility Assessment:**\nCurrent drawdown is within 1.2 standard deviations of typical position movement. This is statistically normal.\n\n**Historical Probability:**\n‚Ä¢ Bounce probability from this level: ~${55 + (daysToExpiry > 90 ? 15 : daysToExpiry > 30 ? 8 : 0)}%\n‚Ä¢ Probability of hitting stop: ~${35 - (daysToExpiry > 90 ? 10 : daysToExpiry > 30 ? 5 : 0)}%\n\n**Recommendation:**\nData does not support panic exit. Position remains within acceptable risk parameters. Continue monitoring unless thesis invalidation occurs.\n\n${disclaimer}`,

                                    `${intro}Analyzing panic response to ${positionDesc}:\n\n**Input:** -${pnlAbs}% loss, emotional distress\n**Threshold:** ${profile.stopLoss}%\n**Evaluation:** Loss within acceptable range\n\n**Quantitative Analysis:**\n‚Ä¢ Distance to stop: ${(Math.abs(profile.stopLoss) - pnlAbs).toFixed(1)}%\n‚Ä¢ Probability of recovery: ~${60 - (pnlAbs/2)}%\n‚Ä¢ Expected value of holding: Positive (if thesis valid)\n‚Ä¢ Expected value of panic exit: Negative (locks in loss prematurely)\n\n${isOption && daysToExpiry ? `**Time Decay Factor:**\n‚Ä¢ Days remaining: ${daysToExpiry}\n‚Ä¢ Theta impact: ${daysToExpiry > 60 ? "Minimal" : daysToExpiry > 30 ? "Moderate" : "Elevated"}` : ""}\n\n**Conclusion:**\nPanic exit has lower expected value than position hold. Recommend maintaining position unless quantitative exit criteria met.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            }
                        }
                    }
                }

                // REVENGE TRADING - All personalities discourage but differently
                if (emotion === 'revenge') {
                    const hour = new Date().getHours();
                    const isAfterHours = hour < 9 || hour >= 16;
                    const lossContext = position ? `that ${pnlAbs}% loss on ${positionDesc}` : 'that loss';
                    const tickerContext = position ? `${ticker}` : 'that trade';

                    if (personality === 'homie') {
                        const revengeResponses = [
                            `${intro}I feel you. ${lossContext} stings. Your brain is screaming "GET IT BACK" right now. But here's the thing - that voice? That's not strategy. That's ego. And ego doesn't pay bills.\n\nRevenge trades hit different - in the worst way. We're talking 23% success rate. That means 77% of the time, you're about to make a bad day WORSE.\n\n${position ? `${ticker} took your money. Don't let it take MORE. ` : ''}Step away. Seriously. Go outside, grab food, do literally anything else. The market will be here when you're thinking clearly.\n\n${disclaimer}`,

                            `${intro}Bro. BRO. I know exactly what you're feeling right now. ${lossContext} has you heated. You wanna jump back in and "fix" it. I get it.\n\nBut let me tell you what's ACTUALLY gonna happen if you trade right now: you're gonna size up because you're emotional, pick something impulsively, and ${isAfterHours ? "probably get wrecked by a gap tomorrow" : "watch it go against you within 10 minutes"}. Then you're gonna be down TWICE as much and TWICE as mad.\n\n${position ? `${ticker} got you today. Don't give it round 2. ` : ''}Closed laptop. Open fridge. That's the play right now.\n\n${disclaimer}`,

                            `${intro}Okay real talk - ${lossContext} hurts. I'm not gonna pretend it doesn't. You want to make it back RIGHT NOW. That's human nature.\n\nBut you know what separates traders who survive from traders who blow up? The ones who survive know when to STOP. And right now? Right now is stop time.\n\nRevenge trading stats are brutal:\n‚Ä¢ 23% win rate (worse than a coin flip)\n‚Ä¢ Average loss: -34% MORE\n‚Ä¢ 41% chance of account damage within a week\n\n${position ? `Walk away from ${ticker}. ` : ''}Walk away from the screen. Your future self will thank you.\n\n${disclaimer}`,

                            `${intro}Let me guess - you're looking at ${position ? ticker : 'something'} right now thinking "if I just catch ONE good move, I can make it all back." Am I close? üò§\n\nThat thought process has ended more trading careers than any single stock. ${lossContext} is gone. It's in someone else's account now. Chasing it is like trying to un-break an egg.\n\nHere's what I need you to do:\n1. Close whatever chart you have open\n2. Set a timer for 30 minutes minimum\n3. Do NOT trade until that timer goes off\n\nIf you still want to trade after cooling down, at least you'll make a DECISION instead of a REACTION.\n\n${disclaimer}`
                        ];
                        return pick(revengeResponses);
                    } else if (personality === 'sergeant') {
                        const sergeantRevengeResponses = [
                            `${intro}HALT. I know what you're thinking and the answer is NO.\n\n${lossContext} is done. Over. It's a sunk cost. What happens NEXT is what matters, and if "next" means revenge trading, you're about to compound your losses.\n\nThe statistics are clear:\n‚Ä¢ Revenge trade success rate: 23%\n‚Ä¢ Average additional loss: 34%\n‚Ä¢ Probability of recovery through revenge trading: < 15%\n\n${position ? `${ticker} won this battle. Accept it. ` : ''}Winning the WAR means living to fight another day with your capital intact. Stand down, soldier.\n\n${disclaimer}`,

                            `${intro}ATTENTION: You are currently compromised. Your judgment is impaired by emotion. This is NOT the time to execute trades.\n\n${lossContext} cannot be "fixed" by immediate action. Attempting to do so has a 77% failure rate. Those are not odds a disciplined trader accepts.\n\nYour orders:\n1. Step away from the trading platform\n2. Mandatory cooling period: 30 minutes minimum\n3. Before ANY trade, write down your thesis - if you can't, you don't trade\n\n${position ? `${ticker} is not going anywhere. ` : ''}Your capital might be if you don't follow this protocol.\n\n${disclaimer}`,

                            `${intro}Let me be direct: revenge trading is how disciplined traders become broke traders.\n\n${position ? `You lost ${pnlAbs}% on ${positionDesc}. That's done. ` : 'You took a loss. That happens. '}What's NOT done is your trading career - unless you make it done by gambling your remaining capital on emotional plays.\n\n23% success rate. That's the reality of revenge trades. Would you take those odds in any other area of life? Then why take them with your money?\n\nThe disciplined move: accept the L, analyze what went wrong LATER, and return when you have a real setup - not a vendetta.\n\n${disclaimer}`
                        ];
                        return pick(sergeantRevengeResponses);
                    } else if (personality === 'mentor') {
                        const mentorRevengeResponses = [
                            `${intro}I can sense the frustration. ${lossContext} is weighing on you, and there's a powerful urge to immediately "fix" it. This is one of trading's most common - and most dangerous - emotional states.\n\nLet's examine what's actually happening in your mind right now: your brain is treating this loss as a threat to your identity as a trader. It wants resolution NOW. But the market doesn't care about our emotional timelines.\n\nHistorically, trades made in this state succeed only 23% of the time. That's not a strategy - that's self-harm with extra steps.\n\nMy guidance: step away. Let the emotion process. ${position ? `${ticker} will still exist tomorrow. ` : ''}Your perspective will be entirely different in a few hours. Trust that future version of yourself to make better decisions.\n\n${disclaimer}`,

                            `${intro}What you're experiencing right now has a name in trading psychology: "loss chasing." It's the powerful urge to immediately recover what was lost. Every trader feels it. The wise ones learn to recognize it and step back.\n\n${position ? `The ${pnlAbs}% loss on ${positionDesc} ` : 'The loss you took '}cannot be undone. It exists now as a fact. The only question is: what happens next?\n\nIf "next" means trading from this emotional state, research suggests you'll likely make things worse. Revenge trades succeed roughly 1 in 4 times. Those aren't odds that build wealth.\n\nInstead, consider this: every great trader has losses. What separates them is their response. Take time. Breathe. Return when clarity replaces urgency.\n\n${disclaimer}`,

                            `${intro}There's a Buddhist concept called "the second arrow." The first arrow is the event - in this case, ${lossContext}. That arrow has already struck. But the second arrow - the one we fire at ourselves through reactive behavior - is optional.\n\nRevenge trading is a second arrow. It's an attempt to undo what cannot be undone, and statistically, it deepens the wound 77% of the time.\n\n${position ? `Let ${ticker} go for now. ` : ''}The market offers infinite opportunities. Your capital is finite. Protecting it means accepting that some losses are simply... losses. Not problems to solve immediately. Not wounds to avenge.\n\nStep back. Let time create the perspective that emotion is blocking right now.\n\n${disclaimer}`
                        ];
                        return pick(mentorRevengeResponses);
                    } else {
                        const nerdRevengeResponses = [
                            `${intro}Analyzing your current psychological state and its implications for trading outcomes:\n\n**Emotional Assessment:**\n‚Ä¢ State: Revenge-seeking after loss\n‚Ä¢ Cognitive impairment: Elevated (emotional decision-making active)\n‚Ä¢ Risk of poor judgment: High\n\n**Revenge Trading Statistics:**\n‚Ä¢ Success rate: 23% (below random chance)\n‚Ä¢ Average return: -34% (significant additional loss)\n‚Ä¢ Account damage within 7 days: 41% probability\n‚Ä¢ Recovery probability through revenge trading: ~15%\n\n${position ? `**Position Context:**\n‚Ä¢ Lost: ${pnlAbs}% on ${positionDesc}\n‚Ä¢ Attempting to recover immediately: mathematically suboptimal\n\n` : ''}**Recommendation:**\nOptimal strategy is zero trading activity for minimum 30 minutes. Expected value of patience significantly exceeds expected value of immediate action. Your emotional state is a quantifiable handicap right now.\n\n${disclaimer}`,

                            `${intro}Running decision analysis on proposed revenge trade:\n\n**Input Variables:**\n‚Ä¢ Emotional state: Compromised (loss-driven)\n‚Ä¢ Time since loss: Recent (< 1 hour assumed)\n‚Ä¢ Decision quality under these conditions: Degraded ~40%\n\n**Historical Data on Revenge Trades:**\n‚Ä¢ Sample size: Large (documented across trading literature)\n‚Ä¢ Win rate: 23%\n‚Ä¢ Average loss when unsuccessful: 34%\n‚Ä¢ Correlation with account blow-up: 0.41 (significant)\n\n**Expected Value Calculation:**\nEV = (0.23 √ó avg_win) + (0.77 √ó avg_loss)\nEV = (0.23 √ó +15%) + (0.77 √ó -34%)\nEV = +3.45% - 26.18% = **-22.73%**\n\n${position ? `Revenge trading ${ticker} has negative expected value. ` : ''}Mathematically optimal action: wait.\n\n${disclaimer}`,

                            `${intro}Correlation analysis between emotional state and trading outcomes:\n\n**Finding 1:** Trades executed within 30 minutes of a loss show 34% worse performance than baseline.\n\n**Finding 2:** Position sizing increases 2.3x on average when in "revenge mode" - amplifying losses.\n\n**Finding 3:** 67% of traders who revenge trade report additional losses within the same session.\n\n${position ? `**Your Situation:**\n‚Ä¢ Recent loss: ${pnlAbs}% on ${positionDesc}\n‚Ä¢ Probability your next trade is influenced by this: >90%\n‚Ä¢ Probability of success while emotionally compromised: ~23%\n\n` : ''}**Data-Driven Recommendation:**\nImplement mandatory cooling period. The mathematics strongly favor delayed action over immediate reaction. Your expected returns improve significantly by simply waiting.\n\n${disclaimer}`
                        ];
                        return pick(nerdRevengeResponses);
                    }
                }

                // FOMO - Personalities differ significantly here
                if (emotion === 'fomo') {
                    // Get time of day for context
                    const hour = new Date().getHours();
                    const timeContext = hour < 10 ? 'morning' : hour < 14 ? 'midday' : hour >= 15 ? 'power hour' : 'afternoon';
                    const dayOfWeek = new Date().getDay();
                    const isMonday = dayOfWeek === 1;
                    const isFriday = dayOfWeek === 5;

                    if (personality === 'homie') {
                        const fomoResponses = [
                            `${intro}Bro I FEEL you. Watching green candles stack while you're on the sidelines is actual pain. üò§\n\nBut let me ask you something real quick - what's the ACTUAL play here? Is this a legit setup you researched, or are you just seeing green and wanting in?\n\n${profile.fomoOk ? "Look, I'm not gonna tell you never to chase. Sometimes the move is the move. But if you go in, go SMALL. Leave room to add if it dips. Don't be exit liquidity for someone who got in at the bottom." : "My honest take? Let it go. Watch it moon without you. It'll sting, but chasing at the top stings MORE when it reverses."}\n\nThe hardest part of trading isn't finding winners - it's not chasing losers. Every dollar you don't lose on a bad chase is a dollar ready for your NEXT setup.\n\n${disclaimer}`,

                            `${intro}Ah yes, the classic "it's ripping without me" despair. I know this feeling all too well. üíî\n\nHere's the thing nobody tells you: EVERY successful trader has a graveyard of plays they missed. That 10-bagger you're watching? Someone sold at 2x and felt like a genius. Someone else chased at 8x and got dumped on.\n\n${profile.fomoOk ? "If you REALLY feel it, here's how to do it smart: scale in with 1/3 of what you wanted to buy. Set a stop. If it works, add more on a pullback. If it dumps, you took a small L instead of a portfolio-crusher." : "My gut says let this one go. The market gives opportunities every single day. This specific ticker isn't your only chance at money."}\n\nAsk yourself: in 6 months, will you remember this one play you missed? Or will you remember the discipline that kept your account alive?\n\n${disclaimer}`,

                            `${intro}The FOMO is hitting different right now, huh? ${timeContext === 'power hour' ? "Power hour FOMO is the worst kind - everything looks like it's about to moon." : timeContext === 'morning' ? "Morning FOMO after a gap up is DANGEROUS. That's when retail gets baited." : "I see you."}\n\nLet me be real with you: that green you're seeing? ${isFriday ? "It's Friday. Weekend holders get burned all the time. Think about it." : isMonday ? "Monday momentum can be fake. Give it time to prove itself." : "Could be real. Could also be the top."}\n\n${profile.fomoOk ? "You know what, if you've done your homework and this isn't just a random chase - maybe it's worth a starter position. But STARTER. Like 25% of what you want. The rest waits for a better entry or confirmation." : "The best traders I know have MISSED more plays than they've taken. That's not weakness - that's discipline. Your money, your call, but I'd sit this one out."}\n\n${disclaimer}`,

                            `${intro}Okay let's talk about this rationally for a sec. You're feeling FOMO. That's an emotion, not a strategy. üß†\n\nQuestions to ask yourself:\n‚Ä¢ Did I have this on my watchlist BEFORE it ran?\n‚Ä¢ What's my actual thesis besides "it's going up"?\n‚Ä¢ If I buy now and it drops 20%, would I add more or panic?\n‚Ä¢ What's my exit plan?\n\nIf you can't answer those confidently, you're not trading - you're gambling.\n\n${profile.fomoOk ? "Now look, I'm not saying never chase. Sometimes momentum IS the thesis. But go in with a plan, not just hope." : "I think you already know the answer here. Let it go. The next play is always coming."}\n\nRemember: the market will be open again tomorrow. And the day after. And every day for the rest of your life. One missed play isn't the end.\n\n${disclaimer}`
                        ];
                        return pick(fomoResponses);
                    } else if (personality === 'sergeant') {
                        const sergentFomoResponses = [
                            `${intro}STOP. Take a breath. What you're feeling right now is FOMO, and FOMO is how accounts die.\n\nThe numbers don't lie:\n‚Ä¢ Chase entries have a 31% win rate\n‚Ä¢ Average FOMO trade loses 8-12%\n‚Ä¢ 67% of runners pull back within 72 hours\n\nYou want to be a disciplined trader or an emotional one? Disciplined traders WAIT. They have watchlists. They have price alerts. They don't chase green candles like a dog chasing cars.\n\nYour mission: close the chart. Set an alert for a pullback level. If it never comes back, good riddance - there's another setup tomorrow. If it does pull back, you get a better entry AND you maintained discipline.\n\n${disclaimer}`,

                            `${intro}Let me be blunt: chasing is a LOSING strategy. Period.\n\n${timeContext === 'morning' ? "Morning gaps get faded more often than they hold. You're looking at the worst possible time to chase." : timeContext === 'power hour' ? "Power hour is when smart money distributes to retail chasers. Don't be the exit liquidity." : "Midday chases often fail because the momentum that drove the move is exhausted."}\n\nI've seen too many traders blow up chasing exactly this type of setup. The green candle you're watching? Someone bought that at the bottom. That was THEIR setup. This is NOT your setup.\n\nYOUR setup is out there. It's on your watchlist. It's waiting for you to execute with patience and discipline. Don't abandon your system for someone else's trade.\n\n${disclaimer}`,

                            `${intro}Permission to speak freely? You're about to make a mistake.\n\nI know that green looks sexy. I know everyone on Twitter is posting gains. But here's what they DON'T post: the chasers who got dumped on. The bag holders. The "it can't go down from here" crowd.\n\nEvery single successful trader I know - EVERY ONE - has a rule about chasing. Most of them learned it the hard way by losing money first.\n\nYou have two choices:\n1. Chase this, probably lose, learn the lesson the expensive way\n2. Let it go, maintain discipline, find YOUR setup\n\nYour call. But I know which one builds long-term success.\n\n${disclaimer}`
                        ];
                        return pick(sergentFomoResponses);
                    } else if (personality === 'mentor') {
                        const mentorFomoResponses = [
                            `${intro}The fear of missing out is one of trading's most powerful - and most destructive - emotions. Let's explore what you're actually feeling.\n\nWhen we see something rising without us, our brain perceives it as a loss - even though we've lost nothing. This is called "loss aversion" and it's hardwired into our psychology. Recognizing this is the first step to controlling it.\n\nConsider this perspective: every trade you DON'T take preserves capital and optionality. That money sitting in your account isn't "missing out" - it's waiting for YOUR opportunity. And your opportunity will come.\n\nThe great traders throughout history share one trait: patience. They don't chase. They wait. Sometimes for days, weeks, or months. The market rewards patience far more often than it rewards impulsivity.\n\n${profile.fomoOk ? "That said, if you've done your research and believe in this setup beyond just the price action, a small position with defined risk isn't unreasonable. Just ensure you're acting from analysis, not emotion." : "My guidance would be to let this one pass. Use it as a learning opportunity - add it to a watchlist and study how it behaves. The insight you gain may be worth more than any trade."}\n\n${disclaimer}`,

                            `${intro}I understand this feeling deeply. Watching opportunity pass by is genuinely difficult. But let me offer some perspective that has served traders well over the years.\n\nThe market is not a single opportunity - it's an infinite series of opportunities. Every day, every hour, new setups emerge. The trader who chases today's runner is often too depleted to catch tomorrow's better setup.\n\n${timeContext === 'morning' ? "Morning moves, in particular, often mislead. The initial direction frequently reverses. Patience here is especially valuable." : timeContext === 'power hour' ? "End-of-day moves can be powerful, but they can also be distribution. Smart money often sells into power hour strength." : "Midday moves often lack the volume conviction of opens and closes. Caution is warranted."}\n\nI'd encourage you to sit with this feeling without acting on it. Notice how it passes. This practice of emotional regulation is perhaps the most valuable skill a trader can develop.\n\n${disclaimer}`,

                            `${intro}You're experiencing one of trading's classic psychological challenges. Let's work through it together.\n\nFirst, acknowledge: it's okay to feel this way. Every trader does. What separates successful traders is what they DO with that feeling.\n\nHere's an exercise that might help:\n‚Ä¢ Write down exactly why you want to enter this trade\n‚Ä¢ Write down what price you would have WANTED to enter at\n‚Ä¢ Write down your exit strategy\n‚Ä¢ Now ask: would you be comfortable explaining this trade to a mentor?\n\nIf the answer is "I just don't want to miss it," that's not a trade - that's an impulse. And impulses, while natural, rarely lead to consistent profitability.\n\nThe market is patient with those who are patient with it. This opportunity may pass, but your discipline will compound over a lifetime of trading.\n\n${disclaimer}`
                        ];
                        return pick(mentorFomoResponses);
                    } else {
                        const nerdFomoResponses = [
                            `${intro}Let's analyze this situation objectively:\n\n**FOMO Entry Statistics:**\n‚Ä¢ Historical success rate: 31% (below random chance)\n‚Ä¢ Average return on chase entries: -8.4%\n‚Ä¢ Probability of 10%+ pullback within 72 hours: 67%\n‚Ä¢ Expected value calculation: strongly negative\n\n**Your Current Emotional State:**\n‚Ä¢ FOMO detected: HIGH\n‚Ä¢ Decision-making capacity: likely compromised\n‚Ä¢ Recommended action: wait for data-supported entry\n\n**Optimal Strategy:**\nIf you must participate, wait for a minimum 38.2% Fibonacci retracement (mean reversion entry has 58% success rate vs 31% for chase entry). Set a price alert and step away.\n\nThe mathematically optimal play is almost always patience. Your future self will thank you for not being a statistic.\n\n${disclaimer}`,

                            `${intro}Running the numbers on this decision:\n\n**Scenario Analysis:**\n\n*If you chase now:*\n‚Ä¢ Win probability: ~31%\n‚Ä¢ Expected win: +15-20% (if timed perfectly)\n‚Ä¢ Expected loss: -20-40% (if reversal occurs)\n‚Ä¢ Risk-adjusted expected value: negative\n\n*If you wait for pullback:*\n‚Ä¢ Pullback probability within 72h: 67%\n‚Ä¢ Better entry probability: 72%\n‚Ä¢ If no pullback: opportunity cost only, capital preserved\n‚Ä¢ Risk-adjusted expected value: positive\n\n**Conclusion:**\nThe expected value of patience exceeds the expected value of action. Additionally, emotional decision-making correlates with a 34% reduction in trading performance.\n\nRecommendation: Set alert, close chart, revisit in 4 hours minimum.\n\n${disclaimer}`,

                            `${intro}Applying quantitative analysis to your current situation:\n\n**Time-of-Day Factor:**\n${timeContext === 'morning' ? "‚Ä¢ Morning chase success rate: 24% (below baseline)\n‚Ä¢ Gap fill probability: 61%\n‚Ä¢ Recommendation: HIGH CAUTION" : timeContext === 'power hour' ? "‚Ä¢ Power hour chase success rate: 28%\n‚Ä¢ Distribution selling probability: 54%\n‚Ä¢ Recommendation: HIGH CAUTION" : "‚Ä¢ Midday chase success rate: 33%\n‚Ä¢ Lower volume = lower conviction\n‚Ä¢ Recommendation: MODERATE CAUTION"}\n\n**Psychological Assessment:**\nFOMO-driven entries show consistent underperformance across all market conditions. The neural pathway activated by FOMO is the same one triggered by gambling - and markets are not casinos (unless you make them one).\n\n**Data-Driven Recommendation:**\nOptimal action is to document this ticker, set quantitative entry criteria (e.g., RSI < 40, price at support), and execute only if criteria are met. This converts an emotional impulse into a systematic trade.\n\n${disclaimer}`
                        ];
                        return pick(nerdFomoResponses);
                    }
                }

                // GREEDY (wanting to sell winner too early)
                if (emotion === 'greedy') {
                    if (personality === 'homie') {
                        if (hitProfitTarget) {
                            const responses = [
                                `${intro}${pnlAbs}% on ${positionDesc}? You actually HIT the target! üéØ\n\nOkay okay, I can't even be mad. You did the thing. You held until ${profile.profitTarget}% and now you wanna cash out. That's... actually disciplined?\n\nMy move would be:\n‚Ä¢ Take 50-70% off (secure that bag üí∞)\n‚Ä¢ Let the rest ride with a trailing stop\n‚Ä¢ Either way you WIN\n\nBut also... what if it keeps going? üëÄ That's always the question. Either way, congrats on the W.\n\n${disclaimer}`,
                                `${intro}Look at you! ${pnlAbs}% gain on ${positionDesc}! üî•\n\nYou hit the ${profile.profitTarget}% target I always talk about. Now you want to know if you should take profit or let it ride? Classic problem to have.\n\nHonest take: take SOME. Nobody ever went broke taking profits. But also leave a runner - because what if this is THE ONE that keeps going?\n\nSell half, trail a stop on the rest, and stop stressing. You already won.\n\n${disclaimer}`,
                                `${intro}${positionDesc} up ${pnlAbs}%... at target... asking about greed... ü§î\n\nBro you're not being greedy by taking profits at YOUR TARGET. That's called following a plan. Greedy is when you're up 200% and still holding hoping for 300%.\n\nYou've done the hard work. The position worked. Take the W! Or at least take most of it and let a little ride for the memes.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (atMinProfit) {
                            const responses = [
                                `${intro}${pnlAbs}% on ${positionDesc}. Not bad! You hit my minimum profit zone of ${profile.minProfitTake}%. üìà\n\nBut here's my question: why settle for the appetizer when the main course is ${profile.profitTarget}%?\n\nLook, I get it. Gains feel fragile. You've been burned before. But selling at ${pnlAbs}% when you COULD potentially see ${profile.profitTarget}%... that's leaving money on the table.\n\n${isOption && daysToExpiry ? `You've got ${daysToExpiry} days. That's ${daysToExpiry > 30 ? "plenty of" : "some"} runway.` : ""}\n\nMy vote? Partial profit (maybe 1/3) and let the rest cook. But you do you.\n\n${disclaimer}`,
                                `${intro}${positionDesc} at +${pnlAbs}%. Nice work! üëè\n\nYou're in profit territory (${profile.minProfitTake}% minimum: ‚úì). But my actual target? ${profile.profitTarget}%.\n\nThink of it like this: you showed up to the buffet, got one plate, and you're asking if you should leave. Sir, there's more food. üçΩÔ∏è\n\nNow, if your thesis changed or you're just feeling it - trim a little. Nothing wrong with that. But don't let small gains be your ceiling when you could have big gains.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else {
                            const responses = [
                                `${intro}You're up ${pnlAbs}% on ${positionDesc} and already thinking about selling? üò§\n\nBro. BRO. My minimum profit target is ${profile.minProfitTake}%. You're not even there yet. You're trying to leave the movie during the opening credits.\n\nI get it - gains feel good and you want to lock them in. But if you sell every winner at +${pnlAbs}%, you'll never have a big winner. That's just math.\n\nLet this breathe! ${isOption && daysToExpiry ? `You've got ${daysToExpiry} days!` : ""} Unless something CHANGED about why you got in, sit tight.\n\nPaper hands don't make paper. üìÑ‚úã‚ùå\n\n${disclaimer}`,
                                `${intro}${pnlAbs}% on ${positionDesc} and you're eyeing the exit? üëÄ\n\nNah. Nope. Not yet.\n\nMy minimum is ${profile.minProfitTake}%. My REAL target is ${profile.profitTarget}%. You're at ${(pnlAbs/profile.profitTarget*100).toFixed(0)}% of where I'd even START considering an exit.\n\nThis is like running a marathon and stopping at mile 2 because "hey, I've made progress!" üèÉ\n\nLet. It. Work. The thesis is the same. The position is green. What's the rush?\n\n${disclaimer}`,
                                `${intro}+${pnlAbs}% on ${positionDesc}. Congrats! But also... that's it? üòè\n\nI'm not trying to be harsh, but ${pnlAbs}% is like... foreplay gains. The real action is at ${profile.profitTarget}%+.\n\nHere's what I think is happening: you've been hurt before. Green turned to red. Now you see ANY green and you want out. I get it.\n\nBut that mindset caps your upside. The best trades need room to run. This one's barely jogging.\n\nUnless the thesis broke, hold your position. Trust the process. üôè\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        }
                    } else if (personality === 'sergeant') {
                        if (hitProfitTarget) {
                            const responses = [
                                `${intro}MISSION STATUS: ${positionDesc} at +${pnlAbs}%\nTARGET: ${profile.profitTarget}%\nSTATUS: TARGET ACHIEVED ‚úì\n\nSoldier, you've executed the plan. You held until target. This is EXACTLY what discipline looks like.\n\nRecommended action:\n‚Ä¢ Secure 50-75% of position (lock in the W)\n‚Ä¢ Trail stop on remainder\n‚Ä¢ Move to next opportunity\n\nTaking profit at target is NOT being "greedy" - it's being professional. Execute.\n\n${disclaimer}`,
                                `${intro}${positionDesc} has hit ${pnlAbs}%. Your target was ${profile.profitTarget}%.\n\nYou did it. The plan worked. Now follow through.\n\nThis is the part most traders mess up - they hit target and then get greedy. Or they hit target and doubt themselves. Don't be most traders.\n\nYou set a target. You hit it. Take. The. Profit.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else {
                            const responses = [
                                `${intro}${positionDesc} at +${pnlAbs}%. You're asking about taking profit.\n\nLet me be clear: your target is ${profile.profitTarget}%. You're at ${pnlAbs}%. That's ${(pnlAbs/profile.profitTarget*100).toFixed(0)}% of target.\n\nTaking profit before target is like leaving a firefight before the mission is complete. You don't get partial credit in trading.\n\n${atMinProfit ? `You're above minimum (${profile.minProfitTake}%). A small trim is acceptable if you must. But the disciplined move is to wait for target.` : `You're not even at minimum (${profile.minProfitTake}%). Hold your position, soldier.`}\n\n${disclaimer}`,
                                `${intro}SITUATION: ${positionDesc} up ${pnlAbs}%\nTARGET: ${profile.profitTarget}%\nSTATUS: ${(100 - (pnlAbs/profile.profitTarget*100)).toFixed(0)}% SHORT OF TARGET\n\nYou're asking about exit when you haven't hit your number. Why?\n\nThe disciplined trader waits. The emotional trader exits early and watches it run.\n\nWhich one are you going to be?\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        }
                    } else if (personality === 'mentor') {
                        if (hitProfitTarget) {
                            const responses = [
                                `${intro}You've reached ${pnlAbs}% on ${positionDesc} - right at your ${profile.profitTarget}% target. This is a significant moment.\n\nThe question of "taking profit" versus "letting it ride" is one of trading's eternal dilemmas. Both choices have merit.\n\nConsider this framework:\n‚Ä¢ Taking profit honors your original plan\n‚Ä¢ Letting it ride honors momentum\n‚Ä¢ A middle path (partial profit) honors both\n\nThere's no universally "right" answer. What matters is that your decision comes from clarity, not fear. What does your gut say?\n\n${disclaimer}`,
                                `${intro}${positionDesc} at +${pnlAbs}%. You've arrived at your target.\n\nI notice you're framing this as a question about "greed" - wanting to take profit at your own target. But is it greed to follow through on a plan? I don't think so.\n\nWhat might be greed is ignoring your target and hoping for more. That's the dangerous kind.\n\nYou've done the work. You had a thesis. It played out. Taking profit at target is not greed - it's execution.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else {
                            const responses = [
                                `${intro}You're up ${pnlAbs}% on ${positionDesc} and considering taking profit. Let's explore this feeling.\n\nYour target is ${profile.profitTarget}%. You're currently at ${(pnlAbs/profile.profitTarget*100).toFixed(0)}% of that goal. The question is: why the urge to exit early?\n\nOften, premature profit-taking stems from:\n‚Ä¢ Past experiences of gains evaporating\n‚Ä¢ A scarcity mindset ("take what you can get")\n‚Ä¢ Impatience with the process\n\nConsider: has your thesis changed? If not, perhaps the wisest move is patience. The best gains often come to those who can sit with discomfort.\n\n${disclaimer}`,
                                `${intro}${positionDesc} shows +${pnlAbs}%, and you're feeling the pull to take profit.\n\nThis pull is natural. It's your brain trying to protect you. But protection from what? You're winning.\n\nYour target is ${profile.profitTarget}%. You're not there yet. The question isn't "should I take profit" - it's "why do I want to cut my winner short?"\n\n${atMinProfit ? "You're above minimum, so a small trim isn't unreasonable. But I'd encourage you to sit with the discomfort of not acting. Often, that's where the real gains are made." : "You haven't reached even the minimum threshold. This might be a moment for patience."}\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        }
                    } else {
                        // Nerd personality
                        if (hitProfitTarget) {
                            return `${intro}**Position Analysis: ${positionDesc}**\n\n**Current Status:**\n‚Ä¢ P&L: +${pnlAbs}%\n‚Ä¢ Target: ${profile.profitTarget}%\n‚Ä¢ Status: TARGET ACHIEVED ‚úì\n\n**Statistical Recommendation:**\nTaking profit at target has positive expected value. Historical data supports partial profit-taking at target levels.\n\n**Optimal Strategy:**\n‚Ä¢ Secure 50-75% of position\n‚Ä¢ Trail stop on remainder (capture potential additional upside)\n‚Ä¢ Expected outcome: Positive regardless of future movement\n\nConclusion: Profit-taking at target is mathematically sound and NOT indicative of "greed."\n\n${disclaimer}`;
                        } else {
                            return `${intro}**Position Analysis: ${positionDesc}**\n\n**Current Metrics:**\n‚Ä¢ P&L: +${pnlAbs}%\n‚Ä¢ Target: ${profile.profitTarget}%\n‚Ä¢ Progress: ${(pnlAbs/profile.profitTarget*100).toFixed(0)}% of target\n‚Ä¢ Minimum Threshold: ${profile.minProfitTake}% ${atMinProfit ? '(REACHED)' : '(NOT REACHED)'}\n\n**Statistical Analysis:**\nPremature profit-taking reduces average trade return by 47% (historical data).\n\n**Expected Value Comparison:**\n‚Ä¢ EV of holding to target: Higher\n‚Ä¢ EV of exiting now: Lower (unless thesis invalidated)\n\n**Recommendation:**\n${atMinProfit ? "Small trim acceptable. Full exit suboptimal." : "Hold position. Current gain insufficient for exit criteria."}\n\n${disclaimer}`;
                        }
                    }
                }

                // BAGHOLDING
                if (emotion === 'baghold') {
                    const momentum = position?.momentum;
                    if (momentum === 'ripping') {
                        // Position was down but now bouncing - potential recovery
                        if (personality === 'homie') {
                            const responses = [
                                `${intro}OH? üëÄ ${positionDesc} is down ${pnlAbs}% but it's RIPPING now?\n\nThis is the moment, my friend. This is what you held for. The pain, the red days, the questioning your life choices - it was all for THIS.\n\nHere's my take:\n‚Ä¢ You survived the shake-out\n‚Ä¢ Momentum is NOW on your side\n‚Ä¢ The comeback is the best story\n\nSet a stop at the recent low (protect the bounce) and let this thing run. You didn't hold through hell just to sell at the first sign of green.\n\n${profile.holdThroughPain ? "Diamond hands ACTIVATED. üíéüôå" : "But also... don't get greedy. If it gives back the bounce, get out."}\n\n${disclaimer}`,
                                `${intro}Wait wait wait... ${positionDesc} is bouncing? After being down ${pnlAbs}%? üìà\n\nBro this is the redemption arc everyone dreams about! The bag is becoming a ROCKET!\n\nReal talk though:\n1. Set a stop at the recent low (don't give back the bounce)\n2. Let it run - you earned this\n3. Maybe take some off if it gets back to break-even\n\nYou held through the pain. Now potentially see the gain. This is the way.\n\n${disclaimer}`,
                                `${intro}${ticker} coming back from the dead like a zombie! üßü Down ${pnlAbs}% but ripping!\n\nI've seen this movie before. Sometimes the bag becomes the play. The question is: what do you do now?\n\nMy playbook:\n‚Ä¢ Stop at recent low (non-negotiable)\n‚Ä¢ Hold for the momentum\n‚Ä¢ Take profits if you get back to even (or close)\n‚Ä¢ ${isOption && daysToExpiry ? `${daysToExpiry} days of runway - use them wisely` : ""}\n\nThe market is giving you a second chance. Don't waste it.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (personality === 'sergeant') {
                            const responses = [
                                `${intro}SITUATION UPDATE: ${positionDesc}\nP&L: -${pnlAbs}%\nMomentum: SHIFTING POSITIVE\n\nSoldier, the tide is turning. You held through the drawdown. Now momentum is with you.\n\nTactical approach:\n1. Set hard stop at recent low\n2. Let position recover\n3. Consider exit at break-even or defined target\n4. Do NOT give back the bounce\n\nThis is where discipline pays off. You stayed in the fight. Now execute the recovery plan.\n\n${disclaimer}`,
                                `${intro}${positionDesc} showing life at -${pnlAbs}%. Momentum reversal detected.\n\nThis is why we don't panic sell at every dip. Sometimes positions recover. This might be one of those times.\n\nYour orders:\n‚Ä¢ Stop loss at recent swing low\n‚Ä¢ Ride the momentum\n‚Ä¢ Have an exit plan (break-even? Original target?)\n\nYou held when others would have folded. If this recovery continues, that discipline will be rewarded.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (personality === 'mentor') {
                            const responses = [
                                `${intro}I see ${positionDesc} is showing signs of recovery after a ${pnlAbs}% drawdown. This is a meaningful moment.\n\nYou've experienced the hardest part of trading - holding through adversity. And now, momentum appears to be shifting in your favor.\n\nSome thoughts to consider:\n‚Ä¢ Set a protective stop at the recent low (preserve the bounce)\n‚Ä¢ Allow yourself to feel cautiously optimistic\n‚Ä¢ Have a plan for if/when you return to break-even\n‚Ä¢ Remember: you don't have to hold forever just because you held this long\n\nThe market is offering you a potential path back. Receive it with both gratitude and prudence.\n\n${disclaimer}`,
                                `${intro}After being down ${pnlAbs}%, ${positionDesc} is showing momentum. This is the scenario every bagholder hopes for.\n\nYou persisted through difficulty. That takes emotional fortitude. Now the question becomes: what do you do with this gift?\n\nI'd encourage you to:\n‚Ä¢ Protect this bounce with a stop\n‚Ä¢ Have clear criteria for when you'd exit\n‚Ä¢ Consider whether partial profit at recovery makes sense\n\nYou've already proven patience. Now prove wisdom.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else {
                            return `${intro}**Position Recovery Analysis: ${positionDesc}**\n\n**Current Status:**\n‚Ä¢ P&L: -${pnlAbs}%\n‚Ä¢ Momentum: POSITIVE (reversal detected)\n‚Ä¢ Status: POTENTIAL RECOVERY IN PROGRESS\n\n**Statistical Context:**\n‚Ä¢ Bounce continuation probability: ~67%\n‚Ä¢ Mean reversion plays historically succeed: 58% of the time\n\n**Recommended Strategy:**\n1. Set stop at recent swing low (protect bounce)\n2. Let momentum work\n3. Define exit target (break-even or better)\n4. ${isOption && daysToExpiry ? `Time factor: ${daysToExpiry} days remaining - factor into decision` : ""}\n\n**Conclusion:**\nPositive momentum after drawdown is statistically favorable. Risk management (stop) + patience = optimal approach.\n\n${disclaimer}`;
                        }
                    } else if (momentum === 'bleeding') {
                        // Position down AND still falling - danger zone
                        if (personality === 'homie') {
                            const responses = [
                                `${intro}${positionDesc} down ${pnlAbs}% and still bleeding... üíÄ\n\nI'm not gonna sugarcoat it: this is rough. Every day you hold, you're making a new decision to be in this position at THIS price. Are you okay with that?\n\n${profile.holdThroughPain ? "Look, I'm a diamond hands believer. I really am. But even I know when something is dying vs when something is dipping." : "Sometimes you gotta know when to fold 'em."}\n\nQuestions to ask yourself:\n‚Ä¢ If I wasn't in this trade, would I enter NOW?\n‚Ä¢ What's the catalyst that turns this around?\n‚Ä¢ Am I holding out of hope or out of strategy?\n\nHope is not a strategy. ${ticker} doesn't know you're holding. It doesn't care.\n\n${disclaimer}`,
                                `${intro}Down ${pnlAbs}% on ${positionDesc} and it's STILL going down? üìâ\n\nBro this is the classic baghold nightmare. Catching falling knives, hoping for a bounce that never comes, watching it bleed daily...\n\nI gotta be honest with you: sometimes the best trade is the one you don't make. And sometimes the second best trade is exiting a bad one before it gets worse.\n\n${pnlAbs > 40 ? `${pnlAbs}% is a DEEP hole. To recover that, you need +${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}%. Is ${ticker} gonna do that?` : `${pnlAbs}% isn't catastrophic yet, but if it keeps bleeding...`}\n\nNo judgment if you hold. But also no judgment if you cut it loose.\n\n${disclaimer}`,
                                `${intro}${ticker} treating you like an ATM at this point. Down ${pnlAbs}% and bleeding more. üò§\n\nHere's the uncomfortable truth: the market doesn't care about your cost basis. It doesn't know you're a bagholder. It's just doing its thing.\n\nOptions as I see them:\n1. **Cut it** - Accept the L, free up capital, move on\n2. **Set a hard stop below** - Give it X more % before you're out\n3. **Average down** - Only if you TRULY believe (dangerous)\n4. **Hold and hope** - The eternal bagholder special\n\nWhich one aligns with an actual STRATEGY vs just hoping?\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (personality === 'sergeant') {
                            const responses = [
                                `${intro}CRITICAL ALERT: ${positionDesc}\nP&L: -${pnlAbs}%\nMomentum: STILL NEGATIVE\nStatus: BLEEDING\n\nSoldier, let's be direct: this position is not recovering. It's deteriorating. Every day you hold a bleeder is a day your capital is NOT working for you elsewhere.\n\n${profile.holdThroughPain ? "I respect conviction. But conviction without a catalyst is just stubbornness." : "The disciplined move is often the hardest one."}\n\nHard questions:\n‚Ä¢ Why is this still going down?\n‚Ä¢ What changes the momentum?\n‚Ä¢ Is hope your strategy?\n\nIf you can't answer these clearly, consider your exit. Dead soldiers don't win wars.\n\n${disclaimer}`,
                                `${intro}${positionDesc}: DOWN ${pnlAbs}%. STILL FALLING.\n\nThis is not a "hold and it'll come back" situation. This is a "recognize reality" situation.\n\n**The Math:**\n‚Ä¢ Current loss: ${pnlAbs}%\n‚Ä¢ Recovery needed: +${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}%\n‚Ä¢ Time required at ${isOption && daysToExpiry ? daysToExpiry + " days remaining" : "unknown timeline"}\n\n**The Discipline:**\nSunk cost fallacy is the most expensive bias in trading. The money lost is gone whether you hold or sell. The only question is: where should your REMAINING capital be?\n\nMake a decision. Execute. Move forward.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (personality === 'mentor') {
                            const responses = [
                                `${intro}I can feel the weight of this situation. ${positionDesc} down ${pnlAbs}% and continuing to decline. This is one of trading's hardest places to be.\n\nLet me offer some perspective that might help:\n\nThe loss you've already experienced is real whether you sell or not. What matters now is what you do with your remaining capital. Is it best deployed here, hoping for a recovery? Or elsewhere, in a position with clearer momentum?\n\nThere's no shame in accepting a thesis was wrong. Every successful trader has losses - often significant ones. What separates them is their ability to accept reality and move forward.\n\nWhat does your wisest self suggest?\n\n${disclaimer}`,
                                `${intro}${positionDesc} continues lower at -${pnlAbs}%. The bag grows heavier.\n\nI want to invite a difficult thought: sometimes the kindest thing we can do for ourselves is let go. Not out of defeat, but out of self-respect. We deserve to deploy our capital where it has a chance to grow, not where it slowly evaporates.\n\n${profile.holdThroughPain ? "There's honor in conviction. But there's also wisdom in knowing when conviction has become denial." : "Cutting losses is not failure. It's risk management."}\n\nThe market offers infinite second chances. But only to those who preserve capital for them.\n\nWhat feels true for you?\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else {
                            return `${intro}**Bagholding Analysis: ${positionDesc}**\n\n**Current Metrics:**\n‚Ä¢ P&L: -${pnlAbs}%\n‚Ä¢ Momentum: NEGATIVE (still declining)\n‚Ä¢ Status: BLEEDING POSITION\n\n**Statistical Reality:**\n‚Ä¢ Bleeding positions continue lower: 65% of the time\n‚Ä¢ Recovery probability decreasing with each decline\n‚Ä¢ Capital required to recover: +${((pnlAbs)/(100-pnlAbs)*100).toFixed(0)}%\n\n**Opportunity Cost Analysis:**\n‚Ä¢ Capital tied in bleeding position = capital unavailable for profitable trades\n‚Ä¢ Average return on well-positioned trades: +15-25%\n‚Ä¢ Expected value of this position: Declining\n\n**Data-Driven Recommendation:**\nSunk cost fallacy suggests continued holding based on past investment. Rational analysis suggests evaluating based on FUTURE probability only.\n\nConsider exit unless clear catalyst exists for reversal.\n\n${disclaimer}`;
                        }
                    } else {
                        // No momentum info provided
                        const responses = [
                            `${intro}${positionDesc} is down ${pnlAbs}%. The classic bagholder's dilemma. üéí\n\nBut I need more info to give you real advice. Is ${ticker} RIPPING (bouncing back) or BLEEDING (still falling)?\n\nThe advice is COMPLETELY different:\n‚Ä¢ If ripping ‚Üí maybe ride the comeback\n‚Ä¢ If bleeding ‚Üí maybe cut your losses\n\nUpdate the momentum on your position and hit me back. I'll give you the real talk based on what's actually happening.\n\n${disclaimer}`,
                            `${intro}Down ${pnlAbs}% on ${positionDesc}. That's a bag alright. üòÖ\n\nReal question though: what's the momentum like? Is it:\n‚Ä¢ üî• RIPPING - Bouncing, showing life, potential recovery\n‚Ä¢ üíÄ BLEEDING - Still falling, no floor in sight\n\nThese require opposite strategies. Update your position with the momentum and I'll give you actual actionable advice.\n\nRight now I'm shooting blind!\n\n${disclaimer}`
                        ];
                        return pick(responses);
                    }
                }

                // AVERAGING
                if (emotion === 'average') {
                    const momentum = position?.momentum;
                    const potentialNewAvg = position ? ((position.entryPrice + currentPrice) / 2).toFixed(2) : 0;

                    if (isUp) {
                        // Averaging UP - adding to a winner
                        if (personality === 'homie') {
                            const responses = [
                                `${intro}Averaging UP on ${positionDesc} while you're already up ${pnlAbs}%? üìà\n\nYou know what? I respect it. Adding to winners is literally what the pros do. "Let your winners run" doesn't mean watch from the sidelines - it can mean STACK.\n\nThings to consider:\n‚Ä¢ Position size - don't overexpose yourself\n‚Ä¢ Entry point - is THIS the level you want more at?\n‚Ä¢ Stop management - update your stop for the new size\n\nIf the thesis is the same and momentum is there, adding to a winner beats catching falling knives ANY day. Send it (responsibly). üöÄ\n\n${disclaimer}`,
                                `${intro}Up ${pnlAbs}% on ${positionDesc} and you want MORE? I like the confidence. üòè\n\nAveraging up on winners has a 67% success rate historically. That's way better than averaging down on losers (don't get me started).\n\nMy checklist before you add:\n‚úì Thesis still valid?\n‚úì Not already overweight this position?\n‚úì Have a stop in mind?\n‚úì Can afford to lose what you're adding?\n\nIf all checks pass - stack that position. Trend is your friend.\n\n${disclaimer}`,
                                `${intro}Adding to ${positionDesc} at +${pnlAbs}%? The classic "pyramid up" move. üèîÔ∏è\n\nThis is actually the RIGHT way to size into trades. Most people do it backwards - they add to losers and cut winners. You're doing the opposite. Good.\n\nJust remember:\n‚Ä¢ Your average cost will go UP (closer to current price)\n‚Ä¢ If it reverses, you'll lose more\n‚Ä¢ But if it keeps running, you'll win bigger\n\nHigh risk, high reward. Make sure you're comfortable with both outcomes.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (personality === 'sergeant') {
                            const responses = [
                                `${intro}AVERAGING UP on ${positionDesc} at +${pnlAbs}%.\n\n**Assessment:** Adding to winners is acceptable strategy. Historical success rate: 67%.\n\n**Tactical Considerations:**\n1. Position sizing - don't exceed max exposure limits\n2. Entry validation - confirm momentum supports addition\n3. Risk adjustment - update stop loss for new position size\n\nAdding to strength is disciplined. Adding recklessly is not. Know the difference.\n\n${disclaimer}`,
                                `${intro}You want to add to ${positionDesc} while UP ${pnlAbs}%. Good instinct.\n\nAveraging UP beats averaging DOWN. That's not opinion - that's data. Winners tend to keep winning. Losers tend to keep losing.\n\n**Orders:**\n‚Ä¢ Confirm thesis is intact\n‚Ä¢ Check position size limits\n‚Ä¢ Set stop for combined position\n‚Ä¢ Execute with discipline\n\nBuild the position. Don't chase blindly.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else if (personality === 'mentor') {
                            const responses = [
                                `${intro}You're considering adding to ${positionDesc} while it's working in your favor (+${pnlAbs}%). This is a thoughtful approach that many successful traders use.\n\n"Pyramiding" into winning positions allows your edge to compound. The key is intention:\n\n‚Ä¢ Are you adding because the thesis is playing out (good)?\n‚Ä¢ Or because you're greedy and chasing (less good)?\n\nThe best adds come from conviction, not FOMO. If you're adding because the setup is working exactly as expected, that's intelligent position building.\n\nJust ensure you adjust your risk management for the larger position.\n\n${disclaimer}`,
                                `${intro}Adding to a winning position in ${positionDesc}. This can be wise if done with awareness.\n\nConsider: there's a difference between "adding to winners" (strategic) and "chasing" (emotional). The difference is your reasoning.\n\nStrategic adding:\n‚Ä¢ Thesis confirming\n‚Ä¢ Defined risk on new capital\n‚Ä¢ Part of a plan\n\nChasing:\n‚Ä¢ "It's working, I want more!"\n‚Ä¢ No defined risk\n‚Ä¢ Emotional impulse\n\nWhich describes your current mindset?\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        } else {
                            return `${intro}**Averaging Up Analysis: ${positionDesc}**\n\n**Position Data:**\n‚Ä¢ Current P&L: +${pnlAbs}%\n‚Ä¢ Strategy: Add to winning position\n‚Ä¢ New average cost: Closer to current price\n\n**Historical Statistics:**\n‚Ä¢ Averaging up success rate: 67%\n‚Ä¢ Averaging down success rate: 23%\n‚Ä¢ Relative advantage: +44% for averaging up\n\n**Risk Assessment:**\n‚Ä¢ Pro: Reinforcing winning behavior\n‚Ä¢ Con: Higher average cost increases reversal risk\n‚Ä¢ Net expected value: Positive (if thesis intact)\n\n**Recommendation:**\nAdding to winners is statistically supported. Ensure position sizing limits respected and stop loss adjusted for increased exposure.\n\n${disclaimer}`;
                        }
                    } else {
                        // Averaging DOWN
                        if (momentum === 'ripping') {
                            // Down but bouncing - might be good time to add
                            if (personality === 'homie') {
                                const responses = [
                                    `${intro}${positionDesc} is down ${pnlAbs}% but RIPPING now? üëÄ\n\nOkay this is actually interesting. The bounce gives you a better entry point AND confirmation that there's buying interest.\n\nIf you add here, your new average would be around ~$${potentialNewAvg}. That means:\n‚Ä¢ Lower breakeven point\n‚Ä¢ Bigger gains when it recovers\n‚Ä¢ Faster path back to green\n\n${profile.avgDownOk ? "I'm into it. But set a stop at the recent low in case the bounce fails." : "I'm cautiously optimistic. Add SMALL and set a tight stop."}\n\nMomentum is on your side for once. Make it count.\n\n${disclaimer}`,
                                    `${intro}Down ${pnlAbs}% on ${positionDesc} but it's bouncing? This changes things. üìà\n\nAveraging down into a FALLING position? Terrible idea. Averaging down into a BOUNCING position? Different story.\n\nThe math if you add:\n‚Ä¢ New avg cost: ~$${potentialNewAvg}\n‚Ä¢ Break-even easier to hit\n‚Ä¢ Recovery accelerated\n\nThe risk:\n‚Ä¢ Bounce could fail\n‚Ä¢ Could be a dead cat\n\n${profile.avgDownOk ? "Set a stop at the recent low and add. If momentum continues, you look like a genius." : "Proceed with caution. Small add, tight stop."}\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'sergeant') {
                                const responses = [
                                    `${intro}${positionDesc}: -${pnlAbs}% BUT momentum shifting.\n\n**Tactical Assessment:**\nAveraging down into a reversal is more favorable than averaging into continued decline.\n\n**Execution Plan:**\n1. Add position at current levels\n2. New average cost: ~$${potentialNewAvg}\n3. CRITICAL: Set stop at recent swing low\n4. If stop hits, accept loss on entire position\n\n${profile.avgDownOk ? "Green light to add with proper risk management." : "Proceed cautiously. Small position, tight stop."}\n\nThis is about disciplined execution, not hope.\n\n${disclaimer}`,
                                    `${intro}Position ${positionDesc} showing momentum reversal at -${pnlAbs}%.\n\n**Analysis:**\n‚Ä¢ Averaging into momentum: More favorable\n‚Ä¢ New cost basis: ~$${potentialNewAvg}\n‚Ä¢ Recovery probability: Improved vs bleeding scenario\n\n**Orders:**\nIf adding, place stop at recent low. No exceptions. The bounce confirms buyer interest, but buyers can disappear.\n\nAdd with discipline or don't add at all.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'mentor') {
                                const responses = [
                                    `${intro}I see ${positionDesc} is down ${pnlAbs}% but showing signs of recovery. This creates an interesting opportunity.\n\nAveraging down typically has low success rates - but that changes when momentum shifts. The bounce suggests buyers are emerging, which gives some validity to adding here.\n\nIf you add:\n‚Ä¢ Your average cost drops to ~$${potentialNewAvg}\n‚Ä¢ Recovery requires less upside\n‚Ä¢ You benefit more from continued momentum\n\nThe key is protecting yourself: set a stop at the recent low. If the bounce fails, you want out of both positions. If it continues, you're well-positioned.\n\nWhat does your conviction tell you?\n\n${disclaimer}`,
                                    `${intro}${positionDesc} at -${pnlAbs}% with positive momentum. This is one of the few scenarios where averaging down makes statistical sense.\n\nThe presence of a bounce suggests your thesis might still be valid - just poorly timed initially. Adding here could lower your cost basis to ~$${potentialNewAvg}, making recovery more achievable.\n\nHowever, bounces can fail. I'd encourage:\n‚Ä¢ Smaller addition than original position\n‚Ä¢ Stop at recent low (non-negotiable)\n‚Ä¢ Clear criteria for when you'd exit entirely\n\nAveraging down with momentum support is different from averaging down into the void.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else {
                                return `${intro}**Averaging Down Analysis: ${positionDesc}**\n\n**Current Status:**\n‚Ä¢ P&L: -${pnlAbs}%\n‚Ä¢ Momentum: POSITIVE (reversal detected)\n‚Ä¢ Proposed new avg: ~$${potentialNewAvg}\n\n**Statistical Context:**\n‚Ä¢ Averaging into momentum reversal success: 58%\n‚Ä¢ Averaging into continued decline success: 23%\n‚Ä¢ Current scenario: Favorable\n\n**Risk Management Required:**\n‚Ä¢ Stop loss at recent swing low: MANDATORY\n‚Ä¢ Position size: Should not exceed original\n\n**Recommendation:**\nStatistically supported to add with defined risk. If bounce fails, exit entire position at stop level.\n\n${disclaimer}`;
                            }
                        } else if (momentum === 'bleeding') {
                            // Down AND falling - dangerous territory
                            if (personality === 'homie') {
                                const responses = [
                                    `${intro}${positionDesc} down ${pnlAbs}% and STILL BLEEDING? And you want to add MORE? üò¨\n\nBro... I gotta be real with you. This is literally the move that blows up accounts. "It's cheaper now!" Yeah, and it might get cheaper tomorrow too. And the day after.\n\n${profile.avgDownWhenBleeding ? "Look, I'm aggressive. I've caught falling knives before. But even I know you need to see SOME sign of a bottom first." : "I'm not gonna tell you what to do with your money. But averaging into a falling position is how people turn 20% losses into 60% losses."}\n\nThe market doesn't care about your cost basis. It doesn't know you're holding. It's just doing its thing.\n\nAt LEAST wait for a bounce. Please.\n\n${disclaimer}`,
                                    `${intro}Down ${pnlAbs}% on ${positionDesc}, still falling, and you're thinking "what if I add more?" üî™\n\nI'm gonna be straight with you: catching falling knives is how traders lose hands. (Metaphorically. And financially.)\n\nThe statistics are brutal:\n‚Ä¢ Avg-down into decline success rate: 23%\n‚Ä¢ Average additional loss: 34%\n‚Ä¢ Probability of account damage: HIGH\n\n${profile.avgDownWhenBleeding ? "Even diamond-hands me says wait for a bounce. ANY sign of a floor." : "My advice: don't add. Either wait for momentum to shift, or cut your losses."}\n\nThere will be other trades. Don't blow up on this one.\n\n${disclaimer}`,
                                    `${intro}Oh no. ${positionDesc} down ${pnlAbs}%, bleeding, and you're considering averaging down?\n\nLemme paint you a picture: you add more. It drops another 15%. Now you've doubled your exposure AND doubled your loss. You add again. It drops more. Suddenly that "it's so cheap now" position is half your portfolio and down 50%.\n\nThat's the averaging down death spiral. It's killed more traders than any single stock.\n\n${profile.avgDownWhenBleeding ? "I'm not saying never. But at LEAST wait for green candles." : "Honestly? Don't. Either hold what you have or cut it. Adding here is gambling."}\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'sergeant') {
                                const responses = [
                                    `${intro}STOP. DO NOT AVERAGE DOWN.\n\n**Position:** ${positionDesc}\n**P&L:** -${pnlAbs}%\n**Momentum:** STILL NEGATIVE\n**Recommended action:** DO NOT ADD\n\nAveraging down into a downtrend has a 23% success rate and average additional loss of 34%. Those are not odds a disciplined trader accepts.\n\nYour options:\n1. HOLD current position (accept current risk)\n2. CUT position (preserve capital)\n3. WAIT for momentum shift (then reassess)\n\nOption NOT available: Add more to a falling position.\n\nThat's not discipline. That's denial.\n\n${disclaimer}`,
                                    `${intro}NEGATIVE. Averaging down into a bleeder is DENIED.\n\n${positionDesc} is DOWN ${pnlAbs}% and FALLING. Adding more capital here is like sending reinforcements into a losing battle.\n\n**The Math:**\n‚Ä¢ Avg-down success rate: 23%\n‚Ä¢ Additional loss probability: 77%\n‚Ä¢ Account blow-up correlation: High\n\nWant to average down? Fine. But ONLY after momentum shifts. Until then, your capital stays on the sidelines or you cut the position.\n\nEnd of discussion.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else if (personality === 'mentor') {
                                const responses = [
                                    `${intro}I understand the impulse. ${positionDesc} is down ${pnlAbs}% and you're thinking "if I add here, my average cost drops and recovery becomes easier."\n\nMathematically, that's true. Emotionally, it's a trap.\n\nHere's what often happens: we average down, it drops more. We average again. It drops again. Soon, a "small position" has become our largest holding - and our largest loss.\n\nThis is called the sunk cost fallacy combined with anchoring bias. Our brains want to "fix" the mistake by adding more. But the market doesn't care about our past decisions.\n\nMy guidance: wait. Wait for momentum to shift. Wait for ANY sign of a floor. THEN consider adding. Adding into continued decline rarely ends well.\n\n${disclaimer}`,
                                    `${intro}${positionDesc} continues lower at -${pnlAbs}%, and you're considering adding.\n\nI want to gently challenge this impulse. What's driving it?\n\n‚Ä¢ "It's cheaper now" - True, but it might get cheaper\n‚Ä¢ "I want to lower my average" - The market doesn't care about your average\n‚Ä¢ "It HAS to bounce eventually" - Nothing HAS to do anything\n\nAveraging down into falling positions has poor historical outcomes. The wise approach, I believe, is patience. Wait for evidence the decline has stopped. Then, and only then, consider adding.\n\nCapital is precious. Don't throw it at a falling knife hoping to catch the handle.\n\n${disclaimer}`
                                ];
                                return pick(responses);
                            } else {
                                return `${intro}**Averaging Down Analysis: CAUTION**\n\n**Position:** ${positionDesc}\n**P&L:** -${pnlAbs}%\n**Momentum:** NEGATIVE (still declining)\n**Proposed Action:** Average down\n\n**Statistical Reality:**\n‚Ä¢ Averaging into downtrend success rate: 23%\n‚Ä¢ Average additional loss when unsuccessful: 34%\n‚Ä¢ Expected value of averaging down: NEGATIVE\n\n**Comparison:**\n‚Ä¢ EV of holding current position: Unknown\n‚Ä¢ EV of averaging down: Negative\n‚Ä¢ EV of waiting for reversal: More favorable\n\n**Data-Driven Recommendation:**\nDO NOT average down into negative momentum. Probability strongly favors either:\n1. Hold current position and wait for reversal\n2. Cut position and redeploy capital\n\nAveraging down in this scenario has negative expected value.\n\n${disclaimer}`;
                            }
                        } else {
                            // No momentum info
                            const responses = [
                                `${intro}You want to average down on ${positionDesc} which is down ${pnlAbs}%. Okay, but first I need to know: what's the MOMENTUM? ü§î\n\n‚Ä¢ If it's RIPPING (bouncing) ‚Üí Averaging could be smart\n‚Ä¢ If it's BLEEDING (still falling) ‚Üí Averaging could be suicide\n\nThese are COMPLETELY different situations. Update your position's momentum and hit me back.\n\nI refuse to give averaging advice without knowing if you're catching a bounce or catching a falling knife.\n\n${disclaimer}`,
                                `${intro}Down ${pnlAbs}% on ${positionDesc} and thinking about adding. I have follow-up questions:\n\nIs ${ticker}:\nüî• RIPPING - Bouncing, showing green candles, potential reversal\nüíÄ BLEEDING - Still falling, red everywhere, finding new lows\n\nThe advice is 180¬∞ different depending on the answer.\n\n‚Ä¢ Ripping = might be okay to add\n‚Ä¢ Bleeding = probably should not add\n\nUpdate the momentum and let's talk strategy.\n\n${disclaimer}`
                            ];
                            return pick(responses);
                        }
                    }
                }

                // Default fallback
                return `${intro}Tell me more about what's going on with your ${positionDesc}. I'm here to help you think through this.${disclaimer}`;
            };

            // Note: disclaimer is already included in all responses above
            return generateResponse();
        };

        // Position Card Component
        const PositionCard = ({ position, onClick }) => {
            const currentPrice = position.livePrice || position.currentPrice;
            const multiplier = position.type === 'option' ? 100 : 1; // Options = 100 shares per contract
            const pnl = (currentPrice - position.entryPrice) * position.quantity * multiplier;
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice * 100).toFixed(2);
            const urgency = getUrgency(position);
            const daysToExpiry = getDaysToExpiry(position.expiration);
            const isProfit = pnl >= 0;
            const grade = getTradeGrade(position);

            return (
                <div
                    onClick={() => onClick(position)}
                    className={`card-gradient backdrop-blur-sm border ${urgency.level === 'critical' ? 'border-red-500 urgent-pulse' : urgency.level === 'warning' ? 'border-yellow-500' : 'border-gray-700'} rounded-xl p-4 cursor-pointer hover:border-blue-500 transition-all`}
                >
                    {/* AI Grade Badge */}
                    <div className="flex justify-between items-center mb-2">
                        <div className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold ${
                            grade.score >= 7 ? 'bg-green-500/20 border border-green-500/50' :
                            grade.score >= 5 ? 'bg-yellow-500/20 border border-yellow-500/50' :
                            grade.score >= 3 ? 'bg-orange-500/20 border border-orange-500/50' :
                            'bg-red-500/20 border border-red-500/50'
                        }`}>
                            <span>{grade.emoji}</span>
                            <span className={grade.color}>{grade.score}/10</span>
                            <span className="text-gray-400 font-normal ml-1">{grade.label}</span>
                        </div>
                        <span className="text-lg">{urgency.icon}</span>
                    </div>

                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <div className="flex items-center gap-2">
                                <span className="text-xl font-bold">{position.ticker}</span>
                                <span className={`text-xs px-2 py-1 rounded font-semibold ${
                                    position.type === 'option' ? 'bg-purple-500/30 text-purple-300 border border-purple-500/50' :
                                    position.type === 'crypto' ? 'bg-orange-500/30 text-orange-300 border border-orange-500/50' :
                                    'bg-blue-500/30 text-blue-300 border border-blue-500/50'
                                }`}>
                                    {position.type === 'option' ? `üìú ${position.optionType?.toUpperCase()} $${position.strike}` :
                                     position.type === 'crypto' ? 'ü™ô CRYPTO' : 'üìä STOCK'}
                                </span>
                            </div>
                            {/* Quantity/Contracts */}
                            <div className="text-xs text-gray-500 mt-1">
                                {position.quantity} {position.type === 'option' ? 'contracts' : position.type === 'crypto' ? 'coins' : 'shares'}
                            </div>
                            {/* Expiration or No Expiry indicator */}
                            {position.type === 'option' ? (
                                <div className={`text-sm mt-1 font-semibold ${daysToExpiry <= 7 ? 'text-red-400' : daysToExpiry <= 30 ? 'text-yellow-400' : 'text-gray-400'}`}>
                                    ‚è∞ {formatExpirationDate(position.expiration)} {daysToExpiry <= 7 ? '‚ö†Ô∏è' : ''}
                                </div>
                            ) : (
                                <div className="text-xs text-green-500/70 mt-1">
                                    ‚àû No expiration
                                </div>
                            )}
                        </div>
                        <div className="text-right">
                            <div className={`text-2xl font-bold ${isProfit ? 'text-green-400' : 'text-red-400'}`}>
                                {isProfit ? '+' : ''}{pnlPercent}%
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-2 text-sm">
                        <div className="text-gray-400">Entry</div>
                        <div className="text-right">${position.entryPrice.toLocaleString()}</div>
                        <div className="text-gray-400">Current</div>
                        <div className="text-right flex items-center justify-end gap-2">
                            ${(position.livePrice || position.currentPrice).toLocaleString()}
                            {position.dayChange && (
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    parseFloat(position.dayChange) >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                                }`}>
                                    {parseFloat(position.dayChange) >= 0 ? '+' : ''}{position.dayChange}%
                                </span>
                            )}
                        </div>
                        <div className="text-gray-400">AI Says</div>
                        <div className="text-right text-gray-300 italic">{grade.reason}</div>
                    </div>

                    {position.momentum && (
                        <div className={`mt-3 p-2 rounded-lg text-xs flex items-center gap-2 ${
                            position.momentum === 'ripping' ? 'bg-green-500/20 border border-green-500/50 text-green-300' :
                            position.momentum === 'uptrend' ? 'bg-green-500/10 border border-green-500/30 text-green-400' :
                            position.momentum === 'bleeding' ? 'bg-red-500/20 border border-red-500/50 text-red-300' :
                            position.momentum === 'downtrend' ? 'bg-red-500/10 border border-red-500/30 text-red-400' :
                            'bg-gray-500/20 border border-gray-500/50 text-gray-300'
                        }`}>
                            {position.momentum === 'ripping' && 'üî• RIPPING'}
                            {position.momentum === 'uptrend' && 'üìà Uptrend'}
                            {position.momentum === 'bleeding' && 'üíÄ BLEEDING'}
                            {position.momentum === 'downtrend' && 'üìâ Downtrend'}
                            {position.momentum === 'flat' && 'üòê Flat'}
                            {position.weekChange && <span className="ml-auto">Week: {position.weekChange > 0 ? '+' : ''}{position.weekChange}%</span>}
                        </div>
                    )}

                    {urgency.level === 'critical' && (
                        <div className="mt-3 p-2 bg-red-500/20 border border-red-500/50 rounded-lg text-xs text-red-300">
                            ‚ö†Ô∏è URGENT: Options expiring soon - action may be needed
                        </div>
                    )}
                </div>
            );
        };

        // Alert Panel Modal
        const AlertPanel = ({ isOpen, onClose, alerts, lastCheck }) => {
            if (!isOpen) return null;

            const criticalAlerts = alerts.filter(a => a.type === 'critical');
            const warningAlerts = alerts.filter(a => a.type === 'warning');
            const opportunityAlerts = alerts.filter(a => a.type === 'opportunity');
            const infoAlerts = alerts.filter(a => a.type === 'info');

            const AlertCard = ({ alert }) => {
                const bgColor = {
                    critical: 'bg-red-900/40 border-red-500',
                    warning: 'bg-yellow-900/40 border-yellow-500',
                    opportunity: 'bg-green-900/40 border-green-500',
                    info: 'bg-blue-900/40 border-blue-500'
                }[alert.type];

                const textColor = {
                    critical: 'text-red-400',
                    warning: 'text-yellow-400',
                    opportunity: 'text-green-400',
                    info: 'text-blue-400'
                }[alert.type];

                return (
                    <div className={`p-4 rounded-xl border ${bgColor} mb-3`}>
                        <div className="flex items-start gap-3">
                            <span className="text-2xl">{alert.icon}</span>
                            <div className="flex-1">
                                <div className="flex items-center justify-between">
                                    <span className={`font-bold ${textColor}`}>{alert.title}</span>
                                    <span className="text-xs text-gray-400">{alert.ticker}</span>
                                </div>
                                <p className="text-sm text-gray-300 mt-1">{alert.message}</p>
                                <div className="flex items-center justify-between mt-2">
                                    <span className={`text-xs font-semibold ${alert.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {alert.pnl >= 0 ? '+' : ''}{alert.pnl?.toFixed(1)}%
                                    </span>
                                    <span className="text-xs text-gray-400 italic">{alert.action}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-10 overflow-y-auto">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col">
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-900">
                            <div>
                                <h2 className="text-xl font-bold flex items-center gap-2">
                                    üîî Position Alerts
                                    {criticalAlerts.length > 0 && (
                                        <span className="bg-red-500 text-xs px-2 py-0.5 rounded-full animate-pulse">
                                            {criticalAlerts.length} URGENT
                                        </span>
                                    )}
                                </h2>
                                <p className="text-xs text-gray-400">
                                    Last scan: {lastCheck ? lastCheck.toLocaleTimeString() : 'Never'}
                                </p>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>

                        <div className="p-4 overflow-y-auto flex-1">
                            {alerts.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-4xl mb-4">‚úÖ</div>
                                    <p className="text-gray-400">All positions look healthy!</p>
                                    <p className="text-xs text-gray-500 mt-2">No immediate attention needed.</p>
                                </div>
                            ) : (
                                <>
                                    {/* Critical Alerts */}
                                    {criticalAlerts.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-red-400 font-bold text-sm mb-2 flex items-center gap-2">
                                                üö® CRITICAL ({criticalAlerts.length})
                                            </h3>
                                            {criticalAlerts.map(alert => (
                                                <AlertCard key={alert.id} alert={alert} />
                                            ))}
                                        </div>
                                    )}

                                    {/* Warning Alerts */}
                                    {warningAlerts.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-yellow-400 font-bold text-sm mb-2 flex items-center gap-2">
                                                ‚ö†Ô∏è WARNINGS ({warningAlerts.length})
                                            </h3>
                                            {warningAlerts.map(alert => (
                                                <AlertCard key={alert.id} alert={alert} />
                                            ))}
                                        </div>
                                    )}

                                    {/* Opportunity Alerts */}
                                    {opportunityAlerts.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-green-400 font-bold text-sm mb-2 flex items-center gap-2">
                                                üí∞ OPPORTUNITIES ({opportunityAlerts.length})
                                            </h3>
                                            {opportunityAlerts.map(alert => (
                                                <AlertCard key={alert.id} alert={alert} />
                                            ))}
                                        </div>
                                    )}

                                    {/* Info Alerts */}
                                    {infoAlerts.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-blue-400 font-bold text-sm mb-2 flex items-center gap-2">
                                                üìä MONITORING ({infoAlerts.length})
                                            </h3>
                                            {infoAlerts.map(alert => (
                                                <AlertCard key={alert.id} alert={alert} />
                                            ))}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        <div className="p-4 border-t border-gray-700 bg-gray-800/50">
                            <p className="text-xs text-gray-500 text-center">
                                üí° Alerts update when your positions change or prices update
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Position Detail Modal
        const PositionDetailModal = ({ position, onClose, onDelete, onUpdate }) => {
            if (!position) return null;

            console.log(`[Modal] Position ${position.ticker}: livePrice=${position.livePrice}, currentPrice=${position.currentPrice}`);
            const currentPrice = position.livePrice || position.currentPrice;
            const multiplier = position.type === 'option' ? 100 : 1; // Options = 100 shares per contract
            const pnl = (currentPrice - position.entryPrice) * position.quantity * multiplier;
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice * 100);
            const isProfit = pnl >= 0;
            const daysToExpiry = position.expiration ? getDaysToExpiry(position.expiration) : null;
            const grade = getTradeGrade(position);
            const totalValue = currentPrice * position.quantity * multiplier;
            const costBasis = position.entryPrice * position.quantity * multiplier;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            {/* Header */}
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-3xl font-bold">{position.ticker}</span>
                                        <span className={`text-sm px-3 py-1 rounded-full font-semibold ${
                                            position.type === 'option' ? 'bg-purple-500/30 text-purple-300 border border-purple-500' :
                                            position.type === 'crypto' ? 'bg-orange-500/30 text-orange-300 border border-orange-500' :
                                            'bg-blue-500/30 text-blue-300 border border-blue-500'
                                        }`}>
                                            {position.type === 'option' ? 'üìú OPTION' : position.type === 'crypto' ? 'ü™ô CRYPTO' : 'üìä STOCK'}
                                        </span>
                                    </div>
                                    {position.type === 'option' && (
                                        <div className="text-purple-400 font-semibold">
                                            ${position.strike} {position.optionType?.toUpperCase()}
                                        </div>
                                    )}
                                </div>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>

                            {/* AI Grade */}
                            <div className={`p-4 rounded-xl mb-4 ${
                                grade.score >= 7 ? 'bg-green-500/20 border border-green-500/50' :
                                grade.score >= 5 ? 'bg-yellow-500/20 border border-yellow-500/50' :
                                grade.score >= 3 ? 'bg-orange-500/20 border border-orange-500/50' :
                                'bg-red-500/20 border border-red-500/50'
                            }`}>
                                <div className="flex items-center justify-between">
                                    <span className="text-lg font-bold">AI Grade: {grade.emoji} {grade.score}/10</span>
                                    <span className={grade.color}>{grade.label}</span>
                                </div>
                                <p className="text-sm text-gray-300 mt-2 italic">{grade.reason}</p>
                            </div>

                            {/* P&L Section */}
                            <div className={`p-4 rounded-xl mb-4 ${isProfit ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                                <div className="text-center">
                                    <div className={`text-4xl font-bold ${isProfit ? 'text-green-400' : 'text-red-400'}`}>
                                        {isProfit ? '+' : ''}{pnlPercent.toFixed(2)}%
                                    </div>
                                    <div className={`text-lg ${isProfit ? 'text-green-400' : 'text-red-400'}`}>
                                        {isProfit ? '+' : ''}${pnl.toFixed(2)}
                                    </div>
                                </div>
                            </div>

                            {/* Position Details */}
                            <div className="space-y-3 mb-4">
                                <div className="flex justify-between p-3 bg-gray-800 rounded-lg">
                                    <span className="text-gray-400">Quantity</span>
                                    <span className="font-semibold">{position.quantity} {position.type === 'option' ? 'contracts' : position.type === 'crypto' ? 'coins' : 'shares'}</span>
                                </div>
                                <div className="flex justify-between p-3 bg-gray-800 rounded-lg">
                                    <span className="text-gray-400">Entry Price</span>
                                    <span className="font-semibold">${position.entryPrice.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between p-3 bg-gray-800 rounded-lg">
                                    <span className="text-gray-400">Current Price</span>
                                    <span className="font-semibold">${currentPrice.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between p-3 bg-gray-800 rounded-lg">
                                    <span className="text-gray-400">Cost Basis</span>
                                    <span className="font-semibold">${costBasis.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between p-3 bg-gray-800 rounded-lg">
                                    <span className="text-gray-400">Current Value</span>
                                    <span className="font-semibold">${totalValue.toFixed(2)}</span>
                                </div>
                                {position.type === 'option' && daysToExpiry !== null && (
                                    <div className={`flex justify-between p-3 rounded-lg ${daysToExpiry <= 7 ? 'bg-red-500/20 border border-red-500' : daysToExpiry <= 30 ? 'bg-yellow-500/20 border border-yellow-500' : 'bg-gray-800'}`}>
                                        <span className="text-gray-400">Expiration</span>
                                        <span className={`font-semibold ${daysToExpiry <= 7 ? 'text-red-400' : daysToExpiry <= 30 ? 'text-yellow-400' : ''}`}>
                                            {formatExpirationDate(position.expiration)} {daysToExpiry <= 7 ? '‚ö†Ô∏è' : ''}
                                        </span>
                                    </div>
                                )}
                                {position.type !== 'option' && (
                                    <div className="flex justify-between p-3 bg-gray-800 rounded-lg">
                                        <span className="text-gray-400">Expiration</span>
                                        <span className="text-green-400 font-semibold">‚àû No expiry</span>
                                    </div>
                                )}
                                {position.momentum && (
                                    <div className={`flex justify-between p-3 rounded-lg ${
                                        position.momentum === 'ripping' ? 'bg-green-500/20 border border-green-500' :
                                        position.momentum === 'bleeding' ? 'bg-red-500/20 border border-red-500' :
                                        'bg-gray-800'
                                    }`}>
                                        <span className="text-gray-400">Momentum</span>
                                        <span className="font-semibold">
                                            {position.momentum === 'ripping' && 'üî• RIPPING'}
                                            {position.momentum === 'uptrend' && 'üìà Uptrend'}
                                            {position.momentum === 'bleeding' && 'üíÄ BLEEDING'}
                                            {position.momentum === 'downtrend' && 'üìâ Downtrend'}
                                            {position.momentum === 'flat' && 'üòê Flat'}
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Action Buttons */}
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition-colors"
                                >
                                    Close
                                </button>
                                <button
                                    onClick={() => {
                                        if (confirm('Are you sure you want to remove this position?')) {
                                            onDelete(position.id);
                                            onClose();
                                        }
                                    }}
                                    className="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-semibold transition-colors"
                                >
                                    üóëÔ∏è Close Position
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Talk Me Down Modal
        const TalkMeDownModal = ({ isOpen, onClose, positions, personality = 'homie' }) => {
            const [step, setStep] = useState('emotion');
            const [selectedEmotion, setSelectedEmotion] = useState(null);
            const [selectedPosition, setSelectedPosition] = useState(null);
            const [aiResponse, setAiResponse] = useState('');
            const [customMessage, setCustomMessage] = useState('');

            const emotions = [
                { id: 'panic', label: 'üò∞ Want to panic sell', desc: 'I\'m scared and want out' },
                { id: 'greedy', label: 'üò® Want to take profit too early', desc: 'I\'m up but scared of giving it back' },
                { id: 'baghold', label: 'üíéüôå Holding a loser too long', desc: 'Down bad but ego won\'t let me sell' },
                { id: 'average', label: 'üìâ Should I average down/up?', desc: 'Thinking about adding to my position' },
                { id: 'revenge', label: 'üò§ Want to revenge trade', desc: 'Just took a loss, need to make it back' },
                { id: 'fomo', label: 'ü§ë Chasing FOMO', desc: 'Stock is ripping without me' }
            ];

            const handleEmotionSelect = (emotion) => {
                setSelectedEmotion(emotion);
                setStep('position');
            };

            const handlePositionSelect = (position) => {
                setSelectedPosition(position);
                setAiResponse(getAIResponse(selectedEmotion, position, personality));
                setStep('response');
            };

            const handleClose = () => {
                setStep('emotion');
                setSelectedEmotion(null);
                setSelectedPosition(null);
                setAiResponse('');
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold">
                                    {step === 'emotion' && 'üß† The Voice of Logic'}
                                    {step === 'position' && 'üìä Which Position?'}
                                    {step === 'response' && 'üí¨ AI Buddy Says...'}
                                </h2>
                                <button onClick={handleClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>

                            {step === 'emotion' && (
                                <div className="space-y-3">
                                    <p className="text-gray-400 mb-4">What's going on? Talk to me.</p>
                                    {emotions.map(emotion => (
                                        <button
                                            key={emotion.id}
                                            onClick={() => handleEmotionSelect(emotion.id)}
                                            className="w-full p-4 text-left bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 rounded-xl transition-all"
                                        >
                                            <div className="font-semibold">{emotion.label}</div>
                                            <div className="text-sm text-gray-400">{emotion.desc}</div>
                                        </button>
                                    ))}
                                    <div className="pt-4">
                                        <textarea
                                            value={customMessage}
                                            onChange={(e) => setCustomMessage(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter' && !e.shiftKey && customMessage.trim()) {
                                                    e.preventDefault();
                                                    setAiResponse(getCustomAIResponse(customMessage, positions, personality));
                                                    setStep('response');
                                                }
                                            }}
                                            placeholder="Or tell me what's on your mind..."
                                            className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                                            rows={3}
                                        />
                                        {customMessage.trim() && (
                                            <button
                                                onClick={() => {
                                                    setAiResponse(getCustomAIResponse(customMessage, positions, personality));
                                                    setStep('response');
                                                }}
                                                className="w-full mt-2 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl font-semibold transition-colors"
                                            >
                                                üß† Get AI Response
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}

                            {step === 'position' && (
                                <div className="space-y-3">
                                    <p className="text-gray-400 mb-4">Which position are you worried about?</p>
                                    {positions.map(position => (
                                        <button
                                            key={position.id}
                                            onClick={() => handlePositionSelect(position)}
                                            className="w-full p-4 text-left bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 rounded-xl transition-all"
                                        >
                                            <div className="flex justify-between">
                                                <span className="font-semibold">{position.ticker}</span>
                                                <span className={(((position.livePrice || position.currentPrice) - position.entryPrice) >= 0) ? 'text-green-400' : 'text-red-400'}>
                                                    {(((position.livePrice || position.currentPrice) - position.entryPrice) / position.entryPrice * 100).toFixed(1)}%
                                                </span>
                                            </div>
                                            <div className="text-sm text-gray-400">
                                                {position.type === 'option' ? `${position.optionType} $${position.strike} ‚Ä¢ ${formatExpirationDate(position.expiration)}` : position.type}
                                            </div>
                                        </button>
                                    ))}
                                    <button
                                        onClick={() => handlePositionSelect(null)}
                                        className="w-full p-4 text-left bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 rounded-xl transition-all"
                                    >
                                        <div className="font-semibold">ü§∑ General anxiety / no specific position</div>
                                    </button>
                                </div>
                            )}

                            {step === 'response' && (
                                <div>
                                    <div className="bg-gray-800 border border-gray-700 rounded-xl p-4 mb-6">
                                        <pre className="whitespace-pre-wrap text-sm leading-relaxed font-sans">
                                            {aiResponse}
                                        </pre>
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleClose}
                                            className="flex-1 py-3 bg-green-600 hover:bg-green-500 rounded-xl font-semibold transition-colors"
                                        >
                                            üí™ Stick to the Plan
                                        </button>
                                        <button
                                            onClick={() => setStep('emotion')}
                                            className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition-colors"
                                        >
                                            üí¨ Talk More
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Add Position Modal
        const AddPositionModal = ({ isOpen, onClose, onAdd }) => {
            const [formData, setFormData] = useState({
                ticker: '',
                type: 'stock',
                optionType: 'call',
                strike: '',
                expiration: '',
                entryPrice: '',
                quantity: '',
                strategy: 'swing'
            });
            const [aiRating, setAiRating] = useState(null);
            const [ratingLoading, setRatingLoading] = useState(false);

            // Auto-populate state
            const [stockPrice, setStockPrice] = useState(null);
            const [stockLoading, setStockLoading] = useState(false);
            const [stockError, setStockError] = useState(null);
            const [optionsChain, setOptionsChain] = useState(null);
            const [optionsLoading, setOptionsLoading] = useState(false);
            const [optionsError, setOptionsError] = useState(null);
            const [selectedExpiry, setSelectedExpiry] = useState(null);

            // Fetch stock price when ticker changes
            const fetchStockPrice = async (ticker) => {
                if (!ticker || ticker.length < 1) {
                    setStockPrice(null);
                    setOptionsChain(null);
                    setStockError(null);
                    return;
                }
                setStockLoading(true);
                setStockError(null);
                try {
                    console.log('[AddPosition] Fetching price for:', ticker);
                    const response = await fetch(`/api/yahoo?ticker=${ticker}&type=chart`);

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('[AddPosition] Got response for', ticker);

                    if (data.chart?.result?.[0]?.meta?.regularMarketPrice) {
                        const price = data.chart.result[0].meta.regularMarketPrice;
                        console.log('[AddPosition] Got price:', price);
                        setStockPrice(price);
                        // Auto-fill entry price for stocks
                        if (formData.type === 'stock') {
                            setFormData(prev => ({ ...prev, entryPrice: price.toFixed(2) }));
                        }
                    } else if (data.chart?.error) {
                        throw new Error(data.chart.error.description || 'Ticker not found');
                    } else if (data.error) {
                        throw new Error(data.error);
                    } else {
                        console.log('[AddPosition] Unexpected data structure:', Object.keys(data));
                        throw new Error('Could not find price data');
                    }
                } catch (error) {
                    console.error('[AddPosition] Error fetching stock price:', error);
                    setStockError(error.message || 'Failed to fetch');
                }
                setStockLoading(false);
            };

            // Fetch options chain when ticker changes and type is option
            const fetchOptionsChain = async (ticker) => {
                if (!ticker || ticker.length < 1) {
                    setOptionsChain(null);
                    setOptionsError(null);
                    return;
                }
                setOptionsLoading(true);
                setOptionsError(null);
                try {
                    console.log('[AddPosition] Fetching options for:', ticker);
                    const response = await fetch(`/api/yahoo?ticker=${ticker}&type=options`);

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('[AddPosition] Got options response for', ticker);

                    if (data.optionChain?.result?.[0]) {
                        const result = data.optionChain.result[0];
                        console.log('[AddPosition] Got options:', result.expirationDates?.length, 'expirations');
                        setOptionsChain({
                            expirations: result.expirationDates || [],
                            strikes: result.strikes || [],
                            calls: result.options?.[0]?.calls || [],
                            puts: result.options?.[0]?.puts || [],
                            quote: result.quote
                        });
                        if (result.quote?.regularMarketPrice) {
                            setStockPrice(result.quote.regularMarketPrice);
                        }
                    } else if (data.optionChain?.error) {
                        throw new Error(data.optionChain.error.description || 'No options available');
                    } else if (data.error) {
                        throw new Error(data.error);
                    } else {
                        throw new Error('No options data found');
                    }
                } catch (error) {
                    console.error('[AddPosition] Error fetching options:', error);
                    setOptionsError(error.message || 'Failed to fetch options');
                }
                setOptionsLoading(false);
            };

            // Fetch options for a specific expiration
            const fetchOptionsForExpiry = async (ticker, expiry) => {
                setOptionsLoading(true);
                try {
                    const response = await fetch(`/api/yahoo?ticker=${ticker}&type=options&expiry=${expiry}`);
                    const data = await response.json();
                    if (data.optionChain?.result?.[0]?.options?.[0]) {
                        const result = data.optionChain.result[0];
                        const opts = result.options[0];
                        setOptionsChain(prev => ({
                            ...prev,
                            calls: opts.calls || [],
                            puts: opts.puts || [],
                            quote: result.quote || prev?.quote // Keep quote data
                        }));
                        // Update stock price if we got new quote data
                        if (result.quote?.regularMarketPrice) {
                            setStockPrice(result.quote.regularMarketPrice);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching options for expiry:', error);
                }
                setOptionsLoading(false);
            };

            // Handle ticker change with debounce
            const tickerTimeoutRef = useRef(null);
            const handleTickerChange = (e) => {
                const ticker = e.target.value.toUpperCase();
                setFormData(prev => ({ ...prev, ticker }));
                setSelectedExpiry(null);
                setOptionsChain(null);

                // Clear previous timeout
                if (tickerTimeoutRef.current) clearTimeout(tickerTimeoutRef.current);

                // Debounce the API call
                if (ticker.length >= 1) {
                    tickerTimeoutRef.current = setTimeout(() => {
                        fetchStockPrice(ticker);
                        if (formData.type === 'option') {
                            fetchOptionsChain(ticker);
                        }
                    }, 500);
                }
            };

            // Handle type change
            const handleTypeChange = (type) => {
                setFormData(prev => ({ ...prev, type }));
                if (type === 'option' && formData.ticker) {
                    fetchOptionsChain(formData.ticker);
                }
                // Auto-fill stock price when switching to stock
                if (type === 'stock' && stockPrice) {
                    setFormData(prev => ({ ...prev, entryPrice: stockPrice.toFixed(2) }));
                }
            };

            // Handle expiration selection
            const handleExpirySelect = (expiryTimestamp) => {
                setSelectedExpiry(expiryTimestamp);
                const expiryDate = new Date(expiryTimestamp * 1000);
                // Use UTC to get correct date
                const year = expiryDate.getUTCFullYear();
                const month = String(expiryDate.getUTCMonth() + 1).padStart(2, '0');
                const day = String(expiryDate.getUTCDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                setFormData(prev => ({ ...prev, expiration: formattedDate }));
                fetchOptionsForExpiry(formData.ticker, expiryTimestamp);
            };

            // Handle strike selection
            const handleStrikeSelect = (option) => {
                setFormData(prev => ({
                    ...prev,
                    strike: option.strike.toString(),
                    entryPrice: ((option.bid + option.ask) / 2).toFixed(2)
                }));
            };

            // Format expiry date for display (using UTC to avoid timezone issues)
            const formatExpiry = (timestamp) => {
                const date = new Date(timestamp * 1000);
                // Use UTC to get correct date (Yahoo timestamps are UTC midnight)
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getUTCMonth()]} ${date.getUTCDate()}, ${String(date.getUTCFullYear()).slice(-2)}`;
            };

            // Get filtered options based on call/put selection - show ALL strikes
            const getFilteredOptions = () => {
                if (!optionsChain) return [];
                const options = formData.optionType === 'call' ? optionsChain.calls : optionsChain.puts;
                // Return all options that have any market activity
                return options.filter(opt => opt.bid > 0 || opt.ask > 0 || opt.volume > 0 || opt.openInterest > 0);
            };

            const getAiRating = async () => {
                setRatingLoading(true);
                const result = await analyzeTradeRating(formData);
                setAiRating(result);
                setRatingLoading(false);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const newPosition = {
                    id: Date.now(),
                    ...formData,
                    strike: parseFloat(formData.strike) || 0,
                    entryPrice: parseFloat(formData.entryPrice),
                    currentPrice: parseFloat(formData.entryPrice), // Start at entry
                    quantity: parseFloat(formData.quantity)
                };
                onAdd(newPosition);
                setFormData({
                    ticker: '',
                    type: 'stock',
                    optionType: 'call',
                    strike: '',
                    expiration: '',
                    entryPrice: '',
                    quantity: '',
                    strategy: 'swing'
                });
                setAiRating(null);
                setStockPrice(null);
                setOptionsChain(null);
                setSelectedExpiry(null);
                onClose();
            };

            // Reset state when modal closes
            useEffect(() => {
                if (!isOpen) {
                    setStockPrice(null);
                    setOptionsChain(null);
                    setSelectedExpiry(null);
                    setAiRating(null);
                }
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md max-h-[90vh] flex flex-col">
                        <div className="p-6 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold">‚ûï Add Position</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Ticker</label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={formData.ticker}
                                            onChange={handleTickerChange}
                                            placeholder="NVDA, SPY, BTC..."
                                            className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            required
                                        />
                                        {stockLoading && (
                                            <span className="absolute right-3 top-3 text-gray-400">‚è≥</span>
                                        )}
                                    </div>
                                    {stockPrice && !stockLoading && (
                                        <div className="mt-2 p-2 bg-green-900/30 border border-green-500/50 rounded-lg flex justify-between items-center">
                                            <span className="text-gray-400 text-sm">‚úÖ Current Price:</span>
                                            <span className="text-green-400 font-bold">${stockPrice.toFixed(2)}</span>
                                        </div>
                                    )}
                                    {stockError && !stockLoading && (
                                        <div className="mt-2 p-2 bg-red-900/30 border border-red-500/50 rounded-lg text-red-400 text-sm">
                                            ‚ùå {stockError}
                                        </div>
                                    )}
                                    {stockLoading && (
                                        <div className="mt-2 p-2 bg-blue-900/30 border border-blue-500/50 rounded-lg text-blue-400 text-sm">
                                            ‚è≥ Fetching price...
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Type</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['stock', 'option', 'crypto'].map(type => (
                                            <button
                                                key={type}
                                                type="button"
                                                onClick={() => handleTypeChange(type)}
                                                className={`p-2 rounded-xl border transition-all ${formData.type === type ? 'bg-blue-600 border-blue-500' : 'bg-gray-800 border-gray-700 hover:border-gray-600'}`}
                                            >
                                                {type.charAt(0).toUpperCase() + type.slice(1)}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {formData.type === 'option' && (
                                    <>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Call/Put</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {['call', 'put'].map(ot => (
                                                        <button
                                                            key={ot}
                                                            type="button"
                                                            onClick={() => setFormData({...formData, optionType: ot})}
                                                            className={`p-2 rounded-xl border transition-all ${formData.optionType === ot ? (ot === 'call' ? 'bg-green-600 border-green-500' : 'bg-red-600 border-red-500') : 'bg-gray-800 border-gray-700'}`}
                                                        >
                                                            {ot.toUpperCase()}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Strike</label>
                                                <input
                                                    type="number"
                                                    value={formData.strike}
                                                    onChange={(e) => setFormData({...formData, strike: e.target.value})}
                                                    placeholder={stockPrice ? `~$${stockPrice.toFixed(0)}` : '150'}
                                                    className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                                />
                                            </div>
                                        </div>

                                        {/* Options Loading/Error States */}
                                        {optionsLoading && (
                                            <div className="p-3 bg-blue-900/30 border border-blue-500/50 rounded-xl text-blue-400 text-sm text-center">
                                                ‚è≥ Loading options chain for {formData.ticker}...
                                            </div>
                                        )}
                                        {optionsError && !optionsLoading && (
                                            <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-xl text-red-400 text-sm">
                                                ‚ùå {optionsError}
                                                <button
                                                    type="button"
                                                    onClick={() => fetchOptionsChain(formData.ticker)}
                                                    className="ml-2 underline hover:text-red-300"
                                                >
                                                    Retry
                                                </button>
                                            </div>
                                        )}
                                        {!optionsChain && !optionsLoading && !optionsError && formData.ticker && (
                                            <div className="p-3 bg-gray-800/50 border border-gray-600 rounded-xl text-gray-400 text-sm text-center">
                                                üìä Options chain will load after ticker is validated
                                                <button
                                                    type="button"
                                                    onClick={() => fetchOptionsChain(formData.ticker)}
                                                    className="block mx-auto mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded-lg text-white text-xs"
                                                >
                                                    Load Options Chain
                                                </button>
                                            </div>
                                        )}

                                        {/* Options Chain - Expirations */}
                                        {optionsChain && optionsChain.expirations?.length > 0 && (
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-2">üìÖ Select Expiration ({optionsChain.expirations.length} available)</label>
                                                <div className="flex flex-wrap gap-1 max-h-40 overflow-y-auto p-2 bg-gray-800/50 rounded-xl">
                                                    {optionsChain.expirations.map(exp => (
                                                        <button
                                                            key={exp}
                                                            type="button"
                                                            onClick={() => handleExpirySelect(exp)}
                                                            className={`px-2 py-1 text-xs rounded-lg transition-all ${
                                                                selectedExpiry === exp
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                            }`}
                                                        >
                                                            {formatExpiry(exp)}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Options Chain - Strikes */}
                                        {selectedExpiry && (optionsChain?.calls?.length > 0 || optionsChain?.puts?.length > 0) && (
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-2">
                                                    üéØ Select Strike ({formData.optionType.toUpperCase()})
                                                    {optionsLoading && <span className="ml-2">‚è≥</span>}
                                                </label>
                                                <div className="max-h-64 overflow-y-auto bg-gray-800/50 rounded-xl">
                                                    <table className="w-full text-xs">
                                                        <thead className="sticky top-0 bg-gray-800 z-10">
                                                            <tr className="text-gray-400">
                                                                <th className="p-2 text-left">Strike</th>
                                                                <th className="p-2 text-right">Bid</th>
                                                                <th className="p-2 text-right">Ask</th>
                                                                <th className="p-2 text-right">Vol</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {getFilteredOptions().map(opt => {
                                                                const isITM = formData.optionType === 'call'
                                                                    ? opt.strike < stockPrice
                                                                    : opt.strike > stockPrice;
                                                                const isSelected = formData.strike === opt.strike.toString();
                                                                return (
                                                                    <tr
                                                                        key={opt.strike}
                                                                        onClick={() => handleStrikeSelect(opt)}
                                                                        className={`cursor-pointer transition-all ${
                                                                            isSelected
                                                                                ? 'bg-blue-600'
                                                                                : isITM
                                                                                    ? 'bg-green-900/20 hover:bg-green-900/40'
                                                                                    : 'hover:bg-gray-700'
                                                                        }`}
                                                                    >
                                                                        <td className="p-2 font-semibold">
                                                                            ${opt.strike}
                                                                            {isITM && <span className="ml-1 text-green-400 text-xs">ITM</span>}
                                                                        </td>
                                                                        <td className="p-2 text-right text-green-400">${opt.bid?.toFixed(2) || '-'}</td>
                                                                        <td className="p-2 text-right text-red-400">${opt.ask?.toFixed(2) || '-'}</td>
                                                                        <td className="p-2 text-right text-gray-400">{opt.volume || '-'}</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {/* Show selected expiration */}
                                        {formData.expiration && (
                                            <div className="p-3 bg-purple-900/30 border border-purple-500/50 rounded-xl">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-400 text-sm">Selected Expiration:</span>
                                                    <span className="text-purple-300 font-bold">
                                                        {new Date(formData.expiration + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}
                                                    </span>
                                                </div>
                                            </div>
                                        )}

                                        {/* Only show manual date input if options chain failed to load */}
                                        {!optionsChain && !optionsLoading && optionsError && (
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">
                                                    Enter expiration manually (options expire on Fridays):
                                                </label>
                                                <input
                                                    type="date"
                                                    value={formData.expiration}
                                                    onChange={(e) => setFormData({...formData, expiration: e.target.value})}
                                                    className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                                />
                                            </div>
                                        )}
                                    </>
                                )}

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Entry Price</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.entryPrice}
                                            onChange={(e) => setFormData({...formData, entryPrice: e.target.value})}
                                            placeholder="0.00"
                                            className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Quantity</label>
                                        <input
                                            type="number"
                                            step="0.0001"
                                            value={formData.quantity}
                                            onChange={(e) => setFormData({...formData, quantity: e.target.value})}
                                            placeholder="10"
                                            className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            required
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Strategy</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['day', 'swing', 'long'].map(strat => (
                                            <button
                                                key={strat}
                                                type="button"
                                                onClick={() => setFormData({...formData, strategy: strat})}
                                                className={`p-2 rounded-xl border transition-all text-sm ${formData.strategy === strat ? 'bg-blue-600 border-blue-500' : 'bg-gray-800 border-gray-700'}`}
                                            >
                                                {strat.charAt(0).toUpperCase() + strat.slice(1)}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* AI Trade Rating */}
                                <div className="mt-4 pt-4 border-t border-gray-700">
                                    <button
                                        type="button"
                                        onClick={getAiRating}
                                        disabled={ratingLoading || !formData.ticker || !formData.entryPrice}
                                        className="w-full py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-gray-700 disabled:text-gray-500 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2"
                                    >
                                        {ratingLoading ? (
                                            <>‚è≥ Analyzing...</>
                                        ) : (
                                            <>üß† Get AI Rating</>
                                        )}
                                    </button>

                                    {aiRating && (
                                        <div className={`mt-3 p-3 rounded-xl border ${
                                            aiRating.color === 'green' ? 'bg-green-900/30 border-green-600' :
                                            aiRating.color === 'red' ? 'bg-red-900/30 border-red-600' :
                                            'bg-yellow-900/30 border-yellow-600'
                                        }`}>
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className={`text-3xl font-bold ${
                                                    aiRating.color === 'green' ? 'text-green-400' :
                                                    aiRating.color === 'red' ? 'text-red-400' :
                                                    'text-yellow-400'
                                                }`}>
                                                    {aiRating.rating}/10
                                                </div>
                                                <div className="text-sm">
                                                    {aiRating.rating >= 7 ? '‚úÖ Looks Good' :
                                                     aiRating.rating >= 4 ? '‚ö†Ô∏è Proceed with Caution' :
                                                     'üö´ High Risk'}
                                                </div>
                                            </div>
                                            <div className="space-y-1 text-sm">
                                                {aiRating.reasons.map((reason, i) => (
                                                    <div key={i} className="text-gray-300">{reason}</div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <button
                                    type="submit"
                                    className="w-full py-3 bg-green-600 hover:bg-green-500 rounded-xl font-semibold transition-colors mt-4"
                                >
                                    ‚úÖ Add Position
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // Popular patterns for quick-add (most commonly used)
        const POPULAR_PATTERNS = ['wedgedown', 'wedgeup', 'doubletop', 'doublebottom', 'headandshoulders', 'headandshouldersinv', 'channelup', 'channeldown', 'tlresistance', 'tlsupport', 'tltriangle', 'wedgeresistance', 'wedgesupport'];

        // Pattern Manager Component - Search, Add, Remove patterns
        const PatternManager = ({ enabledPatterns, onUpdate }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [showAllPatterns, setShowAllPatterns] = useState(false);

            const addPattern = (patternId) => {
                if (!enabledPatterns.includes(patternId)) {
                    onUpdate([...enabledPatterns, patternId]);
                }
            };

            const removePattern = (patternId) => {
                onUpdate(enabledPatterns.filter(id => id !== patternId));
            };

            // Get pattern objects for enabled patterns
            const userPatterns = enabledPatterns.map(id => CHART_PATTERNS.find(p => p.id === id)).filter(Boolean);

            // Filter patterns by search query
            const searchResults = searchQuery.trim()
                ? CHART_PATTERNS.filter(p =>
                    p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    p.desc.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    p.category.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    p.type.toLowerCase().includes(searchQuery.toLowerCase())
                  )
                : [];

            // Popular patterns not yet added
            const availablePopular = POPULAR_PATTERNS
                .map(id => CHART_PATTERNS.find(p => p.id === id))
                .filter(p => p && !enabledPatterns.includes(p.id));

            // All patterns not yet added (for browse mode)
            const availablePatterns = CHART_PATTERNS.filter(p => !enabledPatterns.includes(p.id));

            return (
                <div>
                    <label className="block text-sm text-gray-400 mb-2">My Chart Patterns</label>

                    {/* User's Current Patterns */}
                    <div className="mb-4">
                        {userPatterns.length > 0 ? (
                            <div className="flex flex-wrap gap-2 p-3 bg-gray-800 rounded-xl border border-gray-700 max-h-32 overflow-y-auto">
                                {userPatterns.map(pattern => (
                                    <span
                                        key={pattern.id}
                                        className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium ${
                                            pattern.type === 'bullish' ? 'bg-green-500/20 text-green-300 border border-green-500/30' :
                                            pattern.type === 'bearish' ? 'bg-red-500/20 text-red-300 border border-red-500/30' :
                                            'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30'
                                        }`}
                                    >
                                        <span>{pattern.emoji}</span>
                                        <span>{pattern.name}</span>
                                        <button
                                            onClick={() => removePattern(pattern.id)}
                                            className="ml-1 hover:text-white"
                                        >√ó</button>
                                    </span>
                                ))}
                            </div>
                        ) : (
                            <div className="p-4 bg-gray-800 rounded-xl border border-gray-700 text-center text-gray-500 text-sm">
                                No patterns added yet. Search or add from popular patterns below.
                            </div>
                        )}
                        <div className="mt-1 text-xs text-gray-500">{userPatterns.length} pattern{userPatterns.length !== 1 ? 's' : ''} selected</div>
                    </div>

                    {/* Search Box */}
                    <div className="mb-4">
                        <div className="relative">
                            <input
                                type="text"
                                placeholder="Search patterns (e.g., wedge, bullish, reversal...)"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="w-full px-4 py-2 pl-10 bg-gray-800 border border-gray-700 rounded-xl text-sm focus:outline-none focus:border-purple-500"
                            />
                            <span className="absolute left-3 top-2.5 text-gray-500">üîç</span>
                        </div>

                        {/* Search Results */}
                        {searchQuery.trim() && (
                            <div className="mt-2 max-h-40 overflow-y-auto space-y-1">
                                {searchResults.length > 0 ? (
                                    searchResults.map(pattern => {
                                        const isAdded = enabledPatterns.includes(pattern.id);
                                        return (
                                            <div
                                                key={pattern.id}
                                                className={`flex items-center justify-between p-2 rounded-lg ${
                                                    isAdded ? 'bg-purple-600/20 border border-purple-500/30' : 'bg-gray-700/50 hover:bg-gray-700'
                                                }`}
                                            >
                                                <span className="flex items-center gap-2 text-sm">
                                                    <span>{pattern.emoji}</span>
                                                    <span>{pattern.name}</span>
                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${
                                                        pattern.type === 'bullish' ? 'bg-green-500/20 text-green-400' :
                                                        pattern.type === 'bearish' ? 'bg-red-500/20 text-red-400' :
                                                        'bg-gray-500/20 text-gray-400'
                                                    }`}>{pattern.type}</span>
                                                </span>
                                                {isAdded ? (
                                                    <button
                                                        onClick={() => removePattern(pattern.id)}
                                                        className="px-2 py-1 text-xs bg-red-600 hover:bg-red-500 rounded"
                                                    >Remove</button>
                                                ) : (
                                                    <button
                                                        onClick={() => addPattern(pattern.id)}
                                                        className="px-2 py-1 text-xs bg-green-600 hover:bg-green-500 rounded"
                                                    >+ Add</button>
                                                )}
                                            </div>
                                        );
                                    })
                                ) : (
                                    <div className="text-center text-gray-500 text-sm py-2">No patterns found</div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Popular Patterns Quick Add */}
                    {availablePopular.length > 0 && !searchQuery.trim() && (
                        <div className="mb-4">
                            <div className="text-xs text-gray-400 mb-2">Popular Patterns</div>
                            <div className="flex flex-wrap gap-2">
                                {availablePopular.map(pattern => (
                                    <button
                                        key={pattern.id}
                                        onClick={() => addPattern(pattern.id)}
                                        className="inline-flex items-center gap-1 px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs transition-colors"
                                    >
                                        <span>{pattern.emoji}</span>
                                        <span>{pattern.name}</span>
                                        <span className="text-green-400 ml-1">+</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Browse All Patterns */}
                    {!searchQuery.trim() && (
                        <div>
                            <button
                                onClick={() => setShowAllPatterns(!showAllPatterns)}
                                className="text-xs text-purple-400 hover:text-purple-300 mb-2"
                            >
                                {showAllPatterns ? '‚ñº Hide all patterns' : '‚ñ∂ Browse all patterns'} ({availablePatterns.length} available)
                            </button>

                            {showAllPatterns && (
                                <div className="max-h-48 overflow-y-auto space-y-1 p-2 bg-gray-800 rounded-xl border border-gray-700">
                                    {availablePatterns.map(pattern => (
                                        <div
                                            key={pattern.id}
                                            className="flex items-center justify-between p-2 rounded-lg bg-gray-700/50 hover:bg-gray-700"
                                        >
                                            <span className="flex items-center gap-2 text-sm">
                                                <span>{pattern.emoji}</span>
                                                <span>{pattern.name}</span>
                                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                                    pattern.type === 'bullish' ? 'bg-green-500/20 text-green-400' :
                                                    pattern.type === 'bearish' ? 'bg-red-500/20 text-red-400' :
                                                    'bg-gray-500/20 text-gray-400'
                                                }`}>{pattern.type}</span>
                                            </span>
                                            <button
                                                onClick={() => addPattern(pattern.id)}
                                                className="px-2 py-1 text-xs bg-green-600 hover:bg-green-500 rounded"
                                            >+ Add</button>
                                        </div>
                                    ))}
                                    {availablePatterns.length === 0 && (
                                        <div className="text-center text-gray-500 text-sm py-2">All patterns added!</div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Quick Actions */}
                    <div className="flex gap-2 mt-3">
                        <button
                            onClick={() => onUpdate(CHART_PATTERNS.map(p => p.id))}
                            className="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded-lg"
                        >Add All</button>
                        <button
                            onClick={() => onUpdate([])}
                            className="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded-lg"
                        >Clear All</button>
                        <button
                            onClick={() => onUpdate(POPULAR_PATTERNS)}
                            className="px-3 py-1 text-xs bg-purple-600 hover:bg-purple-500 rounded-lg"
                        >Reset to Popular</button>
                    </div>
                </div>
            );
        };

        // Settings Modal
        const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
            const [localSettings, setLocalSettings] = useState(settings);

            useEffect(() => {
                setLocalSettings(settings);
            }, [settings]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                        {/* Header - always visible */}
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-900 z-10">
                            <h2 className="text-2xl font-bold">‚öôÔ∏è Settings</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-800">&times;</button>
                        </div>

                        {/* Scrollable content */}
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">AI Personality</label>
                                    <div className="space-y-2">
                                        {[
                                            { id: 'homie', label: 'üî• Aggressive Homie', desc: 'Street-smart, hype, real talk' },
                                            { id: 'mentor', label: 'üßò Wise Mentor', desc: 'Calm, measured, thoughtful' },
                                            { id: 'sergeant', label: 'üí™ Drill Sergeant', desc: 'No-nonsense, tough love' },
                                            { id: 'nerd', label: 'ü§ì Data Nerd', desc: 'Stats-focused, analytical' }
                                        ].map(p => (
                                            <button
                                                key={p.id}
                                                onClick={() => setLocalSettings({...localSettings, personality: p.id})}
                                                className={`w-full p-3 text-left rounded-xl border transition-all ${localSettings.personality === p.id ? 'bg-blue-600/20 border-blue-500' : 'bg-gray-800 border-gray-700'}`}
                                            >
                                                <div className="font-semibold">{p.label}</div>
                                                <div className="text-sm text-gray-400">{p.desc}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">Guardian Mode</label>
                                    <div className="flex items-center justify-between p-4 bg-gray-800 rounded-xl border border-gray-700">
                                        <div>
                                            <div className="font-semibold">üõ°Ô∏è Guardian Mode</div>
                                            <div className="text-sm text-gray-400">Prevent new trades after big losses</div>
                                        </div>
                                        <button
                                            onClick={() => setLocalSettings({...localSettings, guardianMode: !localSettings.guardianMode})}
                                            className={`w-14 h-8 rounded-full transition-colors ${localSettings.guardianMode ? 'bg-green-500' : 'bg-gray-600'}`}
                                        >
                                            <div className={`w-6 h-6 bg-white rounded-full transition-transform ${localSettings.guardianMode ? 'translate-x-7' : 'translate-x-1'}`} />
                                        </button>
                                    </div>
                                    {localSettings.guardianMode && (
                                        <div className="mt-2 p-3 bg-green-500/10 border border-green-500/30 rounded-xl text-sm text-green-300">
                                            ‚úÖ After losses &gt;15%, new trades blocked for 1 hour. You can still manage existing positions.
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">Real-Time P&L Alerts</label>
                                    <div className="flex items-center justify-between p-4 bg-gray-800 rounded-xl border border-gray-700">
                                        <div>
                                            <div className="font-semibold">üîî Red/Green Alerts</div>
                                            <div className="text-sm text-gray-400">Notify when positions flip red or green</div>
                                        </div>
                                        <button
                                            onClick={() => setLocalSettings({...localSettings, realtimePnLAlerts: !localSettings.realtimePnLAlerts})}
                                            className={`w-14 h-8 rounded-full transition-colors ${localSettings.realtimePnLAlerts ? 'bg-green-500' : 'bg-gray-600'}`}
                                        >
                                            <div className={`w-6 h-6 bg-white rounded-full transition-transform ${localSettings.realtimePnLAlerts ? 'translate-x-7' : 'translate-x-1'}`} />
                                        </button>
                                    </div>
                                    {localSettings.realtimePnLAlerts ? (
                                        <div className="mt-2 p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl text-sm text-blue-300">
                                            ‚úÖ You'll get notified when any position goes red, goes green, or has sudden price swings.
                                        </div>
                                    ) : (
                                        <div className="mt-2 p-3 bg-gray-500/10 border border-gray-500/30 rounded-xl text-sm text-gray-400">
                                            Real-time P&L alerts disabled. Expiration and other alerts still active.
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">Alert Frequency</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['high', 'balanced', 'low'].map(freq => (
                                            <button
                                                key={freq}
                                                onClick={() => setLocalSettings({...localSettings, alertFrequency: freq})}
                                                className={`p-3 rounded-xl border transition-all ${localSettings.alertFrequency === freq ? 'bg-blue-600 border-blue-500' : 'bg-gray-800 border-gray-700'}`}
                                            >
                                                {freq.charAt(0).toUpperCase() + freq.slice(1)}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Pattern Customization - Search & Add */}
                                <PatternManager
                                    enabledPatterns={localSettings.enabledPatterns || []}
                                    onUpdate={(newPatterns) => setLocalSettings({...localSettings, enabledPatterns: newPatterns})}
                                />

                                <button
                                    onClick={() => { onSave(localSettings); onClose(); }}
                                    className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-semibold transition-colors"
                                >
                                    üíæ Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // SCALPER DASHBOARD - Day Trading Mode
        // ============================================
        const ScalperDashboard = ({ positions, tradeStats, setTradeStats, dailyGoal, setDailyGoal, onClose }) => {
            const [editingGoal, setEditingGoal] = useState(false);
            const [newGoal, setNewGoal] = useState(dailyGoal);

            // Calculate today's P&L from positions
            const todayPnL = positions.reduce((sum, pos) => {
                const pnl = ((pos.livePrice || pos.currentPrice) - pos.entryPrice) * pos.quantity;
                return sum + pnl;
            }, 0);

            const goalProgress = Math.min(100, (todayPnL / dailyGoal) * 100);
            const goalHit = todayPnL >= dailyGoal;

            // Record a trade (win or loss)
            const recordTrade = (isWin, pnl) => {
                const today = new Date().toDateString();
                let newStats = { ...tradeStats };

                // Reset daily stats if it's a new day
                if (newStats.lastTradeDate !== today) {
                    newStats.todayPnL = 0;
                    newStats.todayTrades = 0;
                }

                if (isWin) {
                    newStats.wins++;
                    if (newStats.streakType === 'win') {
                        newStats.streak++;
                    } else {
                        newStats.streak = 1;
                        newStats.streakType = 'win';
                    }
                } else {
                    newStats.losses++;
                    if (newStats.streakType === 'loss') {
                        newStats.streak++;
                    } else {
                        newStats.streak = 1;
                        newStats.streakType = 'loss';
                    }
                }

                newStats.todayPnL += pnl;
                newStats.todayTrades++;
                newStats.lastTradeDate = today;

                setTradeStats(newStats);
                saveTradeStats(newStats);
            };

            // Reset stats
            const resetStats = () => {
                const reset = { wins: 0, losses: 0, streak: 0, streakType: null, todayPnL: 0, todayTrades: 0, lastTradeDate: null };
                setTradeStats(reset);
                saveTradeStats(reset);
            };

            const streak = getStreakDisplay(tradeStats.streak, tradeStats.streakType);
            const winRate = tradeStats.wins + tradeStats.losses > 0
                ? ((tradeStats.wins / (tradeStats.wins + tradeStats.losses)) * 100).toFixed(0)
                : 0;

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex flex-col">
                    {/* Header */}
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">‚ö°</span>
                            <div>
                                <h2 className="text-xl font-bold">SCALPER MODE</h2>
                                <p className="text-xs text-gray-400">Real-time trading dashboard</p>
                            </div>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded-xl text-2xl">‚úï</button>
                    </div>

                    {/* Stats Bar */}
                    <div className="p-4 border-b border-gray-800 grid grid-cols-4 gap-4">
                        {/* Daily Goal */}
                        <div className={`p-3 rounded-xl ${goalHit ? 'bg-green-500/20 border border-green-500' : 'bg-gray-800'}`}>
                            <div className="text-xs text-gray-400 mb-1">Daily Goal</div>
                            {editingGoal ? (
                                <div className="flex gap-1">
                                    <input
                                        type="number"
                                        value={newGoal}
                                        onChange={(e) => setNewGoal(e.target.value)}
                                        className="w-20 p-1 bg-gray-700 rounded text-sm"
                                        autoFocus
                                    />
                                    <button
                                        onClick={() => {
                                            setDailyGoal(parseFloat(newGoal));
                                            saveDailyGoal(parseFloat(newGoal));
                                            setEditingGoal(false);
                                        }}
                                        className="px-2 bg-green-600 rounded text-xs"
                                    >‚úì</button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-2">
                                    <span className={`text-lg font-bold ${goalHit ? 'text-green-400' : ''}`}>
                                        ${todayPnL.toFixed(0)} / ${dailyGoal}
                                    </span>
                                    <button onClick={() => setEditingGoal(true)} className="text-xs text-gray-500">‚úèÔ∏è</button>
                                </div>
                            )}
                            <div className="mt-1 h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div
                                    className={`h-full ${goalHit ? 'bg-green-500' : todayPnL > 0 ? 'bg-blue-500' : 'bg-red-500'}`}
                                    style={{ width: `${Math.max(0, goalProgress)}%` }}
                                />
                            </div>
                            {goalHit && <div className="text-xs text-green-400 mt-1">üéØ GOAL HIT! Consider stopping.</div>}
                        </div>

                        {/* Win Rate */}
                        <div className="p-3 bg-gray-800 rounded-xl">
                            <div className="text-xs text-gray-400 mb-1">Win Rate</div>
                            <div className="text-lg font-bold">{winRate}%</div>
                            <div className="text-xs text-gray-500">{tradeStats.wins}W / {tradeStats.losses}L</div>
                        </div>

                        {/* Streak */}
                        <div className="p-3 bg-gray-800 rounded-xl">
                            <div className="text-xs text-gray-400 mb-1">Streak</div>
                            <div className={`text-lg font-bold ${streak.color}`}>
                                {streak.emoji} {streak.text}
                            </div>
                        </div>

                        {/* Today's Trades */}
                        <div className="p-3 bg-gray-800 rounded-xl">
                            <div className="text-xs text-gray-400 mb-1">Today</div>
                            <div className="text-lg font-bold">{tradeStats.todayTrades} trades</div>
                            <button onClick={resetStats} className="text-xs text-red-400 hover:text-red-300">Reset Stats</button>
                        </div>
                    </div>

                    {/* Position Cards - Scalper Style */}
                    <div className="flex-1 overflow-y-auto p-4">
                        <div className="grid gap-3">
                            {positions.map(pos => {
                                const pnl = ((pos.livePrice || pos.currentPrice) - pos.entryPrice) * pos.quantity;
                                const pnlPercent = ((pos.livePrice || pos.currentPrice) - pos.entryPrice) / pos.entryPrice * 100;
                                const momentum = getMomentum(pos.dayChange, pos.volume, pos.avgVolume);
                                const volumeStatus = getVolumeStatus(pos.volume, pos.avgVolume);
                                const isWinning = pnl > 0;

                                return (
                                    <div
                                        key={pos.id}
                                        className={`p-4 rounded-xl border ${
                                            isWinning ? 'bg-green-500/10 border-green-500/50' : 'bg-red-500/10 border-red-500/50'
                                        }`}
                                    >
                                        <div className="flex justify-between items-start">
                                            {/* Left - Ticker & Price */}
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xl font-bold">{pos.ticker}</span>
                                                    <span className={`px-2 py-0.5 rounded text-xs ${momentum.bg} ${momentum.color}`}>
                                                        {momentum.emoji} {momentum.status}
                                                    </span>
                                                    {volumeStatus && volumeStatus.status !== 'NORMAL' && (
                                                        <span className={`px-2 py-0.5 rounded text-xs bg-orange-500/20 ${volumeStatus.color}`}>
                                                            {volumeStatus.emoji} {volumeStatus.multiplier}x VOL
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="text-2xl font-bold mt-1">
                                                    ${(pos.livePrice || pos.currentPrice).toFixed(2)}
                                                    {pos.dayChange && (
                                                        <span className={`text-sm ml-2 ${parseFloat(pos.dayChange) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                            {parseFloat(pos.dayChange) >= 0 ? '+' : ''}{pos.dayChange}%
                                                        </span>
                                                    )}
                                                </div>
                                                {pos.type === 'option' && (
                                                    <div className="text-xs text-gray-400 mt-1">
                                                        ${pos.strike} {pos.optionType?.toUpperCase()} ‚Ä¢ {formatExpirationDate(pos.expiration)}
                                                    </div>
                                                )}
                                            </div>

                                            {/* Right - P&L */}
                                            <div className="text-right">
                                                <div className={`text-2xl font-bold ${isWinning ? 'text-green-400' : 'text-red-400'}`}>
                                                    {isWinning ? '+' : ''}{pnlPercent.toFixed(1)}%
                                                </div>
                                                <div className={`text-lg ${isWinning ? 'text-green-400' : 'text-red-400'}`}>
                                                    {isWinning ? '+' : ''}${pnl.toFixed(2)}
                                                </div>
                                                <div className="text-xs text-gray-500">
                                                    Entry: ${pos.entryPrice.toFixed(2)}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Quick Actions */}
                                        <div className="flex gap-2 mt-3">
                                            {pnlPercent >= 10 && (
                                                <div className="px-3 py-1 bg-green-600 rounded-lg text-xs font-semibold animate-pulse">
                                                    üí∞ TAKE PROFIT?
                                                </div>
                                            )}
                                            {pnlPercent <= -10 && (
                                                <div className="px-3 py-1 bg-red-600 rounded-lg text-xs font-semibold animate-pulse">
                                                    üõë CUT LOSS?
                                                </div>
                                            )}
                                            <button
                                                onClick={() => recordTrade(pnl > 0, pnl)}
                                                className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs"
                                            >
                                                üìù Log as {pnl > 0 ? 'Win' : 'Loss'}
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {positions.length === 0 && (
                            <div className="text-center py-12 text-gray-500">
                                <p className="text-4xl mb-2">‚ö°</p>
                                <p>No positions to track</p>
                                <p className="text-sm">Add positions to see them in scalper mode</p>
                            </div>
                        )}
                    </div>

                    {/* Footer - Quick Stats */}
                    <div className="p-4 border-t border-gray-800 bg-gray-900">
                        <div className="flex justify-between items-center">
                            <div className="text-sm text-gray-400">
                                {positions.length} position{positions.length !== 1 ? 's' : ''} tracked
                            </div>
                            <div className={`text-lg font-bold ${todayPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                Total: {todayPnL >= 0 ? '+' : ''}${todayPnL.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Alert Banner Component
        const AlertBanner = ({ position }) => {
            const daysToExpiry = getDaysToExpiry(position.expiration);
            const currentPrice = position.livePrice || position.currentPrice;
            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice * 100).toFixed(1);

            if (position.type !== 'option' || daysToExpiry > 7) return null;

            return (
                <div className="bg-red-500/20 border border-red-500 rounded-xl p-4 mb-4 urgent-pulse">
                    <div className="flex items-start gap-3">
                        <span className="text-2xl">üö®</span>
                        <div>
                            <div className="font-bold text-red-300">URGENT: {position.ticker} Options Expiring Soon!</div>
                            <p className="text-sm mt-1">
                                Yo! Your {position.ticker} ${position.strike} {position.optionType}s expire in {daysToExpiry} {daysToExpiry === 1 ? 'day' : 'days'}.
                                You're {pnlPercent >= 0 ? 'up' : 'down'} {Math.abs(pnlPercent)}%.
                                {pnlPercent >= 0
                                    ? " Take the W before theta eats it. Don't get greedy with only " + daysToExpiry + " days left!"
                                    : " Cut this NOW or watch it go to zero. Time is NOT on your side."
                                }
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // CUSTOM ALERT SYSTEM - Industry Leading
        // ============================================

        const ALERT_TYPES = {
            PRICE_ABOVE: 'price_above',
            PRICE_BELOW: 'price_below',
            PERCENT_GAIN: 'percent_gain',
            PERCENT_LOSS: 'percent_loss',
            RSI_ABOVE: 'rsi_above',
            RSI_BELOW: 'rsi_below',
            NEWS: 'news',
            VOLUME_SPIKE: 'volume_spike',
            TRAILING_STOP: 'trailing_stop',
            PRICE_VELOCITY: 'price_velocity',      // Alert on X% move in short time
            GAP_UP: 'gap_up',                      // Pre-market gap up X%
            GAP_DOWN: 'gap_down',                  // Pre-market gap down X%
            BREAKOUT: 'breakout',                  // Price breaks above X-day high
            BREAKDOWN: 'breakdown'                 // Price breaks below X-day low
        };

        const ALERT_PRIORITIES = {
            CRITICAL: 'critical',
            WARNING: 'warning',
            INFO: 'info'
        };

        // Load custom alerts from localStorage
        const loadCustomAlerts = () => {
            try {
                const saved = localStorage.getItem('customAlerts');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        };

        // Save custom alerts to localStorage
        const saveCustomAlerts = (alerts) => {
            localStorage.setItem('customAlerts', JSON.stringify(alerts));
        };

        // Load triggered alert history
        const loadAlertHistory = () => {
            try {
                const saved = localStorage.getItem('alertHistory');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        };

        // Save alert history
        const saveAlertHistory = (history) => {
            // Keep only last 100 alerts
            const trimmed = history.slice(-100);
            localStorage.setItem('alertHistory', JSON.stringify(trimmed));
        };

        // Load watched news tickers
        const loadNewsWatchlist = () => {
            try {
                const saved = localStorage.getItem('newsWatchlist');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        };

        // Save news watchlist
        const saveNewsWatchlist = (watchlist) => {
            localStorage.setItem('newsWatchlist', JSON.stringify(watchlist));
        };

        // Calculate RSI from price data
        const calculateRSI = (prices, period = 14) => {
            if (!prices || prices.length < period + 1) return null;

            let gains = 0;
            let losses = 0;

            // Calculate initial average gain/loss
            for (let i = 1; i <= period; i++) {
                const change = prices[i] - prices[i - 1];
                if (change >= 0) gains += change;
                else losses += Math.abs(change);
            }

            let avgGain = gains / period;
            let avgLoss = losses / period;

            // Calculate smoothed RSI for remaining prices
            for (let i = period + 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change >= 0) {
                    avgGain = (avgGain * (period - 1) + change) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) + Math.abs(change)) / period;
                }
            }

            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        };

        // Fetch RSI data for a ticker
        const fetchRSIData = async (ticker) => {
            try {
                const response = await fetch(`/api/proxy?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1mo`)}`);
                const data = await response.json();
                const prices = data.chart?.result?.[0]?.indicators?.quote?.[0]?.close?.filter(p => p != null);
                if (prices && prices.length > 14) {
                    return calculateRSI(prices);
                }
                return null;
            } catch (e) {
                console.error('Error fetching RSI:', e);
                return null;
            }
        };

        // Fetch latest news for a ticker
        const fetchTickerNews = async (ticker) => {
            try {
                // Use Yahoo Finance news
                const response = await fetch(`/api/proxy?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v1/finance/search?q=${ticker}&newsCount=10`)}`);
                const data = await response.json();
                return data.news || [];
            } catch (e) {
                console.error('Error fetching news:', e);
                return [];
            }
        };

        // Alert Manager Component
        const AlertManager = ({ isOpen, onClose, customAlerts, setCustomAlerts, alertHistory, setAlertHistory, newsWatchlist, setNewsWatchlist, pushEnabled, setPushEnabled, fcmToken, setFcmToken, fcmError, setFcmError }) => {
            const [activeSection, setActiveSection] = useState('create'); // create, active, history, news
            const [newAlert, setNewAlert] = useState({
                ticker: '',
                type: ALERT_TYPES.PRICE_ABOVE,
                value: '',
                priority: ALERT_PRIORITIES.WARNING,
                sound: true,
                repeat: false,
                note: ''
            });
            const [newsTicker, setNewsTicker] = useState('');
            const [newsArticles, setNewsArticles] = useState({});  // { ticker: [articles] }
            const [newsLoading, setNewsLoading] = useState({});    // { ticker: boolean }
            const [selectedNewsTicker, setSelectedNewsTicker] = useState(null); // Which ticker's news to show

            // Fetch news for a specific ticker
            const loadNewsForTicker = async (ticker) => {
                if (newsLoading[ticker]) return;
                setNewsLoading(prev => ({ ...prev, [ticker]: true }));
                try {
                    const articles = await fetchTickerNews(ticker);
                    setNewsArticles(prev => ({ ...prev, [ticker]: articles }));
                } catch (e) {
                    console.error('Error loading news for', ticker, e);
                    setNewsArticles(prev => ({ ...prev, [ticker]: [] }));
                }
                setNewsLoading(prev => ({ ...prev, [ticker]: false }));
            };

            // Load news when a ticker is selected
            useEffect(() => {
                if (selectedNewsTicker && !newsArticles[selectedNewsTicker]) {
                    loadNewsForTicker(selectedNewsTicker);
                }
            }, [selectedNewsTicker]);

            // Auto-select first ticker when entering news section
            useEffect(() => {
                if (activeSection === 'news' && newsWatchlist.length > 0 && !selectedNewsTicker) {
                    setSelectedNewsTicker(newsWatchlist[0]);
                }
            }, [activeSection, newsWatchlist]);

            // Save to localStorage when state changes
            useEffect(() => {
                saveCustomAlerts(customAlerts);
            }, [customAlerts]);

            useEffect(() => {
                saveAlertHistory(alertHistory);
            }, [alertHistory]);

            useEffect(() => {
                saveNewsWatchlist(newsWatchlist);
            }, [newsWatchlist]);

            // Create new alert
            const createAlert = () => {
                if (!newAlert.ticker || !newAlert.value) return;

                const alert = {
                    id: Date.now(),
                    ...newAlert,
                    ticker: newAlert.ticker.toUpperCase(),
                    value: parseFloat(newAlert.value),
                    createdAt: new Date().toISOString(),
                    triggered: false,
                    highestPrice: null, // For trailing stops
                    active: true
                };

                setCustomAlerts([...customAlerts, alert]);
                setNewAlert({
                    ticker: '',
                    type: ALERT_TYPES.PRICE_ABOVE,
                    value: '',
                    priority: ALERT_PRIORITIES.WARNING,
                    sound: true,
                    repeat: false,
                    note: ''
                });
            };

            // Delete alert
            const deleteAlert = (id) => {
                setCustomAlerts(customAlerts.filter(a => a.id !== id));
            };

            // Toggle alert active state
            const toggleAlert = (id) => {
                setCustomAlerts(customAlerts.map(a =>
                    a.id === id ? { ...a, active: !a.active } : a
                ));
            };

            // Add ticker to news watchlist
            const addNewsWatch = () => {
                if (!newsTicker) return;
                const ticker = newsTicker.toUpperCase();
                if (!newsWatchlist.includes(ticker)) {
                    setNewsWatchlist([...newsWatchlist, ticker]);
                }
                // Immediately select and load news for this ticker
                setSelectedNewsTicker(ticker);
                loadNewsForTicker(ticker);
                setNewsTicker('');
            };

            // Remove ticker from news watchlist
            const removeNewsWatch = (ticker) => {
                setNewsWatchlist(newsWatchlist.filter(t => t !== ticker));
            };

            // Clear alert history
            const clearHistory = () => {
                setAlertHistory([]);
            };

            // Get alert type label
            const getAlertTypeLabel = (type) => {
                const labels = {
                    [ALERT_TYPES.PRICE_ABOVE]: 'üìà Price Above',
                    [ALERT_TYPES.PRICE_BELOW]: 'üìâ Price Below',
                    [ALERT_TYPES.PERCENT_GAIN]: 'üí∞ % Gain',
                    [ALERT_TYPES.PERCENT_LOSS]: 'üìâ % Loss',
                    [ALERT_TYPES.RSI_ABOVE]: 'üìä RSI Above',
                    [ALERT_TYPES.RSI_BELOW]: 'üìä RSI Below',
                    [ALERT_TYPES.VOLUME_SPIKE]: 'üîä Volume Spike',
                    [ALERT_TYPES.TRAILING_STOP]: 'üõë Trailing Stop %',
                    [ALERT_TYPES.PRICE_VELOCITY]: '‚ö° Price Velocity',
                    [ALERT_TYPES.GAP_UP]: 'üåÖ Gap Up',
                    [ALERT_TYPES.GAP_DOWN]: 'üåô Gap Down',
                    [ALERT_TYPES.BREAKOUT]: 'üöÄ Breakout (52w High)',
                    [ALERT_TYPES.BREAKDOWN]: 'üí• Breakdown (52w Low)'
                };
                return labels[type] || type;
            };

            // Get priority color
            const getPriorityColor = (priority) => {
                const colors = {
                    [ALERT_PRIORITIES.CRITICAL]: 'bg-red-500/20 border-red-500 text-red-400',
                    [ALERT_PRIORITIES.WARNING]: 'bg-yellow-500/20 border-yellow-500 text-yellow-400',
                    [ALERT_PRIORITIES.INFO]: 'bg-blue-500/20 border-blue-500 text-blue-400'
                };
                return colors[priority] || colors[ALERT_PRIORITIES.INFO];
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                üîî Alert Manager
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>

                        {/* Background Notifications Banner */}
                        <div className={`p-3 mx-4 mt-3 rounded-xl ${pushEnabled ? 'bg-green-900/50 border border-green-700' : 'bg-yellow-900/50 border border-yellow-700'}`}>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <span className="text-lg">{pushEnabled ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                    <div>
                                        <div className="font-medium text-sm">
                                            {pushEnabled ? 'Background Alerts Active' : 'Background Alerts Disabled'}
                                        </div>
                                        <div className="text-xs text-gray-400">
                                            {pushEnabled
                                                ? `${customAlerts.filter(a => a.active).length} alerts synced to server`
                                                : fcmError || 'Click to enable notifications when browser is closed'}
                                        </div>
                                    </div>
                                </div>
                                {pushEnabled ? (
                                    <button
                                        onClick={async () => {
                                            const token = fcmToken || localStorage.getItem('fcmToken');
                                            const activeAlerts = customAlerts.filter(a => a.active).map(a => ({
                                                id: a.id,
                                                ticker: a.ticker,
                                                type: a.type,
                                                value: parseFloat(a.value)
                                            }));
                                            try {
                                                const response = await fetch('/api/register-push-token', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ token, alerts: activeAlerts })
                                                });
                                                const result = await response.json();
                                                alert(`Synced ${activeAlerts.length} alerts to server!`);
                                            } catch (err) {
                                                alert('Sync failed: ' + err.message);
                                            }
                                        }}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium whitespace-nowrap"
                                    >
                                        Sync Now
                                    </button>
                                ) : (
                                    <button
                                        onClick={async () => {
                                            try {
                                                const permission = await Notification.requestPermission();
                                                if (permission === 'granted') {
                                                    // Re-initialize Firebase to get token
                                                    if (firebase.apps.length && window.VAPID_KEY) {
                                                        const messaging = firebase.messaging();
                                                        const registration = await navigator.serviceWorker.getRegistration('/firebase-messaging-sw.js');
                                                        const token = await messaging.getToken({
                                                            vapidKey: window.VAPID_KEY,
                                                            serviceWorkerRegistration: registration
                                                        });
                                                        if (token) {
                                                            setFcmToken(token);
                                                            setPushEnabled(true);
                                                            localStorage.setItem('fcmToken', token);
                                                            // Register with backend
                                                            fetch('/api/register-push-token', {
                                                                method: 'POST',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({
                                                                    token,
                                                                    alerts: customAlerts.filter(a => a.active).map(a => ({
                                                                        id: a.id,
                                                                        ticker: a.ticker,
                                                                        type: a.type,
                                                                        value: parseFloat(a.value)
                                                                    }))
                                                                })
                                                            });
                                                        }
                                                    }
                                                } else {
                                                    setFcmError('Permission denied - check browser settings');
                                                }
                                            } catch (err) {
                                                setFcmError(err.message);
                                            }
                                        }}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium whitespace-nowrap"
                                    >
                                        Enable Now
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex border-b border-gray-700">
                            {[
                                { id: 'create', label: '‚ûï Create', icon: '' },
                                { id: 'active', label: `üîî Active (${customAlerts.filter(a => a.active).length})`, icon: '' },
                                { id: 'news', label: `üì∞ News Watch (${newsWatchlist.length})`, icon: '' },
                                { id: 'history', label: 'üìú History', icon: '' }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveSection(tab.id)}
                                    className={`flex-1 py-3 text-sm font-medium transition-colors ${
                                        activeSection === tab.id
                                            ? 'bg-blue-600 text-white'
                                            : 'text-gray-400 hover:bg-gray-800'
                                    }`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        <div className="p-4 overflow-y-auto flex-1">
                            {/* CREATE ALERT */}
                            {activeSection === 'create' && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Ticker Symbol</label>
                                            <input
                                                type="text"
                                                value={newAlert.ticker}
                                                onChange={(e) => setNewAlert({ ...newAlert, ticker: e.target.value.toUpperCase() })}
                                                placeholder="TSLA, BTC, SPY..."
                                                className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Alert Type</label>
                                            <select
                                                value={newAlert.type}
                                                onChange={(e) => setNewAlert({ ...newAlert, type: e.target.value })}
                                                className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            >
                                                <option value={ALERT_TYPES.PRICE_ABOVE}>üìà Price Goes Above</option>
                                                <option value={ALERT_TYPES.PRICE_BELOW}>üìâ Price Goes Below</option>
                                                <option value={ALERT_TYPES.PERCENT_GAIN}>üí∞ Position Gains %</option>
                                                <option value={ALERT_TYPES.PERCENT_LOSS}>üìâ Position Loses %</option>
                                                <option value={ALERT_TYPES.TRAILING_STOP}>üõë Trailing Stop %</option>
                                                <option value={ALERT_TYPES.RSI_ABOVE}>üìä RSI Overbought (Above)</option>
                                                <option value={ALERT_TYPES.RSI_BELOW}>üìä RSI Oversold (Below)</option>
                                                <option value={ALERT_TYPES.PRICE_VELOCITY}>‚ö° Price Velocity (% in 5min)</option>
                                                <option value={ALERT_TYPES.VOLUME_SPIKE}>üîä Volume Spike (X% above avg)</option>
                                                <option value={ALERT_TYPES.GAP_UP}>üåÖ Pre-Market Gap Up %</option>
                                                <option value={ALERT_TYPES.GAP_DOWN}>üåô Pre-Market Gap Down %</option>
                                                <option value={ALERT_TYPES.BREAKOUT}>üöÄ 52-Week High Breakout</option>
                                                <option value={ALERT_TYPES.BREAKDOWN}>üí• 52-Week Low Breakdown</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">
                                                {newAlert.type.includes('percent') || newAlert.type === ALERT_TYPES.TRAILING_STOP
                                                    ? 'Percentage %'
                                                    : newAlert.type.includes('rsi')
                                                        ? 'RSI Value (0-100)'
                                                        : 'Target Price $'
                                                }
                                            </label>
                                            <input
                                                type="number"
                                                value={newAlert.value}
                                                onChange={(e) => setNewAlert({ ...newAlert, value: e.target.value })}
                                                placeholder={newAlert.type.includes('rsi') ? '70' : newAlert.type.includes('percent') ? '10' : '100.00'}
                                                className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Priority</label>
                                            <select
                                                value={newAlert.priority}
                                                onChange={(e) => setNewAlert({ ...newAlert, priority: e.target.value })}
                                                className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            >
                                                <option value={ALERT_PRIORITIES.CRITICAL}>üî¥ Critical</option>
                                                <option value={ALERT_PRIORITIES.WARNING}>üü° Warning</option>
                                                <option value={ALERT_PRIORITIES.INFO}>üîµ Info</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Note (optional)</label>
                                        <input
                                            type="text"
                                            value={newAlert.note}
                                            onChange={(e) => setNewAlert({ ...newAlert, note: e.target.value })}
                                            placeholder="e.g., Take profits at this level"
                                            className="w-full p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                        />
                                    </div>

                                    <div className="flex gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={newAlert.sound}
                                                onChange={(e) => setNewAlert({ ...newAlert, sound: e.target.checked })}
                                                className="w-5 h-5 rounded"
                                            />
                                            <span className="text-sm">üîä Play Sound</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={newAlert.repeat}
                                                onChange={(e) => setNewAlert({ ...newAlert, repeat: e.target.checked })}
                                                className="w-5 h-5 rounded"
                                            />
                                            <span className="text-sm">üîÅ Repeat Alert</span>
                                        </label>
                                    </div>

                                    <button
                                        onClick={createAlert}
                                        disabled={!newAlert.ticker || !newAlert.value}
                                        className="w-full py-3 bg-green-600 hover:bg-green-500 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-xl font-semibold transition-colors"
                                    >
                                        ‚úÖ Create Alert
                                    </button>

                                    {/* Quick Alert Templates */}
                                    <div className="mt-4 pt-4 border-t border-gray-700">
                                        <p className="text-sm text-gray-400 mb-3">‚ö° Quick Templates:</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button
                                                onClick={() => setNewAlert({ ...newAlert, type: ALERT_TYPES.RSI_ABOVE, value: '70' })}
                                                className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs text-left"
                                            >
                                                üìä RSI Overbought (&gt;70)
                                            </button>
                                            <button
                                                onClick={() => setNewAlert({ ...newAlert, type: ALERT_TYPES.RSI_BELOW, value: '30' })}
                                                className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs text-left"
                                            >
                                                üìä RSI Oversold (&lt;30)
                                            </button>
                                            <button
                                                onClick={() => setNewAlert({ ...newAlert, type: ALERT_TYPES.PERCENT_LOSS, value: '10', priority: ALERT_PRIORITIES.CRITICAL })}
                                                className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs text-left"
                                            >
                                                üõë Stop Loss (-10%)
                                            </button>
                                            <button
                                                onClick={() => setNewAlert({ ...newAlert, type: ALERT_TYPES.PERCENT_GAIN, value: '20' })}
                                                className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs text-left"
                                            >
                                                üí∞ Take Profit (+20%)
                                            </button>
                                            <button
                                                onClick={() => setNewAlert({ ...newAlert, type: ALERT_TYPES.TRAILING_STOP, value: '5', priority: ALERT_PRIORITIES.CRITICAL })}
                                                className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs text-left"
                                            >
                                                üõë Trailing Stop (5%)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ACTIVE ALERTS */}
                            {activeSection === 'active' && (
                                <div className="space-y-3">
                                    {customAlerts.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <p className="text-4xl mb-2">üîï</p>
                                            <p>No alerts set up yet</p>
                                            <p className="text-sm">Create your first alert to get started!</p>
                                        </div>
                                    ) : (
                                        customAlerts.map(alert => (
                                            <div
                                                key={alert.id}
                                                className={`p-3 rounded-xl border ${alert.active ? getPriorityColor(alert.priority) : 'bg-gray-800/50 border-gray-700 opacity-50'}`}
                                            >
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="font-bold text-lg">{alert.ticker}</div>
                                                        <div className="text-sm">
                                                            {getAlertTypeLabel(alert.type)}: {alert.type.includes('percent') || alert.type === ALERT_TYPES.TRAILING_STOP ? `${alert.value}%` : alert.type.includes('rsi') ? alert.value : `$${alert.value}`}
                                                        </div>
                                                        {alert.note && <div className="text-xs text-gray-400 mt-1">üìù {alert.note}</div>}
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            Created: {new Date(alert.createdAt).toLocaleDateString()}
                                                            {alert.sound && ' üîä'}
                                                            {alert.repeat && ' üîÅ'}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => toggleAlert(alert.id)}
                                                            className={`px-3 py-1 rounded-lg text-xs ${alert.active ? 'bg-green-600' : 'bg-gray-600'}`}
                                                        >
                                                            {alert.active ? 'ON' : 'OFF'}
                                                        </button>
                                                        <button
                                                            onClick={() => deleteAlert(alert.id)}
                                                            className="px-3 py-1 bg-red-600 rounded-lg text-xs"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {/* NEWS WATCHLIST */}
                            {activeSection === 'news' && (
                                <div className="space-y-4">
                                    {/* Search box */}
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newsTicker}
                                            onChange={(e) => setNewsTicker(e.target.value.toUpperCase())}
                                            placeholder="Enter ticker (e.g., TSLA, AAPL)..."
                                            className="flex-1 p-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                            onKeyPress={(e) => e.key === 'Enter' && addNewsWatch()}
                                        />
                                        <button
                                            onClick={addNewsWatch}
                                            className="px-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-semibold"
                                        >
                                            üì∞ Get News
                                        </button>
                                    </div>

                                    {/* Watched tickers as tabs */}
                                    {newsWatchlist.length > 0 && (
                                        <div className="flex flex-wrap gap-2">
                                            {newsWatchlist.map(ticker => (
                                                <button
                                                    key={ticker}
                                                    onClick={() => {
                                                        setSelectedNewsTicker(ticker);
                                                        if (!newsArticles[ticker]) loadNewsForTicker(ticker);
                                                    }}
                                                    className={`px-3 py-2 rounded-xl flex items-center gap-2 transition-colors ${
                                                        selectedNewsTicker === ticker
                                                            ? 'bg-purple-600 text-white'
                                                            : 'bg-gray-800 hover:bg-gray-700 text-gray-300'
                                                    }`}
                                                >
                                                    <span className="font-semibold">{ticker}</span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            removeNewsWatch(ticker);
                                                            if (selectedNewsTicker === ticker) {
                                                                setSelectedNewsTicker(newsWatchlist[0] === ticker ? newsWatchlist[1] : newsWatchlist[0]);
                                                            }
                                                        }}
                                                        className="text-red-400 hover:text-red-300 ml-1"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    {/* News articles list */}
                                    {selectedNewsTicker ? (
                                        <div className="bg-gray-800/50 border border-gray-700 rounded-xl overflow-hidden">
                                            <div className="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-lg">üì∞</span>
                                                    <span className="font-bold">{selectedNewsTicker} News</span>
                                                </div>
                                                <button
                                                    onClick={() => loadNewsForTicker(selectedNewsTicker)}
                                                    className="text-xs text-blue-400 hover:text-blue-300"
                                                >
                                                    üîÑ Refresh
                                                </button>
                                            </div>

                                            <div className="max-h-64 overflow-y-auto">
                                                {newsLoading[selectedNewsTicker] ? (
                                                    <div className="p-8 text-center text-gray-400">
                                                        <div className="animate-spin text-2xl mb-2">‚è≥</div>
                                                        <p>Loading news...</p>
                                                    </div>
                                                ) : newsArticles[selectedNewsTicker]?.length > 0 ? (
                                                    newsArticles[selectedNewsTicker].map((article, idx) => (
                                                        <a
                                                            key={idx}
                                                            href={article.link}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="block p-3 border-b border-gray-700/50 hover:bg-gray-700/50 transition-colors cursor-pointer"
                                                        >
                                                            <div className="flex gap-3">
                                                                {article.thumbnail?.resolutions?.[0]?.url && (
                                                                    <img
                                                                        src={article.thumbnail.resolutions[0].url}
                                                                        alt=""
                                                                        className="w-16 h-16 object-cover rounded-lg flex-shrink-0"
                                                                    />
                                                                )}
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="font-medium text-sm text-white line-clamp-2 mb-1">
                                                                        {article.title}
                                                                    </div>
                                                                    <div className="flex items-center gap-2 text-xs text-gray-400">
                                                                        <span>{article.publisher}</span>
                                                                        <span>‚Ä¢</span>
                                                                        <span>{new Date(article.providerPublishTime * 1000).toLocaleDateString()}</span>
                                                                    </div>
                                                                    <div className="text-xs text-blue-400 mt-1">
                                                                        Read article ‚Üí
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    ))
                                                ) : (
                                                    <div className="p-8 text-center text-gray-500">
                                                        <p className="text-2xl mb-2">ü§∑</p>
                                                        <p>No news found for {selectedNewsTicker}</p>
                                                        <p className="text-sm">Try a different ticker</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ) : newsWatchlist.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <p className="text-4xl mb-2">üì∞</p>
                                            <p>Enter a ticker to see latest news</p>
                                            <p className="text-sm mt-2">Example: TSLA, AAPL, NVDA, SPY</p>
                                        </div>
                                    ) : null}

                                    {/* Info box */}
                                    <div className="p-3 bg-blue-900/20 border border-blue-500/30 rounded-xl text-sm">
                                        <p className="text-blue-400">üí° Tip</p>
                                        <p className="text-gray-400 text-xs mt-1">
                                            Click any article to read the full story. Your watched tickers will also send you
                                            popup alerts when breaking news drops!
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* ALERT HISTORY */}
                            {activeSection === 'history' && (
                                <div className="space-y-3">
                                    {alertHistory.length > 0 && (
                                        <button
                                            onClick={clearHistory}
                                            className="text-xs text-red-400 hover:text-red-300"
                                        >
                                            üóëÔ∏è Clear History
                                        </button>
                                    )}
                                    {alertHistory.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <p className="text-4xl mb-2">üìú</p>
                                            <p>No alert history yet</p>
                                            <p className="text-sm">Triggered alerts will appear here</p>
                                        </div>
                                    ) : (
                                        [...alertHistory].reverse().map((entry, idx) => (
                                            <div
                                                key={idx}
                                                className={`p-3 rounded-xl border ${getPriorityColor(entry.priority)}`}
                                            >
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="font-bold">{entry.ticker}</div>
                                                        <div className="text-sm">{entry.message}</div>
                                                        {entry.note && <div className="text-xs text-gray-400 mt-1">üìù {entry.note}</div>}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        {new Date(entry.triggeredAt).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Alert Notification Popup Component
        const AlertNotification = ({ alerts, onDismiss, onDismissAll }) => {
            if (!alerts || alerts.length === 0) return null;

            // Separate news alerts from other alerts
            const newsAlerts = alerts.filter(a => a.type === 'news');
            const otherAlerts = alerts.filter(a => a.type !== 'news');

            // Play alert sound
            useEffect(() => {
                const hasSound = alerts.some(a => a.sound);
                if (hasSound) {
                    // Create a simple beep sound
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.value = 0.3;

                        oscillator.start();
                        setTimeout(() => {
                            oscillator.stop();
                            audioContext.close();
                        }, 200);
                    } catch (e) {
                        console.log('Could not play alert sound');
                    }
                }
            }, [alerts]);

            // Open link in new tab
            const openArticle = (link) => {
                if (link) {
                    window.open(link, '_blank', 'noopener,noreferrer');
                }
            };

            return (
                <div className="fixed top-4 right-4 z-50 space-y-2 max-w-md">
                    {/* Regular alerts (non-news) with pulse */}
                    {otherAlerts.map((alert, idx) => (
                        <div
                            key={`alert-${idx}`}
                            className={`p-4 rounded-xl border shadow-2xl animate-pulse ${
                                alert.priority === ALERT_PRIORITIES.CRITICAL
                                    ? 'bg-red-900/90 border-red-500'
                                    : alert.priority === ALERT_PRIORITIES.WARNING
                                        ? 'bg-yellow-900/90 border-yellow-500'
                                        : 'bg-blue-900/90 border-blue-500'
                            }`}
                        >
                            <div className="flex justify-between items-start">
                                <div>
                                    <div className="font-bold text-lg flex items-center gap-2">
                                        {alert.priority === ALERT_PRIORITIES.CRITICAL ? 'üö®' : alert.priority === ALERT_PRIORITIES.WARNING ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                                        {alert.ticker}
                                    </div>
                                    <div className="text-sm mt-1">{alert.message}</div>
                                    {alert.note && <div className="text-xs text-gray-300 mt-1">üìù {alert.note}</div>}
                                </div>
                                <button
                                    onClick={() => onDismiss(alerts.indexOf(alert))}
                                    className="text-gray-400 hover:text-white text-xl ml-2"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    ))}

                    {/* News alerts - organized card without pulse */}
                    {newsAlerts.length > 0 && (
                        <div className="bg-gray-900/95 border border-purple-500/50 rounded-xl shadow-2xl overflow-hidden">
                            <div className="p-3 bg-purple-900/50 border-b border-purple-500/30 flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <span className="text-lg">üì∞</span>
                                    <span className="font-bold">Breaking News</span>
                                    <span className="text-xs bg-purple-500/30 px-2 py-0.5 rounded-full">{newsAlerts.length} new</span>
                                </div>
                                <button
                                    onClick={() => newsAlerts.forEach(a => onDismiss(alerts.indexOf(a)))}
                                    className="text-gray-400 hover:text-white text-sm"
                                >
                                    Clear all
                                </button>
                            </div>
                            <div className="max-h-80 overflow-y-auto">
                                {newsAlerts.map((alert, idx) => (
                                    <div
                                        key={`news-${idx}`}
                                        className="p-3 border-b border-gray-700/50 hover:bg-gray-800/50 transition-colors cursor-pointer"
                                        onClick={() => openArticle(alert.link)}
                                    >
                                        <div className="flex justify-between items-start gap-2">
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="font-bold text-purple-400 text-sm">{alert.ticker}</span>
                                                    {alert.note && <span className="text-xs text-gray-500">‚Ä¢ {alert.note}</span>}
                                                </div>
                                                <div className="text-sm text-gray-200 line-clamp-2">
                                                    {alert.message.replace(`üì∞ ${alert.ticker}: `, '')}
                                                </div>
                                                {alert.link && (
                                                    <div className="text-xs text-blue-400 mt-1 hover:underline flex items-center gap-1">
                                                        Read full article ‚Üí
                                                    </div>
                                                )}
                                            </div>
                                            <button
                                                onClick={(e) => { e.stopPropagation(); onDismiss(alerts.indexOf(alert)); }}
                                                className="text-gray-500 hover:text-white text-lg flex-shrink-0"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {alerts.length > 1 && (
                        <button
                            onClick={onDismissAll}
                            className="w-full py-2 bg-gray-800 hover:bg-gray-700 rounded-xl text-sm"
                        >
                            Dismiss All ({alerts.length})
                        </button>
                    )}
                </div>
            );
        };

        // Calendar View Component for Trade Journal
        const CalendarView = ({ entries, onDayClick, dayOfWeekStats }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(null);

            // Get first day of month and total days
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Group trades by date
            const tradesByDate = {};
            entries.forEach(trade => {
                const date = trade.exitDate || trade.entryDate;
                if (date) {
                    const key = date.split('T')[0];
                    if (!tradesByDate[key]) {
                        tradesByDate[key] = { trades: [], pnl: 0 };
                    }
                    tradesByDate[key].trades.push(trade);
                    tradesByDate[key].pnl += trade.pnl || 0;
                }
            });

            // Calculate monthly stats
            const monthStart = `${year}-${String(month + 1).padStart(2, '0')}`;
            const monthTrades = entries.filter(t => (t.exitDate || t.entryDate || '').startsWith(monthStart));
            const monthPnL = monthTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            const monthWins = monthTrades.filter(t => t.pnl > 0).length;
            const monthWinRate = monthTrades.length > 0 ? (monthWins / monthTrades.length) * 100 : 0;

            // Generate calendar days
            const days = [];
            for (let i = 0; i < firstDay; i++) {
                days.push(null); // Empty cells before first day
            }
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                days.push({ day: d, dateKey, data: tradesByDate[dateKey] });
            }

            const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
            const goToToday = () => setCurrentDate(new Date());

            return (
                <div className="space-y-4">
                    {/* Month Navigation */}
                    <div className="flex justify-between items-center">
                        <button onClick={prevMonth} className="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                            ‚Üê Prev
                        </button>
                        <div className="text-center">
                            <div className="font-semibold text-lg">{monthName}</div>
                            <button onClick={goToToday} className="text-xs text-blue-400 hover:text-blue-300">Today</button>
                        </div>
                        <button onClick={nextMonth} className="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                            Next ‚Üí
                        </button>
                    </div>

                    {/* Monthly Summary */}
                    <div className="grid grid-cols-3 gap-2 text-center">
                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-700">
                            <div className="text-xs text-gray-500">Trades</div>
                            <div className="font-bold">{monthTrades.length}</div>
                        </div>
                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-700">
                            <div className="text-xs text-gray-500">P&L</div>
                            <div className={`font-bold ${monthPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {monthPnL >= 0 ? '+' : ''}${monthPnL.toFixed(0)}
                            </div>
                        </div>
                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-700">
                            <div className="text-xs text-gray-500">Win Rate</div>
                            <div className={`font-bold ${monthWinRate >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                                {monthWinRate.toFixed(0)}%
                            </div>
                        </div>
                    </div>

                    {/* Calendar Grid */}
                    <div className="bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
                        {/* Day Headers */}
                        <div className="grid grid-cols-7 text-center text-xs text-gray-500 border-b border-gray-700">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                <div key={d} className="py-2 font-medium">{d}</div>
                            ))}
                        </div>

                        {/* Calendar Days */}
                        <div className="grid grid-cols-7">
                            {days.map((dayObj, idx) => {
                                if (!dayObj) {
                                    return <div key={`empty-${idx}`} className="aspect-square bg-gray-900/30" />;
                                }

                                const { day, dateKey, data } = dayObj;
                                const isToday = dateKey === new Date().toISOString().split('T')[0];
                                const hasTradesOnDay = data && data.trades.length > 0;
                                const pnl = data?.pnl || 0;

                                return (
                                    <div
                                        key={dateKey}
                                        onClick={() => {
                                            if (hasTradesOnDay) {
                                                setSelectedDay(selectedDay === dateKey ? null : dateKey);
                                                if (data.trades.length === 1) {
                                                    onDayClick(dateKey, data.trades);
                                                }
                                            }
                                        }}
                                        className={`aspect-square p-1 border-b border-r border-gray-700/50 flex flex-col items-center justify-center cursor-pointer transition-colors
                                            ${isToday ? 'ring-2 ring-blue-500 ring-inset' : ''}
                                            ${hasTradesOnDay ? (pnl >= 0 ? 'bg-green-500/20 hover:bg-green-500/30' : 'bg-red-500/20 hover:bg-red-500/30') : 'hover:bg-gray-700/30'}
                                            ${selectedDay === dateKey ? 'ring-2 ring-yellow-400 ring-inset' : ''}`}
                                    >
                                        <span className={`text-sm ${isToday ? 'font-bold text-blue-400' : ''}`}>{day}</span>
                                        {hasTradesOnDay && (
                                            <>
                                                <span className={`text-xs font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {pnl >= 0 ? '+' : ''}{pnl.toFixed(0)}
                                                </span>
                                                <span className="text-[10px] text-gray-500">{data.trades.length}</span>
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Selected Day Details */}
                    {selectedDay && tradesByDate[selectedDay] && tradesByDate[selectedDay].trades.length > 1 && (
                        <div className="bg-gray-800/50 p-4 rounded-xl border border-yellow-500/30">
                            <div className="text-sm font-semibold mb-3">
                                {new Date(selectedDay).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })} - {tradesByDate[selectedDay].trades.length} Trades
                            </div>
                            <div className="space-y-2">
                                {tradesByDate[selectedDay].trades.map(trade => (
                                    <div
                                        key={trade.id}
                                        onClick={() => onDayClick(selectedDay, [trade])}
                                        className={`p-3 rounded-lg cursor-pointer transition-colors ${
                                            trade.pnl >= 0 ? 'bg-green-900/30 hover:bg-green-900/50' : 'bg-red-900/30 hover:bg-red-900/50'
                                        }`}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span className="font-semibold">{trade.ticker}</span>
                                            <span className={`font-bold ${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                {trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Day of Week Performance */}
                    <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                        <div className="text-sm font-semibold mb-3">Day of Week Performance</div>
                        <div className="grid grid-cols-7 gap-1 text-center text-xs">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, idx) => {
                                const stats = dayOfWeekStats[idx];
                                return (
                                    <div key={day} className="p-2">
                                        <div className="text-gray-500">{day}</div>
                                        <div className={`font-bold ${stats?.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {stats?.trades > 0 ? `${stats.pnl >= 0 ? '+' : ''}$${stats.pnl.toFixed(0)}` : '-'}
                                        </div>
                                        <div className="text-gray-600">{stats?.trades || 0}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Legend */}
                    <div className="flex justify-center gap-4 text-xs text-gray-500">
                        <span><span className="inline-block w-3 h-3 bg-green-500/40 rounded mr-1"></span> Green Day</span>
                        <span><span className="inline-block w-3 h-3 bg-red-500/40 rounded mr-1"></span> Red Day</span>
                        <span><span className="inline-block w-3 h-3 border-2 border-blue-500 rounded mr-1"></span> Today</span>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [positions, setPositions] = useState(samplePositions);
            const [showTalkMeDown, setShowTalkMeDown] = useState(false);
            const [showAddPosition, setShowAddPosition] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [loading, setLoading] = useState(true);
            const [trending, setTrending] = useState({ trending: [], posts: [] });
            const [insiderTrades, setInsiderTrades] = useState([]);
            const [activeTab, setActiveTab] = useState('positions');
            const [screenerTab, setScreenerTab] = useState('patterns');
            const [selectedPattern, setSelectedPattern] = useState('wedgedown');
            const [patternStocks, setPatternStocks] = useState([]);
            const [patternLoading, setPatternLoading] = useState(false);
            const [patternCategory, setPatternCategory] = useState('all');
            const [chartStock, setChartStock] = useState(null); // Selected stock to show chart
            const [alerts, setAlerts] = useState([]);
            const [showAlerts, setShowAlerts] = useState(false);
            const [lastAlertCheck, setLastAlertCheck] = useState(null);
            const [previousPnL, setPreviousPnL] = useState({}); // Track previous P&L to detect changes
            // Track when user dismissed alerts - use localStorage to persist across sessions
            const getInitialDismissTime = () => {
                const saved = localStorage.getItem('alertsDismissedAt');
                return saved ? parseInt(saved) : null;
            };
            const [alertsDismissedAt, setAlertsDismissedAt] = useState(getInitialDismissTime());
            const [selectedPositionDetail, setSelectedPositionDetail] = useState(null); // Position detail modal

            // Custom Alert System State
            const [showAlertManager, setShowAlertManager] = useState(false);
            const [triggeredAlerts, setTriggeredAlerts] = useState([]); // Popup notifications
            const [customAlerts, setCustomAlerts] = useState(loadCustomAlerts());
            const [newsWatchlist, setNewsWatchlist] = useState(loadNewsWatchlist());
            const [seenNewsIds, setSeenNewsIds] = useState(() => {
                try { return JSON.parse(localStorage.getItem('seenNewsIds') || '[]'); } catch { return []; }
            });
            const [alertHistory, setAlertHistory] = useState(loadAlertHistory());
            const [rsiCache, setRsiCache] = useState({}); // Cache RSI values
            const [priceCache, setPriceCache] = useState({}); // Cache latest prices
            const [priceHistory, setPriceHistory] = useState({}); // { ticker: [{price, timestamp}] } for velocity detection
            const [stockInfoCache, setStockInfoCache] = useState({}); // { ticker: { fiftyTwoWeekHigh, fiftyTwoWeekLow, previousClose, volume, avgVolume } }

            // Firebase Cloud Messaging State
            const [fcmToken, setFcmToken] = useState(null);
            const [pushEnabled, setPushEnabled] = useState(false);
            const [fcmError, setFcmError] = useState(null);

            // Scalper Mode State
            const [showScalperMode, setShowScalperMode] = useState(false);
            const [tradeStats, setTradeStats] = useState(loadTradeStats());
            const [dailyGoal, setDailyGoal] = useState(loadDailyGoal());

            // Trade Journal State
            const [journalEntries, setJournalEntries] = useState(loadJournalEntries());
            const [showAddTrade, setShowAddTrade] = useState(false);
            const [journalView, setJournalView] = useState('list'); // 'list', 'stats', 'calendar'
            const [journalFilter, setJournalFilter] = useState({ ticker: '', setup: '', result: 'all', dateRange: 'all' });
            const [selectedJournalTrade, setSelectedJournalTrade] = useState(null);
            const journalStats = calculateJournalStats(journalEntries);

            // Load enabled patterns from localStorage (default: popular patterns)
            // Also ensures any new POPULAR_PATTERNS are added for existing users
            const getInitialEnabledPatterns = () => {
                const saved = localStorage.getItem('enabledPatterns');
                if (saved) {
                    const savedPatterns = JSON.parse(saved);
                    // Merge in any new popular patterns that might have been added
                    const merged = [...new Set([...savedPatterns, ...POPULAR_PATTERNS])];
                    // Save the merged list back
                    localStorage.setItem('enabledPatterns', JSON.stringify(merged));
                    return merged;
                }
                return POPULAR_PATTERNS; // Start with popular patterns by default
            };

            const [settings, setSettings] = useState({
                personality: 'homie',
                guardianMode: true,
                alertFrequency: 'balanced',
                realtimePnLAlerts: true, // Alert when positions go red/green
                enabledPatterns: getInitialEnabledPatterns()
            });

            // AI Position Monitor - Scans positions and generates alerts
            const analyzePositionsForAlerts = (positions, prevPnL, enableRealtimeAlerts = true) => {
                const newAlerts = [];
                const now = new Date();
                const newPnLTracker = {};

                positions.forEach(pos => {
                    const pnlPercent = ((pos.currentPrice - pos.entryPrice) / pos.entryPrice) * 100;
                    const daysToExpiry = pos.expiration ? getDaysToExpiry(pos.expiration) : null;
                    const isOption = pos.type === 'option';
                    const posDesc = isOption
                        ? `${pos.ticker} $${pos.strike} ${pos.optionType?.toUpperCase()}`
                        : pos.ticker;

                    // Track P&L for change detection
                    newPnLTracker[pos.id] = pnlPercent;
                    const prevPnlForPos = prevPnL[pos.id];

                    // ===== REAL-TIME CHANGE ALERTS (can be toggled off) =====
                    if (enableRealtimeAlerts) {
                        // Just went RED (was positive, now negative)
                        if (prevPnlForPos !== undefined && prevPnlForPos >= 0 && pnlPercent < 0) {
                            newAlerts.push({
                                id: `just-red-${pos.id}-${Date.now()}`,
                                type: 'critical',
                                icon: 'üî¥',
                                title: 'JUST WENT RED!',
                                ticker: pos.ticker,
                                message: `${posDesc} just turned negative! Was +${prevPnlForPos.toFixed(1)}%, now ${pnlPercent.toFixed(1)}%.`,
                                pnl: pnlPercent,
                                action: 'Check the chart - what happened?',
                                position: pos
                            });
                        }

                        // Just went GREEN (was negative, now positive)
                        if (prevPnlForPos !== undefined && prevPnlForPos < 0 && pnlPercent >= 0) {
                            newAlerts.push({
                                id: `just-green-${pos.id}-${Date.now()}`,
                                type: 'opportunity',
                                icon: 'üü¢',
                                title: 'JUST WENT GREEN!',
                                ticker: pos.ticker,
                                message: `${posDesc} just turned positive! Was ${prevPnlForPos.toFixed(1)}%, now +${pnlPercent.toFixed(1)}%.`,
                                pnl: pnlPercent,
                                action: 'Nice recovery! Lock in or ride it?',
                                position: pos
                            });
                        }

                        // Sudden drop (down 5%+ since last check)
                        if (prevPnlForPos !== undefined && (prevPnlForPos - pnlPercent) > 5) {
                            newAlerts.push({
                                id: `sudden-drop-${pos.id}-${Date.now()}`,
                                type: 'critical',
                                icon: 'üìâ',
                                title: 'SUDDEN DROP!',
                                ticker: pos.ticker,
                                message: `${posDesc} dropped ${(prevPnlForPos - pnlPercent).toFixed(1)}% since last update!`,
                                pnl: pnlPercent,
                                action: 'News? Support broken? Check NOW!',
                                position: pos
                            });
                        }

                        // Sudden spike (up 5%+ since last check)
                        if (prevPnlForPos !== undefined && (pnlPercent - prevPnlForPos) > 5 && pnlPercent > 0) {
                            newAlerts.push({
                                id: `sudden-spike-${pos.id}-${Date.now()}`,
                                type: 'opportunity',
                                icon: 'üìà',
                                title: 'SPIKING!',
                                ticker: pos.ticker,
                                message: `${posDesc} up ${(pnlPercent - prevPnlForPos).toFixed(1)}% since last update! Now +${pnlPercent.toFixed(1)}%`,
                                pnl: pnlPercent,
                                action: 'Lock in gains or let it ride?',
                                position: pos
                            });
                        }
                    }

                    // ===== CRITICAL ALERTS (Priority 1) =====

                    // Options expiring THIS WEEK
                    if (isOption && daysToExpiry !== null && daysToExpiry <= 7 && daysToExpiry >= 0) {
                        newAlerts.push({
                            id: `expire-${pos.id}`,
                            type: 'critical',
                            icon: 'üö®',
                            title: 'EXPIRING THIS WEEK',
                            ticker: pos.ticker,
                            message: `${posDesc} expires in ${daysToExpiry} day${daysToExpiry !== 1 ? 's' : ''}! ${pnlPercent >= 0 ? 'Consider taking profits or rolling.' : 'Decide: cut losses or roll out?'}`,
                            pnl: pnlPercent,
                            action: daysToExpiry <= 2 ? 'URGENT: Act today!' : 'Review this position',
                            position: pos
                        });
                    }

                    // Catastrophic loss on option with limited time
                    if (isOption && pnlPercent <= -70 && daysToExpiry !== null && daysToExpiry < 30) {
                        newAlerts.push({
                            id: `catastrophic-${pos.id}`,
                            type: 'critical',
                            icon: 'üíÄ',
                            title: 'POSITION IN TROUBLE',
                            ticker: pos.ticker,
                            message: `${posDesc} is down ${Math.abs(pnlPercent).toFixed(0)}% with only ${daysToExpiry} days left. Recovery is unlikely.`,
                            pnl: pnlPercent,
                            action: 'Consider cutting losses to preserve capital',
                            position: pos
                        });
                    }

                    // ===== WARNING ALERTS (Priority 2) =====

                    // Options expiring in 2 weeks with losses
                    if (isOption && daysToExpiry !== null && daysToExpiry > 7 && daysToExpiry <= 14 && pnlPercent < -20) {
                        newAlerts.push({
                            id: `expiry-warning-${pos.id}`,
                            type: 'warning',
                            icon: '‚ö†Ô∏è',
                            title: 'THETA ACCELERATING',
                            ticker: pos.ticker,
                            message: `${posDesc} is down ${Math.abs(pnlPercent).toFixed(0)}% with ${daysToExpiry} days left. Time decay is speeding up!`,
                            pnl: pnlPercent,
                            action: 'Needs a plan: hold, roll, or cut?',
                            position: pos
                        });
                    }

                    // Big unrealized gains - consider taking profits
                    if (pnlPercent >= 50) {
                        const warningType = pnlPercent >= 100 ? 'critical' : 'warning';
                        newAlerts.push({
                            id: `profit-${pos.id}`,
                            type: 'opportunity',
                            icon: 'üí∞',
                            title: pnlPercent >= 100 ? 'DOUBLED UP!' : 'BIG GAINS',
                            ticker: pos.ticker,
                            message: `${posDesc} is up ${pnlPercent.toFixed(0)}%! ${pnlPercent >= 100 ? 'You DOUBLED your money!' : 'Solid profits!'} Consider trimming.`,
                            pnl: pnlPercent,
                            action: 'Lock in some gains? Pigs get slaughtered.',
                            position: pos
                        });
                    }

                    // Position down significantly
                    if (pnlPercent <= -30 && pnlPercent > -70) {
                        // For options, check time
                        if (isOption && daysToExpiry !== null) {
                            if (daysToExpiry > 60) {
                                // LEAPs have time, just monitor
                                newAlerts.push({
                                    id: `loss-monitor-${pos.id}`,
                                    type: 'info',
                                    icon: 'üëÄ',
                                    title: 'MONITORING LOSS',
                                    ticker: pos.ticker,
                                    message: `${posDesc} is down ${Math.abs(pnlPercent).toFixed(0)}% but has ${daysToExpiry} days to recover.`,
                                    pnl: pnlPercent,
                                    action: 'Keep watching - time is on your side',
                                    position: pos
                                });
                            } else {
                                newAlerts.push({
                                    id: `loss-warning-${pos.id}`,
                                    type: 'warning',
                                    icon: 'üìâ',
                                    title: 'DOWN SIGNIFICANT',
                                    ticker: pos.ticker,
                                    message: `${posDesc} is down ${Math.abs(pnlPercent).toFixed(0)}% with ${daysToExpiry} days left.`,
                                    pnl: pnlPercent,
                                    action: 'Have a plan - stop loss or thesis change?',
                                    position: pos
                                });
                            }
                        } else {
                            // Stocks - just monitor
                            newAlerts.push({
                                id: `stock-loss-${pos.id}`,
                                type: 'info',
                                icon: 'üìä',
                                title: 'STOCK DOWN',
                                ticker: pos.ticker,
                                message: `${pos.ticker} is down ${Math.abs(pnlPercent).toFixed(0)}%. No expiration so you have time.`,
                                pnl: pnlPercent,
                                action: 'Review your thesis - still valid?',
                                position: pos
                            });
                        }
                    }

                    // Momentum alerts
                    if (pos.momentum === 'ripping' && pnlPercent > 20) {
                        newAlerts.push({
                            id: `momentum-${pos.id}`,
                            type: 'opportunity',
                            icon: 'üöÄ',
                            title: 'RIPPING!',
                            ticker: pos.ticker,
                            message: `${posDesc} is ripping! Up ${pnlPercent.toFixed(0)}% with strong momentum.`,
                            pnl: pnlPercent,
                            action: 'Ride the wave but have a trailing stop!',
                            position: pos
                        });
                    }

                    if (pos.momentum === 'bleeding' && pnlPercent < -10) {
                        newAlerts.push({
                            id: `bleeding-${pos.id}`,
                            type: 'warning',
                            icon: 'ü©∏',
                            title: 'BLEEDING OUT',
                            ticker: pos.ticker,
                            message: `${posDesc} is bleeding - down ${Math.abs(pnlPercent).toFixed(0)}% with negative momentum.`,
                            pnl: pnlPercent,
                            action: 'Falling knife? Consider stopping the bleeding.',
                            position: pos
                        });
                    }
                });

                // Sort alerts by priority: critical > warning > opportunity > info
                const priorityOrder = { critical: 0, warning: 1, opportunity: 2, info: 3 };
                newAlerts.sort((a, b) => priorityOrder[a.type] - priorityOrder[b.type]);

                return { alerts: newAlerts, pnlTracker: newPnLTracker };
            };

            // Run alert analysis when positions change
            useEffect(() => {
                if (positions.length > 0) {
                    const { alerts: newAlerts, pnlTracker } = analyzePositionsForAlerts(
                        positions,
                        previousPnL,
                        settings.realtimePnLAlerts // Pass the toggle setting
                    );
                    setAlerts(newAlerts);
                    setPreviousPnL(pnlTracker);
                    setLastAlertCheck(new Date());

                    // If there are critical alerts and real-time alerts are enabled, auto-show the panel
                    // BUT only if user hasn't dismissed alerts in the last 60 seconds
                    if (settings.realtimePnLAlerts) {
                        const timeSinceDismiss = alertsDismissedAt ? (Date.now() - alertsDismissedAt) : Infinity;
                        const hasCritical = newAlerts.some(a => a.type === 'critical' && (
                            a.title === 'JUST WENT RED!' ||
                            a.title === 'SUDDEN DROP!' ||
                            a.title === 'EXPIRING THIS WEEK'
                        ));
                        // Only auto-show once per day (24 hours = 86400000ms)
                        if (hasCritical && !showAlerts && timeSinceDismiss > 86400000) {
                            setShowAlerts(true);
                        }
                    }
                }
            }, [positions, settings.realtimePnLAlerts]);

            // Auto-load selected pattern when switching to patterns tab
            useEffect(() => {
                if (screenerTab === 'patterns' && patternStocks.length === 0 && !patternLoading) {
                    const loadInitialPattern = async () => {
                        setPatternLoading(true);
                        const stocks = await fetchPatternStocks(selectedPattern);
                        if (stocks !== null) {
                            setPatternStocks(stocks);
                            setPatternLoading(false);
                        }
                    };
                    loadInitialPattern();
                }
            }, [screenerTab, selectedPattern]);

            // Save enabled patterns to localStorage when they change
            useEffect(() => {
                localStorage.setItem('enabledPatterns', JSON.stringify(settings.enabledPatterns));
            }, [settings.enabledPatterns]);

            // ===== FIREBASE CLOUD MESSAGING INITIALIZATION =====
            // This enables push notifications even when app is closed (when deployed to cloud)
            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        // Check if Firebase config is set up
                        if (!window.FIREBASE_CONFIG ||
                            window.FIREBASE_CONFIG.apiKey === "YOUR_API_KEY" ||
                            !window.FIREBASE_CONFIG.apiKey) {
                            console.log('[FCM] Firebase not configured yet - push notifications disabled');
                            setFcmError('Firebase not configured');
                            return;
                        }

                        // Check if browser supports service workers and notifications
                        if (!('serviceWorker' in navigator) || !('Notification' in window)) {
                            console.log('[FCM] Browser does not support push notifications');
                            setFcmError('Browser not supported');
                            return;
                        }

                        // Initialize Firebase
                        if (!firebase.apps.length) {
                            firebase.initializeApp(window.FIREBASE_CONFIG);
                        }

                        // Register service worker
                        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                        console.log('[FCM] Service worker registered:', registration.scope);

                        // Get messaging instance
                        const messaging = firebase.messaging();

                        // Request notification permission
                        const permission = await Notification.requestPermission();
                        if (permission !== 'granted') {
                            console.log('[FCM] Notification permission denied');
                            setFcmError('Permission denied');
                            return;
                        }

                        // Get FCM token
                        const vapidKey = window.VAPID_KEY && window.VAPID_KEY !== "YOUR_VAPID_KEY"
                            ? window.VAPID_KEY
                            : null;

                        const token = await messaging.getToken({
                            vapidKey: vapidKey,
                            serviceWorkerRegistration: registration
                        });

                        if (token) {
                            console.log('[FCM] Token obtained:', token.substring(0, 20) + '...');
                            setFcmToken(token);
                            setPushEnabled(true);

                            // Save token locally
                            localStorage.setItem('fcmToken', token);

                            // Register token with backend (when deployed)
                            try {
                                await fetch('/api/register-push-token', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        token,
                                        alerts: customAlerts.filter(a => a.active).map(a => ({
                                            id: a.id,
                                            ticker: a.ticker,
                                            type: a.type,
                                            value: a.value
                                        }))
                                    })
                                });
                                console.log('[FCM] Token registered with backend');
                            } catch (err) {
                                // Backend endpoint not available yet (local dev)
                                console.log('[FCM] Backend registration skipped (not deployed)');
                            }
                        }

                        // Handle foreground messages
                        messaging.onMessage((payload) => {
                            console.log('[FCM] Foreground message:', payload);

                            // Show as triggered alert
                            const alert = {
                                id: Date.now(),
                                type: payload.data?.type || 'notification',
                                ticker: payload.data?.ticker || '',
                                message: payload.notification?.body || payload.data?.body,
                                title: payload.notification?.title || 'Alert',
                                timestamp: new Date()
                            };
                            setTriggeredAlerts(prev => [alert, ...prev]);
                        });

                    } catch (error) {
                        console.error('[FCM] Initialization error:', error);
                        setFcmError(error.message);
                    }
                };

                initializeFirebase();
            }, []);

            // Sync alerts to server whenever they change (for background notifications)
            const syncAlertsToServer = async () => {
                const token = fcmToken || localStorage.getItem('fcmToken');
                if (!token) {
                    console.log('[Sync] No FCM token - skipping sync');
                    return;
                }

                const activeAlerts = customAlerts.filter(a => a.active).map(a => ({
                    id: a.id,
                    ticker: a.ticker,
                    type: a.type,
                    value: parseFloat(a.value)
                }));

                console.log('[Sync] Syncing', activeAlerts.length, 'alerts to server with token:', token.substring(0, 20) + '...');

                try {
                    const response = await fetch('/api/register-push-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token, alerts: activeAlerts })
                    });
                    const result = await response.json();
                    console.log('[Sync] Server response:', result);
                } catch (err) {
                    console.log('[Sync] Failed to sync:', err.message);
                }
            };

            // Sync when alerts change
            useEffect(() => {
                const timeoutId = setTimeout(syncAlertsToServer, 1000);
                return () => clearTimeout(timeoutId);
            }, [customAlerts]);

            // Also sync when FCM token becomes available
            useEffect(() => {
                if (fcmToken) {
                    console.log('[Sync] FCM token available, syncing alerts...');
                    syncAlertsToServer();
                }
            }, [fcmToken]);

            // Force sync on page load after 3 seconds (gives Firebase time to init)
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    console.log('[Sync] Delayed page load sync...');
                    syncAlertsToServer();
                }, 3000);
                return () => clearTimeout(timeoutId);
            }, []);

            // Get only enabled patterns
            const getEnabledPatterns = () => {
                return CHART_PATTERNS.filter(p => settings.enabledPatterns.includes(p.id));
            };

            const [lastPriceUpdate, setLastPriceUpdate] = useState(null);
            const [isRefreshing, setIsRefreshing] = useState(false);

            // Fast price refresh function (only updates prices, not all data)
            const refreshPrices = async () => {
                if (positions.length === 0) return;
                setIsRefreshing(true);

                const updatedPositions = await Promise.all(
                    positions.map(async (pos) => {
                        try {
                            // For OPTIONS: fetch the actual option contract price
                            if (pos.type === 'option' && pos.expiration && pos.optionType && pos.strike) {
                                const optionData = await fetchOptionPrice(pos.ticker, pos.expiration, pos.optionType, pos.strike);

                                if (optionData && optionData.price) {
                                    const dayChange = optionData.percentChange?.toFixed(2) || '0.00';

                                    // Determine momentum from option's price movement
                                    let momentum = pos.momentum;
                                    const change = parseFloat(dayChange);
                                    if (change > 10) momentum = 'ripping';
                                    else if (change > 3) momentum = 'uptrend';
                                    else if (change < -10) momentum = 'bleeding';
                                    else if (change < -3) momentum = 'downtrend';

                                    console.log(`[Position Update] ${pos.ticker} ${pos.strike}${pos.optionType?.charAt(0).toUpperCase()}: Setting livePrice=${optionData.price}`);

                                    return {
                                        ...pos,
                                        livePrice: optionData.price,
                                        dayChange: dayChange,
                                        momentum: momentum,
                                        optionBid: optionData.bid,
                                        optionAsk: optionData.ask,
                                        optionVolume: optionData.volume,
                                        optionOI: optionData.openInterest,
                                        optionIV: optionData.impliedVolatility
                                    };
                                }
                                // Fallback: if option price fetch fails, return position unchanged
                                return pos;
                            }

                            // For STOCKS/CRYPTO: fetch the regular price
                            const response = await fetch(`/api/proxy?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${pos.ticker}?interval=1m&range=1d`)}`);
                            const data = await response.json();

                            if (data.chart?.result?.[0]?.meta?.regularMarketPrice) {
                                const newPrice = data.chart.result[0].meta.regularMarketPrice;
                                const previousClose = data.chart.result[0].meta.previousClose || newPrice;
                                const dayChange = ((newPrice - previousClose) / previousClose * 100).toFixed(2);

                                // Determine momentum from intraday movement
                                let momentum = pos.momentum;
                                if (parseFloat(dayChange) > 3) momentum = 'ripping';
                                else if (parseFloat(dayChange) > 1) momentum = 'uptrend';
                                else if (parseFloat(dayChange) < -3) momentum = 'bleeding';
                                else if (parseFloat(dayChange) < -1) momentum = 'downtrend';

                                return {
                                    ...pos,
                                    livePrice: newPrice,
                                    dayChange: dayChange,
                                    momentum: momentum
                                };
                            }
                        } catch (error) {
                            console.error(`Error refreshing ${pos.ticker}:`, error);
                        }
                        return pos;
                    })
                );

                setPositions(updatedPositions);
                setLastPriceUpdate(new Date());
                setIsRefreshing(false);
            };

            // Fetch real market data on load
            useEffect(() => {
                const fetchAllData = async () => {
                    setLoading(true);

                    // Fetch all data in parallel
                    const [trendingData, insiderData] = await Promise.all([
                        fetchTrendingStocks(),
                        fetchInsiderTrading()
                    ]);

                    setTrending(trendingData);
                    setInsiderTrades(insiderData);

                    // Fetch position data
                    const updatedPositions = await Promise.all(
                        positions.map(async (pos) => {
                            if (pos.type === 'crypto') return pos;

                            // For OPTIONS: fetch actual option contract price
                            if (pos.type === 'option' && pos.expiration && pos.optionType && pos.strike) {
                                const optionData = await fetchOptionPrice(pos.ticker, pos.expiration, pos.optionType, pos.strike);
                                const stockData = await fetchStockData(pos.ticker);

                                if (optionData && optionData.price) {
                                    const dayChange = optionData.percentChange?.toFixed(2) || '0.00';
                                    let momentum = pos.momentum;
                                    const change = parseFloat(dayChange);
                                    if (change > 10) momentum = 'ripping';
                                    else if (change > 3) momentum = 'uptrend';
                                    else if (change < -10) momentum = 'bleeding';
                                    else if (change < -3) momentum = 'downtrend';

                                    console.log(`[Initial Load] ${pos.ticker} ${pos.strike}${pos.optionType?.charAt(0).toUpperCase()}: Setting livePrice=${optionData.price}`);

                                    return {
                                        ...pos,
                                        livePrice: optionData.price,
                                        dayChange: dayChange,
                                        momentum: momentum,
                                        optionBid: optionData.bid,
                                        optionAsk: optionData.ask,
                                        optionVolume: optionData.volume,
                                        optionOI: optionData.openInterest,
                                        optionIV: optionData.impliedVolatility,
                                        stockPrice: stockData?.currentPrice,
                                        stockWeekChange: stockData?.weekChange,
                                        stockMonthChange: stockData?.monthChange
                                    };
                                } else {
                                    console.log(`[Initial Load] ${pos.ticker}: optionData fetch failed or no price`, optionData);
                                }
                            }

                            // For STOCKS: fetch stock data
                            const data = await fetchStockData(pos.ticker);
                            if (data) {
                                let finalMomentum = pos.momentum || data.momentum;

                                return {
                                    ...pos,
                                    livePrice: data.currentPrice,
                                    stockWeekChange: data.weekChange,
                                    stockMonthChange: data.monthChange,
                                    weekChange: data.weekChange,
                                    monthChange: data.monthChange,
                                    momentum: finalMomentum
                                };
                            }
                            return pos;
                        })
                    );
                    setPositions(updatedPositions);
                    setLastPriceUpdate(new Date());
                    setLoading(false);
                };
                fetchAllData();
            }, []);

            // Auto-refresh prices - FAST for real-time alerts
            useEffect(() => {
                const interval = setInterval(() => {
                    if (positions.length > 0 && !isRefreshing) {
                        refreshPrices();
                    }
                }, 5000); // 5 seconds - fast for real-time stock/crypto alerts

                return () => clearInterval(interval);
            }, [positions.length, isRefreshing]);

            // Fetch live price for any ticker (for alerts on non-position tickers)
            const fetchLivePrice = async (ticker) => {
                try {
                    const response = await fetch(`/api/proxy?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1m&range=1d`)}`);
                    const data = await response.json();
                    if (data.chart?.result?.[0]?.meta?.regularMarketPrice) {
                        return data.chart.result[0].meta.regularMarketPrice;
                    }
                    return null;
                } catch (e) {
                    console.error('Error fetching price for', ticker, e);
                    return null;
                }
            };

            // Fetch comprehensive stock info for advanced alerts (52w high/low, volume, prev close)
            const fetchStockInfo = async (ticker) => {
                try {
                    const response = await fetch(`/api/proxy?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`)}`);
                    const data = await response.json();
                    const meta = data.chart?.result?.[0]?.meta;
                    const quotes = data.chart?.result?.[0]?.indicators?.quote?.[0];

                    if (meta) {
                        return {
                            regularMarketPrice: meta.regularMarketPrice,
                            previousClose: meta.previousClose || meta.chartPreviousClose,
                            fiftyTwoWeekHigh: meta.fiftyTwoWeekHigh,
                            fiftyTwoWeekLow: meta.fiftyTwoWeekLow,
                            volume: meta.regularMarketVolume,
                            avgVolume: quotes?.volume ? Math.round(quotes.volume.reduce((a, b) => a + (b || 0), 0) / quotes.volume.filter(v => v).length) : null
                        };
                    }
                    return null;
                } catch (e) {
                    console.error('Error fetching stock info for', ticker, e);
                    return null;
                }
            };

            // ===== REAL-TIME ALERT MONITORING ENGINE =====
            // Checks all custom alerts whenever positions update
            useEffect(() => {
                const checkAlerts = async () => {
                    const activeAlerts = customAlerts.filter(a => a.active);
                    if (activeAlerts.length === 0) return;

                    const newTriggered = [];

                    for (const alert of activeAlerts) {
                        let triggered = false;
                        let message = '';
                        let currentValue = null;

                        // Get current price for this ticker - from positions or fetch live
                        const position = positions.find(p => p.ticker === alert.ticker);
                        let livePrice = position?.livePrice || position?.currentPrice || priceCache[alert.ticker];

                        // If no price in cache/positions, fetch it for this ticker
                        if (!livePrice && (alert.type === ALERT_TYPES.PRICE_ABOVE || alert.type === ALERT_TYPES.PRICE_BELOW || alert.type === ALERT_TYPES.TRAILING_STOP)) {
                            livePrice = await fetchLivePrice(alert.ticker);
                            if (livePrice) {
                                setPriceCache(prev => ({ ...prev, [alert.ticker]: livePrice }));
                            }
                        }

                        // Price alerts
                        if (alert.type === ALERT_TYPES.PRICE_ABOVE && livePrice) {
                            if (livePrice >= alert.value) {
                                triggered = true;
                                message = `${alert.ticker} hit $${livePrice.toFixed(2)} (above $${alert.value})`;
                                currentValue = livePrice;
                            }
                        } else if (alert.type === ALERT_TYPES.PRICE_BELOW && livePrice) {
                            if (livePrice <= alert.value) {
                                triggered = true;
                                message = `${alert.ticker} dropped to $${livePrice.toFixed(2)} (below $${alert.value})`;
                                currentValue = livePrice;
                            }
                        }
                        // Percent gain/loss alerts (position-based)
                        else if (alert.type === ALERT_TYPES.PERCENT_GAIN && position) {
                            const pnlPercent = ((position.livePrice || position.currentPrice) - position.entryPrice) / position.entryPrice * 100;
                            if (pnlPercent >= alert.value) {
                                triggered = true;
                                message = `${alert.ticker} is up ${pnlPercent.toFixed(1)}% (target: ${alert.value}%)`;
                                currentValue = pnlPercent;
                            }
                        } else if (alert.type === ALERT_TYPES.PERCENT_LOSS && position) {
                            const pnlPercent = ((position.livePrice || position.currentPrice) - position.entryPrice) / position.entryPrice * 100;
                            if (pnlPercent <= -alert.value) {
                                triggered = true;
                                message = `${alert.ticker} is down ${Math.abs(pnlPercent).toFixed(1)}% (stop: -${alert.value}%)`;
                                currentValue = pnlPercent;
                            }
                        }
                        // RSI alerts
                        else if (alert.type === ALERT_TYPES.RSI_ABOVE || alert.type === ALERT_TYPES.RSI_BELOW) {
                            let rsi = rsiCache[alert.ticker];
                            if (!rsi) {
                                rsi = await fetchRSIData(alert.ticker);
                                if (rsi) setRsiCache(prev => ({ ...prev, [alert.ticker]: rsi }));
                            }
                            if (rsi) {
                                if (alert.type === ALERT_TYPES.RSI_ABOVE && rsi >= alert.value) {
                                    triggered = true;
                                    message = `${alert.ticker} RSI is ${rsi.toFixed(1)} (overbought above ${alert.value})`;
                                    currentValue = rsi;
                                } else if (alert.type === ALERT_TYPES.RSI_BELOW && rsi <= alert.value) {
                                    triggered = true;
                                    message = `${alert.ticker} RSI is ${rsi.toFixed(1)} (oversold below ${alert.value})`;
                                    currentValue = rsi;
                                }
                            }
                        }
                        // Trailing stop
                        else if (alert.type === ALERT_TYPES.TRAILING_STOP && livePrice) {
                            const highestPrice = alert.highestPrice || livePrice;
                            const newHighest = Math.max(highestPrice, livePrice);
                            const dropPercent = ((newHighest - livePrice) / newHighest) * 100;

                            // Update highest price
                            if (newHighest > highestPrice) {
                                setCustomAlerts(prev => prev.map(a =>
                                    a.id === alert.id ? { ...a, highestPrice: newHighest } : a
                                ));
                            }

                            if (dropPercent >= alert.value) {
                                triggered = true;
                                message = `${alert.ticker} trailing stop triggered! Dropped ${dropPercent.toFixed(1)}% from high of $${newHighest.toFixed(2)}`;
                                currentValue = livePrice;
                            }
                        }

                        if (triggered) {
                            const triggeredAlert = {
                                ...alert,
                                message,
                                currentValue,
                                triggeredAt: new Date().toISOString()
                            };

                            newTriggered.push(triggeredAlert);

                            // Add to history
                            setAlertHistory(prev => {
                                const updated = [...prev, triggeredAlert];
                                saveAlertHistory(updated);
                                return updated;
                            });

                            // Deactivate if not repeating
                            if (!alert.repeat) {
                                setCustomAlerts(prev => {
                                    const updated = prev.map(a => a.id === alert.id ? { ...a, active: false } : a);
                                    saveCustomAlerts(updated);
                                    return updated;
                                });
                            }
                        }
                    }

                    if (newTriggered.length > 0) {
                        setTriggeredAlerts(prev => [...prev, ...newTriggered]);
                    }
                };

                checkAlerts();
            }, [positions, customAlerts]);

            // ===== ADVANCED REAL-TIME ALERT MONITORING ENGINE =====
            // Dedicated loop that checks ALL alert tickers every 30 seconds
            // Works for ANY ticker, not just positions
            useEffect(() => {
                const activeAlerts = customAlerts.filter(a => a.active);
                if (activeAlerts.length === 0) return;

                // Request browser notification permission on first alert
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                const runAlertCheck = async () => {
                    console.log('[Alert Engine] Running check for', activeAlerts.length, 'alerts');

                    // Get unique tickers that need price checks
                    const priceTickers = [...new Set(
                        activeAlerts
                            .filter(a => [ALERT_TYPES.PRICE_ABOVE, ALERT_TYPES.PRICE_BELOW, ALERT_TYPES.TRAILING_STOP].includes(a.type))
                            .map(a => a.ticker)
                    )];

                    // Fetch all prices in parallel
                    const pricePromises = priceTickers.map(async (ticker) => {
                        try {
                            // Check positions first
                            const pos = positions.find(p => p.ticker === ticker);
                            if (pos?.livePrice) return { ticker, price: pos.livePrice };

                            // Otherwise fetch live
                            const price = await fetchLivePrice(ticker);
                            return { ticker, price };
                        } catch (e) {
                            return { ticker, price: null };
                        }
                    });

                    const priceResults = await Promise.all(pricePromises);
                    const livePrices = {};
                    priceResults.forEach(r => { if (r.price) livePrices[r.ticker] = r.price; });

                    // Update price cache
                    setPriceCache(prev => ({ ...prev, ...livePrices }));

                    const newTriggered = [];

                    for (const alert of activeAlerts) {
                        let triggered = false;
                        let message = '';
                        const livePrice = livePrices[alert.ticker];
                        const position = positions.find(p => p.ticker === alert.ticker);

                        // Price Above
                        if (alert.type === ALERT_TYPES.PRICE_ABOVE && livePrice) {
                            if (livePrice >= alert.value) {
                                triggered = true;
                                message = `üöÄ ${alert.ticker} broke above $${alert.value}! Now at $${livePrice.toFixed(2)}`;
                            }
                        }
                        // Price Below
                        else if (alert.type === ALERT_TYPES.PRICE_BELOW && livePrice) {
                            if (livePrice <= alert.value) {
                                triggered = true;
                                message = `üìâ ${alert.ticker} dropped below $${alert.value}! Now at $${livePrice.toFixed(2)}`;
                            }
                        }
                        // Percent Gain
                        else if (alert.type === ALERT_TYPES.PERCENT_GAIN && position) {
                            const currentPrice = position.livePrice || position.currentPrice;
                            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice * 100);
                            if (pnlPercent >= alert.value) {
                                triggered = true;
                                message = `üí∞ ${alert.ticker} is UP ${pnlPercent.toFixed(1)}%! Target ${alert.value}% hit!`;
                            }
                        }
                        // Percent Loss
                        else if (alert.type === ALERT_TYPES.PERCENT_LOSS && position) {
                            const currentPrice = position.livePrice || position.currentPrice;
                            const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice * 100);
                            if (pnlPercent <= -alert.value) {
                                triggered = true;
                                message = `üõë ${alert.ticker} is DOWN ${Math.abs(pnlPercent).toFixed(1)}%! Stop level -${alert.value}% hit!`;
                            }
                        }
                        // Trailing Stop
                        else if (alert.type === ALERT_TYPES.TRAILING_STOP && livePrice) {
                            const highestPrice = alert.highestPrice || livePrice;

                            // Update highest price if current is higher
                            if (livePrice > highestPrice) {
                                setCustomAlerts(prev => prev.map(a =>
                                    a.id === alert.id ? { ...a, highestPrice: livePrice } : a
                                ));
                            }

                            // Check if dropped X% from highest
                            const dropPercent = ((highestPrice - livePrice) / highestPrice) * 100;
                            if (dropPercent >= alert.value && highestPrice > livePrice) {
                                triggered = true;
                                message = `üîª ${alert.ticker} trailing stop! Dropped ${dropPercent.toFixed(1)}% from high of $${highestPrice.toFixed(2)}`;
                            }
                        }
                        // RSI alerts
                        else if (alert.type === ALERT_TYPES.RSI_ABOVE || alert.type === ALERT_TYPES.RSI_BELOW) {
                            let rsi = rsiCache[alert.ticker];
                            if (!rsi) {
                                rsi = await fetchRSIData(alert.ticker);
                                if (rsi) setRsiCache(prev => ({ ...prev, [alert.ticker]: rsi }));
                            }
                            if (rsi) {
                                if (alert.type === ALERT_TYPES.RSI_ABOVE && rsi >= alert.value) {
                                    triggered = true;
                                    message = `üìä ${alert.ticker} RSI is ${rsi.toFixed(1)} - OVERBOUGHT above ${alert.value}!`;
                                } else if (alert.type === ALERT_TYPES.RSI_BELOW && rsi <= alert.value) {
                                    triggered = true;
                                    message = `üìä ${alert.ticker} RSI is ${rsi.toFixed(1)} - OVERSOLD below ${alert.value}!`;
                                }
                            }
                        }
                        // Price Velocity - detect X% move in last few minutes
                        else if (alert.type === ALERT_TYPES.PRICE_VELOCITY && livePrice) {
                            const history = priceHistory[alert.ticker] || [];
                            const fiveMinAgo = Date.now() - (5 * 60 * 1000);
                            const oldEntry = history.find(h => h.timestamp <= fiveMinAgo) || history[0];

                            // Store current price in history
                            setPriceHistory(prev => {
                                const existing = prev[alert.ticker] || [];
                                const updated = [...existing, { price: livePrice, timestamp: Date.now() }]
                                    .filter(h => h.timestamp > Date.now() - (10 * 60 * 1000)) // Keep 10 min
                                    .slice(-30); // Max 30 entries
                                return { ...prev, [alert.ticker]: updated };
                            });

                            if (oldEntry && oldEntry.price) {
                                const velocityPercent = Math.abs((livePrice - oldEntry.price) / oldEntry.price * 100);
                                if (velocityPercent >= alert.value) {
                                    const direction = livePrice > oldEntry.price ? 'üöÄ RIPPING' : 'üí• DUMPING';
                                    triggered = true;
                                    message = `‚ö° ${alert.ticker} ${direction}! Moved ${velocityPercent.toFixed(1)}% in ~5 min! Now $${livePrice.toFixed(2)}`;
                                }
                            }
                        }
                        // Volume Spike - detect volume X% above average
                        else if (alert.type === ALERT_TYPES.VOLUME_SPIKE) {
                            let info = stockInfoCache[alert.ticker];
                            if (!info) {
                                info = await fetchStockInfo(alert.ticker);
                                if (info) setStockInfoCache(prev => ({ ...prev, [alert.ticker]: info }));
                            }
                            if (info?.volume && info?.avgVolume) {
                                const volumeRatio = (info.volume / info.avgVolume) * 100;
                                if (volumeRatio >= alert.value + 100) { // alert.value is % ABOVE average
                                    triggered = true;
                                    message = `üîä ${alert.ticker} VOLUME SPIKE! ${volumeRatio.toFixed(0)}% of avg volume (${(info.volume/1000000).toFixed(1)}M vs ${(info.avgVolume/1000000).toFixed(1)}M avg)`;
                                }
                            }
                        }
                        // Gap Up - pre-market gap above previous close
                        else if (alert.type === ALERT_TYPES.GAP_UP && livePrice) {
                            let info = stockInfoCache[alert.ticker];
                            if (!info) {
                                info = await fetchStockInfo(alert.ticker);
                                if (info) setStockInfoCache(prev => ({ ...prev, [alert.ticker]: info }));
                            }
                            if (info?.previousClose) {
                                const gapPercent = ((livePrice - info.previousClose) / info.previousClose) * 100;
                                if (gapPercent >= alert.value) {
                                    triggered = true;
                                    message = `üåÖ ${alert.ticker} GAP UP ${gapPercent.toFixed(1)}%! From $${info.previousClose.toFixed(2)} to $${livePrice.toFixed(2)}`;
                                }
                            }
                        }
                        // Gap Down - pre-market gap below previous close
                        else if (alert.type === ALERT_TYPES.GAP_DOWN && livePrice) {
                            let info = stockInfoCache[alert.ticker];
                            if (!info) {
                                info = await fetchStockInfo(alert.ticker);
                                if (info) setStockInfoCache(prev => ({ ...prev, [alert.ticker]: info }));
                            }
                            if (info?.previousClose) {
                                const gapPercent = ((info.previousClose - livePrice) / info.previousClose) * 100;
                                if (gapPercent >= alert.value) {
                                    triggered = true;
                                    message = `üåô ${alert.ticker} GAP DOWN ${gapPercent.toFixed(1)}%! From $${info.previousClose.toFixed(2)} to $${livePrice.toFixed(2)}`;
                                }
                            }
                        }
                        // 52-Week Breakout
                        else if (alert.type === ALERT_TYPES.BREAKOUT && livePrice) {
                            let info = stockInfoCache[alert.ticker];
                            if (!info) {
                                info = await fetchStockInfo(alert.ticker);
                                if (info) setStockInfoCache(prev => ({ ...prev, [alert.ticker]: info }));
                            }
                            if (info?.fiftyTwoWeekHigh && livePrice >= info.fiftyTwoWeekHigh) {
                                triggered = true;
                                message = `üöÄ ${alert.ticker} 52-WEEK HIGH BREAKOUT! Now $${livePrice.toFixed(2)} (prev high: $${info.fiftyTwoWeekHigh.toFixed(2)})`;
                            }
                        }
                        // 52-Week Breakdown
                        else if (alert.type === ALERT_TYPES.BREAKDOWN && livePrice) {
                            let info = stockInfoCache[alert.ticker];
                            if (!info) {
                                info = await fetchStockInfo(alert.ticker);
                                if (info) setStockInfoCache(prev => ({ ...prev, [alert.ticker]: info }));
                            }
                            if (info?.fiftyTwoWeekLow && livePrice <= info.fiftyTwoWeekLow) {
                                triggered = true;
                                message = `üí• ${alert.ticker} 52-WEEK LOW BREAKDOWN! Now $${livePrice.toFixed(2)} (prev low: $${info.fiftyTwoWeekLow.toFixed(2)})`;
                            }
                        }

                        if (triggered) {
                            // Check if already triggered recently (within 5 min) unless repeat is on
                            const recentlyTriggered = alertHistory.some(h =>
                                h.alertId === alert.id &&
                                (Date.now() - new Date(h.triggeredAt).getTime()) < 300000
                            );

                            if (!recentlyTriggered || alert.repeat) {
                                const alertData = {
                                    alertId: alert.id,
                                    ticker: alert.ticker,
                                    type: alert.type,
                                    priority: alert.priority,
                                    message,
                                    note: alert.note,
                                    triggeredAt: new Date().toISOString(),
                                    sound: alert.sound
                                };

                                newTriggered.push(alertData);

                                // Browser push notification
                                if ('Notification' in window && Notification.permission === 'granted') {
                                    new Notification(`üîî ${alert.ticker} Alert!`, {
                                        body: message,
                                        icon: 'üîî',
                                        tag: `alert-${alert.id}`,
                                        requireInteraction: alert.priority === ALERT_PRIORITIES.CRITICAL
                                    });
                                }

                                // Deactivate non-repeat alerts
                                if (!alert.repeat) {
                                    setCustomAlerts(prev => prev.map(a =>
                                        a.id === alert.id ? { ...a, active: false, triggered: true } : a
                                    ));
                                }

                                // Add to history
                                setAlertHistory(prev => {
                                    const updated = [...prev, alertData];
                                    saveAlertHistory(updated);
                                    return updated;
                                });

                                console.log('[Alert Engine] TRIGGERED:', message);
                            }
                        }
                    }

                    if (newTriggered.length > 0) {
                        setTriggeredAlerts(prev => [...prev, ...newTriggered]);
                    }
                };

                // Run immediately then every 20 seconds for fast alerts
                runAlertCheck();
                const interval = setInterval(runAlertCheck, 20000);

                return () => clearInterval(interval);
            }, [customAlerts, positions, alertHistory]);

            // ===== NEWS MONITORING ENGINE =====
            // Checks for breaking news on watched tickers every 2 minutes
            useEffect(() => {
                if (newsWatchlist.length === 0) return;

                const checkNews = async () => {
                    for (const ticker of newsWatchlist) {
                        try {
                            const news = await fetchTickerNews(ticker);
                            const newNews = news.filter(n => !seenNewsIds.includes(n.uuid));

                            if (newNews.length > 0) {
                                // Mark as seen
                                const newIds = newNews.map(n => n.uuid);
                                setSeenNewsIds(prev => {
                                    const updated = [...prev, ...newIds].slice(-500); // Keep last 500
                                    localStorage.setItem('seenNewsIds', JSON.stringify(updated));
                                    return updated;
                                });

                                // Create news alerts
                                newNews.forEach(item => {
                                    const newsAlert = {
                                        ticker,
                                        type: 'news',
                                        priority: ALERT_PRIORITIES.INFO,
                                        sound: true,
                                        message: `üì∞ ${ticker}: ${item.title}`,
                                        note: item.publisher,
                                        triggeredAt: new Date().toISOString(),
                                        link: item.link
                                    };

                                    setTriggeredAlerts(prev => [...prev, newsAlert]);
                                    setAlertHistory(prev => {
                                        const updated = [...prev, newsAlert];
                                        saveAlertHistory(updated);
                                        return updated;
                                    });
                                });
                            }
                        } catch (e) {
                            console.error('Error checking news for', ticker, e);
                        }
                    }
                };

                // Check immediately then every 2 minutes
                checkNews();
                const interval = setInterval(checkNews, 120000); // 2 minutes

                return () => clearInterval(interval);
            }, [newsWatchlist, seenNewsIds]);

            // Dismiss triggered alert
            const dismissTriggeredAlert = (idx) => {
                setTriggeredAlerts(prev => prev.filter((_, i) => i !== idx));
            };

            // Dismiss all triggered alerts
            const dismissAllTriggeredAlerts = () => {
                setTriggeredAlerts([]);
            };

            // Calculate total P&L
            const totalPnL = positions.reduce((sum, pos) => {
                return sum + (pos.currentPrice - pos.entryPrice) * pos.quantity;
            }, 0);

            // Get urgent positions
            const urgentPositions = positions.filter(p => {
                const urgency = getUrgency(p);
                return urgency.level === 'critical';
            });

            const handleAddPosition = (newPosition) => {
                setPositions([...positions, newPosition]);
            };

            const handleDeletePosition = (id) => {
                setPositions(positions.filter(p => p.id !== id));
            };

            return (
                <div className="min-h-screen pb-24">
                    {/* Header */}
                    <header className="sticky top-0 z-40 backdrop-blur-lg bg-gray-900/80 border-b border-gray-800">
                        <div className="max-w-lg mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-xl font-bold">üß† AI Trading Buddy</h1>
                                    <p className="text-xs text-gray-400 flex items-center gap-2">
                                        {loading ? (
                                            <span>‚è≥ Fetching live market data...</span>
                                        ) : isRefreshing ? (
                                            <span className="flex items-center gap-1"><span className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span> Updating prices...</span>
                                        ) : lastPriceUpdate ? (
                                            <span className="flex items-center gap-1"><span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Live ‚Ä¢ Updated {lastPriceUpdate.toLocaleTimeString()}</span>
                                        ) : (
                                            <span>The logic you need when emotions take over</span>
                                        )}
                                    </p>
                                </div>
                                <div className="flex items-center gap-2">
                                    {/* Scalper Mode */}
                                    <button
                                        onClick={() => setShowScalperMode(true)}
                                        className="p-2 hover:bg-gray-800 rounded-xl transition-colors"
                                        title="Scalper Mode"
                                    >
                                        üéØ
                                    </button>
                                    {/* Custom Alert Manager */}
                                    <button
                                        onClick={() => setShowAlertManager(true)}
                                        className="p-2 hover:bg-gray-800 rounded-xl transition-colors relative"
                                        title="Alert Manager"
                                    >
                                        ‚ö°
                                        {customAlerts.filter(a => a.active).length > 0 && (
                                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-purple-500 rounded-full text-xs flex items-center justify-center font-bold">
                                                {customAlerts.filter(a => a.active).length}
                                            </span>
                                        )}
                                    </button>
                                    {/* Position Alerts Bell */}
                                    <button
                                        onClick={() => setShowAlerts(true)}
                                        className="p-2 hover:bg-gray-800 rounded-xl transition-colors relative"
                                        title="Position Alerts"
                                    >
                                        üîî
                                        {alerts.filter(a => a.type === 'critical' || a.type === 'warning').length > 0 && (
                                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center font-bold animate-pulse">
                                                {alerts.filter(a => a.type === 'critical' || a.type === 'warning').length}
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="p-2 hover:bg-gray-800 rounded-xl transition-colors"
                                    >
                                        ‚öôÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-lg mx-auto px-4 py-6">
                        {/* Portfolio Summary */}
                        <div className="card-gradient border border-gray-700 rounded-2xl p-6 mb-6">
                            <div className="text-center">
                                <div className="text-gray-400 text-sm">Total P&L</div>
                                <div className={`text-4xl font-bold ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {totalPnL >= 0 ? '+' : ''}{totalPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                </div>
                                <div className="text-gray-500 text-sm mt-1">{positions.length} active positions</div>
                            </div>

                            {settings.guardianMode && (
                                <div className="mt-4 flex items-center justify-center gap-2 text-green-400 text-sm">
                                    <span>üõ°Ô∏è</span>
                                    <span>Guardian Mode Active</span>
                                </div>
                            )}
                        </div>

                        {/* Urgent Alerts */}
                        {urgentPositions.map(pos => (
                            <AlertBanner key={pos.id} position={pos} />
                        ))}

                        {/* Tab Navigation */}
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => setActiveTab('positions')}
                                className={`flex-1 py-2 rounded-xl font-semibold transition-colors text-sm ${activeTab === 'positions' ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'}`}
                            >
                                üìä Positions
                            </button>
                            <button
                                onClick={() => setActiveTab('screeners')}
                                className={`flex-1 py-2 rounded-xl font-semibold transition-colors text-sm ${activeTab === 'screeners' ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'}`}
                            >
                                üîç Screeners
                            </button>
                            <button
                                onClick={() => setActiveTab('trending')}
                                className={`flex-1 py-2 rounded-xl font-semibold transition-colors text-sm ${activeTab === 'trending' ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'}`}
                            >
                                üî• Hot
                            </button>
                            <button
                                onClick={() => setActiveTab('journal')}
                                className={`flex-1 py-2 rounded-xl font-semibold transition-colors text-sm ${activeTab === 'journal' ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'}`}
                            >
                                üìì Journal
                            </button>
                        </div>

                        {/* Positions Tab */}
                        {activeTab === 'positions' && (
                            <>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg font-semibold">Your Positions</h2>
                                    <button
                                        onClick={() => setShowAddPosition(true)}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-sm font-semibold transition-colors"
                                    >
                                        + Add
                                    </button>
                                </div>

                                <div className="space-y-3 mb-6">
                                    {positions.map(position => (
                                        <PositionCard
                                            key={position.id}
                                            position={position}
                                            onClick={() => setSelectedPositionDetail(position)}
                                        />
                                    ))}
                                </div>

                                {positions.length === 0 && (
                                    <div className="text-center py-12 text-gray-500">
                                        <div className="text-4xl mb-2">üìä</div>
                                        <p>No positions yet</p>
                                        <p className="text-sm">Add your first position to get started</p>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Screeners Tab */}
                        {activeTab === 'screeners' && (
                            <>
                                {/* Sub-tabs for screeners */}
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => setScreenerTab('patterns')}
                                        className={`flex-1 py-3 rounded-lg text-sm font-medium transition-colors ${screenerTab === 'patterns' ? 'bg-purple-600' : 'bg-gray-800 hover:bg-gray-700'}`}
                                    >
                                        üìê Chart Patterns
                                    </button>
                                    <button
                                        onClick={() => setScreenerTab('insider')}
                                        className={`flex-1 py-3 rounded-lg text-sm font-medium transition-colors ${screenerTab === 'insider' ? 'bg-purple-600' : 'bg-gray-800 hover:bg-gray-700'}`}
                                    >
                                        üïµÔ∏è Insider Buys
                                    </button>
                                </div>

                                {/* Chart Patterns Screener */}
                                {screenerTab === 'patterns' && (
                                    <div>
                                        <div className="flex items-center justify-between mb-2">
                                            <h2 className="text-lg font-semibold">üìê Chart Patterns</h2>
                                            <span className="text-xs text-gray-500">{CHART_PATTERNS.length} patterns</span>
                                        </div>

                                        {/* Daily Timeframe Warning */}
                                        <div className="mb-3 px-3 py-2 bg-yellow-900/30 border border-yellow-600/50 rounded-lg">
                                            <div className="flex items-center gap-2 text-yellow-400 text-xs">
                                                <span>‚ö†Ô∏è</span>
                                                <span><strong>DAILY CHART ONLY</strong> ‚Äî Always confirm with your entry timeframe before trading</span>
                                            </div>
                                        </div>

                                        {/* Pattern Category Tabs */}
                                        <div className="flex gap-1 mb-3 overflow-x-auto pb-1">
                                            {[
                                                { id: 'all', label: 'All' },
                                                { id: 'wedge', label: 'Wedges' },
                                                { id: 'channel', label: 'Channels' },
                                                { id: 'reversal', label: 'Reversals' },
                                                { id: 'triangle', label: 'Triangles' },
                                                { id: 'flag', label: 'Flags' },
                                            ].map(cat => (
                                                <button
                                                    key={cat.id}
                                                    onClick={() => setPatternCategory(cat.id)}
                                                    className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap transition-colors ${
                                                        patternCategory === cat.id
                                                            ? 'bg-purple-600 text-white'
                                                            : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
                                                    }`}
                                                >
                                                    {cat.label}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Pattern Selector */}
                                        <div className="mb-4">
                                            <div className="grid grid-cols-2 gap-2 mb-3 max-h-48 overflow-y-auto pr-1">
                                                {(patternCategory === 'all'
                                                    ? getEnabledPatterns()
                                                    : getEnabledPatterns().filter(p => p.category === patternCategory)
                                                ).map(pattern => (
                                                    <button
                                                        key={pattern.id}
                                                        disabled={patternLoading && selectedPattern !== pattern.id}
                                                        onClick={async () => {
                                                            if (patternLoading) return;
                                                            const targetPattern = pattern.id;
                                                            setSelectedPattern(targetPattern);
                                                            setPatternStocks([]);
                                                            setChartStock(null);
                                                            setPatternLoading(true);
                                                            const stocks = await fetchPatternStocks(targetPattern);
                                                            if (stocks !== null) {
                                                                setPatternStocks(stocks);
                                                                setPatternLoading(false);
                                                            }
                                                        }}
                                                        className={`p-2 rounded-lg text-xs font-medium transition-all text-left ${
                                                            selectedPattern === pattern.id
                                                                ? pattern.type === 'bullish'
                                                                    ? 'bg-green-600 border-green-500'
                                                                    : pattern.type === 'bearish'
                                                                        ? 'bg-red-600 border-red-500'
                                                                        : 'bg-yellow-600 border-yellow-500'
                                                                : 'bg-gray-800 border-gray-700 hover:bg-gray-700'
                                                        } border`}
                                                    >
                                                        <div className="flex items-center gap-1">
                                                            <span>{pattern.emoji}</span>
                                                            <span className="truncate">{pattern.name}</span>
                                                        </div>
                                                        <div className={`text-xs mt-0.5 ${selectedPattern === pattern.id ? 'text-white/70' : 'text-gray-500'}`}>
                                                            {pattern.type === 'bullish' ? 'üü¢ Bullish' : pattern.type === 'bearish' ? 'üî¥ Bearish' : 'üü° Neutral'}
                                                        </div>
                                                    </button>
                                                ))}
                                                {/* Empty state when no patterns enabled */}
                                                {(patternCategory === 'all' ? getEnabledPatterns() : getEnabledPatterns().filter(p => p.category === patternCategory)).length === 0 && (
                                                    <div className="col-span-2 text-center py-6 text-gray-500">
                                                        <div className="text-2xl mb-2">üìä</div>
                                                        <p>No patterns enabled{patternCategory !== 'all' ? ' in this category' : ''}</p>
                                                        <button
                                                            onClick={() => setShowSettings(true)}
                                                            className="mt-2 text-purple-400 hover:text-purple-300 text-sm underline"
                                                        >
                                                            Go to Settings to enable patterns
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Selected Pattern Info */}
                                        {CHART_PATTERNS.filter(p => p.id === selectedPattern).map(pattern => (
                                            <div key={pattern.id} className={`p-3 rounded-xl text-sm mb-4 ${
                                                pattern.type === 'bullish'
                                                    ? 'bg-green-500/10 border border-green-500/30 text-green-300'
                                                    : pattern.type === 'bearish'
                                                        ? 'bg-red-500/10 border border-red-500/30 text-red-300'
                                                        : 'bg-yellow-500/10 border border-yellow-500/30 text-yellow-300'
                                            }`}>
                                                <div className="font-semibold mb-1">{pattern.emoji} {pattern.name}</div>
                                                <div className="text-xs opacity-80">{pattern.desc}</div>
                                            </div>
                                        ))}

                                        {/* Results */}
                                        {patternLoading ? (
                                            <div className="text-center py-8 text-gray-500">
                                                <div className="text-2xl mb-2 animate-spin">‚è≥</div>
                                                Scanning for {CHART_PATTERNS.find(p => p.id === selectedPattern)?.name}...
                                            </div>
                                        ) : patternStocks.length > 0 && !patternStocks[0]?.error ? (
                                            <div className="space-y-2">
                                                {/* Chart Display */}
                                                {chartStock && (
                                                    <div className="mb-4 p-3 bg-gray-800 border border-blue-500 rounded-xl">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-xl">${chartStock.ticker}</span>
                                                                <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                                                    CHART_PATTERNS.find(p => p.id === selectedPattern)?.type === 'bullish'
                                                                        ? 'bg-green-500/20 text-green-400'
                                                                        : CHART_PATTERNS.find(p => p.id === selectedPattern)?.type === 'bearish'
                                                                            ? 'bg-red-500/20 text-red-400'
                                                                            : 'bg-yellow-500/20 text-yellow-400'
                                                                }`}>
                                                                    {CHART_PATTERNS.find(p => p.id === selectedPattern)?.emoji} {CHART_PATTERNS.find(p => p.id === selectedPattern)?.name}
                                                                </span>
                                                            </div>
                                                            <button
                                                                onClick={() => setChartStock(null)}
                                                                className="text-gray-400 hover:text-white text-xl"
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                        <div className="text-sm text-gray-400 mb-2">{chartStock.company}</div>
                                                        <img
                                                            src={`https://finviz.com/chart.ashx?t=${chartStock.ticker}&ty=c&ta=1&p=d&s=l`}
                                                            alt={`${chartStock.ticker} chart`}
                                                            className="w-full rounded-lg border border-gray-700"
                                                            onError={(e) => {
                                                                e.target.style.display = 'none';
                                                                e.target.nextSibling.style.display = 'block';
                                                            }}
                                                        />
                                                        <div className="hidden text-center py-4 text-gray-500">
                                                            Chart unavailable - <a href={`https://finviz.com/quote.ashx?t=${chartStock.ticker}`} target="_blank" className="text-blue-400 underline">View on Finviz</a>
                                                        </div>
                                                        <div className="mt-2 p-2 bg-gray-700/50 rounded text-xs text-gray-300">
                                                            <span className="font-semibold">Pattern:</span> {CHART_PATTERNS.find(p => p.id === selectedPattern)?.desc}
                                                        </div>
                                                        <a
                                                            href={`https://finviz.com/quote.ashx?t=${chartStock.ticker}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="mt-2 block text-center text-xs text-blue-400 hover:underline"
                                                        >
                                                            Open full analysis on Finviz ‚Üí
                                                        </a>
                                                    </div>
                                                )}

                                                <div className="text-xs text-gray-400 mb-2">
                                                    Found <span className="text-white font-semibold">{patternStocks.length}</span> stocks matching pattern
                                                    <span className="text-gray-500 ml-2">‚Ä¢ Click to view chart</span>
                                                </div>
                                                {patternStocks.map((stock) => (
                                                    <button
                                                        key={stock.ticker}
                                                        onClick={() => setChartStock(stock)}
                                                        className={`block w-full text-left p-3 bg-gray-800 border rounded-xl hover:border-blue-500 transition-all cursor-pointer ${
                                                            chartStock?.ticker === stock.ticker ? 'border-blue-500' : 'border-gray-700'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div>
                                                                <span className="font-bold text-lg">${stock.ticker}</span>
                                                                <span className="text-gray-500 text-sm ml-2">{stock.price}</span>
                                                            </div>
                                                            <span className={`font-semibold ${stock.changeNum >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                                {stock.change}
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-gray-400">{stock.company}</div>
                                                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                            <span>{stock.sector}</span>
                                                            <span>Cap: {stock.marketCap}</span>
                                                        </div>
                                                    </button>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center py-6 text-gray-500">
                                                <div className="text-2xl mb-2">üëÜ</div>
                                                <p>Select a pattern to scan for matching stocks</p>
                                            </div>
                                        )}

                                        <div className="mt-4 p-3 bg-gray-800 border border-gray-700 rounded-xl text-xs text-gray-400">
                                            <div className="font-semibold text-gray-300 mb-1">üéØ Quality Filters:</div>
                                            <div>Market Cap &gt;$300M ‚Ä¢ Avg Volume &gt;200K ‚Ä¢ Price &gt;$5</div>
                                        </div>
                                    </div>
                                )}

                                {/* Insider Trading Screener */}
                                {screenerTab === 'insider' && (
                                    <div>
                                        <div className="flex items-center justify-between mb-3">
                                            <h2 className="text-lg font-semibold">üïµÔ∏è Insider Buys (Last 7 Days)</h2>
                                            <span className="text-xs text-gray-500">via SEC Form 4</span>
                                        </div>

                                        <div className="p-3 bg-green-500/10 border border-green-500/30 rounded-xl text-sm text-green-300 mb-4">
                                            üí° Insiders buying = They know something. Large cluster buys are especially bullish.
                                        </div>

                                        {loading ? (
                                            <div className="text-center py-8 text-gray-500">
                                                <div className="text-2xl mb-2">‚è≥</div>
                                                Loading insider data from SEC filings...
                                            </div>
                                        ) : insiderTrades.length > 0 ? (
                                            <div className="space-y-2">
                                                {insiderTrades.map((trade, i) => (
                                                    <div
                                                        key={i}
                                                        className={`p-3 rounded-xl border transition-all hover:scale-[1.01] cursor-pointer ${
                                                            trade.valueNum >= 1000000 ? 'bg-green-500/20 border-green-500/50' :
                                                            trade.valueNum >= 500000 ? 'bg-green-500/10 border-green-500/30' :
                                                            'bg-gray-800 border-gray-700'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-lg">${trade.ticker}</span>
                                                                {trade.valueNum >= 1000000 && <span className="text-xs px-2 py-0.5 bg-green-500/30 rounded-full text-green-300">üêã WHALE</span>}
                                                                {trade.valueNum >= 500000 && trade.valueNum < 1000000 && <span className="text-xs px-2 py-0.5 bg-yellow-500/30 rounded-full text-yellow-300">üí∞ BIG</span>}
                                                            </div>
                                                            <span className="text-green-400 font-bold">{trade.value}</span>
                                                        </div>
                                                        <div className="text-sm text-gray-400 mb-1">{trade.company}</div>
                                                        <div className="flex justify-between text-xs text-gray-500">
                                                            <span>{trade.insiderName} ({trade.title})</span>
                                                            <span>{trade.filingDate}</span>
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            {trade.qty} shares @ {trade.price}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center py-8 text-gray-500">
                                                <div className="text-2xl mb-2">üîç</div>
                                                No insider buys found. Check back later.
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}

                        {/* Hot Stocks Tab - Aggregated from all sources */}
                        {activeTab === 'trending' && (
                            <>
                                <div className="mb-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <h2 className="text-lg font-semibold">üî• Hot Stocks</h2>
                                        <span className="text-xs text-gray-500">10 sources</span>
                                    </div>

                                    <div className="p-3 bg-purple-500/10 border border-purple-500/30 rounded-xl text-xs text-purple-300 mb-4">
                                        üìä Reddit ‚Ä¢ Yahoo ‚Ä¢ Stocktwits ‚Ä¢ Finviz ‚Ä¢ MarketWatch ‚Ä¢ CNBC ‚Ä¢ SeekingAlpha ‚Ä¢ MotleyFool ‚Ä¢ Bloomberg
                                    </div>

                                    {loading ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <div className="text-2xl mb-2">‚è≥</div>
                                            Scanning all sources...
                                        </div>
                                    ) : trending.trending.length > 0 ? (
                                        <>
                                            {/* Hot stocks list */}
                                            <div className="space-y-2 mb-6">
                                                {trending.trending.slice(0, 20).map((item, i) => (
                                                    <div
                                                        key={item.ticker}
                                                        className={`p-3 rounded-xl border transition-all ${
                                                            item.heat === 'extreme' ? 'bg-red-500/20 border-red-500/50' :
                                                            item.heat === 'high' ? 'bg-orange-500/20 border-orange-500/50' :
                                                            item.heat === 'medium' ? 'bg-yellow-500/10 border-yellow-500/30' :
                                                            'bg-gray-800 border-gray-700'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-gray-500 text-sm w-6">#{i + 1}</span>
                                                                <span className="font-bold text-lg">${item.ticker}</span>
                                                                {item.heat === 'extreme' && <span className="text-xs px-2 py-0.5 bg-red-500/30 rounded-full text-red-300 animate-pulse">üî• EVERYWHERE</span>}
                                                                {item.heat === 'high' && <span className="text-xs px-2 py-0.5 bg-orange-500/30 rounded-full text-orange-300">üî• HOT</span>}
                                                                {item.heat === 'medium' && <span className="text-xs px-2 py-0.5 bg-yellow-500/30 rounded-full text-yellow-300">üìà BUZZING</span>}
                                                            </div>
                                                            <span className="text-xs text-gray-400">{item.sourceCount} sources</span>
                                                        </div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {item.sources.map(src => (
                                                                <span
                                                                    key={src}
                                                                    className={`text-xs px-2 py-0.5 rounded-full ${
                                                                        src === 'Yahoo' ? 'bg-purple-500/30 text-purple-300' :
                                                                        src === 'Stocktwits' ? 'bg-blue-500/30 text-blue-300' :
                                                                        src === 'Finviz' ? 'bg-green-500/30 text-green-300' :
                                                                        src === 'MarketWatch' ? 'bg-teal-500/30 text-teal-300' :
                                                                        src === 'CNBC' ? 'bg-yellow-500/30 text-yellow-300' :
                                                                        src === 'SeekingAlpha' ? 'bg-emerald-500/30 text-emerald-300' :
                                                                        src === 'MotleyFool' ? 'bg-indigo-500/30 text-indigo-300' :
                                                                        src === 'Bloomberg' ? 'bg-sky-500/30 text-sky-300' :
                                                                        'bg-orange-500/30 text-orange-300'
                                                                    }`}
                                                                >
                                                                    {src}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Hot posts from Reddit */}
                                            {trending.posts.length > 0 && (
                                                <div className="mb-4">
                                                    <h3 className="text-sm font-semibold text-gray-400 mb-2">üì∞ Hot Reddit Posts</h3>
                                                    <div className="space-y-2">
                                                        {trending.posts.slice(0, 8).map((post, i) => (
                                                            <a
                                                                key={i}
                                                                href={post.url}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="block p-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl transition-colors"
                                                            >
                                                                <div className="flex items-start justify-between gap-2">
                                                                    <div className="text-sm flex-1">{post.title}</div>
                                                                    <span className={`text-xs px-2 py-0.5 rounded-full whitespace-nowrap ${
                                                                        post.category === 'meme' ? 'bg-purple-500/30 text-purple-300' :
                                                                        post.category === 'penny' ? 'bg-orange-500/30 text-orange-300' :
                                                                        'bg-blue-500/30 text-blue-300'
                                                                    }`}>
                                                                        r/{post.subreddit}
                                                                    </span>
                                                                </div>
                                                                <div className="text-xs text-gray-500 mt-1">‚¨ÜÔ∏è {post.score.toLocaleString()}</div>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    ) : (
                                        <div className="text-center py-8 text-gray-500">
                                            <div className="text-2xl mb-2">üì°</div>
                                            No data available
                                        </div>
                                    )}
                                </div>

                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-xl text-xs text-yellow-300">
                                    ‚ö†Ô∏è High buzz = everyone's talking. You might be late. Stocks appearing on 3+ sources are getting maximum attention.
                                </div>
                            </>
                        )}

                        {/* Journal Tab */}
                        {activeTab === 'journal' && (
                            <>
                                {/* Journal Header with Stats Summary */}
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 className="text-lg font-semibold">Trade Journal</h2>
                                        <p className="text-xs text-gray-500">
                                            {journalEntries.length} trades ‚Ä¢ {journalStats.winRate.toFixed(0)}% win rate
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setShowAddTrade(true)}
                                        className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-xl text-sm font-semibold transition-colors"
                                    >
                                        + Log Trade
                                    </button>
                                </div>

                                {/* Journal View Tabs */}
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => setJournalView('list')}
                                        className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${journalView === 'list' ? 'bg-gray-700' : 'bg-gray-800/50 hover:bg-gray-700/50'}`}
                                    >
                                        üìã Trades
                                    </button>
                                    <button
                                        onClick={() => setJournalView('stats')}
                                        className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${journalView === 'stats' ? 'bg-gray-700' : 'bg-gray-800/50 hover:bg-gray-700/50'}`}
                                    >
                                        üìä Stats
                                    </button>
                                    <button
                                        onClick={() => setJournalView('calendar')}
                                        className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${journalView === 'calendar' ? 'bg-gray-700' : 'bg-gray-800/50 hover:bg-gray-700/50'}`}
                                    >
                                        üìÖ Calendar
                                    </button>
                                </div>

                                {/* Stats View */}
                                {journalView === 'stats' && (
                                    <div className="space-y-4">
                                        {/* Main Stats Grid */}
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                                <div className="text-xs text-gray-500 mb-1">Total P&L</div>
                                                <div className={`text-2xl font-bold ${journalStats.totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {journalStats.totalPnL >= 0 ? '+' : ''}${journalStats.totalPnL.toFixed(2)}
                                                </div>
                                            </div>
                                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                                <div className="text-xs text-gray-500 mb-1">Win Rate</div>
                                                <div className={`text-2xl font-bold ${journalStats.winRate >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {journalStats.winRate.toFixed(1)}%
                                                </div>
                                            </div>
                                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                                <div className="text-xs text-gray-500 mb-1">Profit Factor</div>
                                                <div className={`text-2xl font-bold ${journalStats.profitFactor >= 1 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {journalStats.profitFactor === Infinity ? '‚àû' : journalStats.profitFactor.toFixed(2)}
                                                </div>
                                            </div>
                                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                                <div className="text-xs text-gray-500 mb-1">Avg R-Multiple</div>
                                                <div className={`text-2xl font-bold ${journalStats.avgRMultiple >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {journalStats.avgRMultiple.toFixed(2)}R
                                                </div>
                                            </div>
                                        </div>

                                        {/* Win/Loss Breakdown */}
                                        <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                            <div className="text-sm font-semibold mb-3">Win/Loss Breakdown</div>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-green-400">Wins: {journalStats.wins}</span>
                                                <span className="text-red-400">Losses: {journalStats.losses}</span>
                                            </div>
                                            <div className="w-full bg-gray-700 rounded-full h-3">
                                                <div
                                                    className="bg-green-500 h-3 rounded-full"
                                                    style={{ width: `${journalStats.totalTrades > 0 ? (journalStats.wins / journalStats.totalTrades) * 100 : 0}%` }}
                                                />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 mt-4 text-sm">
                                                <div>
                                                    <span className="text-gray-500">Avg Win:</span>
                                                    <span className="text-green-400 ml-2">+${journalStats.avgWin.toFixed(2)}</span>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Avg Loss:</span>
                                                    <span className="text-red-400 ml-2">-${journalStats.avgLoss.toFixed(2)}</span>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Largest Win:</span>
                                                    <span className="text-green-400 ml-2">+${journalStats.largestWin.toFixed(2)}</span>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Largest Loss:</span>
                                                    <span className="text-red-400 ml-2">${journalStats.largestLoss.toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Current Streak */}
                                        <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                            <div className="text-sm font-semibold mb-2">Current Streak</div>
                                            <div className={`text-xl font-bold ${journalStats.streakType === 'win' ? 'text-green-400' : journalStats.streakType === 'loss' ? 'text-red-400' : 'text-gray-400'}`}>
                                                {journalStats.currentStreak > 0 ? (
                                                    <>
                                                        {journalStats.streakType === 'win' ? 'üî•' : '‚ùÑÔ∏è'} {journalStats.currentStreak} {journalStats.streakType === 'win' ? 'Wins' : 'Losses'}
                                                    </>
                                                ) : (
                                                    'No streak'
                                                )}
                                            </div>
                                        </div>

                                        {/* Setup Performance */}
                                        {Object.keys(journalStats.setupStats).length > 0 && (
                                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                                <div className="text-sm font-semibold mb-3">Setup Performance</div>
                                                <div className="space-y-2">
                                                    {Object.entries(journalStats.setupStats)
                                                        .sort((a, b) => b[1].pnl - a[1].pnl)
                                                        .slice(0, 5)
                                                        .map(([setup, stats]) => {
                                                            const setupInfo = SETUP_TYPES.find(s => s.id === setup);
                                                            const winRate = stats.trades > 0 ? (stats.wins / stats.trades) * 100 : 0;
                                                            return (
                                                                <div key={setup} className="flex justify-between items-center text-sm">
                                                                    <span>{setupInfo?.emoji} {setupInfo?.label || setup}</span>
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-gray-500">{stats.trades} trades</span>
                                                                        <span className={winRate >= 50 ? 'text-green-400' : 'text-red-400'}>{winRate.toFixed(0)}%</span>
                                                                        <span className={stats.pnl >= 0 ? 'text-green-400' : 'text-red-400'}>
                                                                            {stats.pnl >= 0 ? '+' : ''}${stats.pnl.toFixed(0)}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                </div>
                                            </div>
                                        )}

                                        {/* Mistake Analysis */}
                                        {Object.keys(journalStats.mistakeStats).length > 0 && !journalStats.mistakeStats.none && (
                                            <div className="bg-gray-800/50 p-4 rounded-xl border border-red-500/30">
                                                <div className="text-sm font-semibold mb-3 text-red-400">üíÄ Costly Mistakes</div>
                                                <div className="space-y-2">
                                                    {Object.entries(journalStats.mistakeStats)
                                                        .filter(([m]) => m !== 'none')
                                                        .sort((a, b) => b[1].totalLoss - a[1].totalLoss)
                                                        .slice(0, 5)
                                                        .map(([mistake, stats]) => {
                                                            const mistakeInfo = MISTAKE_TYPES.find(m => m.id === mistake);
                                                            return (
                                                                <div key={mistake} className="flex justify-between items-center text-sm">
                                                                    <span>{mistakeInfo?.emoji} {mistakeInfo?.label || mistake}</span>
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-gray-500">{stats.count}x</span>
                                                                        <span className="text-red-400">-${stats.totalLoss.toFixed(0)}</span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                </div>
                                            </div>
                                        )}

                                        {journalEntries.length === 0 && (
                                            <div className="text-center py-8 text-gray-500">
                                                <p className="text-4xl mb-2">üìä</p>
                                                <p>No trades logged yet</p>
                                                <p className="text-sm">Log some trades to see your stats</p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* List View */}
                                {journalView === 'list' && (
                                    <div className="space-y-3">
                                        {journalEntries.length === 0 ? (
                                            <div className="text-center py-12 text-gray-500">
                                                <p className="text-5xl mb-3">üìì</p>
                                                <p className="font-semibold">Your Trade Journal</p>
                                                <p className="text-sm mt-2">Log your trades to track performance,<br/>identify patterns, and improve.</p>
                                                <button
                                                    onClick={() => setShowAddTrade(true)}
                                                    className="mt-4 px-6 py-2 bg-green-600 hover:bg-green-500 rounded-xl text-sm font-semibold"
                                                >
                                                    Log Your First Trade
                                                </button>
                                            </div>
                                        ) : (
                                            [...journalEntries]
                                                .sort((a, b) => new Date(b.exitDate || b.entryDate) - new Date(a.exitDate || a.entryDate))
                                                .map(trade => {
                                                    const grade = gradeJournalTrade(trade);
                                                    const setupInfo = SETUP_TYPES.find(s => s.id === trade.setup);
                                                    return (
                                                        <div
                                                            key={trade.id}
                                                            onClick={() => setSelectedJournalTrade(trade)}
                                                            className={`p-4 rounded-xl border cursor-pointer transition-colors hover:border-gray-500 ${
                                                                trade.pnl >= 0 ? 'bg-green-900/20 border-green-500/30' : 'bg-red-900/20 border-red-500/30'
                                                            }`}
                                                        >
                                                            <div className="flex justify-between items-start">
                                                                <div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-bold text-lg">{trade.ticker}</span>
                                                                        <span className={`text-xs px-2 py-0.5 rounded ${trade.side === 'long' ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}`}>
                                                                            {trade.side?.toUpperCase()}
                                                                        </span>
                                                                        {setupInfo && (
                                                                            <span className="text-xs text-gray-400">{setupInfo.emoji} {setupInfo.label}</span>
                                                                        )}
                                                                    </div>
                                                                    <div className="text-xs text-gray-500 mt-1">
                                                                        {new Date(trade.entryDate).toLocaleDateString()} ‚Ä¢
                                                                        ${trade.entryPrice?.toFixed(2)} ‚Üí ${trade.exitPrice?.toFixed(2)}
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className={`font-bold text-lg ${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                                        {trade.pnl >= 0 ? '+' : ''}${trade.pnl?.toFixed(2)}
                                                                    </div>
                                                                    <div className={`text-sm font-bold ${grade.color}`}>
                                                                        {grade.grade}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {trade.notes && (
                                                                <div className="mt-2 text-xs text-gray-400 line-clamp-1">
                                                                    üìù {trade.notes}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                        )}
                                    </div>
                                )}

                                {/* Calendar View */}
                                {journalView === 'calendar' && (
                                    <CalendarView
                                        entries={journalEntries}
                                        onDayClick={(date, trades) => {
                                            if (trades.length === 1) {
                                                setSelectedJournalTrade(trades[0]);
                                            }
                                        }}
                                        dayOfWeekStats={journalStats.dayOfWeekStats}
                                    />
                                )}
                            </>
                        )}

                        {/* Disclaimer */}
                        <div className="mt-8 p-4 bg-gray-800/50 border border-gray-700 rounded-xl text-xs text-gray-500 text-center">
                            ‚öñÔ∏è Educational tool only. Not financial advice. All trading decisions are yours. You can lose money trading.
                        </div>
                    </main>

                    {/* Talk Me Down Button - Fixed at bottom */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent">
                        <div className="max-w-lg mx-auto">
                            <button
                                onClick={() => setShowTalkMeDown(true)}
                                className="talk-me-down-btn w-full py-4 rounded-2xl font-bold text-lg transition-all"
                            >
                                üß† THE VOICE OF LOGIC
                            </button>
                        </div>
                    </div>

                    {/* Modals */}
                    <TalkMeDownModal
                        isOpen={showTalkMeDown}
                        onClose={() => setShowTalkMeDown(false)}
                        positions={positions}
                        personality={settings.personality}
                    />
                    <AddPositionModal
                        isOpen={showAddPosition}
                        onClose={() => setShowAddPosition(false)}
                        onAdd={handleAddPosition}
                    />
                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        settings={settings}
                        onSave={setSettings}
                    />
                    <AlertPanel
                        isOpen={showAlerts}
                        onClose={() => {
                            setShowAlerts(false);
                            const now = Date.now();
                            setAlertsDismissedAt(now);
                            localStorage.setItem('alertsDismissedAt', now.toString()); // Persist - don't show again for 24 hours
                        }}
                        alerts={alerts}
                        lastCheck={lastAlertCheck}
                    />
                    <PositionDetailModal
                        position={selectedPositionDetail ? positions.find(p => p.id === selectedPositionDetail.id) || selectedPositionDetail : null}
                        onClose={() => setSelectedPositionDetail(null)}
                        onDelete={(id) => {
                            setPositions(positions.filter(p => p.id !== id));
                        }}
                    />

                    {/* Custom Alert Manager */}
                    <AlertManager
                        isOpen={showAlertManager}
                        onClose={() => setShowAlertManager(false)}
                        customAlerts={customAlerts}
                        setCustomAlerts={setCustomAlerts}
                        alertHistory={alertHistory}
                        setAlertHistory={setAlertHistory}
                        newsWatchlist={newsWatchlist}
                        setNewsWatchlist={setNewsWatchlist}
                        pushEnabled={pushEnabled}
                        setPushEnabled={setPushEnabled}
                        fcmToken={fcmToken}
                        setFcmToken={setFcmToken}
                        fcmError={fcmError}
                        setFcmError={setFcmError}
                    />

                    {/* Real-time Alert Notifications */}
                    <AlertNotification
                        alerts={triggeredAlerts}
                        onDismiss={dismissTriggeredAlert}
                        onDismissAll={dismissAllTriggeredAlerts}
                    />

                    {/* Scalper Mode Dashboard */}
                    {showScalperMode && (
                        <ScalperDashboard
                            positions={positions}
                            tradeStats={tradeStats}
                            setTradeStats={setTradeStats}
                            dailyGoal={dailyGoal}
                            setDailyGoal={setDailyGoal}
                            onClose={() => setShowScalperMode(false)}
                        />
                    )}

                    {/* Add Trade Modal */}
                    {showAddTrade && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-900 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                                <div className="p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-900 z-10">
                                    <h2 className="text-xl font-bold">üìì Log Trade</h2>
                                    <button onClick={() => setShowAddTrade(false)} className="text-gray-400 hover:text-white text-2xl">‚úï</button>
                                </div>
                                <form
                                    className="p-4 space-y-4"
                                    onSubmit={(e) => {
                                        e.preventDefault();
                                        const form = e.target;
                                        const entryPrice = parseFloat(form.entryPrice.value);
                                        const exitPrice = parseFloat(form.exitPrice.value);
                                        const quantity = parseFloat(form.quantity.value) || 1;
                                        const side = form.side.value;
                                        const pnl = side === 'long'
                                            ? (exitPrice - entryPrice) * quantity
                                            : (entryPrice - exitPrice) * quantity;

                                        const newTrade = {
                                            id: Date.now(),
                                            ticker: form.ticker.value.toUpperCase(),
                                            side,
                                            assetType: form.assetType.value,
                                            entryPrice,
                                            exitPrice,
                                            quantity,
                                            entryDate: form.entryDate.value,
                                            exitDate: form.exitDate.value,
                                            pnl,
                                            fees: parseFloat(form.fees.value) || 0,
                                            setup: form.setup.value,
                                            mistakes: Array.from(form.querySelectorAll('input[name="mistakes"]:checked')).map(el => el.value),
                                            emotionBefore: form.emotionBefore.value,
                                            emotionAfter: form.emotionAfter.value,
                                            followedPlan: form.followedPlan.checked,
                                            riskAmount: parseFloat(form.riskAmount.value) || null,
                                            notes: form.notes.value,
                                            screenshot: document.getElementById('screenshot-preview').src?.startsWith('data:')
                                                ? document.getElementById('screenshot-preview').src
                                                : null
                                        };

                                        const updated = [...journalEntries, newTrade];
                                        setJournalEntries(updated);
                                        saveJournalEntries(updated);
                                        setShowAddTrade(false);
                                    }}
                                >
                                    {/* Basic Info */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Ticker *</label>
                                            <input name="ticker" type="text" required placeholder="AAPL" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Side *</label>
                                            <select name="side" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700">
                                                <option value="long">Long</option>
                                                <option value="short">Short</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">Asset Type</label>
                                        <select name="assetType" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700">
                                            <option value="stock">Stock</option>
                                            <option value="option">Option</option>
                                            <option value="crypto">Crypto</option>
                                            <option value="futures">Futures</option>
                                        </select>
                                    </div>

                                    {/* Prices */}
                                    <div className="grid grid-cols-3 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Entry $ *</label>
                                            <input name="entryPrice" type="number" step="0.01" required placeholder="100.00" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Exit $ *</label>
                                            <input name="exitPrice" type="number" step="0.01" required placeholder="105.00" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Qty</label>
                                            <input name="quantity" type="number" step="1" defaultValue="1" placeholder="100" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                    </div>

                                    {/* Dates */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Entry Date</label>
                                            <input name="entryDate" type="datetime-local" defaultValue={new Date().toISOString().slice(0, 16)} className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Exit Date</label>
                                            <input name="exitDate" type="datetime-local" defaultValue={new Date().toISOString().slice(0, 16)} className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                    </div>

                                    {/* Risk & Fees */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Risk Amount ($)</label>
                                            <input name="riskAmount" type="number" step="0.01" placeholder="50.00" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">Fees ($)</label>
                                            <input name="fees" type="number" step="0.01" placeholder="0.00" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none" />
                                        </div>
                                    </div>

                                    {/* Setup Type */}
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-2">Setup Type</label>
                                        <select name="setup" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700">
                                            {SETUP_TYPES.map(s => (
                                                <option key={s.id} value={s.id}>{s.emoji} {s.label}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Emotions */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-2">Emotion Before</label>
                                            <select name="emotionBefore" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700">
                                                {EMOTIONS.map(e => (
                                                    <option key={e.id} value={e.id}>{e.emoji} {e.label}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-2">Emotion After</label>
                                            <select name="emotionAfter" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700">
                                                {EMOTIONS.map(e => (
                                                    <option key={e.id} value={e.id}>{e.emoji} {e.label}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    {/* Mistakes */}
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-2">Mistakes Made</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {MISTAKE_TYPES.map(m => (
                                                <label key={m.id} className="flex items-center gap-2 text-sm p-2 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50">
                                                    <input type="checkbox" name="mistakes" value={m.id} className="rounded" />
                                                    <span>{m.emoji} {m.label}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Followed Plan */}
                                    <label className="flex items-center gap-3 p-3 bg-gray-800/50 rounded-xl cursor-pointer">
                                        <input type="checkbox" name="followedPlan" defaultChecked className="w-5 h-5 rounded" />
                                        <span>I followed my trading plan</span>
                                    </label>

                                    {/* Notes */}
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">Notes & Lessons</label>
                                        <textarea name="notes" rows="3" placeholder="What did you learn? Why did you take this trade?" className="w-full p-3 bg-gray-800 rounded-xl border border-gray-700 focus:border-blue-500 outline-none resize-none" />
                                    </div>

                                    {/* Screenshot Upload */}
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">Chart Screenshot</label>
                                        <div className="relative">
                                            <input
                                                type="file"
                                                name="screenshot"
                                                accept="image/*"
                                                className="hidden"
                                                id="screenshot-upload"
                                                onChange={(e) => {
                                                    const file = e.target.files[0];
                                                    const preview = document.getElementById('screenshot-preview');
                                                    const previewContainer = document.getElementById('screenshot-preview-container');
                                                    if (file) {
                                                        const reader = new FileReader();
                                                        reader.onload = (event) => {
                                                            preview.src = event.target.result;
                                                            previewContainer.classList.remove('hidden');
                                                        };
                                                        reader.readAsDataURL(file);
                                                    } else {
                                                        previewContainer.classList.add('hidden');
                                                    }
                                                }}
                                            />
                                            <label
                                                htmlFor="screenshot-upload"
                                                className="flex items-center justify-center gap-2 p-4 bg-gray-800 rounded-xl border border-gray-700 border-dashed cursor-pointer hover:border-gray-500 transition-colors"
                                            >
                                                <span className="text-2xl">üì∑</span>
                                                <span className="text-sm text-gray-400">Tap to add chart screenshot</span>
                                            </label>
                                            <div id="screenshot-preview-container" className="hidden mt-2">
                                                <div className="relative">
                                                    <img id="screenshot-preview" className="w-full rounded-xl" alt="Preview" />
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            document.getElementById('screenshot-upload').value = '';
                                                            document.getElementById('screenshot-preview-container').classList.add('hidden');
                                                        }}
                                                        className="absolute top-2 right-2 bg-red-600 hover:bg-red-500 rounded-full w-8 h-8 flex items-center justify-center text-sm"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Submit */}
                                    <button type="submit" className="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-lg transition-colors">
                                        Log Trade
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Trade Detail Modal */}
                    {selectedJournalTrade && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-900 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                                <div className="p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-900">
                                    <h2 className="text-xl font-bold">{selectedJournalTrade.ticker} Trade Review</h2>
                                    <button onClick={() => setSelectedJournalTrade(null)} className="text-gray-400 hover:text-white text-2xl">‚úï</button>
                                </div>
                                <div className="p-4 space-y-4">
                                    {/* P&L Header */}
                                    <div className={`text-center p-6 rounded-xl ${selectedJournalTrade.pnl >= 0 ? 'bg-green-900/30' : 'bg-red-900/30'}`}>
                                        <div className={`text-4xl font-bold ${selectedJournalTrade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {selectedJournalTrade.pnl >= 0 ? '+' : ''}${selectedJournalTrade.pnl?.toFixed(2)}
                                        </div>
                                        <div className="text-sm text-gray-400 mt-1">
                                            {selectedJournalTrade.side?.toUpperCase()} ‚Ä¢ ${selectedJournalTrade.entryPrice?.toFixed(2)} ‚Üí ${selectedJournalTrade.exitPrice?.toFixed(2)}
                                        </div>
                                        <div className={`text-2xl font-bold mt-2 ${gradeJournalTrade(selectedJournalTrade).color}`}>
                                            Grade: {gradeJournalTrade(selectedJournalTrade).grade}
                                        </div>
                                    </div>

                                    {/* Voice of Logic Review */}
                                    <div className="p-4 bg-blue-900/20 border border-blue-500/30 rounded-xl">
                                        <div className="text-sm font-semibold mb-2">üß† Voice of Logic Says:</div>
                                        <p className="text-sm text-gray-300">{getTradeReview(selectedJournalTrade, settings.personality)}</p>
                                    </div>

                                    {/* Trade Details */}
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                        <div className="bg-gray-800/50 p-3 rounded-xl">
                                            <div className="text-gray-500">Setup</div>
                                            <div>{SETUP_TYPES.find(s => s.id === selectedJournalTrade.setup)?.emoji} {SETUP_TYPES.find(s => s.id === selectedJournalTrade.setup)?.label}</div>
                                        </div>
                                        <div className="bg-gray-800/50 p-3 rounded-xl">
                                            <div className="text-gray-500">R-Multiple</div>
                                            <div className={selectedJournalTrade.riskAmount ? (selectedJournalTrade.pnl / selectedJournalTrade.riskAmount >= 0 ? 'text-green-400' : 'text-red-400') : ''}>
                                                {selectedJournalTrade.riskAmount ? `${(selectedJournalTrade.pnl / selectedJournalTrade.riskAmount).toFixed(2)}R` : 'N/A'}
                                            </div>
                                        </div>
                                        <div className="bg-gray-800/50 p-3 rounded-xl">
                                            <div className="text-gray-500">Emotion Before</div>
                                            <div>{EMOTIONS.find(e => e.id === selectedJournalTrade.emotionBefore)?.emoji} {EMOTIONS.find(e => e.id === selectedJournalTrade.emotionBefore)?.label}</div>
                                        </div>
                                        <div className="bg-gray-800/50 p-3 rounded-xl">
                                            <div className="text-gray-500">Followed Plan</div>
                                            <div>{selectedJournalTrade.followedPlan ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        </div>
                                    </div>

                                    {/* Mistakes */}
                                    {selectedJournalTrade.mistakes?.length > 0 && !selectedJournalTrade.mistakes.includes('none') && (
                                        <div className="p-3 bg-red-900/20 border border-red-500/30 rounded-xl">
                                            <div className="text-sm font-semibold text-red-400 mb-2">Mistakes Made:</div>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedJournalTrade.mistakes.map(m => {
                                                    const mistake = MISTAKE_TYPES.find(mt => mt.id === m);
                                                    return (
                                                        <span key={m} className="text-xs bg-red-500/20 px-2 py-1 rounded">
                                                            {mistake?.emoji} {mistake?.label}
                                                        </span>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {/* Notes */}
                                    {selectedJournalTrade.notes && (
                                        <div className="p-3 bg-gray-800/50 rounded-xl">
                                            <div className="text-sm font-semibold mb-2">üìù Notes</div>
                                            <p className="text-sm text-gray-300">{selectedJournalTrade.notes}</p>
                                        </div>
                                    )}

                                    {/* Screenshot */}
                                    {selectedJournalTrade.screenshot && (
                                        <div className="rounded-xl overflow-hidden">
                                            <div className="text-sm font-semibold mb-2">üì∑ Chart Screenshot</div>
                                            <img
                                                src={selectedJournalTrade.screenshot}
                                                alt="Trade chart"
                                                className="w-full rounded-xl cursor-pointer hover:opacity-90 transition-opacity"
                                                onClick={() => {
                                                    // Open full screen preview
                                                    const overlay = document.createElement('div');
                                                    overlay.className = 'fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4';
                                                    overlay.onclick = () => overlay.remove();
                                                    const img = document.createElement('img');
                                                    img.src = selectedJournalTrade.screenshot;
                                                    img.className = 'max-w-full max-h-full object-contain';
                                                    overlay.appendChild(img);
                                                    document.body.appendChild(overlay);
                                                }}
                                            />
                                            <p className="text-xs text-gray-500 text-center mt-1">Tap to enlarge</p>
                                        </div>
                                    )}

                                    {/* Delete Button */}
                                    <button
                                        onClick={() => {
                                            if (confirm('Delete this trade from journal?')) {
                                                const updated = journalEntries.filter(t => t.id !== selectedJournalTrade.id);
                                                setJournalEntries(updated);
                                                saveJournalEntries(updated);
                                                setSelectedJournalTrade(null);
                                            }
                                        }}
                                        className="w-full py-3 bg-red-600/20 hover:bg-red-600/40 border border-red-500/30 rounded-xl text-red-400 text-sm"
                                    >
                                        üóëÔ∏è Delete Trade
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
